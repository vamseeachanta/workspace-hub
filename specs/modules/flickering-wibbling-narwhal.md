# WRK-009: Reproduce rev30 Lower Tertiary BSEE Field Results

## Summary

Reproduce Roy's FDAS V30 lower tertiary financial results using BSEE field data to confirm repeatability. This unblocks WRK-010, WRK-011, and WRK-024.

## Scope

- **In scope:** Lower tertiary fields only, using V30 assumptions and methodology as-is
- **Out of scope:** Non-lower-tertiary fields — these require revised assumptions based on publicly available data
- **Follow-up:** `/work add` a new item for revising assumptions for non-lower-tertiary fields after WRK-009 completes

## Current State

### What exists (key finding: Roy's V30 is in-repo)

**Roy's V30 code + golden baseline** at `docs/modules/bsee/analysis/production/FDAS_V30/`:
- `generate_financial_summary_V30.py` — Roy's financial engine (474 lines)
- `financial_project_summary.xlsx` — Roy's OUTPUT (the golden baseline)
- `chronological_lease_analysis.xlsx` — Roy's curated production input
- `lease_assumptions.xlsx`, `leases.xlsx`, `wti_monthly.xlsx` — Roy's config inputs
- `drilling_and_completion_days.xlsx` — D&C input
- `V30_Golden_Baseline_Reference_Full_With_AfterTax.docx` — reference doc

**Additional Roy attachments** at `docs/modules/bsee/data/SME_Roy_attachments/` (13 dated folders: 2025-05-14 through 2025-09-19)

**Reimplemented pipeline (Pipeline B)** at `scripts/bsee/analyze_lower_tertiary_npv.py`:
- Reads raw BSEE OGOR zip files → YAML configs → flat price NPV
- Output: `results/lower_tertiary/npv_summary.csv` (5 producing fields)
- Uses **different methodology** than Roy's V30 (flat prices, no D&C costs, lump-sum CAPEX)

**FDAS module** at `src/worldenergydata/modules/fdas/`:
- `core/financial.py` — NPV, MIRR, IRR (Excel-compatible)
- `adapters/bsee_adapter.py` — BSEE data transformation
- `data/production.py`, `data/drilling.py`, `analysis/cashflow.py`

**Validation tests** at `tests/modules/fdas/validation/test_against_original.py`:
- ALL SKIP because `FDAS_SOURCE_DIR` points to `/home/vamsee/Downloads/FDAS_V30` (doesn't exist)
- Correct path is `docs/modules/bsee/analysis/production/FDAS_V30/` (in-repo)

### Key gap: Two pipelines, different methodologies

| Aspect | Roy's V30 | Pipeline B (current) |
|--------|-----------|---------------------|
| Oil price | Historical WTI (wti_monthly.xlsx) | Flat $75/bbl |
| Gas | Not modeled | Flat $3.50/mcf |
| D&C costs | From drilling_and_completion_days.xlsx | Not included |
| Facilities | Host CAPEX, SURF, pumps, well systems | Not included |
| OPEX | Variable $/bbl + Fixed $/year | Per-BOE flat rate |
| Tax | Pre-tax analysis | 21% federal |
| CAPEX | Time-distributed in cashflow | Lump sum subtracted from NPV |
| Production source | chronological_lease_analysis.xlsx (curated) | Raw BSEE OGOR zips |

The existing `npv_summary.csv` was generated by Pipeline B, NOT Roy's code.

## Plan — Two-Phase Verification

### Phase A: Confirm Roy's V30 is deterministic (code → same output)

Run Roy's original code on his own input files and verify it reproduces `financial_project_summary.xlsx`.

### Phase B: Reproduce V30 results from our pipeline (BSEE OGOR → match V30)

Run our reimplemented code against raw BSEE data and confirm results match Roy's golden baseline.

---

### Step 1: Fix validation test paths and enable existing tests

**Files to modify:**
- `tests/modules/fdas/validation/test_against_original.py:20` — change `FDAS_SOURCE_DIR`
- `tests/modules/fdas/validation/conftest.py` — update fixture paths

**Action:**
```python
# From:
FDAS_SOURCE_DIR = Path("/home/vamsee/Downloads/FDAS_V30")
# To:
FDAS_SOURCE_DIR = Path(__file__).resolve().parents[4] / "docs/modules/bsee/analysis/production/FDAS_V30"
```

**Verify:** `uv run pytest tests/modules/fdas/validation/ -v` — tests should no longer skip.

### Step 2: Extract golden baseline from Roy's output

**Create:** `scripts/extract_golden_baseline.py`
- Read `financial_project_summary.xlsx` (Roy's output)
- Extract per-development metrics: NPV, MIRR, Revenue, Costs, Cashflow
- Save to `config/analysis/lower_tertiary/golden_baseline_v30.yml`

**Create:** `config/analysis/lower_tertiary/golden_baseline_v30.yml`
- Per-field reference values from Roy's V30 output
- Used by all repeatability tests as comparison target

### Step 3: Phase A — Run Roy's V30 code on its own inputs (determinism check)

**Create:** `tests/modules/fdas/validation/test_v30_determinism.py`

Tests:
1. Run `generate_financial_summary_V30.py` programmatically with V30 input files
2. Compare output against `financial_project_summary.xlsx` — must be identical
3. This confirms Roy's code + inputs = deterministic output

If this fails: Roy's code may have external dependencies (date-sensitive, environment-dependent). Document and investigate.

### Step 4: Phase B — Write repeatability tests (TDD — red phase)

**Create:** `tests/modules/lower_tertiary/test_repeatability_v30.py`

Tests to write:
1. **Production data match** — compare BSEE OGOR production for V30 leases against `chronological_lease_analysis.xlsx` monthly totals per field
2. **Financial calc match** — run our `calculate_monthly_financials` with V30 assumptions and compare against V30 output
3. **Per-field NPV match** — for each producing field, NPV within ±1% of golden baseline
4. **Per-field MIRR match** — MIRR within ±0.1% absolute
5. **Revenue match** — total revenue within ±0.1%
6. **Portfolio totals** — aggregate metrics within tolerance

Tolerances (from FDAS spec):
- NPV: ±1% relative
- MIRR: ±0.1% absolute
- Revenue: ±0.1% relative
- Cashflow: ±0.5% relative

### Step 5: Build V30-aligned reproducer (using V30 assumptions as-is)

**Create:** `src/worldenergydata/analysis/lower_tertiary/v30_reproducer.py`

This module uses the **same assumptions and methodology as V30** — no changes to the financial model. It only swaps the production data source from Roy's curated xlsx to raw BSEE OGOR zips.

This module:
- Reads BSEE OGOR data (raw zip files) for V30 lease set
- Maps to V30 development groups using V30 lease mapping
- Applies V30 assumptions as-is: historical WTI prices, D&C costs, facilities CAPEX, variable + fixed OPEX from `lease_assumptions.xlsx`
- Calculates NPV/MIRR using V30 trimmed cashflow approach (via `fdas.core.financial`)
- Returns results in same structure as golden baseline for comparison

Key sub-tasks:
- Production extraction: load OGOR zips → filter by V30 leases → aggregate by development
- Price deck: load `wti_monthly.xlsx` → apply to production months (V30 methodology)
- Cost model: load `lease_assumptions.xlsx` → apply per-development costs (V30 methodology)
- Financial calcs: use `fdas.core.financial` (already reimplemented and tested)

**Note:** Assumption revision for non-lower-tertiary fields is a separate work item to be captured via `/work add`.

### Step 6: Make tests green

Iterate until all repeatability tests pass:
- Debug production data mismatches (OGOR vs curated xlsx)
- Debug financial calculation differences
- Document any accepted deviations with explanations

### Step 7: Generate repeatability report

**Create:** `reports/lower_tertiary/v30_repeatability_report.md`

Contents:
- Phase A result: V30 determinism confirmed (yes/no)
- Phase B summary table: field | metric | V30 baseline | reproduced | delta | pass/fail
- Production comparison (BSEE OGOR vs Roy's curated xlsx)
- Financial comparison per field
- Explanation of any accepted deviations
- Data vintage, code version, timestamp

### Step 8: Update work item and unblock dependents

- Check off WRK-009 acceptance criteria
- Record commit hash
- Unblock: WRK-010, WRK-024
- `/work add` new item: "Revise financial assumptions for non-lower-tertiary fields using publicly available data" (target: worldenergydata, related: WRK-009)

## Critical Files

| File | Action | Purpose |
|------|--------|---------|
| `tests/modules/fdas/validation/test_against_original.py` | Modify | Fix FDAS_SOURCE_DIR path (line 20) |
| `tests/modules/fdas/validation/conftest.py` | Modify | Fix fixture paths |
| `tests/modules/fdas/validation/test_v30_determinism.py` | Create | Phase A: V30 determinism tests |
| `scripts/extract_golden_baseline.py` | Create | Extract V30 reference numbers |
| `config/analysis/lower_tertiary/golden_baseline_v30.yml` | Create | Structured golden baseline |
| `tests/modules/lower_tertiary/test_repeatability_v30.py` | Create | Phase B: repeatability test suite |
| `src/worldenergydata/analysis/lower_tertiary/v30_reproducer.py` | Create | V30-aligned reproduction pipeline |
| `reports/lower_tertiary/v30_repeatability_report.md` | Create | Results documentation |

## Verification

**Phase A (determinism):**
1. `uv run pytest tests/modules/fdas/validation/ -v` — existing tests pass (no skips)
2. `uv run pytest tests/modules/fdas/validation/test_v30_determinism.py -v` — V30 code reproduces its own output

**Phase B (repeatability):**
3. `uv run pytest tests/modules/lower_tertiary/test_repeatability_v30.py -v` — our pipeline matches V30 within tolerance
4. `reports/lower_tertiary/v30_repeatability_report.md` shows per-field pass/fail with deltas < 1%

**Completion:**
5. WRK-009 acceptance criteria all checked
6. Commit with message: `feat(lower-tertiary): WRK-009 - reproduce V30 results with repeatability verification`

## Dependencies

- BSEE OGOR zip files at `data/modules/bsee/zip/historical_production_yearly/` (confirmed present: 1996-2025)
- Roy's V30 files at `docs/modules/bsee/analysis/production/FDAS_V30/` (confirmed present)
- Python packages: pandas, numpy, openpyxl, pyyaml (all in pyproject.toml)
