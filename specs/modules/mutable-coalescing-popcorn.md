# WRK-313 Phase 4 Implementation Plan
# (WRK-310/311/312 captured by hooks — Phase 4 assigned WRK-313)

## Context

Phases 1–3 of WRK-129 delivered a complete OrcaFlex HTML report framework:
12 Pydantic models, 17 section builders, 5 renderers, `generate_orcaflex_report()`,
82.98% test coverage. Reports can only be generated by manually populating models
from dicts — there is no live data source. Phase 4 adds the OrcFxAPI bridge:
completing missing extractors, wiring them into the CLI, building a mooring adapter,
and delivering 2 example reports from real model data.

## Current State

| Component | Status |
|-----------|--------|
| `extractors/geometry_extractor.py` | ✅ Functional — nodes, static shape, TDP, End A/B |
| `extractors/mesh_extractor.py` | ✅ Functional — segments, quality ratios |
| `extractors/results_extractor.py` | ✅ Functional — static tensions/profiles, RangeGraph envelopes, TimeHistory |
| `extractors/loads_extractor.py` | ❌ Missing |
| `extractors/materials_extractor.py` | ❌ Missing |
| `extractors/boundary_conditions_extractor.py` | ❌ Missing |
| `extractors/mooring_extractor.py` | ❌ Missing (ComprehensiveResults → OrcaFlexAnalysisReport) |
| `universal_cli.py --html-report` flag | ❌ Missing (existing `--report` saves JSON only) |
| Example HTML reports | ❌ Missing (generate_examples.py uses synthetic data only) |

## Plan

### Step 1: Create WRK-313 work item
File: `.claude/work-queue/pending/WRK-313.md`
- Title: "OrcaFlex Reporting Phase 4 — OrcFxAPI Integration"
- Links to: WRK-129, spec: `specs/modules/wrk-129-orcaflex-analysis-reporting.md`

### Step 2: Add 3 missing extractors

**`extractors/loads_extractor.py`** — `extract_loads(model) → EnvironmentData`
- Read `model.environment.WaveHeight`, `WavePeriod`, `CurrentVelocity`, `CurrentDirection`
- Build `LoadCaseData` from the active environment settings
- Return `EnvironmentData(load_cases=[...], current_profile=...)`

**`extractors/materials_extractor.py`** — `extract_materials(line) → MaterialData`
- Read line type properties via `line.OrcaFlexObject.LineTypes` or `line.LineType`
- Build `LineTypeData(name, od, id, wt, density_kg_m3, ...)`
- Return `MaterialData(line_types=[...])`

**`extractors/boundary_conditions_extractor.py`** — `extract_boundary_conditions(line) → BCData`
- Read `line.EndAConnection`, `line.EndBConnection` (fixed/vessel/seabed)
- Read `line.SeabedNormalStiffness`, `line.SeabedShearStiffness`
- Build `BCEndData` and `SeabedModelData`
- Return `BCData(end_a=..., end_b=..., seabed=...)`

Pattern: all three follow the existing `try: import OrcFxAPI as ofx / except ImportError: ofx = None` guard.

### Step 3: Update `extractors/__init__.py`
Add exports: `extract_loads`, `extract_materials`, `extract_boundary_conditions`

### Step 4: Add `--html-report PATH` to `universal_cli.py`

New Click option alongside existing `--report` (JSON) option:
```python
@click.option("--html-report", type=click.Path(), default=None,
              help="Generate structured HTML report to this path")
```

After `runner.run()` completes, if `--html-report` is set:
1. Load the first `.sim` file from `run_results.sim_files_created`
2. Open model: `model = ofx.Model(sim_path)`
3. Find **all Line objects** in model: `lines = [obj for obj in model.objects if obj.type == ofx.ObjectType.Line]`
4. Build a single `OrcaFlexAnalysisReport` aggregating all lines:
   ```python
   # Geometry: primary (longest) line profile
   geometry = extract_geometry(primary_line)

   # Materials: deduplicated line types across all lines
   materials = extract_materials_all_lines(lines)

   # Boundary conditions: End A/B from primary line
   boundary_conditions = extract_boundary_conditions(primary_line)

   # Mesh: aggregate all lines' segments
   mesh = extract_mesh_all_lines(lines)

   # Static results: per_line_tensions dict keyed by line name
   static_results = StaticResultsData(
       per_line_tensions={l.Name: extract_end_tension(l) for l in lines},
       ...extract_static_results(primary_line),
   )

   # Dynamic results: envelopes from ALL lines (each labeled with line name)
   dynamic_results = extract_dynamic_results_all_lines(lines, model)

   # Environment: from model-level settings
   loads = extract_loads(model)
   ```
5. Call `generate_orcaflex_report(report, html_report_path)`
6. Echo path to console

Guard all extractor calls with `try/except` — partial reports are better than failures.
Add helper `extract_*_all_lines()` aggregators to new `extractors/aggregator.py`.

### Step 5: Mooring bridge extractor

**`extractors/mooring_extractor.py`** — `extract_mooring_report(comprehensive_results, ...) → OrcaFlexAnalysisReport`

Maps `ComprehensiveResults` (dataclass from `mooring_analysis/comprehensive_analysis/models.py`) to `OrcaFlexAnalysisReport`:
- `ComprehensiveResults.individual_results` → per-line pretension → `StaticResultsData.per_line_tensions`
- `StiffnessMetrics.natural_periods` → summary notes
- `FenderMetrics.utilization_rates` → `DesignCheckData.checks` (UtilizationData per fender)
- Returns `OrcaFlexAnalysisReport(structure_type="mooring", ...)`

### Step 6: Example reports

Update `examples/solvers/orcaflex/reporting/generate_examples.py`:
- Keep existing synthetic-data examples (SCR riser, pipeline)
- Actually write HTML files to `examples/solvers/orcaflex/reporting/outputs/`
- Commit 2 HTML output files as `riser_example.html` and `pipeline_example.html`

### Step 7: Tests for new extractors

File: `tests/solvers/orcaflex/reporting/test_extractors.py`

Each extractor test uses `unittest.mock.MagicMock()` to mock OrcFxAPI objects:
```python
from unittest.mock import MagicMock, patch

def test_extract_materials():
    mock_line = MagicMock()
    mock_line.LineType = "8in_Pipe"
    # ... mock properties
    with patch('...materials_extractor.ofx', MagicMock()):
        result = extract_materials(mock_line)
    assert isinstance(result, MaterialData)
    assert result.line_types[0].name == "8in_Pipe"
```

Also test: `ImportError` path when `ofx is None` raises cleanly.

### Step 8: Coverage check + legal scan

```bash
cd /d/workspace-hub/digitalmodel
python -m pytest tests/solvers/orcaflex/reporting/ -v \
  --cov=digitalmodel.solvers.orcaflex.reporting \
  --cov-fail-under=80
bash /d/workspace-hub/scripts/legal/legal-sanity-scan.sh
```

### Step 9: Commit + update spec

Commit in `digitalmodel` submodule, update hub pointer.
Update `specs/modules/wrk-129-orcaflex-analysis-reporting.md`:
- Phases 2a, 2b, 3 → ✅ Complete
- Phase 4 → ✅ Complete
- progress: 50% → 100%
- status: "in_progress" → "complete"
Update WRK-313 → `percent_complete: 100`

## Critical Files

| File | Action |
|------|--------|
| `digitalmodel/src/digitalmodel/solvers/orcaflex/reporting/extractors/loads_extractor.py` | Create |
| `digitalmodel/src/digitalmodel/solvers/orcaflex/reporting/extractors/materials_extractor.py` | Create |
| `digitalmodel/src/digitalmodel/solvers/orcaflex/reporting/extractors/boundary_conditions_extractor.py` | Create |
| `digitalmodel/src/digitalmodel/solvers/orcaflex/reporting/extractors/mooring_extractor.py` | Create |
| `digitalmodel/src/digitalmodel/solvers/orcaflex/reporting/extractors/aggregator.py` | Create — multi-line aggregation helpers |
| `digitalmodel/src/digitalmodel/solvers/orcaflex/reporting/extractors/__init__.py` | Expand exports |
| `digitalmodel/src/digitalmodel/solvers/orcaflex/universal_cli.py` | Add `--html-report` flag |
| `digitalmodel/examples/solvers/orcaflex/reporting/generate_examples.py` | Write actual HTML outputs |
| `digitalmodel/tests/solvers/orcaflex/reporting/test_extractors.py` | Create |
| `.claude/work-queue/pending/WRK-313.md` | Create |
| `specs/modules/wrk-129-orcaflex-analysis-reporting.md` | Update progress/status |

## Reuse

| Existing asset | Used for |
|----------------|----------|
| `extractors/geometry_extractor.py:extract_geometry()` | Reference pattern for OrcFxAPI line attribute access |
| `extractors/results_extractor.py:extract_static_results()` | Reference for `StaticResult()` + `RangeGraph()` patterns |
| `core/model_interface.py:MockOrcaFlexModel` | Reference for mock pattern in tests |
| `mooring_analysis/comprehensive_analysis/models.py:ComprehensiveResults` | Input type for mooring_extractor |
| `universal_cli.py` Click app | Add `--html-report` alongside existing `--report` flag |

## Verification

1. `python -m pytest tests/solvers/orcaflex/reporting/ --cov=digitalmodel.solvers.orcaflex.reporting --cov-fail-under=80` — all pass, ≥ 80%
2. `bash /d/workspace-hub/scripts/legal/legal-sanity-scan.sh` — 0 violations
3. `python examples/solvers/orcaflex/reporting/generate_examples.py` — 2 HTML files written to `outputs/`
4. `orcaflex-universal --mock --html-report /tmp/test.html` — HTML file generated from mock run
5. `git diff --stat` in digitalmodel — no source changes to Phases 1–3 files
