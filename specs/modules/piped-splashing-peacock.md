# Plan: Fix Semantic Comparison Using OWD Companion YAMLs

**Title:** fix-semantic-comparison-dormant-qtf
**Module:** digitalmodel / orcawave / L00_validation_wamit
**Version:** 1.0
**Session:** piped-splashing-peacock
**Agent:** claude-sonnet-4-6
**Review:** pending

---

## Context

The L00 validation suite now has OWD companion `.yml` files (generated by
`generate_owd_ymls.py`) sitting next to every `.owd`. Comparing these against
the `benchmark/spec_orcawave/` YAMLs revealed the root cause of the residual
significant semantic diffs in cases 3.1/3.2/3.3.

### Root Cause — Wrong SolveType in Dormant QTF Check

`_compare_orcawave_ymls()` has a "dormant QTF" tier: keys that are only
meaningful when QTF is active are downgraded to cosmetic when QTF is inactive.
The bug: the inactive check reads **OWD's** SolveType:

```python
is_qtf = "qtf" in owd_data.get("SolveType", "").lower()  # BUG: uses OWD
```

Cases 3.2 and 3.3 have OWD = "Full QTF calculation" → `is_qtf = True` →
every QTF-specific key remains **significant**, even though spec uses
"Potential and source formulations" and those keys are completely irrelevant
for comparing first-order RAOs.

**Fix:** Check **spec's** SolveType — when spec is Potential-only, all OWD
QTF keys are dormant regardless of how the OWD was originally configured.

### Key Findings from OWD vs Spec YAML Comparison

| Case | OWD-only keys causing significant diffs | Root |
|------|----------------------------------------|------|
| 3.2 | `QTFMinCrossingAngle/Max`, `QTFMin/MaxPeriodOrFrequency`, `QTFFrequencyTypes`, all `FreeSurface*` zone keys (10 keys) | OWD Full QTF; check uses OWD |
| 3.3 | Same pattern: 8 QTF + FreeSurface keys | OWD Full QTF; check uses OWD |
| 3.1 | `FreeSurfaceOuterCircleNumberOfSegments: 18 vs 0`, `FreeSurfaceAsymptoticZoneExpansionOrder: 10 vs 0` | Both Full QTF, genuinely different but results agree → convention |

### Additional Missing Cosmetic Keys (found in OWD yamls, absent from spec)

| Key | Present in | Should be |
|-----|-----------|-----------|
| `HasResonanceDampingLid` | spec only (No) | cosmetic — OWD default is No, spec makes it explicit |
| `PreferredLoadRAOCalculationMethod` | OWD only (Haskind) | cosmetic — load RAO method preference, doesn't affect diffraction RAOs |
| `FreeSurfacePanelledZoneMeshFileName` | already in DORMANT_QTF | cosmetic unconditionally (filename rename only, e.g. BMC.fdf→val_bmc.fdf) |
| `FreeSurfacePanelledZoneMeshFormat` | already in DORMANT_QTF | cosmetic unconditionally (format tag) |
| `FreeSurfacePanelledZoneMeshLengthUnits` | already in DORMANT_QTF | cosmetic unconditionally (units label) |

### Convention: QTF Discretisation Params When Both Use Full QTF (case 3.1)

When both OWD and spec run Full QTF, differences in discretisation parameters
(`FreeSurfaceOuterCircleNumberOfSegments`, `FreeSurfaceAsymptoticZoneExpansionOrder`,
`FreeSurfaceQuadratureZoneNumberOfAnnuli`) represent different convergence choices
that produce the same result. These should be **convention** (not significant).

### Companion YAML Fallback in `_build_results_from_config()`

Currently Call Site 2 looks only in `benchmark/*_input.yml` for the OWD YAML.
Now that companion yamls exist at `OrcaWave v11.0 files/*.yml`, we can fall back
to them when the benchmark OWD yaml is missing (e.g., before the first full run).

---

## Implementation

### File to modify
`/d/workspace-hub/digitalmodel/scripts/benchmark/validate_owd_vs_spec.py`

---

### Change 1 — Fix dormant QTF check (line ~1323)

```python
# BEFORE (bug: uses OWD's SolveType)
is_qtf = "qtf" in owd_data.get("SolveType", "").lower()

# AFTER (correct: keys are dormant when SPEC doesn't use QTF)
is_qtf = "qtf" in spec_data.get("SolveType", "").lower()
```

Expected effect:
- Case 3.1 (spec = Full QTF): `is_qtf = True` → no change (correct — both use QTF)
- Case 3.2 (spec = Potential): `is_qtf = False` → ~20 dormant keys → cosmetic
- Case 3.3 (spec = Potential): `is_qtf = False` → ~15 dormant keys → cosmetic

---

### Change 2 — Add missing cosmetic keys to `_COSMETIC_KEYS`

Add to the existing `_COSMETIC_KEYS` set:

```python
"HasResonanceDampingLid",           # spec explicit No = OWD default No
"PreferredLoadRAOCalculationMethod", # solver preference, not physics
```

Move these 3 from `_DORMANT_QTF_KEYS` to `_COSMETIC_KEYS` (filename/format
labels — always cosmetic regardless of QTF status):

```python
"FreeSurfacePanelledZoneMeshFileName",
"FreeSurfacePanelledZoneMeshFormat",
"FreeSurfacePanelledZoneMeshLengthUnits",
```

---

### Change 3 — Add convention keys for QTF discretisation

Add to `_CONVENTION_KEYS` (same-physics, different convergence setting):

```python
"FreeSurfaceOuterCircleNumberOfSegments",   # move from DORMANT_QTF
"FreeSurfaceAsymptoticZoneExpansionOrder",  # move from DORMANT_QTF
"FreeSurfaceQuadratureZoneNumberOfAnnuli",  # move from DORMANT_QTF
"FreeSurfaceQuadratureZoneRadiusStep",      # move from DORMANT_QTF
"FreeSurfaceQuadratureZoneNumberOfRadialNodes",    # move from DORMANT_QTF
"FreeSurfaceQuadratureZoneNumberOfAzimuthalNodes", # move from DORMANT_QTF
"FreeSurfaceQuadratureZoneInnerRadius",     # move from DORMANT_QTF (if present)
"FreeSurfacePanelledZoneType",              # move from DORMANT_QTF
"FreeSurfacePanelledZoneInnerRadius",       # move from DORMANT_QTF
```

Rationale: these parameters control discretisation accuracy, not physics. When
they differ (OWD uses fine grid, spec uses 0/default), the solver still produces
the same first-order RAOs → convention, not significant.

> Note: after Change 1, most of these are already handled as dormant when spec
> is Potential-only. Moving them to CONVENTION ensures they're also handled
> correctly when both files use Full QTF (case 3.1).

---

### Change 4 — Companion YAML fallback in `_build_results_from_config()`

At Call Site 2 (around line 1606), after the existing `owd_ymls = sorted(...)`:

```python
owd_ymls = sorted(benchmark_dir.glob("*_input.yml"))
# NEW: fall back to companion yml next to the .owd if benchmark yml absent
if not owd_ymls and case_key in CASES:
    owd_path = CASES[case_key].get("owd")
    if owd_path:
        companion = owd_path.with_suffix(".yml")
        if companion.exists():
            owd_ymls = [companion]
```

---

## Critical Files

| File | Change |
|------|--------|
| `scripts/benchmark/validate_owd_vs_spec.py` line ~1323 | Fix dormant QTF check: OWD→spec SolveType |
| `scripts/benchmark/validate_owd_vs_spec.py` `_COSMETIC_KEYS` (~line 1182) | Add `HasResonanceDampingLid`, `PreferredLoadRAOCalculationMethod`; receive 3 moved from DORMANT_QTF |
| `scripts/benchmark/validate_owd_vs_spec.py` `_CONVENTION_KEYS` (~line 1256) | Add 9 FreeSurface discretisation params (moved from DORMANT_QTF) |
| `scripts/benchmark/validate_owd_vs_spec.py` `_DORMANT_QTF_KEYS` (~line 1223) | Remove 12 keys promoted to COSMETIC or CONVENTION |
| `scripts/benchmark/validate_owd_vs_spec.py` `_build_results_from_config()` ~line 1606 | Add companion yml fallback |

Reference OWD companion YAMLs used in investigation:
- `3.1/OrcaWave v11.0 files/Bottom mounted cylinder.yml`
- `3.2/OrcaWave v11.0 files/Sphere.yml`
- `3.3/OrcaWave v11.0 files/test.yml`

---

## Expected Outcomes

| Case | Current significant | Expected after fix |
|------|--------|-------------------|
| 3.1 | 3 | 0–1 (FreeSurface discretisation → convention) |
| 3.2 | 23 | 1–2 (WaterDepth if still diff; BodyMeshFileName is cosmetic) |
| 3.3 | 18 | 2–4 (body-level diffs if any remain; HasResonanceDampingLid → cosmetic) |

---

## Verification

```bash
cd /d/workspace-hub/digitalmodel

# Re-run cases 3.1, 3.2, 3.3 with updated comparison logic
uv run python scripts/benchmark/validate_owd_vs_spec.py --case 3.1
uv run python scripts/benchmark/validate_owd_vs_spec.py --case 3.2
uv run python scripts/benchmark/validate_owd_vs_spec.py --case 3.3

# Expect: significant diffs reduced per table above
# All cases still PASS (r=1.0000)

# Regenerate master HTML
uv run python scripts/benchmark/validate_owd_vs_spec.py --all
```

Success criteria:
- Case 3.2 significant diffs ≤ 2
- Case 3.3 significant diffs ≤ 4
- Case 3.1 significant diffs = 0
- All 13 cases still PASS
- `validation_summary.html` shows EQUIV or near-EQUIV for 3.1/3.2/3.3
