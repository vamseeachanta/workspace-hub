name: Baseline Testing

on:
  push:
    branches:
      - main
      - 'feature/**'
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - commit
          - task

env:
  PYTHON_VERSION: '3.12'
  COVERAGE_THRESHOLD: '80'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install test dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-mock pytest-json-report

      - name: Install project dependencies
        run: |
          # Install dependencies for key submodules
          for sub in worldenergydata digitalmodel assetutilities; do
            if [ -f "${sub}/pyproject.toml" ]; then
              echo "Installing dependencies for ${sub}..."
              pip install -e "${sub}" || echo "Warning: Failed to install ${sub}"
            fi
          done

      - name: Run test suite
        id: test
        run: |
          TEST_SUITE="${{ github.event.inputs.test_suite || 'all' }}"

          echo "Running test suite: ${TEST_SUITE}"

          case "${TEST_SUITE}" in
            commit)
              if [ -x scripts/test/test-commit.sh ]; then
                ./scripts/test/test-commit.sh --all
              else
                echo "test-commit.sh not found, running default tests"
                python3 -m pytest --tb=short -v --maxfail=10
              fi
              ;;
            task)
              if [ -x scripts/test/test-task.sh ]; then
                ./scripts/test/test-task.sh
              else
                echo "test-task.sh not found, running default tests"
                python3 -m pytest --tb=short -v
              fi
              ;;
            all)
              if [ -x scripts/test/test-session.sh ]; then
                ./scripts/test/test-session.sh
              else
                echo "test-session.sh not found, running all tests"
                python3 -m pytest --tb=short -v --cov --cov-report=xml --cov-report=term
              fi
              ;;
          esac

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ github.run_id }}
          path: |
            coverage.xml
            .coverage
            htmlcov/
          retention-days: 30

      - name: Generate test summary
        if: always()
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test Suite:** ${{ github.event.inputs.test_suite || 'all' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Python Version:** ${{ env.PYTHON_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f coverage.xml ]; then
            echo "Coverage report generated successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "No coverage report available" >> $GITHUB_STEP_SUMMARY
          fi

  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install linting tools
        run: |
          pip install ruff black isort mypy || true

      - name: Run linters
        continue-on-error: true
        run: |
          echo "## Code Quality Checks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Run ruff if available
          if command -v ruff &> /dev/null; then
            echo "Running ruff..." >> $GITHUB_STEP_SUMMARY
            ruff check . --output-format=github || echo "Ruff found issues" >> $GITHUB_STEP_SUMMARY
          fi

          # Run black check if available
          if command -v black &> /dev/null; then
            echo "Running black..." >> $GITHUB_STEP_SUMMARY
            black --check --diff . || echo "Black formatting issues" >> $GITHUB_STEP_SUMMARY
          fi
