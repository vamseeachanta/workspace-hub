#!/bin/bash
# ABOUTME: O&G Standards System Status Monitor
# ABOUTME: Shows extraction, embedding, and search status at a glance

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DB_PATH="/mnt/ace/O&G-Standards/_inventory.db"

# Colors
BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

print_header() {
    echo -e "\n${BLUE}${BOLD}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${BLUE}${BOLD}       O&G STANDARDS KNOWLEDGE SYSTEM STATUS${NC}"
    echo -e "${BLUE}${BOLD}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
}

check_database() {
    if [ ! -f "$DB_PATH" ]; then
        echo -e "${RED}âœ— Database not found at $DB_PATH${NC}"
        return 1
    fi
    return 0
}

get_stats() {
    if ! check_database; then
        return 1
    fi

    # Get document stats using Python (more portable than sqlite3 CLI)
    STATS=$(python3 -c "
import sqlite3
conn = sqlite3.connect('$DB_PATH')
docs = conn.execute('SELECT COUNT(*) FROM documents').fetchone()[0]
extracted = conn.execute('SELECT COUNT(DISTINCT document_id) FROM text_chunks').fetchone()[0]
chunks = conn.execute('SELECT COUNT(*) FROM text_chunks').fetchone()[0]
embedded = conn.execute('SELECT COUNT(*) FROM text_chunks WHERE embedding IS NOT NULL').fetchone()[0]
print(f'{docs},{extracted},{chunks},{embedded}')
" 2>/dev/null || echo "0,0,0,0")

    TOTAL_DOCS=$(echo "$STATS" | cut -d',' -f1)
    EXTRACTED=$(echo "$STATS" | cut -d',' -f2)
    TOTAL_CHUNKS=$(echo "$STATS" | cut -d',' -f3)
    EMBEDDED=$(echo "$STATS" | cut -d',' -f4)

    # Calculate percentages
    if [ "$TOTAL_DOCS" -gt 0 ]; then
        EXTRACT_PCT=$((EXTRACTED * 100 / TOTAL_DOCS))
    else
        EXTRACT_PCT=0
    fi

    if [ "$TOTAL_CHUNKS" -gt 0 ]; then
        EMBED_PCT=$((EMBEDDED * 100 / TOTAL_CHUNKS))
    else
        EMBED_PCT=0
    fi

    echo -e "${CYAN}${BOLD}ğŸ“Š Database Statistics${NC}"
    echo -e "   Total PDFs:     ${BOLD}$(printf "%'d" $TOTAL_DOCS)${NC}"
    echo -e "   Extracted:      ${BOLD}$(printf "%'d" $EXTRACTED)${NC} (${EXTRACT_PCT}%)"
    echo -e "   Total Chunks:   ${BOLD}$(printf "%'d" $TOTAL_CHUNKS)${NC}"
    echo -e "   Embedded:       ${BOLD}$(printf "%'d" $EMBEDDED)${NC} (${EMBED_PCT}%)"
    echo ""
}

check_processes() {
    echo -e "${CYAN}${BOLD}âš™ï¸  Background Processes${NC}"

    # Check extraction
    EXTRACT_PID=$(pgrep -f "extract.py" 2>/dev/null | head -1)
    if [ -n "$EXTRACT_PID" ]; then
        echo -e "   Extraction:  ${GREEN}â—${NC} Running (PID: $EXTRACT_PID)"
    else
        echo -e "   Extraction:  ${YELLOW}â—‹${NC} Not running"
    fi

    # Check embedding
    EMBED_PID=$(pgrep -f "embed.py" 2>/dev/null | head -1)
    if [ -n "$EMBED_PID" ]; then
        echo -e "   Embedding:   ${GREEN}â—${NC} Running (PID: $EMBED_PID)"
    else
        echo -e "   Embedding:   ${YELLOW}â—‹${NC} Not running"
    fi
    echo ""
}

check_api_keys() {
    echo -e "${CYAN}${BOLD}ğŸ”‘ API Configuration${NC}"

    if [ -n "$ANTHROPIC_API_KEY" ]; then
        echo -e "   Claude API:  ${GREEN}âœ“${NC} Configured"
    else
        echo -e "   Claude API:  ${RED}âœ—${NC} Not set (export ANTHROPIC_API_KEY=...)"
    fi

    if [ -n "$OPENAI_API_KEY" ]; then
        echo -e "   OpenAI API:  ${GREEN}âœ“${NC} Configured"
    else
        echo -e "   OpenAI API:  ${YELLOW}â—‹${NC} Not set (optional)"
    fi
    echo ""
}

show_commands() {
    echo -e "${CYAN}${BOLD}ğŸ“‹ Available Commands${NC}"
    echo -e "   ${BOLD}og${NC} <query>           Quick keyword search"
    echo -e "   ${BOLD}og -i${NC}                Interactive search mode"
    echo -e "   ${BOLD}og-rag${NC} <question>    AI-powered Q&A (requires API key)"
    echo -e "   ${BOLD}og-rag -i${NC}            Interactive AI assistant"
    echo -e "   ${BOLD}og-status${NC}            Show this status"
    echo ""
}

show_recent_activity() {
    echo -e "${CYAN}${BOLD}ğŸ“ˆ Recent Activity${NC}"

    # Show last extraction log entry
    if [ -f /tmp/extract.log ]; then
        LAST_EXTRACT=$(tail -1 /tmp/extract.log 2>/dev/null | head -c 80)
        echo -e "   Last extraction: ${LAST_EXTRACT}..."
    fi

    # Show last embedding log entry
    if [ -f /tmp/embed.log ]; then
        LAST_EMBED=$(tail -1 /tmp/embed.log 2>/dev/null | head -c 80)
        echo -e "   Last embedding:  ${LAST_EMBED}..."
    fi
    echo ""
}

# Main
print_header
get_stats
check_processes
check_api_keys
show_commands
show_recent_activity

echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "   Standards Library: ${BOLD}/mnt/ace/O&G-Standards/${NC}"
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
