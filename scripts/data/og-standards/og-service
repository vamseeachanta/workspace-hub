#!/bin/bash
# ABOUTME: O&G Standards Service Manager
# ABOUTME: Start/stop/manage extraction and embedding processes

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# Force CPU mode for embeddings
export CUDA_VISIBLE_DEVICES=""

usage() {
    echo "O&G Standards Service Manager"
    echo ""
    echo "Usage: og-service <command>"
    echo ""
    echo "Commands:"
    echo "  start-extract    Start PDF text extraction"
    echo "  start-embed      Start vector embedding generation"
    echo "  start-all        Start both extraction and embedding"
    echo "  stop-extract     Stop extraction process"
    echo "  stop-embed       Stop embedding process"
    echo "  stop-all         Stop all processes"
    echo "  restart          Restart all processes"
    echo "  status           Show process status"
    echo "  logs             Tail all log files"
    echo ""
}

start_extract() {
    EXTRACT_PID=$(pgrep -f "extract.py" 2>/dev/null | head -1)
    if [ -n "$EXTRACT_PID" ]; then
        echo -e "${YELLOW}Extraction already running (PID: $EXTRACT_PID)${NC}"
        return 0
    fi

    echo -e "${GREEN}Starting extraction...${NC}"
    cd "$SCRIPT_DIR"
    nohup python extract.py --workers 4 > /tmp/extract.log 2>&1 &
    sleep 1
    NEW_PID=$(pgrep -f "extract.py" 2>/dev/null | head -1)
    if [ -n "$NEW_PID" ]; then
        echo -e "${GREEN}✓ Extraction started (PID: $NEW_PID)${NC}"
    else
        echo -e "${RED}✗ Failed to start extraction${NC}"
        return 1
    fi
}

start_embed() {
    EMBED_PID=$(pgrep -f "embed.py" 2>/dev/null | head -1)
    if [ -n "$EMBED_PID" ]; then
        echo -e "${YELLOW}Embedding already running (PID: $EMBED_PID)${NC}"
        return 0
    fi

    echo -e "${GREEN}Starting embedding (CPU mode)...${NC}"
    cd "$SCRIPT_DIR"
    nohup python embed.py --model local --batch-size 100 > /tmp/embed.log 2>&1 &
    sleep 2
    NEW_PID=$(pgrep -f "embed.py" 2>/dev/null | head -1)
    if [ -n "$NEW_PID" ]; then
        echo -e "${GREEN}✓ Embedding started (PID: $NEW_PID)${NC}"
    else
        echo -e "${RED}✗ Failed to start embedding${NC}"
        return 1
    fi
}

stop_extract() {
    EXTRACT_PID=$(pgrep -f "extract.py" 2>/dev/null | head -1)
    if [ -z "$EXTRACT_PID" ]; then
        echo -e "${YELLOW}Extraction not running${NC}"
        return 0
    fi

    echo -e "${YELLOW}Stopping extraction (PID: $EXTRACT_PID)...${NC}"
    kill $EXTRACT_PID 2>/dev/null
    sleep 1
    if pgrep -f "extract.py" > /dev/null 2>&1; then
        kill -9 $(pgrep -f "extract.py") 2>/dev/null
    fi
    echo -e "${GREEN}✓ Extraction stopped${NC}"
}

stop_embed() {
    EMBED_PID=$(pgrep -f "embed.py" 2>/dev/null | head -1)
    if [ -z "$EMBED_PID" ]; then
        echo -e "${YELLOW}Embedding not running${NC}"
        return 0
    fi

    echo -e "${YELLOW}Stopping embedding (PID: $EMBED_PID)...${NC}"
    kill $EMBED_PID 2>/dev/null
    sleep 1
    if pgrep -f "embed.py" > /dev/null 2>&1; then
        kill -9 $(pgrep -f "embed.py") 2>/dev/null
    fi
    echo -e "${GREEN}✓ Embedding stopped${NC}"
}

show_status() {
    echo "Process Status:"
    echo ""

    EXTRACT_PID=$(pgrep -f "extract.py" 2>/dev/null | head -1)
    if [ -n "$EXTRACT_PID" ]; then
        echo -e "  Extraction: ${GREEN}● Running${NC} (PID: $EXTRACT_PID)"
    else
        echo -e "  Extraction: ${RED}○ Stopped${NC}"
    fi

    EMBED_PID=$(pgrep -f "embed.py" 2>/dev/null | head -1)
    if [ -n "$EMBED_PID" ]; then
        echo -e "  Embedding:  ${GREEN}● Running${NC} (PID: $EMBED_PID)"
    else
        echo -e "  Embedding:  ${RED}○ Stopped${NC}"
    fi
    echo ""
}

tail_logs() {
    echo "=== Tailing logs (Ctrl+C to stop) ==="
    echo ""
    tail -f /tmp/extract.log /tmp/embed.log 2>/dev/null
}

case "$1" in
    start-extract)
        start_extract
        ;;
    start-embed)
        start_embed
        ;;
    start-all)
        start_extract
        start_embed
        ;;
    stop-extract)
        stop_extract
        ;;
    stop-embed)
        stop_embed
        ;;
    stop-all)
        stop_extract
        stop_embed
        ;;
    restart)
        stop_extract
        stop_embed
        sleep 2
        start_extract
        start_embed
        ;;
    status)
        show_status
        ;;
    logs)
        tail_logs
        ;;
    *)
        usage
        ;;
esac
