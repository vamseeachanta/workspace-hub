#!/bin/bash

# ABOUTME: Git post-commit hook to trigger Gemini review for ALL commits
# ABOUTME: Automatically queues new commits for review

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Configuration - Detect workspace-hub root
if [ -n "$WORKSPACE_HUB" ]; then
    # Use environment variable if set
    WORKSPACE_HUB="$WORKSPACE_HUB"
else
    # Try to find workspace-hub from git repo
    CURRENT_REPO=$(git rev-parse --show-toplevel 2>/dev/null || echo "")
    
    if [ -n "$CURRENT_REPO" ]; then
        PARENT_DIR="$(dirname "$CURRENT_REPO")"
        if [ -f "$PARENT_DIR/CLAUDE.md" ] && [ -d "$PARENT_DIR/scripts/ai-review" ]; then
            WORKSPACE_HUB="$PARENT_DIR"
        elif [ -f "$CURRENT_REPO/CLAUDE.md" ] && [ -d "$CURRENT_REPO/scripts/ai-review" ]; then
            WORKSPACE_HUB="$CURRENT_REPO"
        fi
    fi
    
    if [ -z "$WORKSPACE_HUB" ]; then
        SEARCH_DIR="$(pwd)"
        while [ "$SEARCH_DIR" != "/" ] && [ "$SEARCH_DIR" != "" ]; do
            if [ -f "$SEARCH_DIR/CLAUDE.md" ] && [ -d "$SEARCH_DIR/scripts/ai-review" ]; then
                WORKSPACE_HUB="$SEARCH_DIR"
                break
            fi
            SEARCH_DIR="$(dirname "$SEARCH_DIR")"
        done
    fi
fi

GEMINI_REVIEW_SCRIPT="$WORKSPACE_HUB/scripts/ai-review/gemini-review.sh"

# Get repository info
REPO_ROOT=$(git rev-parse --show-toplevel)
REPO_NAME=$(basename "$REPO_ROOT")
COMMIT_SHA=$(git rev-parse HEAD)
SHORT_SHA=$(git rev-parse --short HEAD)

# Main logic
echo ""
echo -e "${BLUE}ðŸ” Post-commit hook: Triggering Gemini Review...${NC}"

# Check if review script exists
if [ ! -f "$GEMINI_REVIEW_SCRIPT" ]; then
    echo -e "${YELLOW}âš  Gemini review script not found: $GEMINI_REVIEW_SCRIPT${NC}"
    exit 0
fi

# Run review in background
(
    # Small delay to ensure git is fully done
    sleep 1

    # Run the review
    # We redirect output to avoid messing up the terminal after git commit returns
    bash "$GEMINI_REVIEW_SCRIPT" -r "$REPO_ROOT" HEAD > /dev/null 2>&1
) &

echo -e "${GREEN}âœ“ Gemini Review Queued!${NC}"
echo -e "${CYAN}Repository:${NC} $REPO_NAME"
echo -e "${CYAN}Commit:${NC}     $SHORT_SHA"
echo ""
echo -e "${YELLOW}Check pending reviews with:${NC}"
echo "  $WORKSPACE_HUB/scripts/ai-review/gemini-review-manager.sh list"
echo ""

exit 0
