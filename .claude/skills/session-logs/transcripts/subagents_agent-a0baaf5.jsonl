{"ts":"2026-01-26T20:47:21.138Z","role":"ai","text":"I'll design a comprehensive implementation plan for the BEMRosetta integration module. Let me first explore the existing codebase to understand the patterns, data models, and integration points.","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:47:21.520Z","role":"ai","text":"[tool:Glob]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:47:21.883Z","role":"ai","text":"[tool:Glob]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:47:22.244Z","role":"ai","text":"[tool:Glob]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:47:40.778Z","role":"human","text":"[result]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:47:41.912Z","role":"human","text":"[result]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:47:42.104Z","role":"human","text":"[result]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:47:47.075Z","role":"ai","text":"Let me explore the existing hydrodynamics models and interface patterns.","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:47:47.497Z","role":"ai","text":"[tool:Read]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:47:48.057Z","role":"ai","text":"[tool:Read]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:47:48.392Z","role":"ai","text":"[tool:Glob]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:48:06.874Z","role":"human","text":"[result]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:48:06.877Z","role":"human","text":"[result]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:48:06.874Z","role":"human","text":"[result]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:48:14.314Z","role":"ai","text":"Excellent. Let me explore more of the hydrodynamics module structure and the AQWA module for parser patterns.","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:48:14.758Z","role":"ai","text":"[tool:Read]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:48:15.266Z","role":"ai","text":"[tool:Read]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:48:15.717Z","role":"ai","text":"[tool:Read]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:48:23.217Z","role":"human","text":"[result]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:48:34.308Z","role":"human","text":"[result]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:48:34.308Z","role":"human","text":"[result]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:48:42.395Z","role":"ai","text":"Now let me look at more module structures including CLI patterns and test organization.","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:48:43.134Z","role":"ai","text":"[tool:Read]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:48:43.674Z","role":"ai","text":"[tool:Glob]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:48:44.011Z","role":"ai","text":"[tool:Glob]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:49:02.452Z","role":"human","text":"[result]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:49:02.552Z","role":"human","text":"[result]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:49:03.517Z","role":"human","text":"[result]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:49:10.746Z","role":"ai","text":"Now let me explore the diffraction module since it's the most relevant for BEM conversion, and check pyproject.toml for CLI registration patterns.","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:49:11.237Z","role":"ai","text":"[tool:Glob]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:49:12.168Z","role":"ai","text":"[tool:Grep]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:49:12.654Z","role":"ai","text":"[tool:Read]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:49:30.751Z","role":"human","text":"[result]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:49:30.920Z","role":"human","text":"[result]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:49:31.783Z","role":"human","text":"[result]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:49:37.520Z","role":"ai","text":"Let me examine the diffraction module's structure, particularly the converters and CLI patterns.","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:49:38.329Z","role":"ai","text":"[tool:Read]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:49:38.864Z","role":"ai","text":"[tool:Read]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:49:39.394Z","role":"ai","text":"[tool:Read]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:49:47.241Z","role":"human","text":"[result]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:49:58.756Z","role":"human","text":"[result]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:49:58.756Z","role":"human","text":"[result]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:50:07.573Z","role":"ai","text":"Excellent. Let me also check the existing BEMRosetta documentation and libbemrosetta.py interface, plus look at test patterns.","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:50:08.570Z","role":"ai","text":"[tool:Read]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:50:09.080Z","role":"ai","text":"[tool:Glob]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:50:09.618Z","role":"ai","text":"[tool:Read]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:50:28.524Z","role":"human","text":"[result]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:50:28.527Z","role":"human","text":"[result]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:50:28.524Z","role":"human","text":"[result]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:50:37.070Z","role":"ai","text":"Let me check one more test file to understand the testing patterns, and also look at the diffraction CLI for command structure.","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:50:37.698Z","role":"ai","text":"[tool:Read]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:50:38.139Z","role":"ai","text":"[tool:Read]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:50:45.243Z","role":"human","text":"[result]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:50:50.808Z","role":"human","text":"[result]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:50:58.303Z","role":"ai","text":"Now let me check the BEMRosetta software location and any existing documentation about from_aqwa_to_orcawave conversion.","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:50:59.369Z","role":"ai","text":"[tool:Bash]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:51:00.642Z","role":"ai","text":"[tool:Read]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:51:12.150Z","role":"human","text":"[result]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:51:12.174Z","role":"human","text":"[result]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:51:18.276Z","role":"ai","text":"Let me also read the libbemrosetta.py to understand the Python interface and look at exception patterns used in the project.","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:51:18.791Z","role":"ai","text":"[tool:Read]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:51:19.296Z","role":"ai","text":"[tool:Glob]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:51:38.509Z","role":"human","text":"[result]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:51:38.511Z","role":"human","text":"[result]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:51:45.084Z","role":"ai","text":"[tool:Read]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:51:51.362Z","role":"human","text":"[result]","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
{"ts":"2026-01-26T20:53:39.375Z","role":"ai","text":"I now have a comprehensive understanding of the codebase patterns. Let me provide the detailed implementation plan for the BEMRosetta integration module.\n\n---\n\n# BEMRosetta Integration Module - Implementation Plan\n\n## Executive Summary\n\nThis plan details the design for a BEMRosetta integration module that will provide a unified interface for converting hydrodynamic coefficients between BEM solver formats (WAMIT, AQWA, OrcaWave, Nemoh, Capytaine, HAMS, Hydrostar, Diodore) and exporting to OrcaFlex-compatible formats. The module will leverage both the BEMRosetta command-line executable and integrate with existing digitalmodel diffraction/hydrodynamics modules.\n\n---\n\n## 1. Module Architecture\n\n### 1.1 Directory Structure\n\n```\nsrc/digitalmodel/modules/bemrosetta/\n|-- __init__.py                    # Graceful imports, feature detection, public API\n|-- cli.py                         # Click-based CLI commands\n|-- models.py                      # Pydantic/dataclass data models\n|-- core/\n|   |-- __init__.py\n|   |-- interfaces.py              # Abstract base classes (ParserInterface, ConverterInterface)\n|   |-- exceptions.py              # BEMRosetta-specific exceptions\n|   |-- runner.py                  # BEMRosetta executable wrapper\n|   |-- config.py                  # Configuration management\n|-- parsers/\n|   |-- __init__.py\n|   |-- base.py                    # Base parser class\n|   |-- wamit_parser.py            # WAMIT .out, .1, .3, etc.\n|   |-- aqwa_parser.py             # AQWA .LIS, .DAT\n|   |-- nemoh_parser.py            # Nemoh format\n|   |-- hams_parser.py             # HAMS .pnl format\n|   |-- capytaine_parser.py        # Capytaine .nc format\n|   |-- hydrostar_parser.py        # Hydrostar format\n|   |-- diodore_parser.py          # Diodore format\n|-- converters/\n|   |-- __init__.py\n|   |-- base.py                    # Base converter class\n|   |-- to_wamit.py                # Convert to WAMIT format\n|   |-- to_orcaflex.py             # Convert to OrcaFlex YAML\n|   |-- to_hams.py                 # Convert to HAMS format\n|   |-- to_openfast.py             # Convert to OpenFAST-WAMIT\n|   |-- to_bemio.py                # Convert to Bemio HDF5\n|-- mesh/\n|   |-- __init__.py\n|   |-- mesh_handler.py            # Panel mesh operations\n|   |-- gdf_handler.py             # WAMIT GDF format\n|   |-- dat_handler.py             # AQWA/Nemoh DAT format\n|   |-- stl_handler.py             # STL mesh support\n|   |-- gmsh_handler.py            # GMSH mesh support\n|   |-- pnl_handler.py             # HAMS PNL format\n|-- validators/\n|   |-- __init__.py\n|   |-- coefficient_validator.py   # Validate hydrodynamic coefficients\n|   |-- causality_checker.py       # Kramers-Kronig relations\n|   |-- symmetry_checker.py        # Matrix symmetry validation\n|-- visualization/\n|   |-- __init__.py\n|   |-- rao_plots.py               # RAO visualization\n|   |-- coefficient_plots.py       # Added mass/damping plots\n|   |-- mesh_viewer.py             # Panel mesh visualization\n|-- MODULE_README.md               # Module documentation\n```\n\n### 1.2 Data Flow Diagram\n\n```\n                                    +-------------------+\n                                    |  BEMRosetta_cl    |\n                                    |  (Subprocess)     |\n                                    +--------+----------+\n                                             |\n+------------------+                         v                    +------------------+\n|  Input Formats   |    +------------+  +------------+           |  Output Formats  |\n|  - WAMIT         |--->|  Parsers   |->|  Unified   |---------->|  - WAMIT         |\n|  - AQWA          |    +------------+  |  Schema    |           |  - OrcaFlex YAML |\n|  - OrcaWave      |                    |            |           |  - HAMS          |\n|  - Nemoh         |                    | (RAOData,  |           |  - OpenFAST      |\n|  - Capytaine     |                    |  Matrices) |           |  - Bemio HDF5    |\n|  - HAMS          |                    +------+-----+           +------------------+\n|  - Hydrostar     |                           |\n|  - Diodore       |                           v\n+------------------+                    +------------+\n                                        | Validators |\n                                        | - Symmetry |\n                                        | - Causality|\n                                        | - Limits   |\n                                        +------------+\n                                               |\n                                               v\n                                        +------------+\n                                        | Converters |\n                                        +------------+\n                                               |\n                                               v\n                                +---------------------------+\n                                | Integration Points        |\n                                | - diffraction module      |\n                                | - hydrodynamics module    |\n                                | - OrcaFlex workflow       |\n                                +---------------------------+\n```\n\n---\n\n## 2. Core Components\n\n### 2.1 Data Models (`models.py`)\n\nThe module will reuse and extend existing models from the hydrodynamics and diffraction modules:\n\n```python\n# Reuse from hydrodynamics module:\n# - HydrodynamicMatrix\n# - RAOData\n# - VesselProperties\n# - WaveParameters\n\n# Reuse from diffraction module:\n# - DiffractionResults\n# - RAOSet, AddedMassSet, DampingSet\n# - FrequencyData, HeadingData\n# - DOF enum\n\n# New models specific to BEMRosetta:\n\n@dataclass\nclass BEMSolverMetadata:\n    \"\"\"Metadata from BEM solver output\"\"\"\n    solver_name: str                    # WAMIT, AQWA, Nemoh, etc.\n    solver_version: Optional[str]\n    analysis_date: Optional[str]\n    water_depth: float\n    vessel_name: str\n    body_count: int\n    frequency_count: int\n    heading_count: int\n    includes_qtf: bool\n    coordinate_system: str              # \"global\" or \"body-fixed\"\n\n@dataclass\nclass QTFData:\n    \"\"\"Quadratic Transfer Function data (second-order forces)\"\"\"\n    frequencies_1: np.ndarray           # First frequency array\n    frequencies_2: np.ndarray           # Second frequency array (for difference freq)\n    headings: np.ndarray\n    qtf_coefficients: np.ndarray        # Complex QTF values [n_freq1 x n_freq2 x n_head x 6]\n    qtf_type: str                       # \"sum\" or \"difference\"\n\n@dataclass  \nclass ExcitingForceData:\n    \"\"\"Wave exciting force coefficients\"\"\"\n    frequencies: np.ndarray\n    headings: np.ndarray\n    magnitude: np.ndarray               # [n_freq x n_heading x 6]\n    phase: np.ndarray                   # [n_freq x n_heading x 6]\n    force_type: str                     # \"Froude-Krylov\", \"diffraction\", or \"total\"\n\n@dataclass\nclass PanelMesh:\n    \"\"\"Panel mesh data for diffraction analysis\"\"\"\n    vertices: np.ndarray                # [n_vertices x 3]\n    panels: np.ndarray                  # [n_panels x 4] (quad panels)\n    panel_centers: np.ndarray           # [n_panels x 3]\n    panel_normals: np.ndarray           # [n_panels x 3]\n    panel_areas: np.ndarray             # [n_panels]\n    is_symmetric: bool                  # Half-body with symmetry\n    \n@dataclass\nclass BEMRosettaConfig:\n    \"\"\"Configuration for BEMRosetta operations\"\"\"\n    executable_path: Path\n    working_directory: Path\n    input_format: str\n    output_format: str\n    water_depth: float\n    frequencies: Optional[List[float]]\n    headings: Optional[List[float]]\n    include_qtf: bool = False\n    verbosity: int = 1\n```\n\n### 2.2 Core Interfaces (`core/interfaces.py`)\n\n```python\nfrom abc import ABC, abstractmethod\nfrom typing import Dict, Any, Optional, List\nfrom pathlib import Path\n\nclass ParserInterface(ABC):\n    \"\"\"Interface for BEM solver output parsers\"\"\"\n    \n    @property\n    @abstractmethod\n    def supported_extensions(self) -> List[str]:\n        \"\"\"File extensions this parser handles\"\"\"\n        pass\n    \n    @property\n    @abstractmethod\n    def solver_name(self) -> str:\n        \"\"\"Name of the BEM solver\"\"\"\n        pass\n    \n    @abstractmethod\n    def parse(self, file_path: Path) -> DiffractionResults:\n        \"\"\"Parse solver output to unified schema\"\"\"\n        pass\n    \n    @abstractmethod\n    def validate_file(self, file_path: Path) -> bool:\n        \"\"\"Check if file is valid for this parser\"\"\"\n        pass\n    \n    @abstractmethod\n    def extract_metadata(self, file_path: Path) -> BEMSolverMetadata:\n        \"\"\"Extract solver metadata without full parsing\"\"\"\n        pass\n\n\nclass ConverterInterface(ABC):\n    \"\"\"Interface for format converters\"\"\"\n    \n    @property\n    @abstractmethod\n    def output_format(self) -> str:\n        \"\"\"Target output format name\"\"\"\n        pass\n    \n    @abstractmethod\n    def convert(self, results: DiffractionResults, output_path: Path) -> Path:\n        \"\"\"Convert results to target format\"\"\"\n        pass\n    \n    @abstractmethod\n    def validate_output(self, output_path: Path) -> bool:\n        \"\"\"Validate generated output file\"\"\"\n        pass\n\n\nclass MeshHandlerInterface(ABC):\n    \"\"\"Interface for panel mesh handlers\"\"\"\n    \n    @property\n    @abstractmethod\n    def mesh_format(self) -> str:\n        \"\"\"Mesh format name\"\"\"\n        pass\n    \n    @abstractmethod\n    def read(self, file_path: Path) -> PanelMesh:\n        \"\"\"Read mesh from file\"\"\"\n        pass\n    \n    @abstractmethod\n    def write(self, mesh: PanelMesh, file_path: Path) -> Path:\n        \"\"\"Write mesh to file\"\"\"\n        pass\n    \n    @abstractmethod\n    def validate(self, mesh: PanelMesh) -> List[str]:\n        \"\"\"Validate mesh quality, return issues\"\"\"\n        pass\n```\n\n### 2.3 BEMRosetta Runner (`core/runner.py`)\n\n```python\nclass BEMRosettaRunner:\n    \"\"\"\n    Wrapper for BEMRosetta command-line executable\n    \n    Provides Python interface to BEMRosetta_cl.exe for:\n    - Format conversion\n    - Mesh manipulation\n    - Batch processing\n    \"\"\"\n    \n    def __init__(\n        self,\n        executable_path: Optional[Path] = None,\n        working_directory: Optional[Path] = None\n    ):\n        \"\"\"\n        Initialize runner\n        \n        Args:\n            executable_path: Path to BEMRosetta_cl.exe\n                            Default: D:/software/BEMRosetta/BEMRosetta_cl.exe\n            working_directory: Working directory for operations\n        \"\"\"\n        ...\n    \n    def convert(\n        self,\n        input_file: Path,\n        output_format: str,\n        output_dir: Path,\n        **options\n    ) -> Path:\n        \"\"\"\n        Convert between BEM formats\n        \n        Args:\n            input_file: Input file path\n            output_format: Target format (wamit, orcawave, hams, etc.)\n            output_dir: Output directory\n            **options: Additional conversion options\n            \n        Returns:\n            Path to converted file\n        \"\"\"\n        ...\n    \n    def convert_mesh(\n        self,\n        input_mesh: Path,\n        output_format: str,\n        output_path: Path\n    ) -> Path:\n        \"\"\"Convert mesh between formats (GDF, DAT, STL, etc.)\"\"\"\n        ...\n    \n    def get_info(self, input_file: Path) -> BEMSolverMetadata:\n        \"\"\"Extract information from BEM file without full conversion\"\"\"\n        ...\n    \n    def batch_convert(\n        self,\n        config: BatchConversionConfig\n    ) -> BatchConversionReport:\n        \"\"\"Process multiple files in batch\"\"\"\n        ...\n```\n\n### 2.4 Exceptions (`core/exceptions.py`)\n\nFollowing the pattern from `orcaflex/core/exceptions.py`:\n\n```python\nclass BEMRosettaError(Exception):\n    \"\"\"Base exception for BEMRosetta module\"\"\"\n    \n    def __init__(\n        self,\n        message: str,\n        error_code: Optional[str] = None,\n        context: Optional[Dict[str, Any]] = None,\n        suggestions: Optional[List[str]] = None\n    ):\n        ...\n\nclass ParserError(BEMRosettaError):\n    \"\"\"Error parsing BEM solver output\"\"\"\n    pass\n\nclass ConverterError(BEMRosettaError):\n    \"\"\"Error during format conversion\"\"\"\n    pass\n\nclass ExecutableNotFoundError(BEMRosettaError):\n    \"\"\"BEMRosetta executable not found\"\"\"\n    pass\n\nclass UnsupportedFormatError(BEMRosettaError):\n    \"\"\"Unsupported input/output format\"\"\"\n    pass\n\nclass MeshError(BEMRosettaError):\n    \"\"\"Error in mesh operations\"\"\"\n    pass\n\nclass ValidationError(BEMRosettaError):\n    \"\"\"Validation failure for hydrodynamic data\"\"\"\n    pass\n```\n\n---\n\n## 3. Parser Implementations\n\n### 3.1 WAMIT Parser (`parsers/wamit_parser.py`)\n\n```python\nclass WAMITParser(ParserInterface):\n    \"\"\"\n    Parser for WAMIT output files\n    \n    Handles:\n    - .out summary file\n    - .1 added mass coefficients\n    - .3 damping coefficients  \n    - .4 exciting forces\n    - .5 RAOs\n    - .12p, .12d QTF files\n    \"\"\"\n    \n    @property\n    def supported_extensions(self) -> List[str]:\n        return ['.out', '.1', '.3', '.4', '.5', '.12p', '.12d']\n    \n    @property\n    def solver_name(self) -> str:\n        return \"WAMIT\"\n    \n    def parse(self, file_path: Path) -> DiffractionResults:\n        \"\"\"Parse WAMIT output to unified schema\"\"\"\n        # Implementation: Read all available files in directory\n        # Build complete DiffractionResults object\n        ...\n```\n\n### 3.2 AQWA Parser (`parsers/aqwa_parser.py`)\n\nThis will integrate with the existing `diffraction/aqwa_converter.py` but provide additional capabilities:\n\n```python\nclass AQWAParser(ParserInterface):\n    \"\"\"\n    Enhanced AQWA parser using BEMRosetta\n    \n    Extends existing AQWAConverter with:\n    - Multi-body support\n    - QTF extraction\n    - Mesh import from .DAT\n    \"\"\"\n    \n    def parse(self, file_path: Path) -> DiffractionResults:\n        # Use existing aqwa_lis_parser for basic data\n        # Extend with BEMRosetta for additional data\n        ...\n```\n\n---\n\n## 4. Converter Implementations\n\n### 4.1 OrcaFlex Converter (`converters/to_orcaflex.py`)\n\n```python\nclass OrcaFlexConverter(ConverterInterface):\n    \"\"\"\n    Convert to OrcaFlex-compatible formats\n    \n    Integrates with existing diffraction/orcaflex_exporter.py\n    and adds BEMRosetta-specific workflows.\n    \"\"\"\n    \n    @property\n    def output_format(self) -> str:\n        return \"orcaflex\"\n    \n    def convert(\n        self,\n        results: DiffractionResults,\n        output_path: Path,\n        export_format: str = \"yaml\"  # yaml, csv, excel\n    ) -> Path:\n        \"\"\"\n        Convert to OrcaFlex format\n        \n        Uses existing OrcaFlexExporter for the actual export\n        \"\"\"\n        exporter = OrcaFlexExporter(results, output_path)\n        return exporter.export_all()\n```\n\n---\n\n## 5. Validators\n\n### 5.1 Causality Checker (`validators/causality_checker.py`)\n\n```python\nclass KramersKronigValidator:\n    \"\"\"\n    Validate causality of hydrodynamic coefficients using Kramers-Kronig relations\n    \n    Reference: DNV-RP-H103 Appendix A\n    \"\"\"\n    \n    def validate(\n        self,\n        frequencies: np.ndarray,\n        added_mass: List[np.ndarray],\n        damping: List[np.ndarray],\n        tolerance: float = 0.1\n    ) -> ValidationReport:\n        \"\"\"\n        Check Kramers-Kronig consistency\n        \n        The infinite-frequency added mass A_inf can be computed from damping:\n        A_inf = A(omega) + (2/pi) * integral[B(s)/(s^2 - omega^2) ds]\n        \"\"\"\n        ...\n```\n\n### 5.2 Coefficient Validator (`validators/coefficient_validator.py`)\n\n```python\nclass CoefficientValidator:\n    \"\"\"\n    Validate physical consistency of hydrodynamic coefficients\n    \"\"\"\n    \n    def validate_symmetry(self, matrices: List[np.ndarray]) -> List[str]:\n        \"\"\"Check 6x6 matrices are symmetric\"\"\"\n        ...\n    \n    def validate_positive_definite(self, matrices: List[np.ndarray]) -> List[str]:\n        \"\"\"Check damping matrices are positive semi-definite\"\"\"\n        ...\n    \n    def validate_frequency_limits(\n        self,\n        frequencies: np.ndarray,\n        added_mass: List[np.ndarray]\n    ) -> List[str]:\n        \"\"\"Check added mass approaches A_inf at high frequency\"\"\"\n        ...\n    \n    def validate_rao_limits(\n        self,\n        frequencies: np.ndarray,\n        rao_data: RAOSet\n    ) -> List[str]:\n        \"\"\"Check RAO approaches 1.0 at low frequency for heave\"\"\"\n        ...\n```\n\n---\n\n## 6. CLI Commands (`cli.py`)\n\n```python\n@click.group()\n@click.version_option(version=__version__, prog_name=\"bemrosetta\")\ndef cli():\n    \"\"\"BEMRosetta Integration - Hydrodynamic coefficient conversion tools\"\"\"\n    pass\n\n@cli.command('convert')\n@click.argument('input_file', type=click.Path(exists=True))\n@click.option('--output-format', '-f', \n              type=click.Choice(['wamit', 'orcaflex', 'hams', 'openfast', 'bemio']),\n              required=True, help='Output format')\n@click.option('--output-dir', '-o', type=click.Path(), default='output',\n              help='Output directory')\n@click.option('--water-depth', '-d', type=float, help='Water depth (m)')\n@click.option('--validate/--no-validate', default=True,\n              help='Run validation checks')\ndef convert(input_file, output_format, output_dir, water_depth, validate):\n    \"\"\"Convert BEM solver output between formats\"\"\"\n    ...\n\n@cli.command('info')\n@click.argument('input_file', type=click.Path(exists=True))\ndef info(input_file):\n    \"\"\"Display information about BEM solver file\"\"\"\n    ...\n\n@cli.command('validate')\n@click.argument('input_file', type=click.Path(exists=True))\n@click.option('--strict/--relaxed', default=False,\n              help='Strict validation mode')\ndef validate(input_file, strict):\n    \"\"\"Validate hydrodynamic coefficients\"\"\"\n    ...\n\n@cli.command('convert-mesh')\n@click.argument('input_mesh', type=click.Path(exists=True))\n@click.option('--output-format', '-f',\n              type=click.Choice(['gdf', 'dat', 'stl', 'pnl']),\n              required=True, help='Output mesh format')\n@click.option('--output', '-o', type=click.Path(), required=True,\n              help='Output file path')\ndef convert_mesh(input_mesh, output_format, output):\n    \"\"\"Convert panel mesh between formats\"\"\"\n    ...\n\n@cli.command('batch')\n@click.argument('config_file', type=click.Path(exists=True))\ndef batch(config_file):\n    \"\"\"Batch process multiple files from configuration\"\"\"\n    ...\n\n@cli.command('compare')\n@click.argument('file1', type=click.Path(exists=True))\n@click.argument('file2', type=click.Path(exists=True))\n@click.option('--tolerance', '-t', type=float, default=0.05,\n              help='Comparison tolerance (default: 5%)')\n@click.option('--output', '-o', type=click.Path(), help='Output report path')\ndef compare(file1, file2, tolerance, output):\n    \"\"\"Compare hydrodynamic coefficients from two sources\"\"\"\n    ...\n```\n\n---\n\n## 7. Integration Strategy\n\n### 7.1 Integration with Existing Modules\n\n**Diffraction Module Integration:**\n```python\n# In bemrosetta/__init__.py\nfrom digitalmodel.modules.diffraction import (\n    DiffractionResults,\n    RAOSet,\n    AddedMassSet,\n    DampingSet,\n    OrcaFlexExporter,\n    validate_diffraction_results\n)\n\n# BEMRosetta converters can produce DiffractionResults\n# which are directly compatible with existing OrcaFlexExporter\n```\n\n**Hydrodynamics Module Integration:**\n```python\n# Reuse hydrodynamics data models\nfrom digitalmodel.modules.hydrodynamics import (\n    HydrodynamicMatrix,\n    CoefficientDatabase,\n    RAOData\n)\n\n# BEMRosetta can populate CoefficientDatabase from any BEM solver\n```\n\n### 7.2 Module Registration\n\nIn `pyproject.toml`:\n```toml\n[project.scripts]\n# ... existing entries ...\nbemrosetta = \"digitalmodel.modules.bemrosetta.cli:cli\"\n```\n\n### 7.3 Feature Detection\n\n```python\n# In bemrosetta/__init__.py\n\nimport shutil\nfrom pathlib import Path\n\n# Check for BEMRosetta executable\nBEMROSETTA_EXECUTABLE = Path(\"D:/software/BEMRosetta/BEMRosetta_cl.exe\")\nBEMROSETTA_AVAILABLE = BEMROSETTA_EXECUTABLE.exists()\n\nif not BEMROSETTA_AVAILABLE:\n    # Try to find in PATH\n    found = shutil.which(\"BEMRosetta_cl\")\n    if found:\n        BEMROSETTA_EXECUTABLE = Path(found)\n        BEMROSETTA_AVAILABLE = True\n\n# Feature flags based on dependencies\ntry:\n    import h5py\n    HDF5_AVAILABLE = True\nexcept ImportError:\n    HDF5_AVAILABLE = False\n\ntry:\n    import netCDF4\n    NETCDF_AVAILABLE = True  \nexcept ImportError:\n    NETCDF_AVAILABLE = False\n```\n\n---\n\n## 8. Test Strategy\n\n### 8.1 Test Structure\n\n```\ntests/modules/bemrosetta/\n|-- __init__.py\n|-- conftest.py                    # Shared fixtures\n|-- fixtures/                      # Test data files\n|   |-- wamit/\n|   |   |-- vessel.out\n|   |   |-- vessel.1\n|   |   |-- vessel.3\n|   |-- aqwa/\n|   |   |-- vessel.LIS\n|   |   |-- vessel.DAT\n|   |-- nemoh/\n|   |-- meshes/\n|       |-- sample.gdf\n|       |-- sample.stl\n|-- test_parsers.py                # Parser unit tests\n|-- test_converters.py             # Converter unit tests\n|-- test_validators.py             # Validator unit tests\n|-- test_runner.py                 # BEMRosetta runner tests\n|-- test_cli.py                    # CLI integration tests\n|-- test_mesh_handlers.py          # Mesh operation tests\n|-- test_integration.py            # End-to-end integration tests\n```\n\n### 8.2 Mock Strategy for CI\n\nSince BEMRosetta executable may not be available in CI:\n\n```python\n# In conftest.py\n\nimport pytest\nfrom unittest.mock import Mock, patch\nfrom pathlib import Path\n\n@pytest.fixture\ndef mock_bemrosetta_runner():\n    \"\"\"Mock BEMRosetta executable for CI testing\"\"\"\n    with patch('digitalmodel.modules.bemrosetta.core.runner.subprocess') as mock_subprocess:\n        mock_subprocess.run.return_value = Mock(\n            returncode=0,\n            stdout=\"Conversion successful\",\n            stderr=\"\"\n        )\n        yield mock_subprocess\n\n@pytest.fixture\ndef sample_wamit_data():\n    \"\"\"Sample WAMIT output data for testing\"\"\"\n    return {\n        'frequencies': np.array([0.3, 0.5, 0.7, 0.9]),\n        'headings': np.array([0, 45, 90, 135, 180]),\n        'added_mass': [...],\n        'damping': [...],\n        'raos': {...}\n    }\n\n@pytest.fixture\ndef skip_if_no_bemrosetta():\n    \"\"\"Skip test if BEMRosetta not available\"\"\"\n    from digitalmodel.modules.bemrosetta import BEMROSETTA_AVAILABLE\n    if not BEMROSETTA_AVAILABLE:\n        pytest.skip(\"BEMRosetta executable not available\")\n```\n\n### 8.3 Test Categories\n\n```python\n# test_parsers.py\n\nclass TestWAMITParser:\n    \"\"\"Unit tests for WAMIT parser\"\"\"\n    \n    def test_parse_out_file(self, sample_wamit_files):\n        \"\"\"Test parsing .out summary file\"\"\"\n        ...\n    \n    def test_parse_added_mass(self, sample_wamit_files):\n        \"\"\"Test parsing .1 added mass file\"\"\"\n        ...\n    \n    def test_parse_raos(self, sample_wamit_files):\n        \"\"\"Test parsing .5 RAO file\"\"\"\n        ...\n    \n    def test_invalid_file_raises_error(self):\n        \"\"\"Test proper error handling for invalid files\"\"\"\n        ...\n\nclass TestAQWAParser:\n    \"\"\"Unit tests for AQWA parser\"\"\"\n    ...\n\n# test_validators.py\n\nclass TestCausalityChecker:\n    \"\"\"Test Kramers-Kronig validation\"\"\"\n    \n    def test_valid_coefficients_pass(self, sample_coefficients):\n        \"\"\"Valid coefficients should pass causality check\"\"\"\n        ...\n    \n    def test_inconsistent_coefficients_fail(self):\n        \"\"\"Inconsistent coefficients should be flagged\"\"\"\n        ...\n\n# test_integration.py\n\n@pytest.mark.integration\nclass TestBEMRosettaIntegration:\n    \"\"\"End-to-end integration tests\"\"\"\n    \n    @pytest.mark.skipif(not BEMROSETTA_AVAILABLE, reason=\"BEMRosetta not installed\")\n    def test_wamit_to_orcaflex_conversion(self, sample_wamit_files, tmp_path):\n        \"\"\"Test complete WAMIT to OrcaFlex workflow\"\"\"\n        ...\n    \n    def test_diffraction_module_integration(self, sample_results):\n        \"\"\"Test integration with existing diffraction module\"\"\"\n        ...\n```\n\n---\n\n## 9. Implementation Phases\n\n### Phase 1: Core Infrastructure (Week 1-2)\n1. Create module directory structure\n2. Implement data models (`models.py`)\n3. Implement interfaces (`core/interfaces.py`)\n4. Implement exceptions (`core/exceptions.py`)\n5. Implement BEMRosetta runner (`core/runner.py`)\n6. Write basic unit tests\n\n### Phase 2: Parsers (Week 2-3)\n1. Implement WAMIT parser (highest priority - most common format)\n2. Implement AQWA parser (integrate with existing)\n3. Implement Nemoh parser\n4. Implement HAMS parser\n5. Write parser unit tests\n\n### Phase 3: Converters (Week 3-4)\n1. Implement OrcaFlex converter (integrate with existing exporter)\n2. Implement WAMIT converter\n3. Implement HAMS converter\n4. Implement OpenFAST converter\n5. Write converter unit tests\n\n### Phase 4: Validators and Mesh (Week 4-5)\n1. Implement coefficient validator\n2. Implement Kramers-Kronig checker\n3. Implement mesh handlers (GDF, DAT, STL)\n4. Write validation tests\n\n### Phase 5: CLI and Integration (Week 5-6)\n1. Implement CLI commands\n2. Add pyproject.toml entry\n3. Write CLI integration tests\n4. Write end-to-end integration tests\n5. Create MODULE_README.md documentation\n\n### Phase 6: Visualization (Optional, Week 6+)\n1. Implement RAO plotting\n2. Implement coefficient plotting\n3. Implement mesh viewer\n\n---\n\n## 10. Dependencies\n\n### Required\n- numpy >= 1.24.0 (already in pyproject.toml)\n- scipy >= 1.10.0 (already in pyproject.toml)\n- click >= 8.0.0 (already in pyproject.toml)\n- pandas >= 2.0.0 (already in pyproject.toml)\n- pydantic >= 2.7.0 (already in pyproject.toml)\n- loguru >= 0.7.0 (already in pyproject.toml)\n\n### Optional (for specific features)\n- h5py >= 3.10.0 (for Bemio HDF5 format) - already in pyproject.toml\n- netCDF4 (for Capytaine .nc format) - may need to add\n- plotly >= 5.0 (for visualization) - already in pyproject.toml\n\n### External\n- BEMRosetta_cl.exe at `D:/software/BEMRosetta/BEMRosetta_cl.exe`\n\n---\n\n## 11. Configuration Example\n\n```yaml\n# bemrosetta_config.yml\nbemrosetta:\n  executable_path: \"D:/software/BEMRosetta/BEMRosetta_cl.exe\"\n  working_directory: \"./temp\"\n  \nconversion:\n  input_format: \"wamit\"\n  output_format: \"orcaflex\"\n  water_depth: 1200.0\n  include_qtf: false\n  \nvalidation:\n  check_symmetry: true\n  check_causality: true\n  symmetry_tolerance: 0.001\n  causality_tolerance: 0.1\n  \nmesh:\n  check_quality: true\n  min_panel_area: 0.1\n  max_aspect_ratio: 10.0\n```\n\n---\n\n### Critical Files for Implementation\n\n1. **`D:\\workspace-hub\\digitalmodel\\src\\digitalmodel\\modules\\diffraction\\output_schemas.py`** - Core data models to reuse (DiffractionResults, RAOSet, AddedMassSet, DampingSet, DOF enum)\n\n2. **`D:\\workspace-hub\\digitalmodel\\src\\digitalmodel\\modules\\diffraction\\aqwa_converter.py`** - Pattern for parser implementation and integration with unified schema\n\n3. **`D:\\workspace-hub\\digitalmodel\\src\\digitalmodel\\modules\\hydrodynamics\\models.py`** - Additional data models to reuse (HydrodynamicMatrix, RAOData, VesselProperties)\n\n4. **`D:\\workspace-hub\\digitalmodel\\src\\digitalmodel\\modules\\orcaflex\\core\\interfaces.py`** - Interface design patterns to follow (AnalyzerInterface, ProcessorInterface, ExtractorInterface)\n\n5. **`D:\\workspace-hub\\digitalmodel\\src\\digitalmodel\\modules\\diffraction\\cli.py`** - CLI implementation pattern to follow using Click framework","session":"96904e6d-9f4c-47a6-a901-36b403a1dbc9"}
