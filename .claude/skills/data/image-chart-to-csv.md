# image-chart-to-csv

Extract numerical data from matplotlib multi-panel chart PNG images to CSV files,
preserving chart titles, axis labels, units, and legend metadata.

## When to use

- You have a chart image (PNG/JPEG from a report or PDF) and need the underlying numbers
- The chart was generated by matplotlib (clean lines, consistent colours)
- You want to re-plot or compare data from multiple solvers

## Script

```
digitalmodel/scripts/benchmark/extract_chart_data.py
```

## Quick start

```bash
uv run python scripts/benchmark/extract_chart_data.py \
    --image path/to/chart.png \
    --config scripts/benchmark/qtf_plot_config.yaml \
    --output path/to/output/dir/ \
    --grid 26 \
    --debug
```

`--debug` saves `debug_subplot_boxes.png` showing the detected plot regions.

## Algorithm

1. **HSV colour masking** — identifies blue (hue 175-230°) and red/orange (hue 340-380°)
   curves robustly across anti-aliased and JPEG-compressed images.
2. **Per-column y-centroid** — extracts the solid-line series (OrcaWave) at pixel
   resolution across the full x-axis width.
3. **Column-count peak detection** — finds discrete × / □ marker positions (Wamit,
   Analytic) where the per-column pixel count spikes above the mean.
4. **Nearest-neighbour resampling** — maps all series onto a uniform omega grid.

## Output

One CSV per subplot with comment-row metadata then a data table:

```
# title,Diffraction load RAO
# y_unit,kN/m
# x_label,omega (rad/s)
# y_min,0.0
# y_max,35.0
omega_rad_s,OrcaWave_real,OrcaWave_imag,Wamit_real,Wamit_imag
0.5000,3.37,12.28,,
0.6000,3.48,13.91,,14.46
...
```

Blank cells = series not detected at that omega (marker series are sparse).

## Config YAML keys

| Key | Description |
|-----|-------------|
| `series[].hue_lo/hi` | HSV hue range (0-360°); use `hue_hi > 360` for red wrap-around |
| `series[].kind` | `line` → dense column-scan; `marker` → peak-detected clusters |
| `subplots[].pixel_box` | `[x0, y0, x1, y1]` inner axes pixel bounds (no tick labels) |
| `subplots[].y_min/y_max` | Data axis limits (read from the chart's y-axis ticks) |

## Adapting for new chart types

1. Run `--debug` to verify subplot boxes.
2. Probe dominant hues:
   ```python
   from PIL import Image; import numpy as np
   crop = np.asarray(Image.open("chart.png").convert("RGB"))
   # ... HSV analysis (see script header)
   ```
3. Create a new `*_digitize.yaml` next to the image — the script auto-discovers it.

## Known limitations

- Wamit marker detection is approximate (under-detects when markers overlap the line).
  For validated benchmarks, resample the OrcaWave line at marker x-positions instead.
- Mean drift PI subplot has no imaginary part (physically zero for real-valued QTF).
- Series using identical hue ranges cannot be fully separated by colour alone.
