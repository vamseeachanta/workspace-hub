<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Session Lifecycle Schematic — Interactive</title>
<style>
  :root { --bg: #1a1a2e; --card: #16213e; --text: #e0e0e0; --accent: #0f3460; --highlight: #e94560; }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); padding: 2rem; }
  h1 { text-align: center; margin-bottom: 0.5rem; font-size: 1.8rem; color: #fff; }
  .subtitle { text-align: center; color: #888; margin-bottom: 2rem; font-size: 0.9rem; }
  .tabs { display: flex; justify-content: center; gap: 0.5rem; margin-bottom: 2rem; flex-wrap: wrap; }
  .tab { padding: 0.6rem 1.2rem; border: 1px solid #333; border-radius: 6px; cursor: pointer;
         background: var(--card); color: var(--text); font-size: 0.85rem; transition: all 0.2s; }
  .tab:hover { border-color: var(--highlight); color: #fff; }
  .tab.active { background: var(--highlight); border-color: var(--highlight); color: #fff; font-weight: 600; }
  .diagram-container { background: var(--card); border-radius: 12px; padding: 2rem; margin: 0 auto;
                       max-width: 1200px; border: 1px solid #333; display: none; }
  .diagram-container.active { display: block; }
  .diagram-container h2 { margin-bottom: 1rem; font-size: 1.3rem; color: #fff; }
  .diagram-container p { margin-bottom: 1rem; color: #aaa; font-size: 0.85rem; line-height: 1.6; }
  .mermaid { background: #fff; border-radius: 8px; padding: 1.5rem; margin-top: 1rem; }
  .legend { margin-top: 1.5rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px; }
  .legend h3 { font-size: 0.95rem; margin-bottom: 0.5rem; color: #ccc; }
  .legend ul { list-style: none; padding: 0; }
  .legend li { font-size: 0.8rem; color: #999; padding: 0.2rem 0; }
  .legend li::before { content: ''; display: inline-block; width: 12px; height: 12px;
                       border-radius: 3px; margin-right: 0.5rem; vertical-align: middle; }
  .legend li.green::before { background: #e8f5e9; border: 1px solid #4caf50; }
  .legend li.orange::before { background: #fff3e0; border: 1px solid #ff9800; }
  .legend li.blue::before { background: #e3f2fd; border: 1px solid #2196f3; }
  .timing-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
  .timing-table th, .timing-table td { padding: 0.5rem 0.75rem; text-align: left; border-bottom: 1px solid #333; font-size: 0.8rem; }
  .timing-table th { color: #aaa; font-weight: 600; }
  .timing-table td { color: #ccc; }
  .timing-table tr:hover td { background: rgba(255,255,255,0.03); }
  footer { text-align: center; margin-top: 3rem; color: #555; font-size: 0.75rem; }
</style>
</head>
<body>

<h1>Session Lifecycle Schematic</h1>
<p class="subtitle">workspace-hub &middot; Claude Code hooks &amp; signal flow &middot; Interactive viewer</p>

<div class="tabs">
  <div class="tab active" onclick="showDiagram('main')">Main Lifecycle</div>
  <div class="tab" onclick="showDiagram('readiness')">Start Readiness</div>
  <div class="tab" onclick="showDiagram('signals')">Signal Data Flow</div>
  <div class="tab" onclick="showDiagram('roadmap')">Enhancement Roadmap</div>
  <div class="tab" onclick="showDiagram('priority')">Priority Matrix</div>
  <div class="tab" onclick="showDiagram('timing')">Timing Budget</div>
</div>

<!-- 1. Main Lifecycle -->
<div id="main" class="diagram-container active">
  <h2>Session Lifecycle — Full Pipeline</h2>
  <p>From session start through active work to stop hooks. Each tool call passes through PreToolUse/PostToolUse.
     Stop hooks run sequentially on /exit, Ctrl+C, or timeout.</p>
  <div class="mermaid">
flowchart TD
    START([Session Start]) --> LOAD[Load CLAUDE.md + rules/ + memory/]
    LOAD --> STATUS[Init statusline-command.sh]
    STATUS --> SESSION

    subgraph SESSION [Active Session]
        direction TB
        PRE["PreToolUse
        1. session-logger pre
        2. ecosystem-check
        3. readiness check (once/session)
        4. edit notification"]
        TOOL[Tool Executes]
        POST["PostToolUse
        1. session-logger post
        2. save notification
        3. capture-corrections"]
        COMPACT["PreCompact
        1. pre-compact-save
        2. delegation reminder
        3. auto-compact tips"]

        PRE --> TOOL --> POST
        POST -.-> |on compaction| COMPACT
    end

    SESSION --> |"/exit or Ctrl+C or timeout"| STOP

    subgraph STOP [Stop Hooks — Sequential]
        direction TB
        S1["1. session-end-evaluate ~2s"]
        S2["2. timestamp marker"]
        S3["3. post-task-review ~1s"]
        S4["4. consume-signals ~3s"]
        S5["5. generate-resource-index ~2s"]
        S6["6. query-quota ~5s"]
        S7["7. wrk-traceability-check"]
        S8["8. ecosystem-health-check ~1s"]
        S9["9. ensure-readiness ~1s"]
        S10["10. improve.sh ~30-60s"]

        S1 --> S2 --> S3 --> S4 --> S5 --> S6 --> S7 --> S8 --> S9 --> S10
    end

    subgraph IMPROVE [improve.sh Phases]
        direction TB
        P1["Phase 1: COLLECT — Shell"]
        P2["Phase 2: CLASSIFY — API"]
        P3["Phase 3: ECOSYSTEM — Hybrid"]
        P4["Phase 4: GUARD — Shell"]
        P5["Phase 5: APPLY — API+Shell"]
        P55["Phase 5.5: RECOMMEND — Shell"]
        P6["Phase 6: LOG — Shell"]
        P7["Phase 7: CLEANUP — Shell"]

        P1 --> P2 --> P3 --> P4 --> P5 --> P55 --> P6 --> P7
    end

    S10 --> IMPROVE
    STOP --> ENDNODE([Session End])
  </div>
</div>

<!-- 2. Start Readiness -->
<div id="readiness" class="diagram-container">
  <h2>Session Start — Readiness Checks (Proposed)</h2>
  <p>R4, R5, R8 are implemented in <code>hooks/readiness/readiness.sh</code> (runs once per session via PreToolUse).
     R1-R3, R6-R7 are proposed. Non-blocking: warnings only, never prevents session start.</p>
  <div class="mermaid">
flowchart TD
    START([Session Start]) --> READY{Readiness Checks}

    subgraph READY_CHECKS ["Readiness Dispatcher ~200ms total"]
        direction LR
        R1["R1: Memory Curation
        MEMORY.md &lt; 200 lines?
        No stale entries?"]
        R2["R2: Index Freshness
        RESOURCE_INDEX &lt; 24h?
        data-catalog matches?"]
        R3["R3: Skill Health
        Active skills &lt; 350?
        No orphan skills?"]
        R4["R4: Agent Readiness
        model-registry valid?
        contract up to date?"]
        R5["R5: Context Budget
        Auto-load &lt; 16KB?
        No bloated rules?"]
        R6["R6: Submodule Sync
        All on main?
        Not &gt;5 behind?"]
        R7["R7: Signal Triage
        Pending &lt; 50?
        Last briefing read?"]
        R8["R8: Environment
        Python OK? jq/yq?
        WORKSPACE_HUB set?"]
    end

    READY --> READY_CHECKS
    READY_CHECKS --> |all pass| LOAD[Load Context + Start Session]
    READY_CHECKS --> |warnings| WARN[Display Warnings + Start Session]

    style R1 fill:#e8f5e9
    style R2 fill:#e8f5e9
    style R3 fill:#fff3e0
    style R4 fill:#c8e6c9,stroke:#2e7d32,stroke-width:2px
    style R5 fill:#c8e6c9,stroke:#2e7d32,stroke-width:2px
    style R6 fill:#e3f2fd
    style R7 fill:#fff3e0
    style R8 fill:#c8e6c9,stroke:#2e7d32,stroke-width:2px
  </div>
  <div class="legend">
    <h3>Priority Legend</h3>
    <ul>
      <li class="green">Implemented (R4, R5, R8) — bold green border</li>
      <li class="green">High priority proposed (R1, R2)</li>
      <li class="orange">Medium priority proposed (R3, R7)</li>
      <li class="blue">Low priority proposed (R6)</li>
    </ul>
  </div>
</div>

<!-- 3. Signal Data Flow -->
<div id="signals" class="diagram-container">
  <h2>Signal Data Flow</h2>
  <p>How data flows from signal producers (during session) through state directories to consumers (at stop) and final outputs.</p>
  <div class="mermaid">
flowchart LR
    subgraph PRODUCERS [Signal Producers]
        SL[session-logger.sh]
        CC[capture-corrections.sh]
        EH[ecosystem-health-check.sh]
    end

    subgraph STATE [State Directory]
        SESS["sessions/*.jsonl"]
        CORR["corrections/.recent_edits"]
        PR["pending-reviews/*.jsonl"]
        ACC[accumulator.json]
    end

    subgraph CONSUMERS [Signal Consumers]
        CS[consume-signals.sh]
        IMP[improve.sh]
    end

    subgraph OUTPUTS [Outputs]
        BRIEF[session-briefing.md]
        WRK["WRK-xxx.md"]
        MEM["memory/*.md"]
        RULES["rules/*.md"]
        SKILLS["skills/**/*.md"]
        CHLOG[improve-changelog.yaml]
        ARCH["archive/YYYYMMDD/"]
    end

    SL --> SESS
    SL --> PR
    CC --> CORR
    CC --> PR
    EH --> PR

    SESS --> CS
    PR --> CS
    CS --> ACC
    CS --> BRIEF
    CS --> WRK
    CS --> ARCH

    PR --> IMP
    ACC --> IMP
    IMP --> MEM
    IMP --> RULES
    IMP --> SKILLS
    IMP --> CHLOG
  </div>
</div>

<!-- 4. Enhancement Roadmap -->
<div id="roadmap" class="diagram-container">
  <h2>Stop Hook Enhancement Roadmap</h2>
  <p>Proposed additions beyond the current 9 stop hooks. Budget constraint: total exit time should stay under 120s.</p>
  <div class="mermaid">
flowchart LR
    subgraph CURRENT [Current Stop Hooks 1-9]
        C1[evaluate] --> C2[timestamp] --> C3[review] --> C4[consume-signals]
        C4 --> C5[resource-index] --> C6[quota] --> C7[wrk-check]
        C7 --> C8[ecosystem] --> C9[improve.sh]
    end

    subgraph PROPOSED [Proposed Enhancements]
        SR1["S-R1: Cost Tracking
        API cost per session"]
        SR2["S-R2: Submodule Drift
        Detect stale pointers"]
        SR5["S-R5: Continuity Save
        Resume context next session"]
        SR6["S-R6: Legal Quick Scan
        Deny-list on changed files"]
    end

    C9 --> SR1
    C9 --> SR2
    C9 --> SR5
    C9 --> SR6

    style SR5 fill:#e8f5e9,stroke:#4caf50
    style SR6 fill:#e8f5e9,stroke:#4caf50
    style SR1 fill:#fff3e0,stroke:#ff9800
    style SR2 fill:#fff3e0,stroke:#ff9800
  </div>
  <div class="legend">
    <h3>Priority Legend</h3>
    <ul>
      <li class="green">High priority — S-R5 (Continuity Save), S-R6 (Legal Quick Scan)</li>
      <li class="orange">Medium priority — S-R1 (Cost Tracking), S-R2 (Submodule Drift)</li>
    </ul>
  </div>
</div>

<!-- 5. Priority Matrix -->
<div id="priority" class="diagram-container">
  <h2>Future WRK Items — Impact vs Effort</h2>
  <p>Quadrant chart mapping future work items by implementation effort and expected impact.
     Top-left quadrant ("Do First") has highest ROI.</p>
  <div class="mermaid">
quadrantChart
    title Future WRK Items — Impact vs Effort
    x-axis Low Effort --> High Effort
    y-axis Low Impact --> High Impact
    quadrant-1 Do First
    quadrant-2 Plan Carefully
    quadrant-3 Fill Gaps
    quadrant-4 Consider Later
    WRK-175 Engineering Loader: [0.3, 0.8]
    WRK-176 Code Version Guard: [0.2, 0.7]
    WRK-177 Calc Audit Trail: [0.5, 0.9]
    WRK-178 Data Provenance: [0.4, 0.6]
    WRK-179 Agent Pre-flight: [0.2, 0.8]
    WRK-180 Cross-Agent Sync: [0.6, 0.5]
    WRK-181 Session Replay: [0.9, 0.7]
    WRK-182 Predictive Planning: [0.8, 0.8]
    WRK-183 Knowledge Graph: [0.9, 0.9]
  </div>
</div>

<!-- 6. Timing Budget -->
<div id="timing" class="diagram-container">
  <h2>Timing Budget</h2>
  <p>Breakdown of stop hook execution time. API calls (query-quota, improve.sh) dominate the budget.</p>
  <table class="timing-table">
    <thead>
      <tr><th>Phase</th><th>Typical</th><th>Worst Case</th><th>Notes</th></tr>
    </thead>
    <tbody>
      <tr><td>Stop hooks 1-3</td><td>~3s</td><td>~5s</td><td>Pure shell, fast</td></tr>
      <tr><td>consume-signals (#4)</td><td>~3s</td><td>~8s</td><td>Depends on signal volume</td></tr>
      <tr><td>generate-resource-index (#5)</td><td>~2s</td><td>~4s</td><td>Filesystem scan</td></tr>
      <tr><td>query-quota (#6)</td><td>~5s</td><td>~15s</td><td>Network call to Anthropic API</td></tr>
      <tr><td>hooks 7-8</td><td>~2s</td><td>~3s</td><td>Pure shell</td></tr>
      <tr><td>ensure-readiness (#9)</td><td>~1s</td><td>~2s</td><td>R1+R5+R6 checks, writes report</td></tr>
      <tr><td>improve.sh (#10)</td><td>~30s</td><td>~60s</td><td>2-3 API calls dominate</td></tr>
      <tr style="font-weight:700"><td>Total</td><td>~46s</td><td>~97s</td><td>API latency is variable</td></tr>
    </tbody>
  </table>

  <h2 style="margin-top:2rem">Quick vs Full Mode</h2>
  <table class="timing-table">
    <thead>
      <tr><th>Mode</th><th>Trigger</th><th>Phases Run</th><th>Time</th></tr>
    </thead>
    <tbody>
      <tr><td>Full</td><td>/exit</td><td>All 7 phases</td><td>~30-60s</td></tr>
      <tr><td>Quick (--quick)</td><td>Ctrl+C / --quick flag</td><td>Phases 1, 4, 6, 7 only (shell-only)</td><td>~2-3s</td></tr>
      <tr><td>Dry run (--dry-run)</td><td>Manual testing</td><td>All phases, no writes</td><td>~30-60s</td></tr>
    </tbody>
  </table>
</div>

<footer>
  Session Lifecycle Schematic v1.0 &middot; workspace-hub &middot; Generated 2026-02-17
</footer>

<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
  mermaid.initialize({
    startOnLoad: true,
    theme: 'default',
    flowchart: { useMaxWidth: true, htmlLabels: true, curve: 'basis' },
    securityLevel: 'loose'
  });
</script>

<script>
  function showDiagram(id) {
    document.querySelectorAll('.diagram-container').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    event.target.classList.add('active');
  }
  // expose globally for onclick
  window.showDiagram = showDiagram;
</script>

</body>
</html>
