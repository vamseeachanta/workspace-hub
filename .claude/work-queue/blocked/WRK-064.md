---
id: WRK-064
title: 'OrcaFlex format converter: license-required validation and backward-compat
  wrapper'
status: blocked
priority: medium
complexity: medium
created_at: 2026-01-31 14:00:00+00:00
target_repos:
- digitalmodel
commit: null
spec_ref: specs/modules/harmonic-knitting-gizmo.md
related:
- WRK-032
- WRK-026
blocked_by: []
blocked_reason: Requires OrcaFlex license (OrcFxAPI) - must run on licensed machine
synced_to: []
provider: codex
plan_reviewed: false
plan_approved: false
computer: acma-ansys05
execution_workstations: [acma-ansys05]
plan_workstations: [acma-ansys05]
---

# OrcaFlex Format Converter: License-Required Tasks

## Context

The OrcaFlex Three-Way Format Converter (`format_converter/`) was implemented on a non-licensed machine. **All 102 tests pass** using YAML-only operations. The following tasks require an OrcaFlex license (OrcFxAPI) and must be completed on a licensed machine.

## Completed (no license needed)

- [x] `yaml_utils.py` — Canonical `OrcaFlexDumper`, `orcaflex_dump()`, `orcaflex_load()`
- [x] `protocols.py` — `ConversionReport` dataclass, `FormatConverter` protocol
- [x] `section_mapping.py` — `SECTION_MAPPING`, `REVERSE_SECTION_MAPPING`, `INPUT_PARAMETERS`
- [x] `format_detector.py` — `FormatType` enum, `detect_format()`
- [x] `single_to_modular.py` — `SingleToModularConverter` (promoted from yaml_to_include.py)
- [x] `modular_to_single.py` — `ModularToSingleConverter` (extracted from level_3_physical.py)
- [x] `spec_to_modular.py` — `SpecToModularConverter` (wraps ModularModelGenerator)
- [x] `spec_to_single.py` — `SpecToSingleConverter` (chains spec→modular→single)
- [x] `modular_to_spec.py` — `ModularToSpecConverter` (best-effort reverse extraction)
- [x] `single_to_spec.py` — `SingleToSpecConverter` (chains single→modular→spec)
- [x] `cli.py` — 8 subcommands (single2modular, modular2single, spec2modular, etc.)
- [x] `__main__.py` — `python -m` entry point
- [x] `pyproject.toml` — `orcaflex-convert` entry point registered
- [x] 102 tests passing (yaml_utils, format_detector, single↔modular, round-trip, spec conversions, CLI)

## Pending Tasks (require OrcaFlex license)

### 1. End-to-end OrcaFlex validation test
Run converted YAML files through OrcaFlex to verify they load and simulate correctly:
```bash
# On licensed machine:
uv run python -m digitalmodel.modules.orcaflex.format_converter \
    single2modular "docs/modules/orcaflex/examples/raw/A01/A01 Catenary riser.yml" \
    -o /tmp/a01_modular/

# Load in OrcaFlex and verify static analysis runs
uv run python -c "
import OrcFxAPI
model = OrcFxAPI.Model()
model.LoadData('/tmp/a01_modular/master.yml')
model.CalculateStatics()
print('Static analysis OK')
"
```

### 2. Round-trip OrcaFlex binary fidelity test
Verify round-trip through OrcaFlex binary format preserves model:
```
A01.yml → single2modular → modular → OrcaFlex load → OrcaFlex save → compare
```

### 3. Update backward-compat wrapper in `scripts/conversion/yaml_to_include.py`
The original `yaml_to_include.py` still has its own `OrcaFlexDumper` and `OrcaFlexYAMLConverter`. Update it to import from the new canonical locations:
```python
# scripts/conversion/yaml_to_include.py — backward-compat wrapper
from digitalmodel.modules.orcaflex.yaml_utils import OrcaFlexDumper
from digitalmodel.modules.orcaflex.format_converter.single_to_modular import SingleToModularConverter
from digitalmodel.modules.orcaflex.format_converter.section_mapping import SECTION_MAPPING, INPUT_PARAMETERS

# Keep OrcaFlexYAMLConverter as alias for backward compat
OrcaFlexYAMLConverter = SingleToModularConverter
```
This is not license-dependent but was deferred to avoid breaking existing workflows.

### 4. Test with additional example files
Run conversions on all example files in `docs/modules/orcaflex/examples/raw/` (A01-A10, E01-E10, etc.) and verify OrcaFlex can load each converted output:
- Batch convert: `orcaflex-convert single2modular --batch docs/modules/orcaflex/examples/raw/ -o /tmp/batch_modular/`
- Load each in OrcaFlex and run statics

### 5. Update `library_generator.py` to use canonical OrcaFlexDumper
Replace the duplicate `OrcaFlexLibraryDumper` in `src/digitalmodel/modules/orcaflex/library_generator.py` with an import from `yaml_utils.py`.

## File Locations

```
src/digitalmodel/modules/orcaflex/
  yaml_utils.py                           # Canonical OrcaFlexDumper
  format_converter/
    __init__.py                           # Re-exports all converters
    protocols.py                          # ConversionReport, FormatConverter
    format_detector.py                    # FormatType, detect_format()
    section_mapping.py                    # SECTION_MAPPING, INPUT_PARAMETERS
    single_to_modular.py                  # SingleToModularConverter
    modular_to_single.py                  # ModularToSingleConverter
    spec_to_modular.py                    # SpecToModularConverter
    spec_to_single.py                     # SpecToSingleConverter
    modular_to_spec.py                    # ModularToSpecConverter
    single_to_spec.py                     # SingleToSpecConverter
    cli.py                                # Unified CLI with 8 subcommands
    __main__.py                           # python -m entry point

tests/modules/orcaflex/format_converter/
    conftest.py                           # Shared fixtures (real test data)
    test_yaml_utils.py                    # 18 tests
    test_format_detector.py               # 13 tests
    test_single_to_modular.py             # 11 tests
    test_modular_to_single.py             # 13 tests (incl deep merge)
    test_round_trip.py                    # 4 tests (critical fidelity)
    test_spec_conversions.py              # 29 tests (all spec converters)
    test_cli.py                           # 13 tests (all subcommands)
```

## Quick Verification Commands (for licensed machine)

```bash
# Run existing tests (should all pass)
cd /mnt/github/workspace-hub/digitalmodel
uv run pytest tests/modules/orcaflex/format_converter/ -v

# Format detection
uv run python -m digitalmodel.modules.orcaflex.format_converter detect \
    docs/modules/orcaflex/examples/raw/A01/"A01 Catenary riser.yml"
# Expected: single

# Round-trip conversion
uv run python -m digitalmodel.modules.orcaflex.format_converter \
    single2modular docs/modules/orcaflex/examples/raw/A01/"A01 Catenary riser.yml" \
    -o /tmp/test_modular/

uv run python -m digitalmodel.modules.orcaflex.format_converter \
    modular2single /tmp/test_modular/master.yml \
    -o /tmp/test_roundtrip.yml

# Spec extraction
uv run python -m digitalmodel.modules.orcaflex.format_converter \
    single2spec docs/modules/orcaflex/examples/raw/A01/"A01 Catenary riser.yml" \
    -o /tmp/extracted_spec.yml
```

## Plan

- **Step 1**: Access licensed machine (AceEngineer-03 has OrcaFlex 10.0)
- **Step 2**: Run end-to-end OrcaFlex validation test (A01 Catenary riser round-trip)
- **Step 3**: Run binary fidelity test (YAML → OrcaFlex load → save → compare)
- **Step 4**: Update backward-compat wrapper in `scripts/conversion/yaml_to_include.py`
- **Step 5**: Batch test all example files in `docs/modules/orcaflex/examples/raw/`
- **Step 6**: Update `library_generator.py` to use canonical `OrcaFlexDumper`
- **Verify**: All 102 existing tests still pass + new license-dependent tests pass

### Review Notes
- **Verdict**: Claude: APPROVE | Codex: MINOR | Gemini: MINOR
- **Actions taken**:
  - No plan changes required (well-structured with clear validation steps)
  - Codex suggested defining backward-compat version ranges and adding checksums for fidelity tests — noted for implementation phase
  - Gemini noted: confirm AceEngineer-03 access and active license before proceeding
  - License-dependent tests in CI should be skipped gracefully (mark with `@pytest.mark.skipif`)
- *Cross-reviewed: 2026-02-09*

*Approved by user: 2026-02-09*

---
*Created from format converter implementation session (2026-01-31). All YAML-only work complete; license-dependent validation pending.*
