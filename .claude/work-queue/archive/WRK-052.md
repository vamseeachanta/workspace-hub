---
id: WRK-052
title: "assetutilities test coverage improvement"
status: archived
priority: high
complexity: complex
created_at: 2026-01-30T00:00:00Z
target_repos:
  - assetutilities
commit:
spec_ref:
related: [WRK-051, WRK-053, WRK-054, WRK-055, WRK-056]
blocked_by: []
synced_to: []
tags: [testing, coverage, tdd]
---
# assetutilities Test Coverage Improvement

## What
Improve test coverage for the assetutilities repository from the current 21% to 80%+. The repo has 11K statements and 2684 test files, but several key packages have zero coverage.

## Why
At 21% coverage, critical utility packages used across multiple projects have no regression protection. Zero-coverage packages like excel_utilities, pdf_utilities, devtools, reportgen, and validators are particularly risky as they handle data I/O and validation.

## Current State
- **Coverage**: 21%
- **Statements**: ~11K
- **Test files**: 2684
- **Zero-coverage packages**: excel_utilities, pdf_utilities, devtools, reportgen, validators

## Strategy
1. Focus on zero-coverage packages first: excel_utilities, pdf_utilities, devtools, reportgen, validators
2. Write tests for public API surfaces of each package
3. Add edge case and error handling tests
4. Increase coverage incrementally per package

## Acceptance Criteria
- [ ] excel_utilities package coverage reaches 80%+
- [ ] pdf_utilities package coverage reaches 80%+
- [ ] devtools package coverage reaches 80%+
- [ ] reportgen package coverage reaches 80%+
- [ ] validators package coverage reaches 80%+
- [ ] Overall repository coverage reaches 80%+
- [ ] CI pipeline reports coverage on every PR

## Notes
- Zero-coverage packages should be highest priority as they represent the largest risk
- Some packages may need test fixtures (sample Excel/PDF files) for proper testing

## Plan

**Spec**: `specs/modules/wrk-052-assetutilities-test-coverage.md`
**Target**: `assetutilities/tests/`

### Current State (from research)
- **11K statements**, 2,684 test files, 21% coverage
- **Zero-coverage packages**: excel_utilities, pdf_utilities, devtools, reportgen, validators
- **Working packages**: common/ (39 files, 0 tests — critical gap), units/ (TrackedQuantity has tests)
- **Key modules**: `common/` is imported by worldenergydata + digitalmodel — highest blast radius
- **Test runner**: `PYTHONPATH="src" python3 -m pytest --noconftest`

### Phase 1 — Audit & Fix Test Infrastructure
- **Deduplicate test files**: Audit 2,684 test files for duplicates/generated tests. Count unique vs. generated. The high count is suspicious for an 11K-statement library.
- Verify pytest discovers test files after deduplication
- Fix import paths: many tests may import `assetutilities` incorrectly
- Create `conftest.py` with proper PYTHONPATH setup
- Establish true baseline: run full suite, count pass/fail/error/skip. Note: "21% coverage" needs verification — if many test files fail to run, actual executed coverage could be much lower.

### Phase 2 — Priority Tiers (by dependency risk)
**Tier 1 — Critical (0% → 80%)** — used by other repos:
- `common/` — 39 files, 0 tests; shared utilities (file I/O, config parsing, data transforms)
  - Focus: `data_manager.py`, `config_reader.py`, `file_utilities.py`, `yml_utilities.py`
- `validators/` — input validation used at system boundaries

**Tier 2 — High (0% → 80%)** — data I/O:
- `excel_utilities/` — Excel read/write, template population
- `pdf_utilities/` — PDF generation, parsing, merging
- `reportgen/` — report generation from templates

**Tier 3 — Medium**:
- `devtools/` — developer tooling, linting helpers
- Remaining packages with partial coverage

### Phase 3 — Test Writing Strategy
- **Real data fixtures**: Create `tests/fixtures/` with sample Excel, PDF, YAML, JSON files
- **No mocks**: Use real file I/O per testing rules; temp directories for write tests
- **Per module**: Public API → edge cases → error paths
- **Naming**: `test_<module>_<function>_<scenario>_<expected>`
- **Target**: 15-25 tests per zero-coverage module

### Phase 4 — CI Coverage Reporting
- Add `pytest-cov` with `--cov=assetutilities --cov-report=html`
- Set per-package minimum thresholds
- Generate coverage badge

### Phase 5 — Incremental Milestones
1. Audit & fix infrastructure → deduplicate, verify test discovery (Days 1-3)
2. `common/` to 80% (estimate after baseline established) — highest priority due to cross-repo usage
3. `validators/` to 80% — schedule after common/ assessment
4. `excel_utilities/` + `pdf_utilities/` — staged coverage targets, lower initially due to external deps
5. `reportgen/` + `devtools/` — schedule after Tier 2 assessment
6. Overall 80%+ with CI gate — staged per-package thresholds
**Note**: Original 9-day timeline is unrealistic. Phase 1 audit alone will take 2-3 days. Remaining phases: estimate after baseline established.

### Dependencies
- Some tests need openpyxl, pdfplumber, or similar — verify installed
- PDF generation tests may need wkhtmltopdf or weasyprint. **If not installed, skip `pdf_utilities` tests with `pytest.importorskip` and document as a known gap.**
- Excel fixture files should be small (<100KB) and committed to tests/fixtures/

### Review Notes
- **Verdict**: Claude: MINOR | Codex: MAJOR | Gemini: APPROVE
- **Actions taken**:
  - Added test file deduplication audit to Phase 1 (2,684 files is suspicious for 11K-statement library)
  - Added true baseline verification — current 21% coverage needs verification method
  - Replaced 9-day timeline with phased approach — Phase 1 alone needs 2-3 days
  - Added `pytest.importorskip` strategy for PDF/wkhtmltopdf dependencies
  - Staged coverage targets for packages with external dependencies
  - Claude and Codex agree timeline is unrealistic; Codex rated MAJOR for this reason
- *Cross-reviewed: 2026-02-09*

*Approved by user: 2026-02-09*

---
*Source: test coverage audit across workspace-hub repositories*
