---
id: WRK-209
title: 'uv enforcement across workspace — eliminate python3/python fallback chains'
status: archived
completed_at: 2026-02-19T00:00:00Z
percent_complete: 100
priority: medium
complexity: medium
compound: false
created_at: 2026-02-19T00:00:00Z
target_repos:
  - workspace-hub
module: automation
tags:
  - uv
  - python
  - cross-platform
  - tooling
  - enforcement
related:
  - WRK-208
  - WRK-210
blocked_by: []
synced_to: []
provider: claude
spec_ref: ''
plan_reviewed: true
plan_approved: true
plan_review_iter: P2-PASS
percent_complete: 20
percent_complete: 0
brochure_status: n/a
---

# WRK-209: uv Enforcement Across Workspace

## What

Replace all `python3`/`python` detection chains in workspace-hub scripts with
`uv run --no-project python`. uv is the declared workspace tool manager and is
already required by `check-encoding.sh`, but many older scripts still use
multi-fallback detection (`python3 || python || error`). This creates silent
incompatibilities across Windows/Linux machines.

## Why

**Session trigger (2026-02-19)**: While writing `check-encoding.sh`, the
initial version used `python3`/`python` fallback detection. User feedback:
"should this not be flowing through uv" and "The solutions are not high
level.. one shot.. Too much intertwined." The clean solution: `uv` is a hard
dependency, not optional — if it's not installed, fail clearly with an
install instruction.

`uv run --no-project python` solves:
- `python3` vs `python` naming difference (Windows vs Linux)
- No system Python required — uv manages its own Python
- No virtual environment activation needed
- Consistent version across all machines

## Scope

### Files to audit and fix

| File | Current pattern | Fix |
|------|----------------|-----|
| `scripts/operations/setup-hooks.sh` | `python3 \|\| python` detection | Remove; uv check already in check-encoding.sh |
| `scripts/data/og-standards/rag.py` | Invoked as `python3 rag.py` | Add `#!/usr/bin/env -S uv run python` shebang |
| `scripts/development/ai-workflow/*.sh` | Any `python3` calls | Replace with `uv run --no-project python` |
| `scripts/improve/improve.sh` | Any `python3` calls | Replace with `uv run --no-project python` |
| `scripts/work-queue/*.py` | `python3 script.py` invocations | Replace with `uv run --no-project python script.py` |
| `CLAUDE.md` memory | "System python3 (3.12.3)" note | Update to "uv manages Python — use uv run" |

### Hub-level pyproject.toml

Add a minimal `pyproject.toml` at workspace-hub root declaring:
- `requires-python = ">=3.12"`
- `tool.uv` section pinning Python version
This allows `uv run python` (without `--no-project`) at hub root while
preserving `--no-project` for hook invocations from arbitrary working dirs.

## Acceptance Criteria

- [ ] All hub scripts that invoke Python use `uv run` (no `python3`/`python` chains)
- [ ] `setup-hooks.sh` Step 4 checks `uv` availability instead of `python3`
- [ ] `pyproject.toml` added at workspace-hub root (minimal — Python version pin only)
- [ ] `CLAUDE.md` memory updated: "uv is required; use `uv run` for all Python invocations"
- [ ] At least one script (e.g., `generate-index.py`) invocable as `uv run python scripts/work-queue/generate-index.py`

## Cross-Review Log

| Iter | Date | Reviewer | Verdict | Key Findings | Resolution |
|------|------|----------|---------|--------------|------------|
| P1 | 2026-02-19 | Claude Opus | **MAJOR** | pyproject.toml risky+unnecessary; 14+ scripts missed; bulk sed unsafe (3 distinct patterns); no submodule verification; no rollback | Plan revised — see below |
| P1 | 2026-02-19 | Codex | **MAJOR** | Bulk sed high-risk; submodule boundary not explicit enough; pyproject.toml risk; verification missing as first-class step | Plan revised — see below |
| P1 | 2026-02-19 | Gemini | MINOR | Shebang needs `env -S`; `command -v` breakage; wrong path (`scripts/work-queue/` vs `.claude/work-queue/scripts/`); `setup-claude-env.sh` + `generate-resource-index.sh` missing from scope | Incorporated into revision |

**P1 overall: FAIL** (Opus + Codex both MAJOR = hard block). Plan revised below. Requires new user approval + re-review.

| P2 | 2026-02-19 | Claude Opus | MINOR | `--ignore-file=.gitmodules` not valid rg flag; bare `python` in auto_embed.sh missed by Step 5 regex; prose says "three patterns" but table has five | Noted in executor brief |
| P2 | 2026-02-19 | Codex-role | MINOR | 6 additional files found: 3 claude-reflect scripts + 3 .claude/work-queue/scripts/; Step 1 regex misses bare `python`; Step 5 missing `.claude/work-queue/scripts/` path; `python3 -m` pattern not in table | Noted in executor brief |
| P2 | 2026-02-19 | Gemini | implicit-APPROVE | Gemini executed 5 files instead of reviewing — changes verified correct, bash -n pass, submodule boundary intact | Kept; treated as implicit APPROVE |

**P2 overall: PASS** — no MAJORs. Partially executed (5 files done by Gemini).

**Executor brief addenda (from P2 caveats):**
- Step 1 audit regex: `"python3|\bpython\b|command -v python"` (catches bare `python` — auto_embed.sh)
- Step 5 verification: add `.claude/work-queue/scripts/` to rg paths
- Remove `--ignore-file=.gitmodules` from Step 1 command (invalid rg flag)
- Add `python3 -m <module>` as 6th pattern row (covers auto-fix-loop.sh:228)
- Add to file list: `.claude/skills/coordination/workspace/claude-reflect/scripts/` (3 files) + `.claude/work-queue/scripts/` (archive-item.sh, on-complete-hook.sh, suggest-future-work.sh)
- Add `--quiet` flag to all `uv run` calls to suppress verbose output (Gemini best practice)
- **Already done** (Gemini, bash -n verified): setup-hooks.sh, system-update.sh, system-maintain.sh, hardware-assess.sh, setup-claude-env.sh

## Plan (v2 — revised after P1 cross-review)

Route B — **Awaiting user re-approval after P1 revisions.**

### Dropped from v1
- `pyproject.toml` at hub root — **dropped entirely**. `--no-project` flag makes it unnecessary. Adding it creates upward uv project-root collision risk for submodule scripts.

### Pattern rules (replaces bulk sed)

Three distinct call patterns require different fixes:

| Pattern | Example | Fix |
|---------|---------|-----|
| Availability check | `command -v python3` | → `command -v uv` |
| Inline execution | `python3 -c "..."` | → `uv run --no-project python -c "..."` |
| Heredoc invocation | `python3 - "$arg" <<'PY'` | → `uv run --no-project python - "$arg" <<'PY'` |
| Script shebang | `#!/usr/bin/env python3` | → `#!/usr/bin/env -S uv run --no-project python` |
| jq fallback chain | `elif command -v python3` | → `elif command -v uv` (keep structure, change binary) |
| Comments/log strings | `echo "python3 not found"` | Leave as-is or update to "uv not found" |

### Revised sequence

**Step 1 — Comprehensive audit** (read-only, no changes)
```bash
# Hub scripts only — explicit exclusion of submodule dirs
rg "python3|command -v python" scripts/ .claude/hooks/ .claude/work-queue/scripts/ \
    --ignore-file=.gitmodules --glob="*.sh" --glob="*.py" -l
```
Categorise every hit by pattern type. Review before touching anything.

**Step 2 — Pattern-specific, file-by-file fixes** (no bulk sed)

Files confirmed in audit (known from P1 review):
- `scripts/operations/setup-hooks.sh` — remove python3 detection block
- `scripts/operations/system/system-update.sh` — jq fallback chain
- `scripts/operations/system/system-maintain.sh` — jq fallback chain
- `scripts/operations/system/hardware-assess.sh` — jq fallback chain
- `scripts/operations/compliance/validate_work_queue_schema.sh`
- `scripts/operations/compliance/normalize_work_queue_metadata.sh`
- `scripts/operations/baseline-validation/hooks/*.sh` (3 files)
- `scripts/propagate-ecosystem.sh`
- `scripts/setup-claude-env.sh` — primary env setup entry point
- `scripts/generate-resource-index.sh`
- `scripts/ai/assessment/auto-sync-usage.sh`
- `scripts/data/batchtools/batch_runner.sh`
- `scripts/data/batchtools/aggregate_results.sh`
- `scripts/data/og-standards/setup.sh`
- `scripts/data/og-standards/auto_embed.sh` — bare `python` (not python3)
- `scripts/utilities/doc-to-context/doc2context.sh`
- `scripts/utilities/doc-to-context/examples/*.sh`
- `.claude/work-queue/scripts/generate-index.py` — shebang if present

Each file edited individually using the pattern table above. Apply `bash -n <file>` after each edit.

**Step 3 — Submodule boundary verification**
```bash
git submodule foreach 'git diff --name-only'
# Must return empty for ALL submodules
```
If any submodule file is modified: revert immediately before proceeding.

**Step 4 — Update MEMORY.md**
Change: `System python3 (3.12.3), NOT venv — for worldenergydata/hub scripts`
To: `uv manages Python for hub scripts — use uv run --no-project python`

**Step 5 — Verification**
```bash
# 1. No bare python3 in hub scripts
rg "python3" scripts/ .claude/hooks/ --glob="*.sh" | grep -v "uv run" | grep -v "^#"
# Must return 0 hits (except comments and log strings)

# 2. Syntax check all modified .sh files
for f in <modified-list>; do bash -n "$f" && echo "OK: $f"; done

# 3. Smoke tests
bash scripts/operations/setup-hooks.sh
uv run --no-project python .claude/work-queue/scripts/generate-index.py

# 4. Confirm submodule boundary
git submodule foreach 'git diff --name-only'
```

## Execution Brief

### Provider
- **Executor**: Codex — file-by-file shell script edits, pattern-specific replacements
- **Alt**: Claude Sonnet — if Codex fails on multi-file coordination

### Task for Executor
See Step 1-5 above. Start with the read-only audit (Step 1) and share the full hit list before making any changes. Apply pattern-specific fixes per the table (no bulk sed). Run verification matrix (Step 5) before committing.

### Done When
- [ ] `rg "python3" scripts/ --glob="*.sh" | grep -v "uv run" | grep -v "^#"` → 0 hits
- [ ] `bash -n` passes on all modified scripts
- [ ] `bash scripts/operations/setup-hooks.sh` exits 0
- [ ] `uv run --no-project python .claude/work-queue/scripts/generate-index.py` exits 0
- [ ] `git submodule foreach 'git diff --name-only'` → empty for all submodules

### For User Review
- Step 1 audit hit list — confirm no submodule scripts are in scope
- Any jq fallback chains in system-*.sh — review that restructured logic is correct
