---
id: WRK-058
title: "AQWA input backend — spec.yml to single .dat and modular deck files"
status: archived
priority: high
complexity: complex
created_at: 2026-01-31T00:00:00Z
target_repos:
  - digitalmodel
commit:
spec_ref:
related: [WRK-026, WRK-057, WRK-025, WRK-027]
blocked_by: [WRK-057]
synced_to: []
parent: WRK-026
---
# AQWA Input Backend — spec.yml to Single .dat and Modular Deck Files

## What
Implement a converter backend that takes a canonical `spec.yml` and generates AQWA-compatible input files in two modes:
1. **Single file**: Combined `.dat` file with all decks assembled
2. **Modular files**: Separate deck files (header/body/footer per deck 0-11) that can be independently edited and recombined

## Why
The existing `aqwa_dat_files.py` generates decks from YAML config but uses an AQWA-specific schema. This backend adapts the canonical spec to AQWA's deck-based input format, enabling solver-agnostic workflows.

## Existing Code to Leverage
- `src/digitalmodel/modules/aqwa/aqwa_dat_files.py` — `AqwaDATFiles` class with `get_dc_XX_body()` methods
- `src/digitalmodel/base_configs/modules/aqwa/template_decks/` — 30+ deck templates (01-18 header/body/footer)
- `src/digitalmodel/modules/aqwa/aqwa_pre_process.py` — pre-processing orchestrator
- `docs/modules/aqwa/examples/03_dat/` — real AQWA `.dat` example files

## Deck Mapping from Spec

| Spec Section | AQWA Deck | Cards |
|-------------|-----------|-------|
| analysis | Deck 0 | GENERAL, RESTART, OPTIONS |
| vessel.geometry | Deck 1 | COOR, NOD5, STRC (coordinates + nodes) |
| vessel.geometry | Deck 2 | ELM*, HYDI, FIXD (elements + topology) |
| vessel.mass | Deck 3 | MATE (mass properties) |
| vessel.inertia | Deck 4 | GEOM, PMAS (geometric/inertia) |
| environment | Deck 5 | GLOB (constants) |
| frequencies + headings | Deck 6 | FDR (frequency/direction) |
| solver_options | Deck 7+ | WFS, DRC, DRM etc. |

## Implementation Steps
1. Create `AQWABackend` class in `src/digitalmodel/modules/diffraction/backends/aqwa_backend.py`
2. Map canonical spec fields to AQWA deck card values
3. Single-file mode: assemble all decks into one `.dat` with proper sequencing
4. Modular mode: write each deck to separate files in `deck_XX/` directory with a `combine.sh` script
5. Mesh conversion: spec mesh (common format) → AQWA node/element format (Deck 1+2)
6. Validate generated `.dat` against known-good examples

## Acceptance Criteria
- [ ] `AQWABackend.generate_single(spec) → Path` produces valid `.dat` file
- [ ] `AQWABackend.generate_modular(spec) → Path` produces deck directory structure
- [ ] Generated `.dat` matches structure of `docs/modules/aqwa/examples/03_dat/001_ship_raos/001_ship_raos.dat`
- [ ] Mesh nodes/elements correctly formatted from common mesh format
- [ ] Parametric variation: change spec values → regenerate → diff shows only changed decks
- [ ] Tests using existing example data as ground truth

---
*Source: WRK-026 child — AQWA input backend*
