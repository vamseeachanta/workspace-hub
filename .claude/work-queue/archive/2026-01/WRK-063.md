---
id: WRK-063
title: "Reverse parsers — AQWA .dat and OrcaWave .yml to canonical spec.yml"
status: archived
priority: high
complexity: complex
created_at: 2026-01-31T00:00:00Z
target_repos:
  - digitalmodel
commit:
spec_ref:
related: [WRK-026, WRK-057, WRK-058, WRK-059, WRK-060]
blocked_by: [WRK-057]
synced_to: []
parent: WRK-026
---
# Reverse Parsers — AQWA .dat and OrcaWave .yml to Canonical spec.yml

## What
Build parsers that read existing solver-specific input files and produce a canonical `spec.yml`. This enables the key workflow: "I have a model in format X, generate format Y" by going through the canonical intermediate.

```
AQWA .dat ──AQWAParser──> DiffractionSpec ──to_yaml()──> spec.yml
OrcaWave .yml ──OrcaWaveParser──> DiffractionSpec ──to_yaml()──> spec.yml
```

Combined with the backends (WRK-058, WRK-059), this enables full cross-conversion:
```
AQWA .dat → spec.yml → OrcaWave .yml
OrcaWave .yml → spec.yml → AQWA .dat
```

## Why
Users often have existing models in one solver format and need to run the same analysis in another solver. Without reverse parsing, they would have to manually create a spec.yml from scratch. With reverse parsers, the workflow becomes:
1. Point at existing file
2. Auto-generate spec.yml
3. Generate target solver input

This also supports benchmarking (WRK-031): take an existing AQWA model, auto-convert to OrcaWave, run both, compare results.

## Existing Code to Leverage
- `aqwa/aqwa_dat_files.py` — `DATInspectionResult` already parses .dat files into structured data
- `aqwa/aqwa_lis_files.py` — LIS parser extracts results (post-processing, not input)
- `orcawave/diffraction/orchestrator.py` — reads OrcaWave .yml configs
- `bemrosetta/parsers/aqwa_parser.py` — parses AQWA .LIS output files
- `diffraction/aqwa_converter.py` — `AQWAConverter` reads AQWA outputs

## Implementation

### AQWA .dat → spec.yml Parser
```python
class AQWAInputParser:
    """Parse AQWA .dat input file into DiffractionSpec."""

    def parse(self, dat_path: Path) -> DiffractionSpec:
        """Read AQWA .dat and extract all sections into canonical spec."""
        # 1. Parse deck 0: analysis options
        # 2. Parse deck 1: node coordinates → mesh reference
        # 3. Parse deck 2: element topology → mesh reference
        # 4. Parse deck 3: mass properties
        # 5. Parse deck 4: inertia properties
        # 6. Parse deck 5: environment (water depth)
        # 7. Parse deck 6: frequencies and directions
        # 8. Assemble into DiffractionSpec

    def extract_mesh(self, dat_path: Path, output_path: Path) -> Path:
        """Extract mesh from deck 1+2 and write to common format (GDF/DAT)."""
```

### OrcaWave .yml → spec.yml Parser
```python
class OrcaWaveInputParser:
    """Parse OrcaWave .yml project file into DiffractionSpec."""

    def parse(self, yml_path: Path) -> DiffractionSpec:
        """Read OrcaWave YAML and extract all sections into canonical spec."""
        # 1. Parse UnitsSystem, SolveType → analysis_type
        # 2. Parse Bodies → vessel/bodies
        # 3. Parse Environment → environment
        # 4. Parse PeriodOrFrequency → frequencies
        # 5. Parse WaveHeading → wave_headings
        # 6. Parse solver settings → solver_options
        # 7. Resolve mesh file references
        # 8. Assemble into DiffractionSpec
```

### CLI Integration
```bash
# Parse existing AQWA model to spec
digitalmodel parse-to-spec model.dat --output spec.yml

# Parse existing OrcaWave model to spec
digitalmodel parse-to-spec model.yml --output spec.yml

# Full cross-conversion (shorthand)
digitalmodel convert model.dat --to orcawave --output ./orcawave_run/
digitalmodel convert model.yml --to aqwa --output ./aqwa_run/
```

## Acceptance Criteria
- [ ] `AQWAInputParser.parse(dat_path) → DiffractionSpec` for single-body models
- [ ] `OrcaWaveInputParser.parse(yml_path) → DiffractionSpec` for single-body models
- [ ] Mesh extraction from AQWA .dat to standalone mesh file
- [ ] Round-trip: AQWA .dat → spec.yml → AQWA .dat (structurally equivalent)
- [ ] Round-trip: OrcaWave .yml → spec.yml → OrcaWave .yml (structurally equivalent)
- [ ] Cross-conversion: AQWA .dat → spec.yml → OrcaWave .yml (validated manually)
- [ ] `parse-to-spec` CLI command
- [ ] `convert` CLI shorthand command
- [ ] Tests using existing example files as input

---
*Source: User requirement — if we have model in 1 format, we should be able to create a spec.yml and work towards other formats easily.*
