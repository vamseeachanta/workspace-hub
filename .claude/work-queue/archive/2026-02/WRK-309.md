---
id: WRK-309
title: "chore: portable Python invocation — consistent cross-machine execution, zero error noise"
status: archived
completed_at: 2026-02-23T17:30:08Z
priority: high
complexity: medium
compound: false
created_at: 2026-02-23T00:00:00Z
target_repos:
  - workspace-hub
commit:
spec_ref:
related: [WRK-308]
blocked_by: []
synced_to: []
plan_ensemble: false
ensemble_consensus_score: null
plan_reviewed: true
plan_approved: true
percent_complete: 90
brochure_status: pending
---

# chore: portable Python invocation — consistent cross-machine execution, zero error noise

## What

Part of the "consistent work experience across machines" theme. Two related issues that generate error noise and break flow when working on Windows:

1. **`python3` not found** — Windows exposes Python as `python`, not `python3`. Scripts and hooks that call `python3` fail with exit code 49. No functional problem exists — `python` works — but the error noise wastes agent turns and breaks the illusion of a reliable environment.

2. **`uv run python` per-file in hooks** — A hook spawns `uv run python` once per file across hundreds of files. On Windows, `uv run` startup overhead accumulates into a noticeable delay on every commit.

## Why

The goal is a workspace that feels the same on every machine — no platform-specific error noise, no Windows-only slowdowns. These two issues are the most visible cross-machine friction points in the current Python toolchain layer.

## Acceptance Criteria

- [x] All high-impact scripts use `scripts/lib/python-resolver.sh` (pre-existing; hardened with shim validation)
- [x] `python-resolver.sh` now validates each candidate via `python -c 'import sys; assert sys.version_info[0] >= 3'` — rejects Store shims
- [x] `check-encoding.sh` refactored to single `uv run python` batch call; NUL-safe `git -z` + `read -d ''` collection; `trap` cleanup
- [x] Verified: `check-encoding.sh` exits 0, no exit-49, single process (no per-file spawning)
- [x] Verified: resolver resolves `python` → Python 3.13.5 on Windows (python3 not in PATH)
- [x] Verified: `validate_work_queue_schema.sh` runs cleanly via resolver

## Plan

### Exploration Summary

- 9 scripts use bare `python3`; on Windows MINGW64, `python3` is not in PATH (exit 49) — `python` works
- `.claude/hooks/check-encoding.sh` calls `check_file()` per file (line 52), each spawning a fresh `uv run python` process; for 200 files on post-checkout this is 200× uv startup overhead
- No portable resolver pattern exists in the codebase today
- Scripts already using `uv run python` are unaffected — uv manages its own Python

### Steps

1. **Create `scripts/lib/python-resolver.sh`** — single portable resolver, sourced by all scripts
   - Resolves candidates in order (`python3`, then `python`), validates each with `"$candidate" -c 'import sys'` to reject Windows Store shims that exit 9009
   - Exports `PYTHON` or hard-exits with clear error if no working interpreter found
   - Usage: `. "$(git rev-parse --show-toplevel)/scripts/lib/python-resolver.sh"`

2. **Fix high-impact bare `python3` scripts** — source resolver, replace `python3` with `"${PYTHON}"` (quoted)
   - `scripts/cron/comprehensive-learning-nightly.sh:11`
   - `scripts/operations/compliance/normalize_work_queue_metadata.sh:28`
   - `scripts/operations/compliance/validate_work_queue_schema.sh:45`
   - `scripts/test/lib/invoke-pytest.sh:51`
   - `scripts/development/ai-workflow/auto-fix-loop.sh:228`
   - `scripts/ai/assessment/auto-sync-usage.sh:115,190,202,209`
   - `scripts/utilities/doc-to-context/doc2context.sh:60,97`

3. **Refactor `.claude/hooks/check-encoding.sh`** — batch all files into one `uv run python` call
   - Collect all paths from `collect_files()` using NUL-delimited output (`git ... -z`) end-to-end
   - Write NUL-separated paths to stdin of a single `uv run python` process that loops and returns bad files
   - Use `read -d ''` in the shell loop to handle paths with spaces/newlines safely
   - Eliminates the per-file `uv run` overhead; 200 files → 1 process

4. **Test**
   - `bash .claude/hooks/check-encoding.sh` — no exit 49, completes in <5s on 200+ files
   - `scripts/operations/compliance/validate_work_queue_schema.sh` — exits cleanly on Windows
   - `scripts/cron/comprehensive-learning-nightly.sh` availability check passes

### Verify

- Zero `python3: command not found` / exit-49 noise on Windows MINGW64
- `check-encoding.sh` runtime drops from O(N×uv-startup) to O(1×uv-startup)

### Review Log

| Iter | Date | Reviewer | Verdict | Findings | Fixed |
|------|------|----------|---------|----------|-------|
| P0 | 2026-02-23 | Claude | NO_OUTPUT | — | — |
| P0 | 2026-02-23 | Codex | REQUEST_CHANGES | 2 P2, 2 P3 | 2/2 P2 addressed in plan |
| P0 | 2026-02-23 | Gemini | NO_OUTPUT | — | — |

**P2 fixes applied to plan:**
- Resolver now validates candidate with `"$candidate" -c 'import sys'` to reject Windows Store shims
- `check-encoding.sh` batch uses NUL-delimited I/O end-to-end (`git -z`, `read -d ''`)

**P3 deferred:** Full `.claude/skills/` scan deferred to implementation (will do at time of change); `$PYTHON` quoting noted as implementation-time requirement.

## Agentic AI Horizon

- A portable `$PYTHON` resolver defined once (bootstrap or `.claude/rules/`) eliminates all per-script guessing across sessions and machines
- Batching file-level hooks into single-process invocations is a general pattern worth documenting as a rule for future hook authors

---
*Source: Hook calls `uv run python` per-file across hundreds of files — slow on Windows. `python3` not found (exit 49); `python` works. Theme: consistent cross-machine execution.*
