---
id: WRK-161
title: Parallel pipeline model — concurrent stage execution across sessions
status: archived
priority: medium
complexity: complex
compound: false
created_at: 2026-02-16T19:30:00Z
target_repos:
  - workspace-hub
commit: c9179ef
spec_ref:
related: [WRK-094, WRK-118, WRK-157, WRK-139]
blocked_by: [WRK-157]
synced_to: []
provider: claude
---

## What

Define and implement a parallel pipeline model where multiple sessions can work on different WRK items at different stages simultaneously (Session A plans WRK-X while Session B executes WRK-Y while Session C reviews WRK-Z).

## Why

Current workflow is sequential per session with no coordination across sessions. With 8 terminals active, throughput is limited by lack of pipeline awareness. Sessions don't know what other sessions are doing, leading to suboptimal work selection.

## Acceptance Criteria

- [ ] `work.sh list` shows which items are locked by which session (requires WRK-157)
- [ ] `work.sh next` recommends items based on pipeline balance (prefers stages with no active session)
- [ ] Pipeline stage distribution visible: count of items in each stage across all sessions
- [ ] Session dashboard: `session.sh status` shows all active sessions and their current WRK + stage
- [ ] No two sessions execute the same WRK item (enforced by WRK-157 locking)
- [ ] Stage overlap rules defined:
  - Same item: only one session at a time (serial)
  - Different items: any stages can run in parallel (no constraints)
- [ ] `session-state.yaml` extended to track multiple active sessions (array of session objects)
- [ ] Tests: 3 sessions claiming 3 different items in 3 different stages, `next` recommendation logic, dashboard output

## Plan

### Phase 1: Multi-session state (depends on WRK-157)
1. Extend `session-state.yaml` from single-session to multi-session format:
   ```yaml
   sessions:
     - session_id: "session-A"
       orchestrator_agent: claude
       active_wrk: WRK-126
       last_stage: plan_approval_gate
       locked_at: "2026-02-16T10:00:00Z"
     - session_id: "session-B"
       orchestrator_agent: claude
       active_wrk: WRK-121
       last_stage: implement_tdd
       locked_at: "2026-02-16T11:00:00Z"
   ```
2. Update `session-store.sh` to read/write session arrays
3. `session.sh init` registers new session; `session.sh end` deregisters

### Phase 2: Pipeline-aware work selection
4. Add `pipeline_balance()` to `workflow-guards.sh` — counts items per stage
5. `work.sh next` scores pending items by: priority > stage gap (prefer under-served stages) > age
6. Display pipeline distribution in `work.sh list` header

### Phase 3: Session dashboard
7. `session.sh status` reads all registered sessions, shows table:
   `SESSION_ID | PROVIDER | WRK | STAGE | DURATION`
8. Prune stale sessions (no heartbeat > 2h, matching WRK-157 lock TTL)

### Phase 4: Testing
9. Register 3 mock sessions with different WRK items and stages
10. Verify `work.sh next` recommends item in under-served stage
11. Verify `session.sh status` displays all 3 sessions
12. Verify stale session pruning

*Promoted from workflow-visual.html section 7 refinement candidates (2026-02-16)*
