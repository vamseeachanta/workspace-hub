---
id: WRK-108
title: "Agent usage credits display — show remaining quota at session start for weekly planning"
status: archived
percent_complete: 100
archived_at: 2026-02-13T23:05:00Z
commit: 484daf0
priority: medium
complexity: medium
created_at: 2026-02-10T00:00:00Z
target_repos:
  - workspace-hub
commit:
spec_ref:
related: [WRK-050]
blocked_by: []
synced_to: []
tags: [agent-tooling, productivity, planning]
---

# Agent Usage Credits Display

## What
Display agent usage credits and remaining weekly quota at the start of every agent session (claude, codex, gemini). Provides a quick dashboard so the user can plan which tasks to tackle given available budget.

## Why
Without visibility into remaining credits, sessions get interrupted mid-task when quotas run out. Showing usage upfront enables:
- **Weekly planning**: allocate heavy tasks (cross-reviews, large implementations) to days with high remaining quota
- **Session scoping**: choose smaller tasks when credits are low
- **Cost awareness**: track burn rate across agents over time
- **No surprises**: avoid starting a 2-hour task with 10 minutes of quota left

## Scope

### a/ Per-Agent Usage Query
- **Claude Code**: query usage via `claude` CLI or Anthropic API billing endpoint
- **Codex CLI**: query usage via OpenAI API usage endpoint
- **Gemini CLI**: query usage via Google AI API usage endpoint
- Determine which agents expose usage/quota data programmatically vs. require scraping a dashboard
- Fallback: if no API available, prompt user to manually enter quota (cached locally)

### b/ Session Startup Display
- On every new agent session, display a compact summary:
  ```
  Agent Credits (week of 2026-02-10):
    claude:  ███████░░░  72% remaining (18/25 hrs)
    codex:   █████░░░░░  50% remaining
    gemini:  ████████░░  80% remaining
  ```
- Color-coded: green (>50%), yellow (20-50%), red (<20%)
- Show absolute numbers where available, percentage otherwise
- Total wall-clock time or token count depending on what each API reports

### c/ Weekly Budget Tracking
- Log usage per session to `~/.agent-usage/weekly-log.jsonl`
- Each entry: `{timestamp, agent, tokens_used, duration_s, task_summary}`
- Weekly rollup script to summarize burn rate and project remaining capacity
- Reset tracking on Monday (configurable)

### d/ Integration with Shell Startup
- Hook into the same shell profile mechanism as WRK-050 Phase 4
- `dev-env-check.sh` / `.ps1` calls usage query as part of startup
- Keep total startup time <2s (usage query should be async/cached)
- Cache last-known usage for 15 minutes to avoid API calls on every terminal open

### e/ Planning Recommendations (stretch)
- Based on remaining weekly quota, suggest task sizing:
  - ">70% remaining": safe to run cross-reviews, large implementations
  - "30-70%": medium tasks, single-module work
  - "<30%": small fixes, documentation, planning only
- Optional: integrate with work queue to flag which WRK items fit remaining budget

## Acceptance Criteria
- [x] Usage query works for at least claude CLI (primary agent)
- [x] Compact usage summary displayed at session start
- [x] Weekly usage logged to local file
- [x] Cached to avoid slow startup
- [x] Works on Linux; Windows support follows WRK-050 Phase 4
- [x] Degrades gracefully if API unreachable (show "unknown" not error)

## Technical Notes
- Anthropic API: `GET /v1/usage` or check console.anthropic.com — research exact endpoint
- OpenAI API: `GET /v1/usage` or `GET /dashboard/billing/usage` — research exact endpoint
- Google AI: research Gemini API usage tracking
- Some agents may be on flat-rate plans (e.g. Claude Max) — handle "unlimited" as a valid state
- Privacy: usage logs stay local (`~/.agent-usage/`), never committed to repo

## Plan

### Data Sources (research findings)
- **Claude Code**: `~/.claude/stats-cache.json` — daily messageCount, sessionCount, toolCallCount. Subscription tier from `~/.claude/.credentials.json`. OAuth API blocked by Cloudflare.
- **Codex CLI**: `~/.codex/history.jsonl` — session entries with timestamps. No programmatic quota API for subscription users.
- **Gemini CLI**: `~/.config/gemini/` — no usage stats file available. Estimated from session activity.

### Implementation
1. **New script**: `scripts/ai/assessment/query-quota.sh` (~230 lines)
   - Queries Claude stats-cache.json (adjusts raw messageCount by 15x ratio for approx user requests)
   - Counts Codex history entries for today
   - Estimates Gemini from local data
   - Caches to `~/.cache/agent-quota.json` (15-min TTL)
   - Modes: `--refresh`, `--json`, `--log`, `--weekly`
2. **Updated statusline**: `.claude/statusline-command.sh` reads from cache instead of stale YAML
3. **Session integration**: `scripts/agents/session.sh init` displays credits + logs snapshot
4. **Updated config**: `config/ai-tools/usage-tracking.yaml` refreshed billing period, added quota_tracking section

*Approved by user: 2026-02-13*

---
*Source: user request — agent usage visibility for long-term planning, avoid mid-task quota exhaustion*
