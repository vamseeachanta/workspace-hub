---
id: WRK-285
title: "Write active WRK id to state file on working/ transition"
status: done
priority: high
complexity: simple
compound: false
created_at: 2026-02-21T00:00:00Z
completed_at: 2026-02-21T08:10:00Z
commit: 4c45748
target_repos:
  - workspace-hub
related: [WRK-284, WRK-286]
blocked_by: []
---

# Write active WRK id to state file on working/ transition

## What

No hook currently tracks which WRK item is "in scope" for a session. Downstream
hooks (readiness, traceability) must scan `working/` to infer this, which is
slow and unreliable when multiple items exist.

Create `.claude/state/active-wrk` as the single source of truth for the active
WRK id. This unblocks WRK-284 and WRK-286.

## Plan (Route A)

1. Add `set-active-wrk.sh` helper script — writes WRK id to state file
2. Agent (or skill) calls this when moving a WRK item to `working/` status
3. `wrk-traceability-check.sh` reads state file instead of scanning `working/`
4. `ensure-readiness.sh` clears state file at session end

## Acceptance Criteria

- [ ] `scripts/work-queue/set-active-wrk.sh <WRK-NNN>` writes id to `.claude/state/active-wrk`
- [ ] `scripts/work-queue/clear-active-wrk.sh` clears the file
- [ ] `wrk-traceability-check.sh` reads state file first, falls back to `working/` scan
- [ ] `ensure-readiness.sh` calls `clear-active-wrk.sh` at session end
- [ ] `/work` skill calls `set-active-wrk.sh` when transitioning to working status

## Implementation Notes

State file path: `${WORKSPACE_HUB}/.claude/state/active-wrk`
Format: single line, e.g. `WRK-284`
Add to `.gitignore` (session-local, not committed).

## Completion Notes (2026-02-21)

**Delivered** — commit `4c45748`, 7 files, 180 insertions.

### What was built
- `scripts/work-queue/set-active-wrk.sh` — validates `^WRK-[0-9]+$`, warns (non-fatal)
  if WRK file not found in work-queue, writes state file
- `scripts/work-queue/clear-active-wrk.sh` — idempotent removal
- `wrk-traceability-check.sh` — reads state file → format-validates (terminal injection
  guard) → glob fallback; added `git log --since=12h` to catch committed-in-session WRK
  changes (not just uncommitted status)
- `ensure-readiness.sh` — calls `clear-active-wrk.sh` at session end
- `workflow-guards.sh` `session_record_stage()` — mirrors to state file; surfaces
  failures to stderr without blocking
- `tests/work-queue/test-active-wrk.sh` — 12 tests (unit + hook integration in temp
  git repos); all passing

### Codex review iterations
- **Round 1**: REJECT — combined file cut off mid-function (artifact), `ls|grep|sed` pattern
- **Round 2**: REQUEST_CHANGES — swallowed errors in workflow-guards, injection risk
- **Round 3**: REQUEST_CHANGES — `git log` not session-scoped (12h heuristic), `find`
  option ordering, no integration tests
- **Round 4**: REQUEST_CHANGES — integration tests needed, session-scope limitation documented
- **Round 5**: **APPROVE**

### Open follow-up
- AC#5 (`/work` skill calls `set-active-wrk.sh` on working/ transition) — not addressed
  here; tracked in WRK-286
- Session-scoped git log (true session-start baseline) — noted as future improvement in
  comment; out of scope for WRK-285

## Session Notes (2026-02-21)

**Root cause**: Without a dedicated state file, hooks had to scan `working/` to infer
the active WRK item — slow and unreliable when multiple items coexist in that directory.

**Key insight**: `active-wrk` is the linchpin that unblocks both WRK-284 and WRK-286.
WRK-284 (readiness.sh WRK check) needs it as the source to read; WRK-286 (chore:
commit hardening) benefits from it to surface the active WRK ref in commit-msg warnings.

**Impl pointer**: `ensure-readiness.sh` already invokes cleanup at session end — the
clear-active-wrk call slotted in naturally there without new hook wiring.
