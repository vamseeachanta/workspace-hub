---
id: WRK-207
title: Wire model-tier routing into work queue plan.sh and execute.sh — Sonnet 4.6 default, Opus 4.6 for Route C plan only
status: done
priority: medium
complexity: simple
compound: false
created_at: 2026-02-18T00:00:00Z
target_repos:
  - workspace-hub
commit:
spec_ref:
related: []
blocked_by: []
synced_to: []
plan_reviewed: false
plan_approved: true
percent_complete: 100
brochure_status: n/a
tags:
  - model-routing
  - work-queue
  - cost-optimisation
  - sonnet-4-6
---

# Wire model-tier routing into work queue orchestration scripts

## What

`config/agents/model-registry.yaml` now defines `work_queue_routing` (added 2026-02-18):

```yaml
work_queue_routing:
  route_a:    {plan: sonnet-4-6, execute: sonnet-4-6, review: haiku-4-5}
  route_b:    {plan: sonnet-4-6, execute: sonnet-4-6, review: sonnet-4-6}
  route_c:    {plan: opus-4-6,   execute: sonnet-4-6, review: sonnet-4-6}
  sonnet_effort: medium
```

Wire this into `scripts/agents/plan.sh` and `scripts/agents/execute.sh` so they
auto-select the correct model based on route + phase rather than always defaulting
to the provider's `default_model`.

## Why

Opus 4.6 is ~5x more verbose than average (58M vs 11M tokens per Artificial Analysis
benchmark) and costs $5/$25/M. Using it for all work queue phases is wasteful and
risks draining the weekly quota on a single Route C plan.

Sonnet 4.6 is the correct default: $3/$15/M, concise, preferred by early access users
over Opus 4.5, and Anthropic recommends `effort=medium` for most use cases.

Rule: Opus only earns its token cost for Route C plan phases — complex multi-repo
architecture decisions that genuinely need deeper reasoning. Everything else → Sonnet 4.6.

## Acceptance Criteria

- [ ] `plan.sh` reads `work_queue_routing.<route>.plan` from model-registry.yaml via `model_registry.sh`
- [ ] `execute.sh` reads `work_queue_routing.<route>.execute` similarly
- [ ] Review scripts (`submit-to-claude.sh`) use `work_queue_routing.<route>.review` model
- [ ] `sonnet_effort: medium` passed as `--effort medium` when invoking Sonnet 4.6 via claude CLI
- [ ] Fallback: if route undetectable, default to `sonnet-4-6`
- [ ] `--model-override <model>` flag on plan.sh/execute.sh to bypass routing when needed
- [ ] Existing tests in `scripts/agents/tests/` still pass

## Plan

- **Files**: `scripts/agents/plan.sh`, `scripts/agents/execute.sh`, `scripts/agents/lib/model_registry.sh`
- **Change**: Add `wrk_resolve_model_for_phase()` helper in model_registry.sh; call from plan.sh + execute.sh
- **Test**: Add test cases to existing test suite for model resolution by route
- **Verify**: `bash scripts/agents/tests/test-task-agents-routing.sh`

---
*Source: User input 2026-02-18 — Opus 4.6 verbosity data from Artificial Analysis + Anthropic Sonnet 4.6 guidance*
