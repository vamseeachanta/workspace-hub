---
id: WRK-172
title: "AI agent usage tracking \u2014 real-time quota display, OAuth API, session\
  \ hooks"
status: done
priority: high
complexity: medium
compound: false
created_at: 2026-02-17 00:00:00+00:00
target_repos:
- workspace-hub
target_module: ai-tools
commit: null
spec_ref: null
related:
- WRK-118
- WRK-139
blocked_by: []
synced_to: []
plan_reviewed: true
plan_approved: true
percent_complete: 100
brochure_status: n/a
provider: claude
provider_alt: null
group: null
tags:
- ai-usage
- quota-tracking
- statusline
- hooks
- oauth
---

# AI Agent Usage Tracking — Real-Time Quota Display, OAuth API, Session Hooks

## Context

AI agent weekly usage percentage is the primary bottleneck governing orchestrator availability. Before this work, there was no real-time visibility into weekly usage across Claude, Codex, and Gemini providers.

## What

End-to-end implementation of real-time AI agent usage tracking:

1. **Claude OAuth API integration** — `GET /api/oauth/usage` returns weekly utilization %, 5-hour window %, and reset timestamp
2. **Codex local session parsing** — reads `~/.codex/sessions/*.jsonl` for rate limit data
3. **Gemini manual entry** — no programmatic API exists; manual `--set gemini=X` fallback
4. **Statusline display** — `C:94%↻ 12h O:27%↻ 6h G:0%` with color coding (green <50%, yellow 50-80%, red >80%)
5. **Auto-refresh** — background `query-quota.sh --refresh` when cache >15min old
6. **Session-end hooks** — Stop hooks for resource index generation and quota snapshot logging
7. **Resource Index** — auto-generated `.claude/RESOURCE_INDEX.md` cataloging all workspace resources

## Why

- Weekly Claude usage % is THE bottleneck — governs whether orchestrator sessions are possible
- Real-time visibility enables strategic allocation of remaining capacity
- Codex/Gemini tracking enables provider switching when one is near limit
- Session-end snapshots enable long-term usage trend analysis

## Acceptance Criteria

- [x] Claude weekly % fetched from OAuth API (not estimated from message counts)
- [x] Codex weekly % parsed from local session rate limits
- [x] Gemini supports manual entry with cache persistence
- [x] Statusline shows all 3 providers with weekly % and hours-to-reset
- [x] Auto-refresh triggers when quota cache >15min old
- [x] Stop hooks run at session end (resource index + quota snapshot)
- [x] Resource index generated with correct field names (week_pct, hours_to_reset)
- [x] MEMORY.md updated with API details and patterns

## Deliverables

### Files Created
- `scripts/generate-resource-index.sh` — generates `.claude/RESOURCE_INDEX.md`
- `.claude/RESOURCE_INDEX.md` — auto-generated resource catalog
- `config/ai-tools/agent-quota-latest.json` — repo-local quota cache

### Files Modified
- `scripts/ai/assessment/query-quota.sh` — complete rewrite from message estimation to OAuth API
- `.claude/statusline-command.sh` — weekly % display with color coding and reset times
- `.claude/settings.json` — 2 Stop hooks added
- `CLAUDE.md` — updated Resource Index section
- `.claude/rules/patterns.md` — added "Research Before Building" section

## Key Learnings

- **Research APIs first**: Built message-count estimation heuristics before discovering Claude has an OAuth usage API. Wasted effort. Added to patterns.md as a permanent rule.
- **stats-cache.json is session-end only**: Cannot be used for real-time tracking during active sessions.
- **Gemini has no usage API**: Manual entry is the only option.
- **CLAUDECODE env var**: Must unset when calling `curl` to Claude API to prevent interference.

## Dependencies

- **WRK-139** (done) — multi-agent orchestration framework
- **WRK-118** (pending) — broader AI agent utilization strategy
