---
id: WRK-113
title: "Maintain always-current data index with freshness tracking and source metadata"
status: done
priority: high
complexity: medium
compound: false
created_at: 2026-02-10T14:00:00Z
target_repos:
  - worldenergydata
commit: 1e1a111
spec_ref:
related: [WRK-076, WRK-054]
blocked_by: []
synced_to: []
plan_reviewed: false
plan_approved: false
percent_complete: 0
brochure_status:
---

# Maintain Always-Current Data Index with Freshness Tracking

## What

Enhance the data catalog system (`data/catalog/data-catalog.yml`) to be a living, always-current index of all worldenergydata datasets. Add source URL attribution, update frequency metadata, freshness timestamps (when data was last refreshed from upstream), LFS stub detection, and a staleness alerting mechanism. Ensure the catalog regenerates automatically after any data mutation.

## Why

The current catalog (generated 2026-02-08) captures file-level metadata (size, columns, mtime) but has `update_frequency: null` and `source_url: null` for all 356 datasets. There is no way to know:
- When data was last refreshed from its upstream source
- Which datasets are stale and need refresh
- Which files are LFS stubs vs real data
- What the canonical source URL is for each dataset

Without this, data readiness for analysis is unknown — you can't trust data you can't date.

## Current State

**Existing infrastructure:**
- `scripts/generate_data_catalog.py` — scans `data/modules/`, produces YAML catalog
- `src/worldenergydata/common/catalog.py` — DataCatalog, DatasetEntry, ModuleCatalogEntry dataclasses
- `data/catalog/data-catalog.yml` — 356 datasets across 9 modules

**What's missing from DatasetEntry:**
- `source_url` — always null (never populated)
- `update_frequency` — always null
- No `last_refreshed` field (distinct from `last_modified` which is file mtime)
- No `is_lfs_stub` field
- No `data_status` field (real / stub / empty / stale)

## Acceptance Criteria

- [ ] **Source metadata registry**: Create `data/catalog/source-registry.yml` mapping each module/dataset to its canonical source URL, expected update frequency, and data license
- [ ] **Freshness tracking**: Add `last_refreshed` timestamp field to DatasetEntry — set by data loaders/importers when they successfully fetch new data (distinct from file mtime)
- [ ] **LFS stub detection**: Catalog generator detects and flags LFS stubs (check first 40 bytes for `version https://git-lfs`), adds `is_lfs_stub: true/false` to each dataset entry
- [ ] **Data status field**: Each dataset gets `data_status`: `real` | `lfs_stub` | `empty` | `stale` | `unextracted`
- [ ] **Staleness calculation**: Dataset is `stale` if `last_refreshed` is older than `update_frequency` allows (e.g., quarterly dataset not refreshed in >100 days)
- [ ] **Catalog auto-regeneration**: Hook into data loader/importer exit paths so catalog refreshes after any data mutation
- [ ] **Summary dashboard**: `python3 scripts/generate_data_catalog.py --report` prints a freshness summary table to stdout: module | datasets | real | stubs | stale | last refreshed
- [ ] **Populate source URLs**: Fill in known source URLs for all modules from existing config files (`config/canada.yml`, `config/sodir.yml`, etc.) and BSEE scraper URLs
- [ ] **Tests**: Unit tests for LFS stub detection, staleness calculation, source registry loading
- [ ] **Existing tests pass**: No regression in 762 passing tests

## Plan

### Step 1: Source Metadata Registry (new file)
- **File**: `data/catalog/source-registry.yml` (new)
- **Content**: Per-module, per-dataset source metadata extracted from existing configs:
  ```yaml
  bsee:
    source_base_url: https://www.data.bsee.gov
    license: Public Domain (US Government)
    update_frequency: quarterly
    datasets:
      well_data:
        source_url: https://www.data.bsee.gov/Well/Files/APDRawData.zip
      production:
        source_url: https://www.data.bsee.gov/Production/Files/ProductionRawData.zip
  canada:
    source_base_url: https://api.aer.ca
    update_frequency: monthly
  sodir:
    source_base_url: https://factmaps.sodir.no
    update_frequency: monthly
  hse:
    osha:
      source_url: https://www.osha.gov/data
      update_frequency: annual
    epa_tri:
      source_url: https://www.epa.gov/toxics-release-inventory-tri-program
      update_frequency: annual
    bsee_incidents:
      source_url: https://www.data.bsee.gov/Incident/Files
      update_frequency: quarterly
  ```
- **Source**: Extract URLs from `config/canada.yml`, `config/sodir.yml`, `src/worldenergydata/bsee/data/scrapers/bsee_web.py`, `src/worldenergydata/hse/acquirers/`

### Step 2: Extend DatasetEntry Model
- **File**: `src/worldenergydata/common/catalog.py` (edit)
- **Add fields**:
  - `source_url: str | None = None`
  - `update_frequency: str | None = None` (daily/weekly/monthly/quarterly/annual/static)
  - `last_refreshed: str | None = None` (ISO datetime, set by loaders)
  - `is_lfs_stub: bool = False`
  - `data_status: str = "unknown"` (real/lfs_stub/empty/stale/unextracted)
- **Backward compatible**: All new fields optional with defaults

### Step 3: LFS Stub Detection in Generator
- **File**: `scripts/generate_data_catalog.py` (edit)
- **Change**: In `scan_binary_file()`, read first 40 bytes; if starts with `b"version https://git-lfs"`, set `is_lfs_stub=True`, `data_status="lfs_stub"`
- **Change**: For ZIP files in wind module, set `data_status="unextracted"`
- **Change**: For empty directories (pipeline_safety subdirs), set `data_status="empty"`

### Step 4: Source Registry Merge
- **File**: `scripts/generate_data_catalog.py` (edit)
- **Change**: After scanning files, load `source-registry.yml` and merge `source_url`, `update_frequency` into matching DatasetEntry objects
- **Change**: Calculate `data_status="stale"` if `last_refreshed` + `update_frequency` < now

### Step 5: Freshness Report CLI
- **File**: `scripts/generate_data_catalog.py` (edit)
- **Add**: `--report` flag that prints summary table:
  ```
  Module          | Datasets | Real | Stubs | Stale | Last Refreshed
  bsee            |      149 |   20 |   129 |     0 | 2026-02-08
  hse             |       12 |   12 |     0 |     0 | 2026-02-10
  marine_safety   |        8 |    8 |     0 |     3 | 2025-12-15
  ...
  ```

### Step 6: Tests
- **File**: `tests/test_data_catalog.py` (new)
- **Tests**:
  - LFS stub detection (mock .bin file with LFS header)
  - Staleness calculation (mock registry + dates)
  - Source registry loading and merging
  - Report output format
- **Verify**: `PYTHONPATH="src:../assetutilities/src" python3 -m pytest tests/test_data_catalog.py -v --tb=short --noconftest`

### Target Files

| Artifact | Path | Action |
|----------|------|--------|
| Source registry | `data/catalog/source-registry.yml` | New |
| Catalog model | `src/worldenergydata/common/catalog.py` | Edit (add fields) |
| Catalog generator | `scripts/generate_data_catalog.py` | Edit (LFS detection, registry merge, report) |
| Tests | `tests/test_data_catalog.py` | New |

---
*Source: User request — always maintain an up-to-date index for data, informed by data readiness assessment showing null source_url and update_frequency across all 356 datasets*
