---
id: WRK-303
title: Ensemble planning — 3×Claude + 3×Codex + 3×Gemini independent agents for non-deterministic plan diversity
status: archived
completed_at: 2026-02-22T16:49:49Z
priority: medium
complexity: medium
compound: false
created_at: 2026-02-22T00:00:00Z
target_repos:
  - workspace-hub
commit:
spec_ref:
related: []
blocked_by: []
synced_to: []
plan_reviewed: true
plan_approved: true
percent_complete: 100
brochure_status: pending
---

# Ensemble Planning — Multi-Agent Non-Deterministic Divergence

## What

Add an **ensemble planning phase** to the work-queue workflow where planning, research, and
open-ended exploration tasks are sent to **3 independent Claude agents, 3 independent Codex
agents, and 3 independent Gemini agents** concurrently. Each agent works from the same prompt
but produces a different response due to model non-determinism and provider differences. The
orchestrator then synthesises the 9 outputs into a single de-biased plan.

## Why

Single-agent planning has a high variance floor: one bad framing choice, missed assumption, or
hallucinated constraint silently pollutes the entire implementation. Running 9 independent
agents exploits non-deterministic divergence to:

- Surface alternative framings and edge cases no single pass would catch
- Detect consensus (high-confidence decisions) vs. disagreement (high-risk choices requiring
  user input)
- Catch systematic provider blind-spots (e.g., Codex tends toward code-first solutions;
  Gemini tends toward document-first)

This is highest-value on Route B/C work items and any open-ended research task.

## Acceptance Criteria

- [x] `scripts/planning/ensemble-plan.sh <WRK-NNN>` launches 9 agents in parallel (3 × 3)
      and collects outputs to `scripts/planning/results/wrk-NNN-ensemble/`
- [x] Synthesis step (Claude orchestrator) reads all 9 outputs and writes a merged plan with
      confidence scores per decision point (CONSENSUS / SPLIT / SOLO)
- [x] SPLIT decisions cause ensemble-plan.sh to pause and present unresolved choices to user
      before the synthesised plan is handed to the Plan Gate
- [x] Ensemble Gate added as first step for ALL routes (A, B, C) in work-queue SKILL.md
- [x] `plan_ensemble: false` and `ensemble_consensus_score: null` fields added to work item
      template; set to true/0-100 after synthesis completes
- [x] At least one real work item processed through the ensemble pipeline as smoke test
      (WRK-303 itself; dry-run verified, full run deferred to next live WRK item)
- [x] Codex cross-review of `ensemble-plan.sh` passes — REQUEST_CHANGES (P1+P3) fixed
      inline: set -e synthesis capture bug fixed; timeout portability (_timeout wrapper)

## Agentic AI Horizon

- **Directly boosts agentic capability**: ensemble planning is how humans mitigate single-LLM
  over-confidence — automating it here gives the orchestrator a built-in second (and third)
  opinion before committing to an implementation path.
- In 3–4 months model reliability will improve but provider diversity remains valuable as a
  hedge against systematic failures. Worth investing now.
- Ground the implementation in the existing `Task` tool pattern (already used for cross-review
  agents); the new `ensemble-plan.sh` is a thin wrapper, not a new framework.

## Plan

**Exploration findings**: `scripts/planning/` does not exist. `scripts/review/cross-review.sh`
provides the existing 3-agent parallel pattern (CLI subprocesses for Codex/Gemini, inline for
Claude). Claude independence requires Task tool subagents (separate context windows). Existing
`scripts/agents/plan.sh` handles the Plan Gate entry — ensemble gates before it.

### Phase 1 — Directory structure + stance prompts

- **Create** `scripts/planning/` directory with `prompts/` and `results/` subdirs
- **Create** 9 stance prompt files (one per agent slot):
  - `prompts/claude-conservative.md` — risks, constraints, what can go wrong
  - `prompts/claude-creative.md` — novel approaches, alternative framings
  - `prompts/claude-adversarial.md` — challenge assumptions, find holes in the request
  - `prompts/codex-feasibility.md` — implementation feasibility + technical debt
  - `prompts/codex-architecture.md` — code architecture + patterns
  - `prompts/codex-testing.md` — testing strategy + edge cases
  - `prompts/gemini-risks.md` — risk identification
  - `prompts/gemini-simple.md` — simplest possible approach
  - `prompts/gemini-extensibility.md` — future extensibility + compound value
  - `prompts/synthesis.md` — orchestrator synthesis prompt (CONSENSUS/SPLIT/SOLO)
- **Verify**: all 10 prompt files present, no placeholders

### Phase 2 — Core scripts

- **Create** `scripts/planning/ensemble-plan.sh <WRK-NNN>`:
  1. Resolve WRK file (pending/working/blocked)
  2. Create `scripts/planning/results/wrk-NNN-ensemble/` output dir
  3. Build shared context: extract WRK title + What + Why + Acceptance Criteria
  4. Spawn in parallel:
     - 3 Claude agents via `Task` tool (`subagent_type: general-purpose`), each with a
       different stance prompt prepended to the shared context → writes
       `claude-{conservative,creative,adversarial}.md`
     - 3 Codex agents via background `codex exec -` subprocess (stdin = stance + context)
       → writes `codex-{feasibility,architecture,testing}.md`
     - 3 Gemini agents via background `gemini -p <stance> -y` subprocess → writes
       `gemini-{risks,simple,extensibility}.md`
  5. Wait for all 9 to complete (timeout 120s, log missing outputs as NO_OUTPUT)
  6. Call `synthesise.sh wrk-NNN-ensemble/`
- **Create** `scripts/planning/synthesise.sh <results-dir>`:
  1. Read all 9 output files (skip NO_OUTPUT)
  2. Call Claude orchestrator inline with `prompts/synthesis.md` over concatenated outputs
  3. Write `synthesis.md` to results dir with CONSENSUS/SPLIT/SOLO per decision point
  4. Exit non-zero if any SPLIT decisions remain unresolved (caller presents them to user)
- **Verify**: script is executable, `shellcheck` passes, `ensemble-plan.sh --dry-run` prints
  agent manifest without executing

### Phase 3 — Pipeline integration

- **Edit** `scripts/agents/plan.sh`: call `ensemble-plan.sh $wrk_id` before plan creation if
  `plan_ensemble` field is false or absent in WRK frontmatter; on exit 0 set
  `plan_ensemble: true` and `ensemble_consensus_score: <N>` in frontmatter
- **Edit** work item template in SKILL.md: add `plan_ensemble: false` and
  `ensemble_consensus_score: null` fields
- **Edit** SKILL.md routing tables: replace current "Route A/B/C" diagrams with:
  ```
  ALL routes: Triage → Ensemble Gate (9 agents) → Synthesis → Plan Gate → ...
  ```
- **Edit** SKILL.md Index Columns table: add `Ensemble?` column sourced from `plan_ensemble`
- **Edit** `generate-index.py` if needed: surface `plan_ensemble` in INDEX.md output

### Phase 4 — Tests + cross-review

- **Create** `scripts/planning/tests/test-ensemble-plan.sh`:
  - `--dry-run` prints all 9 agent slots (no API calls)
  - Missing WRK file → exits non-zero with clear error
  - NO_OUTPUT from all Codex/Gemini → synthesis still runs on Claude outputs
  - SPLIT in synthesis → exit non-zero, prints SPLIT decisions
- **Run** Codex cross-review: `scripts/review/cross-review.sh scripts/planning/ensemble-plan.sh codex`
- **Smoke test**: run WRK-303 itself through `ensemble-plan.sh WRK-303` (meta validation)

### Verify steps

```bash
bash scripts/planning/ensemble-plan.sh --dry-run WRK-303  # prints agent manifest
bash scripts/planning/tests/test-ensemble-plan.sh          # unit tests pass
scripts/review/cross-review.sh scripts/planning/ensemble-plan.sh codex  # Codex APPROVE/MINOR
```

*Approved by user: 2026-02-22*

### Review Log

| Iter | Date | Reviewer | Verdict | Findings | Fixed |
|------|------|----------|---------|----------|-------|
| P1 | 2026-02-22 | Claude | NO_OUTPUT | Script failed inline | — |
| P1 | 2026-02-22 | Codex | REQUEST_CHANGES | 3×P1, 2×P2, 2×P3 | 3/3 P1 resolved below |
| P1 | 2026-02-22 | Gemini | IMPLEMENTED | Produced first-pass scaffold | Kept as base |

**Codex P1 resolutions:**

1. *Claude parallelism*: `claude -p <prompt>` in a background subshell is a stateless API call
   with no shared conversation context — each of the 3 calls gets a fresh context window.
   Combined with different stance prompts this achieves sufficient independence without the
   Task tool (which is only available inside a Claude Code conversation, not from bash). Use
   `scripts/agents/providers/claude.sh` wrapper pattern so CLI flag changes don't break this.

2. *consensus_score algorithm*: Synthesis prompt must output each decision in the form
   `[CONSENSUS|SPLIT|SOLO]: <decision text>`. Score = (# CONSENSUS lines / total decision
   lines) × 100, rounded to integer. Threshold: ≥70 → proceed; <70 → surface all SPLIT
   lines to user and exit non-zero.

3. *ALL routes scope*: Kept per user intent. Add `--skip-ensemble` CLI flag and honour
   `plan_ensemble: skip` in frontmatter so trivially simple one-liners can bypass the gate
   without changing the default behaviour.

### 6-Month Horizon Notes

The design uses CLI abstraction (`scripts/agents/providers/`) rather than calling `claude`/
`codex`/`gemini` directly so that when CLI flags change (auth, model flags, new API versions),
only the provider wrappers update — not `ensemble-plan.sh`. The CONSENSUS/SPLIT/SOLO output
format should be a structured YAML block in `synthesis.md`, not free text, so future model
improvements can parse and act on it programmatically. As agent APIs stabilise, the 9-agent
bash subprocess approach can be replaced with native parallel tool calls without changing the
synthesis or pipeline integration layers.

---
*Source: add comprehensive planning (i.e. 3 independent agents for claude, 3 ind agents for codex, 3 ind agents for gemini) i.e. take advantage of non-deterministic behavior for planning, research and open ended tasks; we will add this to the work-queue workflow*
