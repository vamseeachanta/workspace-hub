---
id: WRK-307
title: Fix KVM display loss on ace-linux-2 after switching — EDID emulator or config fix
status: archived
priority: medium
complexity: simple
compound: false
created_at: 2026-02-22T00:00:00Z
computer: ace-linux-2
target_repos:
  - workspace-hub
commit:
spec_ref:
related: [WRK-287, WRK-050, WRK-342]
blocked_by: []
synced_by: []
plan_reviewed: true
plan_approved: true
percent_complete: 100
brochure_status: n/a
---
# Fix KVM display loss on ace-linux-2 after KVM switch

## What

After switching away from ace-linux-2 on the KVM and switching back, the display shows no
signal. The machine is alive (SSH works) but the NVIDIA T400 stops outputting video.

## Why

Unusable without a display. Switching to ace-linux-2 via KVM requires SSH workaround every
time, which defeats the purpose of a KVM setup.

## Diagnosis

- OS: Ubuntu 24.04, Wayland (GDM), NVIDIA T400 4GB
- Display output: `card2-DP-3` (DisplayPort) shows `connected` in sysfs — OS sees monitor
- NVIDIA X11 driver names outputs `DFP-0..DFP-5` (not `DP-*`); monitor is on **DFP-5** (boot display)
- GDM running; session active on `seat0 tty2` (session ID 5)
- Root cause: **KVM drops EDID signal on switch** — NVIDIA GPU stops driving output when
  EDID is lost, does not auto-recover when KVM switches back
- Workaround: `ssh vamsee@ace-linux-2 "loginctl unlock-session <id>"` from ace-linux-1
  (sometimes restores display; if not, `sudo systemctl restart gdm` works but kills session)

## Applied Fix (2026-02-23) — Option B/C

- GDM switched from Wayland → X11: `WaylandEnable=false` in `/etc/gdm3/custom.conf`
- EDID captured from sysfs: `/etc/X11/edid.bin` (256 bytes, Samsung U32J59x)
- Xorg config: `/etc/X11/xorg.conf.d/10-force-display.conf`
  ```
  Section "Device"
      Identifier "NVIDIA T400"
      Driver "nvidia"
      BusID "PCI:129:0:0"
      Option "ConnectedMonitor" "DFP-5"
      Option "CustomEDID" "DFP-5:/etc/X11/edid.bin"
  EndSection
  ```
- **Status: Working** — display survives KVM switches
- **Recovery script**: `scripts/operations/system/fix-kvm-display-ace-linux-2.sh`
  - Run from ace-linux-1: `bash scripts/operations/system/fix-kvm-display-ace-linux-2.sh`
  - With GDM restart: `bash scripts/operations/system/fix-kvm-display-ace-linux-2.sh --restart-gdm`

## Quick Recovery (no script)

```bash
# Step 1 — try unlock first (no session kill)
ssh vamsee@ace-linux-2 "loginctl unlock-session $(loginctl list-sessions | awk '/seat0/{print $1}')"

# Step 2 — if that fails, restart GDM (kills active session)
ssh vamsee@ace-linux-2 "sudo systemctl restart gdm"
```

## Risks of Software Fix

- X11 is being deprecated in Ubuntu; future LTS may drop it
- If config is lost (OS reinstall, update), display breaks again — re-run recovery script
- Permanent fix: hardware EDID dongle (Option A below)

## Acceptance Criteria

- [x] Display recovers after KVM switch (software fix applied 2026-02-23)
- [x] Recovery script available: `scripts/operations/system/fix-kvm-display-ace-linux-2.sh`
- [ ] No manual SSH intervention required — hardware dongle on hold (Option A deferred)
- [x] Solution documented in aceengineer-02.md and hardware.md (2026-02-23)

## Plan

**Option A — Hardware (recommended):** Purchase DisplayPort EDID emulator dongle (~$10).
Plug into the KVM output port for ace-linux-2. Maintains fake EDID signal so NVIDIA T400
always thinks a monitor is connected regardless of KVM position.
- Search: "DisplayPort EDID emulator" or "DP dummy plug"
- Verify DP connector matches KVM output (DP vs mini-DP vs HDMI adapter)

**Option B/C — Software (APPLIED 2026-02-23):** ✓
Switch GDM → X11 and force EDID via Xorg config. Working but X11 dependent.
Re-apply via: `bash scripts/operations/system/fix-kvm-display-ace-linux-2.sh --restart-gdm`

## Remote Desktop Fallback (ace-linux-1 → ace-linux-2)

When KVM display is lost, view/control ace-linux-2 desktop from ace-linux-1 via x11vnc.
x11vnc shares the **physical X11 session** (same as what KVM shows) — not a new session.

**Why x11vnc over xrdp:** xrdp (already installed, inactive) creates a separate independent
session. x11vnc mirrors the physical display — you see exactly what the KVM would show.

### Step 1 — Install x11vnc on ace-linux-2 (once, run directly on ace-linux-2)

```bash
sudo apt install x11vnc
```

### Step 2 — Start x11vnc on ace-linux-2 (run directly on ace-linux-2)

```bash
x11vnc -display :1 -auth /run/user/1000/gdm/Xauthority -forever -bg -nopw -listen localhost -rfbport 5900
```

- `-display :1` — share the physical X11 display (GDM allocates `:1`, not `:0`)
- `-auth /run/user/1000/gdm/Xauthority` — explicit path (`-auth guess` fails on this system)
- `-forever` — keep running after first client disconnects
- `-bg` — run in background
- `-nopw` — no password (safe: bound to localhost only)
- `-listen localhost` — LAN-only, not exposed externally
- `-rfbport 5900` — standard VNC port

Confirm running:
```bash
pgrep -a x11vnc
```

### Step 3 — Connect from ace-linux-1

Open a terminal on ace-linux-1 and run:

```bash
# Open SSH tunnel (background)
ssh -L 5900:localhost:5900 vamsee@ace-linux-2 -N &

# Connect VNC viewer (install if needed: sudo apt install tigervnc-viewer)
vncviewer localhost:5900
```

Or use Remmina (GUI, already likely installed on ace-linux-1):
- New connection → Protocol: VNC → Server: `localhost:5900`
- First create the SSH tunnel (`ssh -L ...`) then connect Remmina

### Step 4 — Make x11vnc auto-start at login (optional, run on ace-linux-2)

Add to GDM autostart so VNC is always available after login:

```bash
mkdir -p ~/.config/autostart
cat > ~/.config/autostart/x11vnc.desktop << 'EOF'
[Desktop Entry]
Type=Application
Name=x11vnc
Exec=x11vnc -display :1 -auth /run/user/1000/gdm/Xauthority -forever -nopw -listen localhost -rfbport 5900
Hidden=false
NoDisplay=false
X-GNOME-Autostart-enabled=true
EOF
```

### Step 5 — Test tunnel from ace-linux-1

Run these commands on **ace-linux-1**:

```bash
# 1. Open SSH tunnel (runs in background)
ssh -L 5900:localhost:5900 vamsee@ace-linux-2 -N &
TUNNEL_PID=$!

# 2. Connect VNC viewer (install if needed: sudo apt install tigervnc-viewer)
vncviewer localhost:5900

# 3. When done, kill the tunnel
kill $TUNNEL_PID
```

Or via Remmina (GUI):
1. Open terminal on ace-linux-1: `ssh -L 5900:localhost:5900 vamsee@ace-linux-2 -N &`
2. Open Remmina → New connection → Protocol: VNC → Server: `localhost:5900` → Connect

You should see the ace-linux-2 physical desktop (same as KVM output).

### Acceptance Criteria for Remote Desktop

- [x] x11vnc installed on ace-linux-2
- [x] VNC accessible from ace-linux-1 via SSH tunnel (verified with TigerVNC 2026-02-23)
- [x] x11vnc autostart configured (`~/.config/autostart/x11vnc.desktop`)

## Agentic AI Horizon

- Hardware fix (EDID dongle) is straightforward and permanent — do it
- x11vnc setup is a one-line install, no AI deferral warranted

---
*Source: KVM switch display loss diagnosed 2026-02-22 via SSH from ace-linux-1. See WRK-287 session log for full diagnosis details.*
