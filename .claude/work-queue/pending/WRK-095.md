---
id: WRK-095
title: Engineering unit tracking system — spec to code lifecycle
status: pending
priority: high
complexity: complex
compound: false
created_at: 2026-02-03T00:00:00Z
target_repos:
  - rock-oil-field
commit:
spec_ref:
related: []
blocked_by: []
synced_to: []
---

# Engineering Unit Tracking System — Spec to Code Lifecycle

## What
Build a system that tracks engineering units (e.g. force, pressure, length, mass, time) through the entire lifecycle: from specification/definition, through input parsing, internal computation, and all the way to code output/reporting. Ensures unit consistency, traceability, and correctness across the full engineering analysis pipeline.

## Why
Engineering software must handle physical units rigorously. Errors in unit conversion or inconsistent unit assumptions are a leading cause of engineering failures. A lifecycle-aware unit tracking system prevents unit mismatch bugs, documents unit provenance, and enables automated verification that inputs, intermediate calculations, and outputs all use consistent and correct units.

## Scope
1. **Spec layer** — Define canonical unit systems (SI, Imperial, custom) and unit registry with conversion factors
2. **Input layer** — Parse and validate units from user input, config files, and external data sources; tag values with their unit metadata
3. **Computation layer** — Propagate units through calculations; detect and flag unit mismatches during arithmetic operations
4. **Output layer** — Format results with correct units; support unit conversion on output; generate unit audit trail
5. **Lifecycle traceability** — Each quantity carries its unit history from source to sink

## Acceptance Criteria
- [ ] Unit registry with extensible unit definitions (SI base + derived, Imperial, custom)
- [ ] Input parser that associates values with validated units
- [ ] Unit propagation through arithmetic operations (multiply, divide, add with compatibility check)
- [ ] Automatic conversion between compatible units
- [ ] Unit mismatch detection raises clear errors at computation boundaries
- [ ] Output formatter respects target unit system preferences
- [ ] Audit trail: any output value can trace its unit lineage back to input
- [ ] Test coverage: unit conversion accuracy, mismatch detection, lifecycle traceability
- [ ] Documentation of supported units and extension mechanism

## Plan

**Target**: `rock-oil-field/src/rock_oil_field/units/` (integration layer)
**Foundation**: `assetutilities/src/assetutilities/units/` (already implemented — 687 lines, 11 files)

### Existing Assets in assetutilities (already done)
- `registry.py` — Singleton pint UnitRegistry with custom energy/offshore units
- `quantity.py` — `TrackedQuantity` wrapper with full provenance tracking (198 lines)
- `computation.py` — `@unit_checked` decorator for function-level unit validation (80 lines)
- `input_parser.py` — Config parsing with 3 unit systems (SI, inch, metric_engineering), 40 field mappings
- `output_formatter.py` — Display formatting and audit trail export
- `traceability.py` — `CalculationAuditLog` for aggregating inputs/outputs/steps
- `domains/energy.py` — 36 energy unit mappings (BOE, MCF, MMBTU, etc.)
- `domains/metocean.py` — Speed, length, temperature, pressure converters
- `domains/offshore.py` — 9 offshore-specific field mappings
- **10 test files** with comprehensive coverage

### Gaps to Fill (from research)
1. **Rock-Oil-Field integration layer** — S7 scripts pass raw numerics, no unit tracking
2. **Unit mismatch detection** — Arithmetic errors are generic pint errors, not engineering-friendly
3. **Compound unit parsing** — Cannot parse "MPa/m", "kg/m³" from config. **Verify first**: test `pint.UnitRegistry().parse_expression('MPa/m')` — pint may already handle this natively. Remove from gap list if so.
4. **Unit system enforcement** — No project-wide policy (e.g., "all inputs must be SI")
5. **Dimension analysis** — No `quantity.dimensions()` or dimensional consistency checks
6. **Lifecycle visualization** — Provenance is flat list; no DAG or SVG flow diagram
7. **Template-based output** — Hardcoded 4 decimal places; no per-quantity-type formatting

### Phase 1 — Rock-Oil-Field Integration Layer
- **Prerequisite**: Verify `rock-oil-field/src/rock_oil_field/units/` path exists. If not, create the package directory. Current `rock-oil-field/src/` contains only `modules/` — adjust target path if package structure differs.
- `rock_oil_field/units/__init__.py` — Re-export from assetutilities
- `orcaflex_adapter.py` — Wrap OrcaFlex parameters with TrackedQuantity:
  - Read model parameters (nodes, lines) with units
  - Wrap hydrodynamic outputs (Hs, current_speed) as TrackedQuantity
  - Format for OrcaFlex input files with unit conversion
- Examples: show unit tracking through a typical S7 analysis workflow (specify explicit file paths for the S7 scripts to be instrumented)

### Phase 2 — Enhanced Unit Safety
- `quantity.py` updates: Custom exception for unit mismatch in arithmetic (engineering-friendly messages)
- `policy.py` — `UnitSystemPolicy(system, strict, auto_convert)` for project-wide enforcement
- `input_parser.py` updates: Support compound units ("Pa/m", "kN*m")

### Phase 3 — Lifecycle Traceability
- `visualization.py` — DAG representation of quantity lineage, SVG/HTML export. **Time-box to 2 days. If not complete, defer DAG visualization to separate WRK item.**
- `output_formatter.py` updates: Template system for per-quantity-type formatting
- `traceability.py` updates: Filtering by unit system, export options

### Phase 4 — Documentation & Examples
- `docs/units-guide.md` — Tutorial: adding custom units, domain adapters, using @unit_checked
- Integration examples with real S7 analysis scripts

### Phase 5 — Tests
- Unit tests for new integration layer
- Mismatch detection tests with engineering scenarios
- Policy enforcement tests
- Round-trip: config → parse → compute → format → verify units preserved

### Review Notes
- **Verdict**: Claude: MINOR | Codex: MINOR | Gemini: APPROVE
- **Actions taken**:
  - Phase 1: Added prerequisite to verify target path exists (`rock_oil_field/units/` not found on disk)
  - Phase 1: Added requirement to specify explicit S7 script file paths (not just "S7 scripts")
  - Gap #3: Added verification step — pint may already handle compound units natively
  - Phase 3: Time-boxed DAG visualization to 2 days to prevent scope creep
  - Codex additionally requested: clarify assetutilities dependency mechanism (submodule/pip/path), define error class name and location
- *Cross-reviewed: 2026-02-09*

*Approved by user: 2026-02-09*

---
*Source: for engineering work, to track units all the way from spec, input and all the way to code and output. the entire lifecycle as a typical engineering process*
