---
id: WRK-043
title: Parametric hull form analysis with RAO generation and client-facing lookup
  graphs
status: pending
priority: low
complexity: complex
created_at: 2026-01-29 12:00:00+00:00
target_repos:
- digitalmodel
commit: null
spec_ref: null
related:
- WRK-034
blocked_by: []
synced_to: []
provider: claude
provider_alt: null
task_agents:
  phase_1: claude
  phase_2: claude
  phase_3: codex
  phase_4: codex
  phase_5: codex
  phase_6: codex
plan_reviewed: false
plan_approved: false
computer: ace-linux-1
execution_workstations: [ace-linux-1]
plan_workstations: [ace-linux-1]
percent_complete: 70
---

# Parametric hull form analysis with RAO generation and client-facing lookup graphs

## What
Run parametric analysis across many hull forms to establish RAOs (Response Amplitude Operators), then generate lookup graphs suitable for displaying to clients. The system should support batch execution across hull form variations and produce polished, presentation-ready output.

## Why
Clients need quick visual reference for vessel motion characteristics across different hull forms. A parametric approach with pre-computed RAOs and lookup graphs enables rapid comparison, informed decision-making, and professional client deliverables without re-running analyses each time.

## Acceptance Criteria
- [x] Parametric hull form definitions (varying key parameters: beam, draft, length, displacement, etc.)
- [ ] Batch analysis pipeline to run diffraction analysis across hull form variations — DEFERRED (requires OrcaWave/AQWA runtime)
- [ ] RAO extraction for key responses (heave, pitch, roll, surge, sway, yaw) — DEFERRED with Phase 2
- [x] RAO database/storage indexed by hull form parameters
- [x] Lookup graph generation — RAO plots per hull form and comparison across forms
- [x] Client-facing graph formatting (professional styling, clear labels, legends)
- [x] Ability to query/filter by hull parameters and retrieve corresponding RAO graphs
- [ ] Documentation of hull form parametric ranges and analysis assumptions — DEFERRED (Phase 5/6)

## Plan

> **Related**: WRK-034 (hull library -- foundation). Builds directly on the existing `hull_library/` and `diffraction/` modules.

### Phase 1: Parametric Hull Form Definition

Define a parametric hull variation schema that generates hull profiles by scaling principal dimensions from a base hull.

**Target files (new)**:
- `src/digitalmodel/hydrodynamics/hull_library/parametric_hull.py` -- parametric variation schema + hull generator

**Target files (existing -- reference)**:
- `src/digitalmodel/hydrodynamics/hull_library/profile_schema.py` (326 lines) -- `HullProfile`, `HullStation`, `HullType`
- `src/digitalmodel/hydrodynamics/hull_library/catalog.py` (413 lines) -- `HullCatalog`, `HullVariation`, `HullCatalogEntry`

**Schema models in `parametric_hull.py`**:
```
ParametricRange:
    min: float
    max: float
    steps: int
    # Generates np.linspace(min, max, steps)

HullParametricSpace:
    base_hull: str                       # Hull ID in catalog
    length_bp_range: ParametricRange | None
    beam_range: ParametricRange | None
    draft_range: ParametricRange | None
    depth_range: ParametricRange | None
    block_coefficient_range: ParametricRange | None
    # Optional fixed overrides
    fixed_params: dict[str, float]       # e.g., {"length_bp": 200.0}

    def combinations() -> Iterator[dict[str, float]]:
        """Cartesian product of all non-None ranges."""

    def generate_profiles(catalog: HullCatalog) -> Iterator[tuple[str, HullProfile]]:
        """Yield (variation_id, scaled_profile) pairs."""
```

The existing `HullVariation` model in `catalog.py` (line 76-84) already has `scale_factors: dict[str, float]` -- the parametric space just automates generating many variations.

**Test file**:
- `tests/hydrodynamics/hull_library/test_parametric_hull.py`

**Steps (TDD)**:
1. Write tests: `ParametricRange(min=10, max=20, steps=3)` generates `[10, 15, 20]`
2. Write tests: `HullParametricSpace` with beam and draft ranges generates correct cartesian product
3. Write tests: `generate_profiles()` scales base hull stations proportionally (half-breadths scale with beam, z-offsets scale with draft)
4. Write tests: Generated profiles pass `HullProfile` validation (stations within dimensions)
5. Write tests: Fixed params override range values
6. Implement `ParametricRange` and `HullParametricSpace` as Pydantic models
7. Implement `generate_profiles()` using `HullProfile.from_yaml_dict()` with scaled values

### Phase 2: Batch Diffraction Analysis Pipeline

Orchestrate diffraction analysis across all hull form variations using the existing `OrcaWaveBatchRunner` as a pattern.

**Target files (new)**:
- `src/digitalmodel/hydrodynamics/hull_library/batch_rao_runner.py` -- batch RAO generation across hull variations

**Target files (existing -- reference)**:
- `src/digitalmodel/hydrodynamics/diffraction/orcawave_batch_runner.py` (~300 lines) -- `OrcaWaveBatchRunner`, `OrcaWaveBatchConfig`, `BatchJobConfig`
- `src/digitalmodel/hydrodynamics/diffraction/orcawave_runner.py` -- `OrcaWaveRunner`, `RunConfig`
- `src/digitalmodel/hydrodynamics/diffraction/input_schemas.py` -- `DiffractionSpec`
- `src/digitalmodel/hydrodynamics/diffraction/mesh_pipeline.py` -- mesh preparation
- `src/digitalmodel/hydrodynamics/hull_library/mesh_generator.py` -- `HullMeshGenerator` (generates `PanelMesh`)

**Steps (TDD)**:
1. Write tests: `BatchRAORunner` generates one diffraction spec per hull variation
2. Write tests: Mesh generated from `HullMeshGenerator` feeds into diffraction solver input
3. Write tests: Dry-run mode (`preview=True`) returns job count without running solver
4. Write tests: Results indexed by variation ID
5. Implement `BatchRAORunner`:
   a. For each variation: generate mesh via `HullMeshGenerator` -> export to `.gdf` format
   b. Create `DiffractionSpec` with mesh path, wave frequencies, headings
   c. Submit to `OrcaWaveRunner` (or Aqwa backend -- both available in `diffraction/`)
   d. Extract RAOs from solver results via `ResultExtractor`
6. Support both sequential and parallel execution (follow `OrcaWaveBatchRunner.ExecutionMode`)

**Test file**:
- `tests/hydrodynamics/hull_library/test_batch_rao_runner.py`

### Phase 3: RAO Database & Storage

Store computed RAOs indexed by hull form parameters for later lookup.

**Target files (new)**:
- `src/digitalmodel/hydrodynamics/hull_library/rao_database.py` -- RAO storage + query API

**Target files (existing -- reference)**:
- `src/digitalmodel/hydrodynamics/models.py` (~150 lines) -- `RAOData` dataclass (frequencies, directions, amplitudes as numpy arrays)
- `src/digitalmodel/hydrodynamics/hull_library/catalog.py` -- `HullCatalog` (registry pattern)

**Schema**:
```
RAODatabaseEntry:
    variation_id: str
    hull_params: dict[str, float]     # beam, draft, length, etc.
    rao_data: RAOData                 # 6-DOF RAOs (frequencies x directions x DOFs)
    metadata: dict                    # solver, run date, mesh panel count, etc.

RAODatabase:
    _entries: dict[str, RAODatabaseEntry]

    def store(entry: RAODatabaseEntry) -> None
    def query(beam_range, draft_range, ...) -> list[RAODatabaseEntry]
    def get_by_id(variation_id: str) -> RAODatabaseEntry
    def save_to_disk(path: Path) -> None     # Parquet or HDF5
    def load_from_disk(path: Path) -> None
    def list_parameters() -> dict[str, list[float]]  # Available parameter values
```

**Test file**:
- `tests/hydrodynamics/hull_library/test_rao_database.py`

**Steps (TDD)**:
1. Write tests: Store and retrieve RAO entry by variation ID
2. Write tests: Query by parameter range returns matching entries
3. Write tests: Round-trip save/load preserves numpy arrays exactly
4. Write tests: `list_parameters()` returns all unique parameter values
5. Implement storage using Parquet (via polars -- already used in project) for disk persistence
6. In-memory dict for fast access during analysis sessions

### Phase 4: Lookup Graph Generation

Generate professional, client-facing RAO plots with comparison capabilities.

**Target files (new)**:
- `src/digitalmodel/hydrodynamics/hull_library/rao_lookup_plots.py` -- Plotly graph generation

**Target files (existing -- reference)**:
- `src/digitalmodel/hydrodynamics/diffraction/rao_plotter.py` -- existing RAO plotting (per-solver)
- `src/digitalmodel/hydrodynamics/rao_analysis/rao_analysis.py` (~200 lines) -- legacy RAO plotting
- `src/digitalmodel/hydrodynamics/hull_library/catalog.py` -- `compute_motions()` (spectral analysis)

**Graph types**:
1. **Per-hull RAO curves**: 6 subplots (surge, sway, heave, roll, pitch, yaw) vs frequency, one hull per plot
2. **Comparison overlay**: Same 6 subplots, multiple hull variations overlaid with colour legend
3. **Parameter sweep**: RAO peak value vs hull parameter (e.g., roll RAO peak vs beam) -- scatter + trendline
4. **Heading polar**: RAO amplitude at peak frequency vs heading direction (polar plot)
5. **3D surface**: RAO amplitude as surface over (frequency, heading) space

**Styling requirements (client-facing)**:
- Professional colour palette (no default Plotly colours)
- Clear axis labels with units (rad/s or s for frequency, m/m or deg/m for RAO)
- Legend with hull parameter values
- Title with hull ID and sea state conditions
- Export as: interactive HTML, static PNG, PDF

**Test file**:
- `tests/hydrodynamics/hull_library/test_rao_lookup_plots.py`

**Steps (TDD)**:
1. Write tests: Per-hull plot generates valid HTML with 6 subplots
2. Write tests: Comparison plot includes all requested hull variations
3. Write tests: Parameter sweep plot has correct x-axis (hull parameter) and y-axis (RAO peak)
4. Write tests: PNG export generates non-zero file
5. Implement using Plotly (`make_subplots`, `go.Scatter`, `go.Surface`)
6. Use `plotly.io.write_html()` and `plotly.io.write_image()` for exports
7. Follow project convention: interactive plots only (Plotly/Bokeh per CLAUDE.md)

### Phase 5: engine.py Registration + CLI

**Target files (modify)**:
- `src/digitalmodel/engine.py` (196 lines) -- add `hull_parametric` basename route

**Target files (new)**:
- `src/digitalmodel/hydrodynamics/hull_library/cli.py` -- CLI for batch hull analysis

**Steps**:
1. Add engine route:
   ```python
   elif basename == "hull_parametric":
       from digitalmodel.hydrodynamics.hull_library.parametric_hull import HullParametricRunner
       runner = HullParametricRunner()
       cfg_base = runner.router(cfg_base)
   ```
2. CLI subcommands: `generate` (run batch analysis), `plot` (generate graphs from database), `query` (filter database)
3. YAML config format for batch runs:
   ```yaml
   basename: hull_parametric
   base_hull: tanker_150m
   parametric_space:
     beam_range: {min: 20, max: 35, steps: 4}
     draft_range: {min: 8, max: 14, steps: 4}
   solver: orcawave  # or aqwa
   output_dir: results/hull_parametric/
   ```

### Phase 6: Client Reporting Package

**Target files (new)**:
- `src/digitalmodel/hydrodynamics/hull_library/client_report.py` -- aggregated report with all graphs

**Steps**:
1. Generate HTML report with: executive summary, hull parameter table, all RAO plots, comparison plots, parameter sweep plots
2. Include interactive Plotly charts (drill-down capability)
3. Export option for PDF (via Plotly `kaleido` backend)
4. Include analysis assumptions and methodology section

### Dependencies & Prerequisites

| Dependency | Status | Notes |
|------------|--------|
-------|
| `hull_library/` module | Available | `catalog.py` (413 lines), `profile_schema.py` (326 lines), `mesh_generator.py` |
| `diffraction/` module | Available | 32 files, OrcaWave + Aqwa backends |
| `HullMeshGenerator` | Available | Generates `PanelMesh` from `HullProfile` |
| `RAOData` model | Available | `hydrodynamics/models.py` (numpy arrays) |
| `WaveSpectra` | Available | `hydrodynamics/wave_spectra/` |
| OrcaWave | Available | Orcina license with OrcaWave module |
| AQWA | Available | ANSYS license with AQWA |
| BEMRosetta/Capytaine | Explore in parallel | Free open-source BEM solver — evaluate as license-free alternative |
| Plotly | Available | Already project standard |
| Polars | Available | For Parquet storage in RAO database |
| Hull profile YAML files | Required | At least 2-3 base hull profiles in `data/hull_profiles/` |

### Existing Code to Build On

| Component | Path | Lines | Reuse Strategy |
|-----------|------|-------|
----------------|
| Hull catalog | `hydrodynamics/hull_library/catalog.py` | 413 | `HullCatalog`, `compute_motions()`, `compute_accelerations()` |
| Hull profile schema | `hydrodynamics/hull_library/profile_schema.py` | 326 | `HullProfile`, `HullStation`, YAML serialization |
| Mesh generator | `hydrodynamics/hull_library/mesh_generator.py` | ~200 | `HullMeshGenerator.generate()` for panel meshes |
| Mesh coarsener | `hydrodynamics/hull_library/coarsen_mesh.py` | -- | Reduce panel count for faster solver runs |
| Schematic generator | `hydrodynamics/hull_library/schematic_generator.py` | -- | SVG hull schematics (optional for reports) |
| OrcaWave batch runner | `hydrodynamics/diffraction/orcawave_batch_runner.py` | ~300 | Batch execution pattern (sequential/parallel) |
| Result extractor | `hydrodynamics/diffraction/result_extractor.py` | -- | Extract RAOs from solver results |
| RAO plotter | `hydrodynamics/diffraction/rao_plotter.py` | -- | Existing Plotly RAO plotting |
| Polars exporter | `hydrodynamics/diffraction/polars_exporter.py` | -- | CSV/Parquet export |
| RAO analysis (legacy) | `hydrodynamics/rao_analysis/rao_analysis.py` | ~200 | Multi-vessel RAO overlay pattern |
| Hydrodynamic models | `hydrodynamics/models.py` | ~150 | `RAOData`, `WaveParameters`, `WaveSpectrumType` |
| Existing hull tests | `tests/hydrodynamics/hull_library/test_catalog.py`, `test_mesh_generator.py` | -- | Test patterns and fixtures |

### Test Strategy

| Test Scope | Target Path | Count (est.) |
|------------|-------------|
--------------|
| Parametric hull schema | `tests/hydrodynamics/hull_library/test_parametric_hull.py` | ~18 |
| Batch RAO runner | `tests/hydrodynamics/hull_library/test_batch_rao_runner.py` | ~12 |
| RAO database | `tests/hydrodynamics/hull_library/test_rao_database.py` | ~15 |
| Lookup plots | `tests/hydrodynamics/hull_library/test_rao_lookup_plots.py` | ~12 |
| Client report | `tests/hydrodynamics/hull_library/test_client_report.py` | ~6 |
| Integration | `tests/hydrodynamics/hull_library/test_parametric_integration.py` | ~8 |
| **Total** | | **~71** |

Run command: `PYTHONPATH="src:../assetutilities/src" python3 -m pytest tests/hydrodynamics/hull_library/ -v --tb=short --noconftest`

### Review Notes

**Cross-review date**: 2026-02-10

| Reviewer | Verdict |
|----------|
---------|
| Claude Opus 4.6 | MINOR |
| Gemini CLI | APPROVE |
| Codex CLI | NO_OUTPUT |

**Feedback incorporated**:
- Three files have significantly inaccurate line counts: mesh_generator.py claimed ~200 actual 504 (2.5x), models.py claimed ~150 actual 373 (2.5x), rao_analysis.py claimed ~200 actual 604 (3x), orcawave_batch_runner.py claimed ~300 actual 384 (28% higher)
- No hull profile YAML files verified -- `data/hull_profiles/` existence not confirmed

*Approved by user: 2026-02-10 (all 3 solvers available: OrcaWave, AQWA, + explore free tools in parallel)*

---
*Source: run many hull forms as parametric analysis and establish RAOs and look up graphs for displaying to clients*

## Implementation Notes

### Phase 1 — Completed 2026-02-24

**Files created**:
- `src/digitalmodel/hydrodynamics/hull_library/parametric_hull.py` (255 lines)
- `tests/hydrodynamics/hull_library/test_parametric_hull.py` (24 tests, all passing)

**Design decision**: Implemented `HullParametricSpace` with a generic `ranges: dict[str, ParametricRange]`
and scale-factor semantics (keys `length_scale`, `beam_scale`, `draft_scale`, `depth_scale`) rather
than named absolute-value fields. Scale factors give simpler geometry math and avoid needing to know
the base hull's dimensions at schema-definition time. The `_scale_profile()` helper maps scale keys
to `HullProfile` geometry transformations: `beam_scale` multiplies `beam` and all station
half-breadths; `draft_scale` multiplies `draft` and all station z-offsets; `length_scale` multiplies
`length_bp` and all station x-positions; `depth_scale` multiplies `depth` (defaults to
`draft_scale` if not set). Variation IDs are deterministic hashes built from sorted key=value pairs.

**Test coverage**:
- `ParametricRange`: linspace generation, single step, five steps, steps=0 rejection, min>max rejection, repr
- `HullParametricSpace.combinations()`: 1D/2D/3D cartesian products, fixed params, empty ranges, dict return type
- `HullParametricSpace.generate_profiles()`: count, tuple types, length/beam/draft scaling, unique IDs, fixed params, missing hull raises, all profiles pass HullProfile validation
- `TestVariationId`: deterministic IDs, different params yield different IDs
- `TestBeamDraftCombinations`: beam(3) × draft(3) = 9 combinations

### Phase 3 — Completed 2026-02-24

**File created**: `src/digitalmodel/hydrodynamics/hull_library/rao_database.py` (293 lines)

**Test file**: `tests/hydrodynamics/hull_library/test_rao_database.py` (22 tests, all passing)

**Design decision**: `RAODatabaseEntry` is a plain dataclass (not Pydantic) to allow numpy array
fields without `arbitrary_types_allowed`. Disk persistence uses pandas + pyarrow Parquet backend
(polars binary not available in this environment); numpy arrays are serialised via `numpy.save`
to bytes columns, providing lossless float64 round-trip. The query API accepts `(lo, hi)` range
tuples per parameter key, matching both exact values and ranges with a single call pattern.

**Test coverage**:
- `RAODatabaseEntry`: creation, metadata, default empty metadata, array storage
- `RAODatabase.store()/get_by_id()`: round-trip, missing key raises, multiple entries, overwrite
- `RAODatabase.query()`: empty filter all-return, exact match, range filter, combined filters, no match
- `RAODatabase.list_parameters()`: unique values, multi-dim, empty DB
- `RAODatabase.save_to_disk()/load_from_disk()`: file creation, variation IDs, hull params, amplitudes, frequencies, nested parent dirs

### Phase 4 — Completed 2026-02-24

**File created**: `src/digitalmodel/hydrodynamics/hull_library/rao_lookup_plots.py` (362 lines)

**Test file**: `tests/hydrodynamics/hull_library/test_rao_lookup_plots.py` (16 tests, all passing)

**Graph functions implemented**:
- `per_hull_rao_plot(entry)` — 2×3 subplot grid, one DOF per subplot, all headings overlaid
- `comparison_plot(entries)` — overlaid multi-hull, 6 DOF traces per entry (heave visible by default)
- `parameter_sweep_plot(entries, param_name, dof)` — sequential colour scale by param value
- `export_html(fig, path)` — CDN-referenced interactive HTML, creates parent dirs
- `export_png(fig, path)` — kaleido-backed static PNG (graceful failure if kaleido missing)

**Total test count across all phases**: 62 tests passing in 60s.

**Commit**: `f92bc8109` (included in refactor(wrk-415) batch commit due to concurrent agent activity)

**Phases remaining**: Phase 2 (batch diffraction — requires OrcaWave/AQWA runtime), Phase 5 (engine.py CLI), Phase 6 (client report)

## Agentic AI Horizon

- Parametric hull form analysis with RAO generation is core hydrodynamic tooling that agents running frequency-domain analysis will use — high compounding value.
- Hull form parametrisation and RAO generation require domain-specific geometry and hydrodynamics code; not superseded by general model improvements.
- **Disposition: do now, shape for leverage** — implement as a well-structured module agents can invoke; this is foundational for multiple downstream analysis workflows (WRK-099, WRK-126).
