---
id: WRK-149
title: "digitalmodel test coverage improvement (re-creates WRK-051)"
status: working
priority: high
complexity: complex
created_at: 2026-02-16T00:00:00Z
target_repos:
  - digitalmodel
target_module:
commit:
spec_ref:
related: [WRK-051]
blocked_by: []
plan: inline
plan_reviewed: true
plan_approved: true
percent_complete: 48
brochure_status: n/a
provider: codex
provider_alt: claude,gemini
task_agents:
  phase_1: codex    # Baseline measurement
  phase_2: codex    # Priority module tests
  phase_3: codex    # Cross-cutting tests
  phase_4: codex    # CI integration
---

# digitalmodel Test Coverage Improvement

## Execution Update (2026-02-18)
- Completed WRK-149 focused test batch in `digitalmodel` for license-independent paths.
- Added 4 new focused test modules and stabilized 5 legacy `asset_integrity` tests for clean collection/skip behavior.
- Focused coverage now includes:
  - `update_deep.py` 100%
  - `polars_exporter.py` 99.14%
  - `catalog.py` 94.70%
  - `rao_registry.py` 99.04%
  - `yml_utilities.py` 84.76%
- Changed-file regression set: `53 passed, 17 skipped, 0 failed`.
- Cross-review packaging submitted to Claude and Gemini:
  - Claude verdict: `APPROVE`
  - Gemini verdict: `ERROR` (non-normalized runner output; requires rerun if strict 2-provider normalized verdict is required)
- Additional license-free increment completed:
  - Commit: `d42399cbb` (`test(asset_integrity): WRK-149 cover yml_utilities fallback error branches`)
  - Consolidated WRK-149 changed-file regression: `32 passed, 8 skipped, 0 failed` via `uv run python -m pytest ...`
- Latest focused priority coverage rerun (license-free scope):
  - Command included: `test_update_deep_additional`, `test_yml_utilities_additional`, `test_polars_exporter_additional`, `test_catalog_additional`, `test_rao_registry`
  - Result: `49 passed, 0 skipped, 0 failed`
  - Coverage:
    - `update_deep.py` 100.00%
    - `yml_utilities.py` 87.20%
    - `polars_exporter.py` 94.83%
    - `catalog.py` 94.70%
    - `rao_registry.py` 99.04%
  - Artifact: `digitalmodel/coverage.wrk149.focused.xml`
- Additional follow-on coverage increment:
  - Commit: `3423b4540` (`test(asset_integrity): WRK-149 drive yml_utilities to full branch coverage`)
  - Targeted test run: `23 passed, 0 failed`
  - `digitalmodel.asset_integrity.common.yml_utilities`: **100.00%** statement+branch coverage

## Cost-Optimized Pickup Path
- Objective: continue WRK-149 on licensed computer with minimal Codex usage.
- Primary providers: `claude` (implementation), `gemini` (cross-review/second opinion).
- Codex usage policy: reserve Codex only for final merge conflict/debug emergencies and final closure summary.

### Pickup Inputs
- Work item: `.claude/work-queue/pending/WRK-149.md`
- Packaging snapshot: `.claude/work-queue/assets/WRK-149/wrk149-packaging-2026-02-18.md`
- Subagent brief: `.claude/work-queue/assets/WRK-149/subagent-briefs-2026-02-18.md`
- Latest focused coverage artifact: `digitalmodel/coverage.wrk149.focused.xml`

### Low-Cost Execution Sequence
1. On licensed machine, run license-dependent WRK-149 suites via Claude.
2. Generate implementation review via Gemini for each significant batch.
3. Normalize and record verdicts in WRK-149 notes (`APPROVE | MINOR | MAJOR | NO_OUTPUT | ERROR`).
4. Use Codex only if Claude/Gemini are blocked or for final consolidation pass.

### Preferred Commands (licensed machine)
- `cd /mnt/local-analysis/workspace-hub`
- `scripts/agents/work.sh WRK-149 --provider claude`
- `scripts/agents/review.sh WRK-149 --all-providers`
- `scripts/review/normalize-verdicts.sh <review-result-file>`

## What
Increase digitalmodel test coverage from ~2.7% to at least 50% (stretch: 80%). WRK-051 was planned and cross-reviewed but never executed. This item resurrects it with a realistic phased approach.

## Why
- 83K lines of production code at 2.7% coverage is the highest technical risk in the workspace
- Active development (wall thickness, hydrodynamics, hull library, FFS) makes regressions likely
- Blocks confidence in refactoring and new feature development

## Acceptance Criteria
- [ ] Test collection fixed (pytest discovers all test files)
- [ ] Baseline coverage measured and documented
- [ ] Priority modules covered first: structural (wall_thickness), hydrodynamics (diffraction), hull_library
- [ ] At least 200 new tests written across priority modules
- [ ] Coverage reaches 50%+ on priority modules
- [ ] CI-compatible test runner configured

## Notes
- Original WRK-051 plan (archived, cross-reviewed 2026-02-09) has detailed per-module breakdown — reference it
- Use existing 3-tier test runner from WRK-119 (test-commit.sh, test-task.sh, test-session.sh)
- Prioritize modules with active development over legacy/stable code

## Plan

**Target**: `tests/` across digitalmodel (extend existing)

### Existing Assets
| Component | Tests | Coverage |
|-----------|-------|----------|
| wall_thickness | 214 | Good |
| fatigue | 493 | Good |
| diffraction/benchmark | 25+ | Moderate |
| hull_library | 13 | Low |
| orcaflex/format_converter | 102 | Good |
| asset_integrity | ~4 effective | Critical gap |
| gis | 18 | Moderate |

### Phase 1 — Baseline Measurement
- Run full test collection: `python3 -m pytest tests/ --collect-only`
- Measure coverage: `python3 -m pytest tests/ --cov=src/digitalmodel --cov-report=html`
- Document: total tests, pass rate, coverage % per module
- Identify untested public APIs

### Phase 2 — Priority Module Tests (highest risk first)
- **asset_integrity** (~4 effective tests → 40+): fix shams, add grid parser, FFS assessment tests
- **hull_library** (13 → 40+): parametric hull generation, catalog validation, mesh quality
- **hydrodynamics** (25 → 60+): RAO extraction, solver comparison, hydrostatic validation
- **orcaflex core** (low → 30+): model interface, configuration, analysis engine

### Phase 3 — Cross-Cutting Tests
- Integration tests: module interactions (e.g., fatigue + orcaflex result extraction)
- Regression tests: pin current behavior for actively developed modules
- Edge cases: empty inputs, missing data, unit conversion boundaries

### Phase 4 — CI Integration
- Configure pytest markers for tiered execution (commit/task/session)
- Ensure no license-dependent tests run in CI (use `@pytest.mark.skipif`)
- Coverage gates: fail if coverage drops below baseline

### Test Strategy
- TDD for new test gaps
- Use existing 3-tier runner: test-commit.sh (fast), test-task.sh (moderate), test-session.sh (full)
- Priority: asset_integrity > hull_library > hydrodynamics > orcaflex core
- Target: 200+ new tests, 50%+ coverage on priority modules
- Run: `PYTHONPATH="src:../assetutilities/src" python3 -m pytest tests/ -v --tb=short --noconftest`
