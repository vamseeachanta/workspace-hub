---
id: WRK-637
title: "feat(memory): memory governance — compaction, tiering, eviction to prevent context-rot"
status: pending
priority: high
complexity: medium
compound: false
created_at: 2026-02-27T00:00:00Z
target_repos:
  - workspace-hub
commit:
spec_ref:
related:
  - WRK-635
  - WRK-636
  - WRK-299
blocked_by: []
parent:
synced_to: []
plan_reviewed: false
plan_approved: false
percent_complete: 0
brochure_status: n/a
computer: [ace-linux-1]
provider: claude
---

# feat(memory): Memory Governance — Compaction, Tiering, Eviction

## Status note

The governance spec and Phase 3b rules are **already live** in
`comprehensive-learning` SKILL.md (added 2026-02-27). The pipeline will log
`"Phase 3b: SKIPPED — script not yet built (WRK-637)"` on each nightly run
until this WRK is implemented. This WRK delivers the script.

## Problem

MEMORY.md is at 168/200 lines (84% full). The 200-line limit is a hard truncation:
lines 201+ are silently never loaded. WRK-635 (session scan) will generate hundreds
of candidate learnings. Without governance, the memory system accumulates noise faster
than it retires it — stale facts crowd out fresh ones, and useful content falls off
the truncation cliff.

Three failure modes to prevent:
1. **Silent truncation**: MEMORY.md > 200 lines → latest entries invisible to Claude
2. **Topic file bloat**: unbounded growth, rarely fully consumed by Claude on-demand
3. **Stale rot**: WRK statuses, paths, commands that are no longer true

## Design

### Tier model

```
MEMORY.md (≤200 lines)         — INDEX ONLY: section headers + 1-line pointers
  └─ topic files (≤150 lines)  — ACTIVE facts, consulted on demand
       └─ archive/ (unbounded) — RETIRED facts, never auto-loaded
```

**MEMORY.md must never contain raw facts.** It is a signpost to topic files only.
Freed lines in MEMORY.md create headroom for new topic file pointers.

### Compaction triggers

Run `scripts/memory/compact-memory.py` when ANY of:
- MEMORY.md exceeds 180 lines (20-line safety margin before hard limit)
- Any topic file exceeds 150 lines
- Comprehensive-learning Phase 3 flags ≥5 stale entries in one run
- Quarterly forced compaction (first Sunday of the month)

### Eviction rules (applied in order)

| Rule | Condition | Action |
|------|-----------|--------|
| Done-WRK expiry | Bullet references WRK-NNN and that item has `status: done` in work-queue for >30 days | Move to `archive/done-wrk.md` |
| Path staleness | File path in bullet does not exist on disk | Flag for manual review → `archive/stale-paths.md` |
| Command staleness | Command in bullet fails with exit code ≠ 0 (spot-check only, 3 per run) | Flag → `archive/stale-commands.md` |
| Low-signal dedup | Two bullets share >80% semantic overlap → keep the fresher/more specific one | Delete older |
| Age eviction | Bullet not referenced in any session signal for 90+ days AND not marked `# keep` | Move to archive |

### Promotion rules (scan output → memory)

WRK-635/636 session scan MUST NOT write directly to MEMORY.md. Write order:
1. New learning → appropriate topic file (append)
2. Topic file > 150 lines → trigger compaction before continuing
3. Compaction may promote a topic file section header to MEMORY.md if it doesn't exist
4. MEMORY.md is only updated by compaction, never by direct scan output

### `# keep` marker

Any bullet in a topic file marked `# keep` at end of line is exempt from age eviction.
Use sparingly — for foundational facts that are always true (e.g., test invocation
commands, confirmed architectural invariants).

### Script: `scripts/memory/compact-memory.py`

**Phase A — audit**
- Parse all topic files; flag bullets matching eviction rules
- Spot-check 3 commands per run (run in subprocess, 5s timeout)
- Produce `memory/compact-audit.md` — proposed actions, no writes yet

**Phase B — dry-run review** (called with `--dry-run`)
- Print full audit to stdout; allow human review before applying

**Phase C — apply**
- Move evicted bullets to `archive/<category>.md`
- Rewrite topic files with evicted bullets removed
- Update MEMORY.md if section pointers changed
- Log: `memory/compact-log.jsonl` — timestamp, bullets_evicted, bullets_archived, lines_freed

### Integration with comprehensive-learning

Add compact-memory as **Phase 3b** (after Knowledge, before Improve):

```
Phase 3  Knowledge    — staleness spot-check (existing)
Phase 3b Compaction   — run compact-memory.py if triggers met (NEW)
Phase 4  Improve      — write improvements into now-headroom-available files
```

This ensures Phase 4 always has headroom to write improvements without risk of
overflow.

### Integration with WRK-635 (session scan)

`scan-sessions.py` must:
1. Check headroom before writing: if topic file ≥ 140 lines, run compaction first
2. Write to topic file, never MEMORY.md
3. After all writes, log candidate count vs written count (rest archived to
   `archive/session-scan-overflow.md` for future compaction cycles to promote)

## Acceptance Criteria

- [ ] `compact-memory.py --dry-run` runs cleanly on current memory files, audits correctly
- [ ] Done-WRK eviction correctly moves expired WRK references to archive
- [ ] Path staleness check correctly flags ≥1 stale path from current memory files
- [ ] Compaction frees ≥10 lines in MEMORY.md or topic files on first run
- [ ] MEMORY.md stays ≤180 lines after full scan from WRK-635 (282 Claude + 252 Codex sessions)
- [ ] `# keep` exemption works correctly — kept bullets survive eviction pass
- [ ] comprehensive-learning SKILL.md updated with Phase 3b entry
- [ ] `compact-log.jsonl` written and human-readable
- [ ] `scan-sessions.py` checks headroom before writing (WRK-635 integration)

## Notes

- Archive files are never auto-loaded — they are permanent storage for context of
  past decisions, accessible manually if needed but not part of active context
- Priority = high: should be implemented BEFORE WRK-635 runs the bulk session scan,
  otherwise the scan output has nowhere to land safely
- Compaction is idempotent — safe to run multiple times; second run on already-
  compacted files should produce zero evictions
