---
id: WRK-156
title: "FFS Phase 1 — wall thickness grid input with Level 1/2 accept-reject workflow"
status: done
priority: high
complexity: complex
created_at: 2026-02-16T00:00:00Z
target_repos:
  - digitalmodel
target_module: asset_integrity
commit: 9753a3f5720e913c17299ef2d72eee927d873464
spec_ref: specs/modules/wrk-138-ffs-module-roadmap.md
related: [WRK-138, WRK-044]
blocked_by: []
plan_reviewed: true
plan: inline
plan_approved: true
percent_complete: 100
brochure_status: n/a
computer: ace-linux-1
provider: claude
provider_alt:
task_agents:
  phase_0: codex    # Prerequisites — fix imports, legal scan
  phase_1: codex    # Grid parser — focused code
  phase_2: claude   # FFS router & assessment — multi-module architecture
  phase_3: codex    # Decision engine — algorithm
  phase_3b: codex   # Expert HTML report — templating
  phase_4: codex    # Tests
---

# FFS Phase 1 — Wall Thickness Grid Assessment

## What
Implement the core FFS assessment capability: accept a wall thickness grid (from C-scan or UT inspection), route through appropriate assessment method (API 579-1 Part 4/5), and produce Level 1/2 accept-reject decisions with a clear report. This is Phase 1 of the WRK-138 roadmap — Phase 0 (module rename, audit) was completed.

## Why
- FFS (Fitness-for-Service) is a key marketing differentiator but the core grid assessment workflow is unbuilt
- Module was renamed from pyintegrity to asset_integrity (WRK-138 Phase 0) and imports fixed
- 20+ historical inspection campaigns in energy_integrity/ provide validation data
- Bridges the gap between the marketing brochure and actual capability

## Acceptance Criteria
- [ ] Grid parser: read wall thickness grid from CSV/Excel (rows=circumferential, cols=axial)
- [ ] FFS router: determine assessment method from component type and flaw type
- [ ] Level 1 assessment: minimum measured thickness vs code-required thickness
- [ ] Level 2 assessment: RSF (Remaining Strength Factor) calculation for local thin areas
- [ ] Decision engine: accept/reject/further-assessment based on API 579-1 criteria
- [ ] Expert-quality HTML report: executive summary, component data sheet, interactive grid heatmap, Level 1/2 assessment sections, remaining life projection with confidence bands, methodology & references with clause numbers, appendix with full data
- [ ] Report is self-contained single HTML (Plotly CDN), print-friendly for PDF export
- [ ] Tests with at least 2 historical inspection datasets
- [ ] All existing asset_integrity tests still pass

## Plan

**Target**: `src/digitalmodel/asset_integrity/` (extend existing)
**Spec**: `specs/modules/wrk-138-ffs-module-roadmap.md` (Phase 1)

### Existing Assets (reuse)
| Component | Path | Lines | Reuse |
|-----------|------|-------|
-------|
| GML/LML assessment | `common/API579_components.py` | 997 | Core calculation engine |
| Design code t_min | `custom/PipeCapacity.py` | 860 | B31.4/B31.8/API RP 1111 |
| Grid loading | `custom/API579/customInputs.py` | ~200 | ExcelRead class |
| Grid visualization | `custom/API579/plotContourf.py` | ~200 | Heatmap rendering |
| Test data | `tests/test_data/API579/` | — | 16in gas + 12in oil grids |
| Config system | `common/ApplicationManager.py` | ~300 | YAML merging |

### Phase 0 — Prerequisites (from roadmap)
- Fix B31G import path (line 398 of API579_components.py)
- Legal scan YAML configs for client references
- Fix sham BS 7910 tests (empty dict comparisons)
- Verify 2 suspect equations in PipeCapacity.py

### Phase 1 — Grid Parser (`grid_parser.py`, ~200 lines)
- Unified input: CSV, XLSX, YAML, NumPy array
- Normalize to 2D pandas DataFrame (rows=axial, cols=circumferential)
- Handle C-scan percentage → absolute thickness (DataCorrectionFactor)
- Handle vendor metadata headers (skiprows)
- Unit normalization (mm ↔ inches, internal=inches)

### Phase 2 — FFS Router + Assessment (`ffs_router.py` + `level1_screener.py` + `level2_engine.py`, ~550 lines)
- `ffs_router.py`: classify GML (Part 4) vs LML (Part 5) from defect morphology
- `level1_screener.py`: t_mm vs t_min (per design code) → ACCEPT or FAIL_LEVEL_1
- `level2_engine.py`: area-averaged RSF for GML, Folias+RSF for LML → ACCEPT or FAIL_LEVEL_2
- Wrap existing `API579GML()` and `API579LML()` calculations

### Phase 3 — Decision Engine (`ffs_decision.py`, ~120 lines)
- Verdict outcomes: Accept / Monitor / Repair / Re-rate / Replace
- Decision tree per API 579-1 Figure 2.1 (assessment flowchart)
- Configurable RSFa threshold (default 0.9)
- Remaining life projection from corrosion rate + current thickness

### Phase 3b — Expert-Quality FFS HTML Report (`ffs_report.py`, ~600 lines)
- **Executive Summary**: component ID, assessment date, design code, verdict (color-coded), governing criterion, remaining life estimate, next inspection date recommendation
- **Component Data Sheet**: pipe OD, nominal WT, material grade, SMYS/SMTS, design pressure, MAOP, operating temperature, service (sweet/sour/H2S), installation date, inspection date
- **Inspection Data Visualization**:
  - Plotly interactive grid heatmap (axial × circumferential) — color scale: green (>t_min) → yellow (approaching) → red (<t_min)
  - Click-to-inspect: hover shows exact WT, location, corrosion rate at each grid point
  - Minimum thickness contour overlay with t_min reference line
  - Circumferential and axial thickness profiles (strip charts along both axes)
- **Level 1 Assessment Section**: t_mm vs t_min table, pass/fail per API 579-1 Part 4 Section 4.3, applicability criteria checklist
- **Level 2 Assessment Section**: RSF calculation methodology, Folias factor (Mt) curve with operating point marked, area-averaged thickness calculation, RSF vs RSFa comparison with margin
- **Remaining Life Projection**: corrosion rate trending (linear + exponential fit), projected thickness vs time plot with t_min threshold crossing, confidence bands (±1σ from corrosion rate uncertainty), recommended re-inspection interval per API 510/570
- **Methodology & References**: API 579-1/ASME FFS-1 Part 4/5 clause references, equations used with clause numbers, assumptions and limitations, design code for t_min (B31.4/B31.8/API RP 1111/DNV-ST-F101)
- **Appendix**: full grid data table (sortable), corrosion rate map, historical comparison (if multiple inspection dates available)
- Self-contained single HTML file (Plotly CDN), print-friendly CSS for PDF export
- Professional styling: monospace numerics, alternating table rows, color-coded verdicts, company logo placeholder

### Phase 4 — Tests
- Grid parser: CSV/XLSX/YAML round-trip, unit conversion, vendor header handling
- Level 1/2 assessments against existing 16in gas and 12in oil test data
- Decision logic boundary cases (RSF exactly at 0.9 threshold)
- Report generation (HTML output validation)
- All existing asset_integrity tests still pass
- Target: 40+ new tests

### Dependencies
- No external software
- Existing test data in `tests/test_data/API579/` sufficient for Phase 1

## Notes
- Detailed spec at specs/modules/wrk-138-ffs-module-roadmap.md (Phase 1 section)
- Phase 0 audit found 2 suspect equations in PipeCapacity.py — verify before building on them
- Reference data in energy_integrity folder (C-scan grids, YAML configs)

## Agentic AI Horizon

- FFS (Fitness-for-Service) wall thickness assessment is a high-value client deliverable for asset integrity work — agents will run FFS assessments autonomously on inspection data.
- API 579 assessment logic must be correctly coded; improved AI reasoning won't replace the need for accurate, code-compliant assessment implementation.
- **Disposition: do now** — FFS capability has direct client value and time sensitivity for integrity assessments; the wall thickness grid input and Level 1/2 workflow is the critical path.
