---
id: WRK-156
title: "FFS Phase 1 — wall thickness grid input with Level 1/2 accept-reject workflow"
status: pending
priority: high
complexity: complex
created_at: 2026-02-16T00:00:00Z
target_repos:
  - digitalmodel
target_module: asset_integrity
commit:
spec_ref: specs/modules/wrk-138-ffs-module-roadmap.md
related: [WRK-138, WRK-044]
blocked_by: []
plan_reviewed: true
plan: inline
plan_approved: false
percent_complete: 0
brochure_status: n/a
provider: claude
provider_alt:
---

# FFS Phase 1 — Wall Thickness Grid Assessment

## What
Implement the core FFS assessment capability: accept a wall thickness grid (from C-scan or UT inspection), route through appropriate assessment method (API 579-1 Part 4/5), and produce Level 1/2 accept-reject decisions with a clear report. This is Phase 1 of the WRK-138 roadmap — Phase 0 (module rename, audit) was completed.

## Why
- FFS (Fitness-for-Service) is a key marketing differentiator but the core grid assessment workflow is unbuilt
- Module was renamed from pyintegrity to asset_integrity (WRK-138 Phase 0) and imports fixed
- 20+ historical inspection campaigns in energy_integrity/ provide validation data
- Bridges the gap between the marketing brochure and actual capability

## Acceptance Criteria
- [ ] Grid parser: read wall thickness grid from CSV/Excel (rows=circumferential, cols=axial)
- [ ] FFS router: determine assessment method from component type and flaw type
- [ ] Level 1 assessment: minimum measured thickness vs code-required thickness
- [ ] Level 2 assessment: RSF (Remaining Strength Factor) calculation for local thin areas
- [ ] Decision engine: accept/reject/further-assessment based on API 579-1 criteria
- [ ] Report generator: HTML report with grid heatmap, pass/fail overlay, methodology notes
- [ ] Tests with at least 2 historical inspection datasets
- [ ] All existing asset_integrity tests still pass

## Plan

**Target**: `src/digitalmodel/asset_integrity/` (extend existing)
**Spec**: `specs/modules/wrk-138-ffs-module-roadmap.md` (Phase 1)

### Existing Assets (reuse)
| Component | Path | Lines | Reuse |
|-----------|------|-------|-------|
| GML/LML assessment | `common/API579_components.py` | 997 | Core calculation engine |
| Design code t_min | `custom/PipeCapacity.py` | 860 | B31.4/B31.8/API RP 1111 |
| Grid loading | `custom/API579/customInputs.py` | ~200 | ExcelRead class |
| Grid visualization | `custom/API579/plotContourf.py` | ~200 | Heatmap rendering |
| Test data | `tests/test_data/API579/` | — | 16in gas + 12in oil grids |
| Config system | `common/ApplicationManager.py` | ~300 | YAML merging |

### Phase 0 — Prerequisites (from roadmap)
- Fix B31G import path (line 398 of API579_components.py)
- Legal scan YAML configs for client references
- Fix sham BS 7910 tests (empty dict comparisons)
- Verify 2 suspect equations in PipeCapacity.py

### Phase 1 — Grid Parser (`grid_parser.py`, ~200 lines)
- Unified input: CSV, XLSX, YAML, NumPy array
- Normalize to 2D pandas DataFrame (rows=axial, cols=circumferential)
- Handle C-scan percentage → absolute thickness (DataCorrectionFactor)
- Handle vendor metadata headers (skiprows)
- Unit normalization (mm ↔ inches, internal=inches)

### Phase 2 — FFS Router + Assessment (`ffs_router.py` + `level1_screener.py` + `level2_engine.py`, ~550 lines)
- `ffs_router.py`: classify GML (Part 4) vs LML (Part 5) from defect morphology
- `level1_screener.py`: t_mm vs t_min (per design code) → ACCEPT or FAIL_LEVEL_1
- `level2_engine.py`: area-averaged RSF for GML, Folias+RSF for LML → ACCEPT or FAIL_LEVEL_2
- Wrap existing `API579GML()` and `API579LML()` calculations

### Phase 3 — Decision + Report (`ffs_decision.py` + `ffs_report.py`, ~320 lines)
- `ffs_decision.py`: verdict = Accept / Monitor / Repair / Re-rate / Replace
- `ffs_report.py`: HTML report with grid heatmap, pass/fail overlay, methodology notes, remaining life projection
- Use Plotly for interactive grid visualization

### Phase 4 — Tests
- Grid parser: CSV/XLSX/YAML round-trip, unit conversion, vendor header handling
- Level 1/2 assessments against existing 16in gas and 12in oil test data
- Decision logic boundary cases (RSF exactly at 0.9 threshold)
- Report generation (HTML output validation)
- All existing asset_integrity tests still pass
- Target: 40+ new tests

### Dependencies
- No external software
- Existing test data in `tests/test_data/API579/` sufficient for Phase 1

## Notes
- Detailed spec at specs/modules/wrk-138-ffs-module-roadmap.md (Phase 1 section)
- Phase 0 audit found 2 suspect equations in PipeCapacity.py — verify before building on them
- Reference data in energy_integrity folder (C-scan grids, YAML configs)
