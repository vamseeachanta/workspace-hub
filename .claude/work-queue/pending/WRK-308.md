---
id: WRK-308
title: "perf: move pre-commit skill validation + readiness checks to nightly cron"
status: pending
priority: high
created: 2026-02-23
tags: [hooks, git, pre-commit, performance, windows, cron, readiness]
computer: any
blocked_by: []
percent_complete: 100
---

## Problem

Two sets of checks ran synchronously in the commit/session path and caused
slowness on Windows/MINGW:

1. **Pre-commit**: `validate-skills.sh` scanned all 480 SKILL.md files on
   every commit (5+ min on Windows). Blocked commits during WRK-304/307 session.

2. **Stop hook**: `ensure-readiness.sh` (444 lines, 10 checks) ran at every
   session end. Deleted from Stop hooks in WRK-304 (commit a1854cd), but its
   9 cron-suitable checks had no new home.

Root cause: same pattern as WRK-304 — bash subprocess spawning in loops is
expensive on Windows. Running analysis at interaction time rather than nightly.

## Fix

**Philosophy (WRK-304 lean-session):** Sessions are pure execution engines.
All health checks and analysis belong in the nightly cron.

1. **Pre-commit**: remove `validate-skills.sh` call → pre-commit exits in <1s
2. **Nightly cron**: `comprehensive-learning-nightly.sh` gains Step 4 (skill
   validation) and Step 5 (9 readiness checks via `nightly-readiness.sh`)
3. **CI safety net**: `skills-validation.yml` unchanged — catches bad frontmatter
   on PRs regardless of pre-commit hook state
4. **R9 (session snapshot)**: re-wire to `readiness.sh` (PreToolUse session-start)
   only — it is session-scoped, not ecosystem-scoped

## Scope

### 1. `.git/hooks/pre-commit` — minimal valid hook

```bash
#!/usr/bin/env bash
set -euo pipefail
# Pre-commit checks — skill validation moved to nightly cron (WRK-308)
```

### 2. `scripts/cron/comprehensive-learning-nightly.sh` — Steps 4 and 5

Insert between rsync (Step 2) and pipeline exec (Step 3):

```bash
# Step 4: validate skill frontmatter (best-effort)
bash scripts/skills/validate-skills.sh .claude/skills || \
  echo "WARNING: skill validation issues found"

# Step 5: readiness checks (best-effort — 9 checks, WRK-308)
READINESS_SCRIPT="scripts/readiness/nightly-readiness.sh"
[[ -f "$READINESS_SCRIPT" ]] && bash "$READINESS_SCRIPT" || \
  echo "INFO: nightly-readiness.sh not found"
```

### 3. `scripts/readiness/nightly-readiness.sh` — new file

9 checks extracted from deleted `ensure-readiness.sh`. Each is best-effort
(`|| true`). Failures write to `.claude/state/readiness-issues.md`.

| Check | What it validates |
|-------|------------------|
| R1 | Memory files ≤ 200 lines |
| R5 | Context budget ≤ 16KB |
| R6 | Submodules on tracking branches, ≤5 commits behind |
| R-CODEX | CODEX.md MAX_TEAMMATES matches settings.json |
| R-MODEL | No stale model IDs in scripts/ |
| R-REGISTRY | model-registry.yaml ≤ 14 days old |
| R-XPROV | CODEX.md + GEMINI.md contain legal + TDD mandates |
| R-SKILLS | session-signals/ fresh, skills committed in 7 days |
| R-HARNESS | CLAUDE.md, AGENTS.md, CODEX.md, GEMINI.md ≤ 25 lines |

R9 (session snapshot <48h old) is session-scoped → `readiness.sh` only,
not included in nightly-readiness.sh.

### 4. `scripts/skills/install-skill-validator-hook.sh`

Remove skill validation heredoc from hook template. Fresh installs get a
lean pre-commit matching the updated `.git/hooks/pre-commit` above.

### 5. `comprehensive-learning` SKILL.md — Phase 6 note

Add ecosystem health bullet to Phase 6 documenting that
`nightly-readiness.sh` surfaces R1/R5/R6/R-CODEX/R-MODEL/R-REGISTRY/
R-XPROV/R-SKILLS/R-HARNESS issues in Phase 10 report.

**Not changed:** `scripts/skills/validate-skills.sh`, `.github/workflows/skills-validation.yml`

## Acceptance Criteria

- [x] `.git/hooks/pre-commit` contains no `validate-skills.sh` call ✅ 2026-02-24
- [x] `time git commit --allow-empty -m "test"` — pre-commit exits in < 1s ✅ 0.023s on ace-linux-1
- [x] `scripts/cron/comprehensive-learning-nightly.sh` contains Steps 4 and 5 ✅ 2026-02-24
- [x] `scripts/readiness/nightly-readiness.sh` exists with all 9 checks ✅ 2026-02-24
- [x] Each nightly-readiness.sh check is best-effort (`|| true`) ✅ 2026-02-24
- [x] Failures write to `.claude/state/readiness-issues.md` ✅ 2026-02-24
- [x] `bash scripts/skills/install-skill-validator-hook.sh` installs hook
      without validate-skills.sh call ✅ delegates to install-all-hooks.sh
- [x] `scripts/skills/validate-skills.sh .claude/skills` still works for
      manual/CI use ✅ unchanged
- [x] CI `skills-validation.yml` passes unchanged ✅ 2026-02-24

## Workstation Verification — pre-commit hook

`.git/hooks/pre-commit` is local to each clone — not tracked in the repo.
Must be verified on each active workstation before closing.

| Machine | Status | Notes |
|---------|--------|-------|
| ace-linux-1 | ✅ verified 2026-02-24 | lean hook, 0.023s |
| ace-linux-2 | ✅ verified 2026-02-24 | lean hook, 0 validate-skills refs |
| ACMA-ANSYS05 | ❓ not checked | SSH unreachable — check manually |

**To check ACMA-ANSYS05:** open Git Bash and run:
```bash
cat "$(git rev-parse --show-toplevel)/.git/hooks/pre-commit"
# Should show only 3 lines (shebang + set + comment), no validate-skills.sh
```

## Route

Route B — move to nightly cron (not staged-files filter). CI remains safety
net for SKILL.md frontmatter on PRs.

## Related

- WRK-304/307: lean-session philosophy — same root cause
- WRK-299: comprehensive-learning pipeline
- `.github/workflows/skills-validation.yml`: CI safety net (unchanged)
- `scripts/readiness/nightly-readiness.sh`: new script (this WRK)
