---
id: WRK-157
title: Session locking — prevent WRK item collision across terminals
status: pending
priority: high
complexity: moderate
compound: false
created_at: 2026-02-16T19:30:00Z
target_repos:
  - workspace-hub
commit:
spec_ref:
related: [WRK-094, WRK-118, WRK-139]
blocked_by: []
synced_to: []
provider: claude
---

## What

Add session-level locking to WRK items so that multiple Claude Code sessions cannot claim the same work item simultaneously.

## Why

With 8 concurrent Claude sessions observed on 2026-02-16, there is no mechanism to prevent two sessions from executing the same WRK item. This risks merge conflicts, duplicate commits, and wasted compute.

## Acceptance Criteria

- [ ] `locked_by` and `locked_at` fields added to WRK frontmatter schema
- [ ] `workflow-guards.sh` gains `claim_wrk <wrk_id>` and `release_wrk <wrk_id>` functions
- [ ] `claim_wrk` is atomic (uses temp file + `mv` pattern from session-store.sh)
- [ ] `claim_wrk` fails with exit code 4 if item already locked by another session
- [ ] Stale lock recovery: locks older than 2 hours are auto-released with warning
- [ ] `execute.sh` calls `claim_wrk` before dispatch, `release_wrk` after completion
- [ ] `review.sh` calls `release_wrk` on archive
- [ ] Tests: concurrent claim attempt (two rapid claims), stale lock recovery, claim-release round-trip
- [ ] No regressions in existing gate exit codes (1, 2, 3)

## Plan

### Phase 1: Schema extension
1. Add `locked_by: ""` and `locked_at: ""` to WRK frontmatter template
2. Add `wrk_claim()` and `wrk_release()` to `scripts/agents/lib/workflow-guards.sh`
3. Claim uses `session_get session_id` as lock value, `session_now_iso` as timestamp

### Phase 2: Gate integration
4. Wire `wrk_claim` into `execute.sh` pre-dispatch check
5. Wire `wrk_release` into `review.sh` post-archive and error paths
6. Add exit code 4 documentation to workflow-visual.html gate table

### Phase 3: Stale lock recovery
7. `wrk_claim` checks `locked_at` — if > 2h old, overwrite with warning to stderr
8. Dead session detection: if `locked_by` session ID not in active `session-state.yaml`, release

### Phase 4: Testing
9. Unit tests for claim/release/stale-recovery (bash test scripts)
10. Integration test: simulate concurrent claim from two session IDs

*Promoted from workflow-visual.html section 7 refinement candidates (2026-02-16)*
