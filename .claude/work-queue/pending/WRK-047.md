---
id: WRK-047
title: OpenFOAM CFD analysis capability for digitalmodel
status: pending
priority: low
complexity: complex
created_at: 2026-01-29T12:00:00Z
target_repos:
  - digitalmodel
commit:
spec_ref:
related: []
blocked_by: []
synced_to: []
---

# OpenFOAM CFD analysis capability for digitalmodel

## What
Develop OpenFOAM CFD analysis capability within digitalmodel â€” tooling for setting up, running, and post-processing CFD simulations using OpenFOAM for marine/offshore engineering applications.

## Why
CFD analysis using OpenFOAM complements potential flow tools (OrcaWave, AQWA) by resolving viscous effects, wave-structure interaction, green water, sloshing, and other nonlinear phenomena. Having an integrated OpenFOAM workflow in digitalmodel enables higher-fidelity analysis where needed.

## Acceptance Criteria
- [ ] OpenFOAM case setup tooling (mesh generation, boundary conditions, solver selection)
- [ ] Pre-processing: geometry import, domain definition, mesh control
- [ ] Solver configuration for relevant marine/offshore applications
- [ ] Post-processing: results extraction, visualisation, force/pressure integration
- [ ] Parametric case generation (varying geometry, flow conditions, etc.)
- [ ] Integration with digitalmodel workflow and data structures
- [ ] Tests covering case setup and post-processing pipelines
- [ ] Documentation of supported analysis types and workflow

## Plan

### Phase 0: Prerequisites and Environment Assessment

**Software availability check:**
- OpenFOAM is NOT installed on this system (no `blockMesh`, `interFoam`, etc. found in PATH)
- GMSH Python package is NOT installed (needed for volume mesh generation)
- PyVista/VTK are NOT installed (useful for post-processing visualization)
- All three must be declared as optional dependencies with graceful fallback

**Existing code to build on:**
- `src/digitalmodel/solvers/gmsh_meshing/` -- GMSH mesh generator, quality analyzer, CLI, data models (already exports to VTK and MSH formats; MSH is an OpenFOAM-compatible mesh input)
- `src/digitalmodel/solvers/gmsh_meshing/mesh_generator.py` -- `GMSHMeshGenerator` class with box, cylinder, STL surface meshing and VTK/MSH export
- `src/digitalmodel/solvers/gmsh_meshing/models.py` -- `MeshQuality`, `MeshStatistics`, `GeometryType`, `ElementType`, `MeshAlgorithm` dataclasses
- `src/digitalmodel/solvers/gmsh_meshing/quality_analyzer.py` -- `MeshQualityAnalyzer` with Jacobian, aspect ratio, skewness metrics
- `src/digitalmodel/hydrodynamics/bemrosetta/models/mesh_models.py` -- `PanelMesh`, `MeshQualityReport` for surface meshes
- `src/digitalmodel/hydrodynamics/diffraction/mesh_pipeline.py` -- `MeshPipeline` conversion between GDF/DAT/STL for solver preparation (pattern to replicate)
- `src/digitalmodel/solvers/blender_automation/examples/marine_engineering_integration.py` -- references hull export to STL for OpenFOAM/Fluent CFD

### Phase 1: OpenFOAM Case Data Model and Directory Builder

**Target path:** `src/digitalmodel/solvers/openfoam/`

Create the OpenFOAM case structure generator:

1. `src/digitalmodel/solvers/openfoam/__init__.py` -- module entry point
2. `src/digitalmodel/solvers/openfoam/models.py` -- Pydantic/dataclass models:
   - `OpenFOAMCase` -- top-level case configuration
   - `BoundaryCondition` -- BC specification (type, value, patch name)
   - `SolverConfig` -- solver selection and tolerances (simpleFoam, interFoam, pimpleFoam)
   - `TurbulenceModel` -- k-epsilon, k-omega SST, LES models
   - `DomainConfig` -- bounding box, refinement zones, cell sizing
   - `CaseType` enum -- `WAVE_LOADING`, `CURRENT_LOADING`, `GREENWATER`, `SLOSHING`, `VIV`
3. `src/digitalmodel/solvers/openfoam/case_builder.py` -- generates the standard OpenFOAM directory tree:
   - `0/` -- initial conditions (U, p, k, omega, alpha.water)
   - `constant/` -- transportProperties, turbulenceProperties, dynamicMeshDict
   - `system/` -- controlDict, fvSchemes, fvSolution, blockMeshDict, snappyHexMeshDict, decomposeParDict
4. `src/digitalmodel/solvers/openfoam/templates/` -- Jinja2 or string templates for each OpenFOAM dict file

**Tests:** `tests/solvers/openfoam/test_models.py`, `tests/solvers/openfoam/test_case_builder.py`
- Test case directory structure creation (verify all required files present)
- Test boundary condition serialization to OpenFOAM syntax
- Test solver selection for each `CaseType`

### Phase 2: Geometry Import and Mesh Generation Pipeline

**Target path:** `src/digitalmodel/solvers/openfoam/mesh_pipeline.py`

1. `mesh_pipeline.py` -- orchestrates the mesh workflow:
   - Accept STL geometry (hull surfaces from `bemrosetta` mesh handlers or Blender exports)
   - Generate background hex mesh via `blockMeshDict` template
   - Configure snappyHexMesh refinement near surfaces
   - Optional: Use GMSH (`solvers/gmsh_meshing/mesh_generator.py`) to generate volume meshes and convert to OpenFOAM-compatible format via `gmshToFoam` utility
2. `geometry_import.py` -- bridge between existing mesh infrastructure and OpenFOAM:
   - Load `PanelMesh` from `bemrosetta` handlers (GDF, DAT, STL)
   - Convert to STL for snappyHexMesh consumption
   - Support hull symmetry mirroring (leveraging `hull_library/mesh_generator.py` patterns)
3. `domain_builder.py` -- parametric domain definition:
   - Automatic domain sizing from geometry bounding box (e.g., 5L upstream, 10L downstream, 3B lateral)
   - Refinement zone specification near free surface (for VOF) and near hull
   - Cell grading ratios for boundary layer resolution

**Tests:** `tests/solvers/openfoam/test_mesh_pipeline.py`
- Test STL-to-case conversion round-trip
- Test domain sizing from known hull geometry
- Test blockMeshDict generation with correct vertex coordinates

### Phase 3: Solver Configuration for Marine Applications

**Target path:** `src/digitalmodel/solvers/openfoam/marine_solvers.py`

1. `marine_solvers.py` -- pre-configured solver setups for marine/offshore:
   - `WaveLoadingSetup` -- interFoam (VOF) with wave generation BCs, absorption zones
   - `CurrentLoadingSetup` -- simpleFoam or pimpleFoam for steady/unsteady current past structures
   - `GreenWaterSetup` -- interFoam with dynamic mesh for deck overtopping
   - `SloshingSetup` -- interFoam for internal tank sloshing (uses mesh motion)
   - `VIVSetup` -- pimpleFoam with 6DOF solver for vortex-induced vibration
2. `wave_models.py` -- wave boundary condition generators:
   - Regular wave (Stokes 2nd/5th order)
   - Irregular wave (JONSWAP, PM spectrum)
   - Current profile (power law, logarithmic)

**Tests:** `tests/solvers/openfoam/test_marine_solvers.py`
- Validate generated controlDict fields for each solver type
- Validate wave BC parameters against analytical formulae

### Phase 4: Post-Processing Pipeline

**Target path:** `src/digitalmodel/solvers/openfoam/post_processing.py`

1. `post_processing.py`:
   - Read OpenFOAM time directories (raw field data)
   - Extract forces and moments on patches (integrate pressure and viscous forces)
   - Extract probe point data (velocity, pressure time series)
   - Free surface elevation extraction from alpha.water field
2. `results_models.py` -- dataclasses for post-processing results:
   - `ForceTimeSeries`, `PressureField`, `FreeSurfaceElevation`
3. `visualization.py` -- Plotly-based visualization (consistent with digitalmodel convention for interactive plots):
   - Force/moment time histories
   - Pressure contour maps
   - Free surface snapshots
   - Convergence monitoring (residuals)

**Tests:** `tests/solvers/openfoam/test_post_processing.py`
- Test parsing of sample OpenFOAM force output files
- Test force integration on synthetic pressure distributions

### Phase 5: Parametric Case Generation

**Target path:** `src/digitalmodel/solvers/openfoam/parametric.py`

1. `parametric.py`:
   - Generate multiple cases from a parameter matrix (wave height, period, heading, current speed)
   - YAML-based parameter specification (consistent with existing `config/` patterns)
   - Case naming and directory management
2. `runner.py`:
   - Subprocess-based OpenFOAM execution (pattern from `blender_automation/core/blender_wrapper.py`)
   - Parallel execution via `decomposeParDict` configuration
   - Run monitoring (check convergence, detect divergence)

**Tests:** `tests/solvers/openfoam/test_parametric.py`
- Test case matrix generation from parameter ranges
- Test directory naming conventions

### Phase 6: Integration and CLI

1. `src/digitalmodel/solvers/openfoam/cli.py` -- Click CLI (pattern from `solvers/gmsh_meshing/cli.py`):
   - `openfoam setup` -- create case from configuration
   - `openfoam mesh` -- generate mesh for existing case
   - `openfoam run` -- execute solver
   - `openfoam postprocess` -- extract results
2. Update `src/digitalmodel/solvers/__init__.py` to expose the new module

### Risks and Mitigations

| Risk | Mitigation |
|------|-----------|
| OpenFOAM not installed on target system | All code must work in "dry-run" mode (generate files without running solver); detect OpenFOAM availability at runtime like GMSH pattern (`OPENFOAM_AVAILABLE` flag) |
| OpenFOAM version incompatibility (v10 vs v2306 vs ESI vs Foundation) | Target OpenFOAM.com (ESI) v2306+ syntax; document version requirements; use version detection |
| Large simulation files (GB-scale) | Post-processing must stream data, not load all into memory; use lazy field reading |
| Complex wave boundary conditions | Start with simplified BCs (regular waves, uniform current); add wave spectra in later iterations |
| GMSH not installed | Provide blockMesh-only fallback for simple geometries; GMSH-based meshing is optional enhancement |

### Dependency Summary

- **Required Python packages:** `pyyaml` (already available), `numpy` (already available), `jinja2` (for templates)
- **Optional Python packages:** `gmsh` (enhanced meshing), `pyvista` (post-processing visualization), `vtk` (field data reading)
- **External software:** OpenFOAM (ESI v2306+ recommended) -- optional for file generation, required for execution
- **Internal dependencies:** `solvers/gmsh_meshing/`, `hydrodynamics/bemrosetta/models/mesh_models.py`, `hydrodynamics/bemrosetta/mesh/` handlers

### Review Notes

**Cross-review date**: 2026-02-10

| Reviewer | Verdict |
|----------|---------|
| Claude Opus 4.6 | APPROVE |
| Gemini CLI | APPROVE |
| Codex CLI | NO_OUTPUT |

**Feedback incorporated**:
- All references verified, dry-run design is sound, risk mitigation thorough

---
*Source: openfoam CFD analysis*
