---
id: WRK-207
title: "fix(ai): align weekly quota reporting with authoritative Claude source"
status: pending
priority: medium
complexity: medium
target_repos:
  - workspace-hub
provider: codex
provider_alt: claude
percent_complete: 75
html_output_ref: .claude/work-queue/assets/WRK-207/review.html
---

# WRK-207: Fix query-quota.sh weekly usage reporting for Claude and Codex

## What
Keep `scripts/ai/assessment/query-quota.sh` accurate for weekly usage reporting while
the Claude OAuth-backed quota source is broken. The current accepted behavior is:

- Codex weekly usage is reported from local history.
- Gemini remains best-effort.
- Claude shows `N/A` in display, weekly summary, and cached quota snapshots unless the
  authoritative OAuth-backed source is available.

This item stays open until the Claude authoritative refresh path is repaired and weekly
reporting can safely consume it.

## Why
Weekly usage output is used for planning and statusline visibility across the repo
ecosystem. Showing an estimated Claude quota as if it were authoritative creates bad
planning data and contradicts the intended `/usage` source of truth. `N/A` is safer
than a wrong percentage.

## Problem
`query-quota.sh --weekly` reports 100% remaining (inaccurate) because it reads from
`~/.agent-usage/weekly-log.jsonl` which is only populated by `--log` flag runs — never
populated historically.

Actual weekly data exists in source files but `--weekly` doesn't read them directly:
- **Claude**: `~/.claude/stats-cache.json` has `dailyActivity[]` — last 7 days show
  52,186 messages across 38 sessions (Feb 11–16; Feb 17–18 not yet written to cache).
  `stats-cache.json` only updates when sessions close, so current-day data lags.
- **Codex**: `~/.codex/history.jsonl` has timestamped entries — 12 messages this week.

The statusline (`statusline-command.sh`) and related tooling should only surface Claude
quota when `config/ai-tools/agent-quota-latest.json` has been populated from the
authoritative OAuth-backed source.

## What Needs Fixing

1. **Keep Claude gated on authoritative data**: `query_claude()` must not turn
   `stats-cache.json` or `ccusage` into a displayed quota percentage while the
   OAuth-backed source is unavailable.

2. **Rewrite `query_codex()` to use weekly window**: filter `history.jsonl` by
   `ts >= (now - 7*86400)` and count entries over the week.

3. **Rewrite `show_weekly_summary()`** to read directly from source files (same logic
   as above) instead of relying on the `weekly-log.jsonl` accumulation file. For
   Claude, weekly display should stay `N/A` until the authoritative source works.

4. **Repair the Claude refresh path**: restore a reliable fetch step that writes fresh
   OAuth-backed quota data into `config/ai-tools/agent-quota-latest.json`.

5. **Statusline `ai_usage` field**: once the authoritative Claude snapshot is repaired,
   `C:|O:|G:` should reflect the same source used by `/usage`.

## Key Files
- `scripts/ai/assessment/query-quota.sh` — main script to fix
- `.claude/statusline-command.sh` — reads `~/.cache/agent-quota.json`
- `~/.claude/stats-cache.json` — Claude source data
- `~/.codex/history.jsonl` — Codex source data

## Cross-Platform Requirements
- Must work on Linux, Windows (MINGW64/Git Bash), and macOS
- `date -d` is GNU-only — use `date -v` on macOS or `python3 -c "..."` for portable epoch math
- `stat -c %Y` (GNU) vs `stat -f %m` (BSD/macOS) — abstract into a helper or use Python fallback
- `wc -l` output has leading spaces on BSD — always pipe through `tr -d ' '`
- Avoid bashisms that differ between bash 3 (macOS default) and bash 5 (Linux/MINGW)
- Test on all 3 platforms before closing

## Notes
- `stats-cache.json` `lastComputedDate` was `2026-02-16` — today's sessions not written yet.
  Weekly sum will undercount current-day usage until session closes.
- Codex history only has 33 total entries — very light usage, easy to count weekly.
- Gemini source (`~/.config/gemini/state.json`) is less reliable; lower priority.
- Current accepted interim behavior:
  - `query-quota.sh` display: Claude `N/A`
  - `query-quota.sh --weekly`: Claude `N/A`
  - `query-quota.sh --refresh --json`: Claude source `unavailable`, quota fields null
- Do not close this item until the OAuth-backed Claude refresh source is working again.

## Consolidation Note (2026-02-27)

- Canonical open item for weekly usage reporting correctness.
- Use this item when `query-quota.sh --weekly` is inaccurate, stale, or otherwise needs bug-fix work.
- Do not use this item for routine weekly usage execution; that maps to the historical display/reporting workflow in `WRK-108`.
- Do not use this item for broad quota infrastructure review; that maps to `WRK-172`.

## Agentic AI Horizon

- Fixing query-quota.sh weekly usage reporting gives accurate quota visibility — directly prevents session-start quota surprises that derail agent execution plans.
- Quota tracking tools are utility infrastructure; fixing this small bug has immediate session-management value.
- **Disposition: keep open** — the unsafe estimated path has been removed, but the
  authoritative Claude refresh source still needs repair.

<!-- computer: ace-linux-1 -->
