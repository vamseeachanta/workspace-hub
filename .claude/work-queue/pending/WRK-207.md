# WRK-207: Fix query-quota.sh weekly usage reporting for Claude and Codex

## Status: pending

## Problem
`query-quota.sh --weekly` reports 100% remaining (inaccurate) because it reads from
`~/.agent-usage/weekly-log.jsonl` which is only populated by `--log` flag runs — never
populated historically.

Actual weekly data exists in source files but `--weekly` doesn't read them directly:
- **Claude**: `~/.claude/stats-cache.json` has `dailyActivity[]` — last 7 days show
  52,186 messages across 38 sessions (Feb 11–16; Feb 17–18 not yet written to cache).
  `stats-cache.json` only updates when sessions close, so current-day data lags.
- **Codex**: `~/.codex/history.jsonl` has timestamped entries — 12 messages this week.

The statusline (`statusline-command.sh`) shows `C:-|O:-|G:-` because the quota cache
has `pct_remaining: 100` which is wrong.

## What Needs Fixing

1. **Rewrite `query_claude()` to use weekly window**: sum `dailyActivity[]` entries for
   last 7 days instead of just today. Compare against weekly limit (not daily).

2. **Rewrite `query_codex()` to use weekly window**: filter `history.jsonl` by
   `ts >= (now - 7*86400)` and count entries over the week.

3. **Rewrite `show_weekly_summary()`** to read directly from source files (same logic
   as above) instead of relying on the `weekly-log.jsonl` accumulation file.

4. **Fix the weekly limit values**: `CLAUDE_DAILY_LIMITS[default_claude_max_20x]=3000`
   was intended as daily but should be weekly. Rename dict to `CLAUDE_WEEKLY_LIMITS`
   and confirm correct cap with user before hardcoding.

5. **Statusline `ai_usage` field**: once `pct_remaining` is accurate in the cache,
   `C:|O:|G:` in the statusline will reflect real usage.

## Key Files
- `scripts/ai/assessment/query-quota.sh` — main script to fix
- `.claude/statusline-command.sh` — reads `~/.cache/agent-quota.json`
- `~/.claude/stats-cache.json` — Claude source data
- `~/.codex/history.jsonl` — Codex source data

## Cross-Platform Requirements
- Must work on Linux, Windows (MINGW64/Git Bash), and macOS
- `date -d` is GNU-only — use `date -v` on macOS or `python3 -c "..."` for portable epoch math
- `stat -c %Y` (GNU) vs `stat -f %m` (BSD/macOS) — abstract into a helper or use Python fallback
- `wc -l` output has leading spaces on BSD — always pipe through `tr -d ' '`
- Avoid bashisms that differ between bash 3 (macOS default) and bash 5 (Linux/MINGW)
- Test on all 3 platforms before closing

## Notes
- `stats-cache.json` `lastComputedDate` was `2026-02-16` — today's sessions not written yet.
  Weekly sum will undercount current-day usage until session closes.
- Codex history only has 33 total entries — very light usage, easy to count weekly.
- Gemini source (`~/.config/gemini/state.json`) is less reliable; lower priority.
- Confirm actual weekly message cap for `default_claude_max_20x` before setting limit.

## Agentic AI Horizon

- Fixing query-quota.sh weekly usage reporting gives accurate quota visibility — directly prevents session-start quota surprises that derail agent execution plans.
- Quota tracking tools are utility infrastructure; fixing this small bug has immediate session-management value.
- **Disposition: do now** — a small, well-scoped bug fix with direct impact on every session's quota planning; close it immediately.

<!-- computer: ace-linux-1 -->
