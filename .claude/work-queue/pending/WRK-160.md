---
id: WRK-160
title: Codex fallback — 2-of-3 consensus when Codex returns NO_OUTPUT
status: pending
priority: high
complexity: moderate
compound: false
created_at: 2026-02-16T19:30:00Z
target_repos:
  - workspace-hub
commit:
spec_ref:
related: [WRK-094, WRK-118]
blocked_by: []
synced_to: []
provider: claude
---

## What

Add a fallback policy to the cross-review gate: when Codex returns `NO_OUTPUT` (empty response on large diffs), accept a 2-of-3 consensus from Claude + Gemini instead of hard-blocking.

## Why

Codex produces empty output on diffs > ~19K lines (known limitation). This blocks archival of correctly-implemented items. The current hard gate has no escape hatch, creating a workflow deadlock for large changes.

## Policy Decision (requires user confirmation)

**Proposed policy hierarchy:**
1. Codex returns `APPROVE` or `MINOR` → **PASS** (current behavior, unchanged)
2. Codex returns `MAJOR` or `REJECT` → **FAIL** (current behavior, unchanged)
3. Codex returns `NO_OUTPUT` or `ERROR` **AND** both Claude + Gemini return `APPROVE` or `MINOR` → **CONDITIONAL PASS** with `codex_fallback: true` tag
4. Codex returns `NO_OUTPUT` **AND** Claude or Gemini also fails → **FAIL** (hard block remains)

This preserves Codex as the primary authority while adding a safety valve for its known failure mode.

## Acceptance Criteria

- [ ] `cross-review.sh` detects `NO_OUTPUT` from Codex (empty file or file < 10 bytes)
- [ ] When NO_OUTPUT detected, checks Claude and Gemini results for consensus
- [ ] 2-of-3 consensus (Claude + Gemini both APPROVE/MINOR) → exit 0 with `codex_fallback: true` in output
- [ ] If consensus not reached → exit 1 (existing hard block behavior)
- [ ] `codex_fallback: true` tag added to WRK frontmatter when fallback used
- [ ] All fallback invocations logged to `scripts/review/results/` with `FALLBACK` prefix
- [ ] `normalize-verdicts.sh` updated to handle `CONDITIONAL_PASS` verdict
- [ ] Tests: Codex NO_OUTPUT + 2 approvals = pass, Codex NO_OUTPUT + 1 approval = fail, Codex REJECT = fail (no fallback)
- [ ] `behavior-contract.yaml` updated with fallback policy documentation

## Plan

### Phase 1: Detection
1. In `cross-review.sh`, after Codex submission, check result file size
2. If < 10 bytes or contains only whitespace → classify as `NO_OUTPUT`

### Phase 2: Consensus logic
3. Read Claude and Gemini result files
4. Extract verdicts via `normalize-verdicts.sh`
5. If both are `APPROVE` or `MINOR` → set `CONDITIONAL_PASS`
6. Otherwise → maintain exit 1

### Phase 3: Tagging
7. On `CONDITIONAL_PASS`: add `codex_fallback: true` and `codex_fallback_date` to WRK frontmatter
8. Log to results/ with `FALLBACK-` filename prefix

### Phase 4: Documentation
9. Update `behavior-contract.yaml` Gate 3 section
10. Update `workflow-visual.html` Gate 3 diagram to show fallback path

### Phase 5: Testing
11. Mock Codex NO_OUTPUT (empty file) + Claude APPROVE + Gemini APPROVE → expect exit 0
12. Mock Codex NO_OUTPUT + Claude APPROVE + Gemini NO_OUTPUT → expect exit 1
13. Mock Codex REJECT + Claude APPROVE + Gemini APPROVE → expect exit 1 (no fallback on explicit reject)

*Promoted from workflow-visual.html section 7 refinement candidates (2026-02-16)*
