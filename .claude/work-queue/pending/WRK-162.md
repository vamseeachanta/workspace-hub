# WRK-162: Combined Multi-Body Benchmark Report

## Status: in_progress
## Priority: medium
## Created: 2026-02-17
## Parent: WRK-149 (expand validation data)

## Description

For multi-body diffraction cases (e.g., case 2.6 Cylinder+Spheroid), create a single
combined report that demonstrates multi-body behavior by bringing both bodies together
in one context, rather than only producing separate per-body reports.

## Context

Current state: per-body reports exist at `body_0/benchmark_report.html` and
`body_1/benchmark_report.html`, plus coupling heatmaps at `coupling/`. Each body
report is standalone with navigation links between them (added in WRK-149 report
quality improvements).

User feedback: "Both bodies should be brought together in a single report context
to demonstrate multi-body behavior."

## Requirements

1. **Combined report** at `benchmark/` root level showing both bodies in a single page
2. **Side-by-side comparison** of RAOs, hydro coefficients for each body
3. **Coupling section** with AM/damping coupling heatmaps inline (not just linked)
4. **Interaction effects** — highlight where multi-body coupling changes responses
5. **Per-body reports** should still exist for detailed drill-down
6. **Navigation** between combined report and per-body reports

## Acceptance Criteria

- [x] Combined report generated for case 2.6 (`benchmark/index.html`) — multi-body overview with RAO table, coupling matrices inline, navigation links
- [x] Both bodies' RAOs visible in single view (per-body correlation table in index.html)
- [x] Coupling matrices shown inline (AM + radiation damping coupling heatmaps, both directions)
- [x] Navigation links between combined and per-body reports
- [x] Single-body cases unaffected (no combined report generated) — validated 2026-02-17: hard guard `if len(bodies) > 1:` in validate_owd_vs_spec.py prevents index.html/body_0/ for single-body cases; confirmed on filesystem (2.7, 2.8, 3.2 etc. have no index.html)

## Progress Log

### 2026-02-17 — Phase 3: Acceptance Criterion Validation (WRK-162)

**Completed:**
- Validated AC5: single-body cases unaffected
  - Code guard in `validate_owd_vs_spec.py`: `if len(bodies) > 1:` gates all multi-body output
  - `body_0/` subdirectory routing: `body_out_dir = out_dir / f"body_{bi}" if len(bodies) > 1 else out_dir`
  - `index.html` and coupling reports never generated for single-body cases
  - Filesystem verified: cases 2.7, 2.8, 3.1, 3.2 all have flat `benchmark/benchmark_report.html` (no `body_0/`, no `index.html`)
- Only multi-body cases in CASES dict: 2.6 (Cylinder+Spheroid) and 3.3 (Cylinder+Ellipsoid)

**All 5 acceptance criteria now satisfied.**

### 2026-02-17 — Phase 4: OrcaWave Settings Fix (cases 2.7, 2.8, 2.9)

**Root cause identified:** Cases 2.7 onwards had significant semantic diffs (6 for 2.7, 2 for 2.8, 1 for 2.9) between OWD exports and spec-generated YAMLs, blocking readiness for AQWA vs OrcaWave comparisons.

**Fixes applied:**
- `validate_owd_vs_spec.py` `_compare_orcawave_ymls`:
  - Added `BodyControlSurfaceMeshFileName`, `BodyControlSurfaceMeshFormat`, `BodyControlSurfaceMeshLengthUnits` to `_COSMETIC_KEYS` (same geometry, different naming convention — consistent with `BodyMeshFileName`)
  - Added `QuadraticLoadMomentumConservation` to `_DORMANT_QTF_KEYS` (inactive for potential-only and non-QTF solves)
- `data/hull_library/panels/primitives/pyramid_zc08.csf` — new file copied from `2.7/OrcaWave v11.0 files/PyramidZC08.csf`
- `2.7/spec.yml` — added `vessel.control_surface` (pyramid_zc08.csf) + `solver_options.divide_non_planar_panels: false`
- `2.8/spec.yml` — added `solver_options.divide_non_planar_panels: false`
- Re-ran validation for cases 2.7, 2.8, 2.9; regenerated master summary HTML

**Result after fixes:**
| Case | Significant diffs (before→after) | Consensus | All-DOF corr |
|------|-----------------------------------|-----------|--------------|
| 2.7  | 6 → 0                             | FULL      | r=1.0000     |
| 2.8  | 2 → 0                             | FULL      | r=1.0000     |
| 2.9  | 1 → 0                             | FULL      | r≥0.9999997  |

**Status:** OrcaWave settings for cases 2.7–2.9 are now semantically equivalent to their OWD ground truth. Ready for AQWA vs OrcaWave comparisons.

### 2026-02-17 — Phase 2: Panel Geometry Schematics (WRK-162)

**Completed:**
- Extracted `diff.panelGeometry` from `test05a.owd` via OrcFxAPI (704 panels total)
  - `test05 cylinder`: 448 panels | `test05 spheroid`: 256 panels
- Injected interactive Plotly 3D Scatter3d into all three Case 2.6 benchmark reports:
  - `benchmark/index.html` — both bodies colour-coded (blue/orange), waterplane surface, 704 panels
  - `body_0/benchmark_report.html` — cylinder only, 448 panels (blue)
  - `body_1/benchmark_report.html` — spheroid only, 256 panels (orange)
- Standalone `benchmark/panel_geometry.html` created
- Committed: `70608a03` in `digitalmodel`
- PNG skipped: Kaleido 1.0.0 incompatible with Plotly 5.17.0 (needs plotly ≥6.1.1 or kaleido==0.2.1)

**Remaining / open:**
- Geometry section is injected via one-shot script (not wired into `BenchmarkPlotter` pipeline) — future: integrate into `build_mesh_schematic_html()` so it runs automatically for all cases
- PNG export blocked by kaleido/plotly version mismatch — not critical
- Single-body case validation (acceptance criterion 5) not yet checked

## Future Ideas

### Geometry Symmetry in Reports
When a body has mesh symmetry applied (xz-plane, yz-plane, or both), the mesh
schematic currently shows only the panels in the GDF file (the symmetric half or
quarter). A future enhancement would reconstruct and display the full symmetric
geometry so the report reflects the actual physical shape — e.g. a quarter-cylinder
GDF renders as a full cylinder in the 3D view.

Implementation notes:
- `build_orcawave_metadata_from_yml` already extracts `mesh_symmetry` from
  `BodyMeshSymmetry` (e.g. "xz and yz planes")
- `MeshPipeline.load()` / `PanelMesh` would need a `reflect(axes)` method
- `build_mesh_schematic_html()` in `BenchmarkPlotter` would apply the reflection
  before plotting if symmetry metadata is present
- Symmetry info is available in the report's hull-mesh parameter table already

## Related

- WRK-149: Multi-body report quality improvements (parent)
- WRK-150: Executive summary dashboard
- Case 2.6: Cylinder+Spheroid (primary test case)
