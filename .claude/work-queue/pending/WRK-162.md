---
id: WRK-162
status: pending
plan_workstations: [ace-linux-1]
execution_workstations: [ace-linux-1]
---

# WRK-162: Combined Multi-Body Benchmark Report

## Status: done
## Priority: medium
## Created: 2026-02-17
## Parent: WRK-149 (expand validation data)

## Description

For multi-body diffraction cases (e.g., case 2.6 Cylinder+Spheroid), create a single
combined report that demonstrates multi-body behavior by bringing both bodies together
in one context, rather than only producing separate per-body reports.

## Context

Current state: per-body reports exist at `body_0/benchmark_report.html` and
`body_1/benchmark_report.html`, plus coupling heatmaps at `coupling/`. Each body
report is standalone with navigation links between them (added in WRK-149 report
quality improvements).

User feedback: "Both bodies should be brought together in a single report context
to demonstrate multi-body behavior."

## Requirements

1. **Combined report** at `benchmark/` root level showing both bodies in a single page
2. **Side-by-side comparison** of RAOs, hydro coefficients for each body
3. **Coupling section** with AM/damping coupling heatmaps inline (not just linked)
4. **Interaction effects** — highlight where multi-body coupling changes responses
5. **Per-body reports** should still exist for detailed drill-down
6. **Navigation** between combined report and per-body reports

## Acceptance Criteria

- [x] Combined report generated for case 2.6 (`benchmark/index.html`) — multi-body overview with RAO table, coupling matrices inline, navigation links
- [x] Both bodies' RAOs visible in single view (per-body correlation table in index.html)
- [x] Coupling matrices shown inline (AM + radiation damping coupling heatmaps, both directions)
- [x] Navigation links between combined and per-body reports
- [x] Single-body cases unaffected (no combined report generated) — validated 2026-02-17: hard guard `if len(bodies) > 1:` in validate_owd_vs_spec.py prevents index.html/body_0/ for single-body cases; confirmed on filesystem (2.7, 2.8, 3.2 etc. have no index.html)

## Progress Log

### 2026-02-17 — Phase 3: Acceptance Criterion Validation (WRK-162)

**Completed:**
- Validated AC5: single-body cases unaffected
  - Code guard in `validate_owd_vs_spec.py`: `if len(bodies) > 1:` gates all multi-body output
  - `body_0/` subdirectory routing: `body_out_dir = out_dir / f"body_{bi}" if len(bodies) > 1 else out_dir`
  - `index.html` and coupling reports never generated for single-body cases
  - Filesystem verified: cases 2.7, 2.8, 3.1, 3.2 all have flat `benchmark/benchmark_report.html` (no `body_0/`, no `index.html`)
- Only multi-body cases in CASES dict: 2.6 (Cylinder+Spheroid) and 3.3 (Cylinder+Ellipsoid)

**All 5 acceptance criteria now satisfied.**

### 2026-02-17 — Phase 4: OrcaWave Settings Fix (cases 2.7, 2.8, 2.9)

**Root cause identified:** Cases 2.7 onwards had significant semantic diffs (6 for 2.7, 2 for 2.8, 1 for 2.9) between OWD exports and spec-generated YAMLs, blocking readiness for AQWA vs OrcaWave comparisons.

**Fixes applied:**
- `validate_owd_vs_spec.py` `_compare_orcawave_ymls`:
  - Added `BodyControlSurfaceMeshFileName`, `BodyControlSurfaceMeshFormat`, `BodyControlSurfaceMeshLengthUnits` to `_COSMETIC_KEYS` (same geometry, different naming convention — consistent with `BodyMeshFileName`)
  - Added `QuadraticLoadMomentumConservation` to `_DORMANT_QTF_KEYS` (inactive for potential-only and non-QTF solves)
- `data/hull_library/panels/primitives/pyramid_zc08.csf` — new file copied from `2.7/OrcaWave v11.0 files/PyramidZC08.csf`
- `2.7/spec.yml` — added `vessel.control_surface` (pyramid_zc08.csf) + `solver_options.divide_non_planar_panels: false`
- `2.8/spec.yml` — added `solver_options.divide_non_planar_panels: false`
- Re-ran validation for cases 2.7, 2.8, 2.9; regenerated master summary HTML

**Result after fixes:**
| Case | Significant diffs (before→after) | Consensus | All-DOF corr |
|------|-----------------------------------|-----------|
--------------|
| 2.7  | 6 → 0                             | FULL      | r=1.0000     |
| 2.8  | 2 → 0                             | FULL      | r=1.0000     |
| 2.9  | 1 → 0                             | FULL      | r≥0.9999997  |

**Status:** OrcaWave settings for cases 2.7–2.9 are now semantically equivalent to their OWD ground truth. Ready for AQWA vs OrcaWave comparisons.

### 2026-02-17 — Phase 2: Panel Geometry Schematics (WRK-162)

**Completed:**
- Extracted `diff.panelGeometry` from `test05a.owd` via OrcFxAPI (704 panels total)
  - `test05 cylinder`: 448 panels | `test05 spheroid`: 256 panels
- Injected interactive Plotly 3D Scatter3d into all three Case 2.6 benchmark reports:
  - `benchmark/index.html` — both bodies colour-coded (blue/orange), waterplane surface, 704 panels
  - `body_0/benchmark_report.html` — cylinder only, 448 panels (blue)
  - `body_1/benchmark_report.html` — spheroid only, 256 panels (orange)
- Standalone `benchmark/panel_geometry.html` created
- Committed: `70608a03` in `digitalmodel`
- PNG skipped: Kaleido 1.0.0 incompatible with Plotly 5.17.0 (needs plotly ≥6.1.1 or kaleido==0.2.1)

**Remaining / open:**
- Geometry section is injected via one-shot script (not wired into `BenchmarkPlotter` pipeline) — future: integrate into `build_mesh_schematic_html()` so it runs automatically for all cases
- PNG export blocked by kaleido/plotly version mismatch — not critical
- Single-body case validation (acceptance criterion 5) not yet checked

### 2026-02-18 — Phase 5: Master Summary Display Fix

**Root cause:** `_generate_master_html` showed `0.0` in grey when `max_abs_diff < 1e-6`,
which looked like zero correlation but actually meant bit-identical results (r=1.0).

**Fix applied:**
- `validate_owd_vs_spec.py` `_generate_master_html`: When `max_diff < 1e-6`, now shows
  `corr:.6f` in green (#16a34a) with `[identical — Δ<1e-6]` tooltip annotation.
- Affected cases: 2.5c, 2.5f, 2.6, 2.7, 2.8, 3.1, 3.3 (all had 0.0 — all are r=1.0)
- Individual `benchmark_report.html` reports were unaffected (showed 1.0000 correctly).
- `validation_summary.html` regenerated via `--summary-only` (108 green 1.000000 cells).
- Committed: `76ffbfc9` in `digitalmodel`; parent pointer updated `6f6e3aa`.

### 2026-02-18 — Phase 6: Fix `diff.headings` empty-after-Calculate() bug

**Root cause:** `OrcFxAPI.Diffraction.headings` returns an empty array after `Calculate()`
for certain analysis types (`full_qtf`, bi-symmetric configurations, fixed-DOF bodies).
The property is only reliably populated via `LoadResults()` from a saved `.owr` file.
This caused 7 of 13 validation cases to show `Headings: 0 (°)` in individual reports,
making DOF plots appear empty.

**Fix applied — 3 change sites in `validate_owd_vs_spec.py`:**
- `solve_owd()` return type: extended from 4-tuple to 5-tuple, adding `owr_path`
  as 5th element; set to `None` in the except block if `SaveResults()` fails
- `run_comparison()`: added `owr_path: Optional[Path] = None` parameter; attaches
  `owr_path` to `metadata["OrcaWave (.owd)"]["owr_path"]` so `BenchmarkRunner`
  extracts it and delegates to `extract_report_data_from_owr()` → `LoadResults()`
- `run_case()`: unpacks 5-tuple from `solve_owd()` and passes `owr_path=owr_path`
  to `run_comparison()`

**Cases regenerated:** 2.2, 2.3, 2.5c, 2.5f, 3.1, 3.2, 3.3
**Verification:** All 14 `benchmark_report.html` files (incl. 2 sub-bodies in 2.6, 3.3)
now show `Headings: N` where N ≥ 1. Master summary regenerated via `--summary-only`.

### 2026-02-18 — Phase 7: Full re-run with Sonnet 4.6 review (WRK-162)

**Action:** Full `--all` regeneration of all 12 validation cases using Claude Sonnet 4.6.

**Code review findings (validate_owd_vs_spec.py — 2126 lines):**
- All Phase 6 fixes confirmed correct: `solve_owd()` 5-tuple (lines 356/439),
  `run_comparison()` owr_path triple-check (lines 773-774), `run_case()` 5-tuple
  unpacking (line 1421), identical-results display fix (lines 1785-1789)
- No bugs, deprecated patterns, or Python warnings found
- Case 2.4 BLOCKED gracefully: skipped in run loop (line 1502), shown in master HTML
- `_compare_orcawave_ymls()` classification logic clean (4-tier: match/cosmetic/convention/significant)
- `DivideNonPlanarPanels: False vs True` — acknowledged significant diff across 8 cases;
  does NOT affect RAOs (all r=1.0). Will not reclassify without further investigation.

**Results:**
| Case | Description                        | DOFs | Headings | Status |
|------|------------------------------------|------|----------|
--------|
| 2.1  | Cylinder R=1 T=0.5 (no IRR)       | all r=1.0000 | 2  | PASS   |
| 2.2  | Cylinder R=1 T=0.5 (base mesh)    | all r=1.0000 | 2  | PASS   |
| 2.3  | Cylinder R=1 T=0.5 (trimmed)      | all r=1.0000 | 2  | PASS   |
| 2.5c | ISSC TLP coarse (128 panels)      | all r=1.0000 | 1  | PASS   |
| 2.5f | ISSC TLP fine (1012 panels)       | all r=1.0000 | 1  | PASS   |
| 2.6  | Multi-body Cylinder+Spheroid      | all r=1.0000 | 1  | PASS   |
| 2.7  | Inverted Pyramid                  | all r=1.0000 | 18 | PASS   |
| 2.8  | Ellipsoid                         | all r=1.0000 | 18 | PASS   |
| 2.9  | Moonpool cylinder with lid        | all r=1.0000 | 6  | PASS   |
| 3.1  | Bottom-mounted cylinder, Full QTF | all r=1.0000 | 1  | PASS   |
| 3.2  | Sphere with Lid                   | all r=1.0000 | 1  | PASS   |
| 3.3  | Multi-body Cylinder + Ellipsoid   | Body1 r=1.0000 | 5 | PASS |

**Committed:** `2a25e92a` in `digitalmodel` (128 files: HTML, JSON, YAML updated)
**Master summary:** `validation_summary.html` regenerated — all green, no regressions.

## Future Ideas

### Geometry Symmetry in Reports
When a body has mesh symmetry applied (xz-plane, yz-plane, or both), the mesh
schematic currently shows only the panels in the GDF file (the symmetric half or
quarter). A future enhancement would reconstruct and display the full symmetric
geometry so the report reflects the actual physical shape — e.g. a quarter-cylinder
GDF renders as a full cylinder in the 3D view.

Implementation notes:
- `build_orcawave_metadata_from_yml` already extracts `mesh_symmetry` from
  `BodyMeshSymmetry` (e.g. "xz and yz planes")
- `MeshPipeline.load()` / `PanelMesh` would need a `reflect(axes)` method
- `build_mesh_schematic_html()` in `BenchmarkPlotter` would apply the reflection
  before plotting if symmetry metadata is present
- Symmetry info is available in the report's hull-mesh parameter table already

### DivideNonPlanarPanels Setting Investigation
`DivideNonPlanarPanels: False vs True` appears in 8 of 12 cases as a "significant"
semantic diff but has zero effect on RAO results (r=1.0). Consider whether to:
- Add to `_COSMETIC_KEYS` (safe when results agree perfectly)
- Document as known OrcaWave default behavior in spec.yml template

## Related

- WRK-149: Multi-body report quality improvements (parent)
- WRK-150: Executive summary dashboard
- Case 2.6: Cylinder+Spheroid (primary test case)

## Agentic AI Horizon

- Combined multi-body benchmark report validates the frequency-domain solver comparison infrastructure for complex cases — important quality evidence for client-facing analysis.
- Benchmark result comparison and reporting is a perfect agent-generated deliverable once the analysis runs complete.
- **Disposition: do now** — close the benchmark reporting gap in WRK-149; multi-body diffraction validation is needed before those analysis types can be used in client projects.

<!-- computer: ace-linux-1 -->
