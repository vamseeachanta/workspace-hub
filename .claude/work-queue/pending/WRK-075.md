---
id: WRK-075
title: "OFFPIPE Integration Module \u2014 pipelay cross-validation against OrcaFlex"
status: pending
priority: low
complexity: complex
compound: false
created_at: 2026-02-02 15:00:00+00:00
target_repos:
- digitalmodel
commit: null
spec_ref: specs/modules/dazzling-snuggling-thunder.md
related: []
blocked_by: []
synced_to: []
provider: claude
provider_alt: null
task_agents:
  phase_0: gemini
  phase_1: claude
  phase_2: codex
  phase_3: codex
  phase_4: codex
  phase_5: codex
  phase_6: codex
plan_reviewed: false
plan_approved: false
computer: acma-ansys05
---

# OFFPIPE Integration Module — pipelay cross-validation against OrcaFlex

## What

Full OFFPIPE module for independent cross-validation of OrcaFlex pipelay analysis. MVP scoped to S-lay static analysis. Includes:
- OFFPIPE output file parser
- Unified pipelay schema (PipelayResults, PipeProfile dataclasses)
- OrcaFlex pipelay result extraction via OrcFxAPI (in orcaflex/ for reuse)
- Configurable tolerance-based comparison engine (relative + absolute per parameter)
- Interactive Plotly HTML benchmark reports with agreement classification
- Input deck generator (Phase 6, deferred)

## Why

OFFPIPE uses an independent beam-column FEM formulation vs OrcaFlex's lumped-mass/spring approach. This makes it the most practical tool for pipelay cross-validation — no other realistic alternative (Flexcom, Riflex, PipeLay) offers better accessibility. The user has comprehensive OFFPIPE documentation and example files to drive parser design.

## Constraints

- Phase 0 blocked until user provides OFFPIPE docs + example files + matching OrcaFlex scenario
- TDD mandatory — tests first for every phase
- Flat module structure (no sub-packages) matching diffraction pattern
- Must register in engine.py for standard YAML routing
- No mocks — real data with pytest.skip fallback

## Acceptance Criteria

- [ ] OFFPIPE S-lay output files parsed correctly (validated against golden reference)
- [ ] OrcaFlex pipelay results extracted via OrcFxAPI
- [ ] Cross-validation comparison with configurable per-parameter tolerances
- [ ] Interactive Plotly HTML benchmark report with agreement classification (EXCELLENT/GOOD/FAIR/POOR)
- [ ] All tests pass via `uv run pytest tests/offpipe/` (TDD, no mocks, real data)
- [ ] engine.py routes `offpipe` basename correctly
- [ ] Skills created: `offpipe-analysis`, `offpipe-orcaflex-benchmark` (Phase 6)

## Implementation Notes

_Populated during processing._

## Plan

> **Spec reference**: `digitalmodel/specs/modules/dazzling-snuggling-thunder.md` (268 lines, cross-reviewed v0.2.0).
> **Phase 0 BLOCKED** until user provides OFFPIPE docs + example output files + matching OrcaFlex scenario.

### Phase 0: Documentation Analysis (GATE -- user-blocked)

**Prerequisite**: User provides:
1. OFFPIPE user manual / technical documentation (PDF)
2. Example S-lay static output file (`.out` or similar)
3. Corresponding OFFPIPE input deck
4. Matching OrcaFlex model (`.dat` or `.yml`) with simulation results (`.sim`)

**Steps**:
1. Analyze OFFPIPE output format: column headers, units, section boundaries (sagbend/overbend/stinger)
2. Map OFFPIPE fields to unified `PipeProfile` schema fields (arclength, stress, curvature, tension, etc.)
3. Identify unmappable fields (fields present in one tool but not the other)
4. Document unit conventions (OFFPIPE may use imperial; OrcaFlex uses SI)
5. Validate example file structure against documentation

**Exit criteria**: Field mapping table complete; parser design documented.

### Phase 1: Scaffold + Router + engine.py Registration

**Target files (new)**:
- `src/digitalmodel/offpipe/__init__.py` -- module exports, `__all__`, version
- `src/digitalmodel/offpipe/offpipe.py` -- thin router class (if/elif dispatch, matching existing pattern in `engine.py` lines 93-190)
- `src/digitalmodel/offpipe/pipelay_schemas.py` -- `PipelayMetadata`, `PipeProfile`, `PipelayResults` dataclasses

**Target files (modify)**:
- `src/digitalmodel/engine.py` (196 lines) -- add `offpipe` basename route after line 188 (before `else` clause)

**Test file**:
- `tests/offpipe/conftest.py` -- fixtures, golden data loaders, `@pytest.mark.offpipe`
- `tests/offpipe/test_offpipe_router.py`

**Steps (TDD)**:
1. Write test: `Offpipe().router({"calculation": {"name": "parse_output"}, ...})` dispatches correctly
2. Write test: `engine(cfg={"basename": "offpipe", ...})` routes to `Offpipe().router()`
3. Write test: Unknown calculation name raises `ValueError`
4. Implement router class (follow `engine.py` pattern: thin class, cfg in/cfg out)
5. Register in `engine.py`:
   ```python
   elif basename == "offpipe":
       from digitalmodel.offpipe.offpipe import Offpipe
       offpipe = Offpipe()
       cfg_base = offpipe.router(cfg_base)
   ```

### Phase 2: OFFPIPE Output Parser + Schema Validation

**Target files (new)**:
- `src/digitalmodel/offpipe/output_parser.py` -- parse OFFPIPE S-lay static `.out` files
- `src/digitalmodel/offpipe/offpipe_converter.py` -- parsed dict to `PipelayResults`

**Test files**:
- `tests/offpipe/test_output_parser.py`
- `tests/offpipe/test_pipelay_schemas.py`
- `tests/offpipe/fixtures/offpipe_slay_static.out` -- golden reference file (from user)
- `tests/offpipe/fixtures/offpipe_slay_expected.json` -- expected parsed output

**Steps (TDD)**:
1. Write tests: Parser extracts header metadata (water depth, pipe OD, lay method)
2. Write tests: Parser extracts sagbend, overbend, and suspended pipe profiles
3. Write tests: Edge cases -- empty file returns empty result, partial file handled gracefully
4. Write tests: `PipelayResults` schema validates non-negative arclengths, monotonically increasing
5. Implement line-by-line parser (OFFPIPE output is fixed-width tabular text)
6. Implement converter: raw parsed dict to validated `PipelayResults`

### Phase 3: OrcaFlex Pipelay Result Extraction + Converter

**Target files (new)**:
- `src/digitalmodel/solvers/orcaflex/pipelay_results.py` -- extract pipelay results via OrcFxAPI (lives in `orcaflex/` for reuse)

**Target files (modify)**:
- `src/digitalmodel/offpipe/offpipe_converter.py` -- add OrcaFlex result converter

**Test files**:
- `tests/offpipe/test_orcaflex_pipelay.py` -- `pytest.skip` if OrcFxAPI not available
- `tests/offpipe/test_offpipe_converter.py`
- `tests/offpipe/fixtures/orcaflex_slay_results.json` -- golden OrcaFlex reference

**Steps (TDD)**:
1. Write tests: OrcFxAPI result extraction produces `PipeProfile` with correct fields
2. Write tests: Arc-length interpolation aligns mismatched grids (OFFPIPE vs OrcaFlex)
3. Implement `extract_pipelay_results(model, line_name)` in `pipelay_results.py`
4. Implement OrcaFlex converter: `.sim` results to `PipelayResults`
5. Both converters produce identical `PipelayResults` schema (verified by type check tests)

### Phase 4: Comparison Engine + Tolerance Configuration

**Target files (new)**:
- `src/digitalmodel/offpipe/pipelay_comparator.py` -- compare two `PipelayResults`
- `src/digitalmodel/offpipe/tolerance_config.py` -- load YAML, per-parameter relative+absolute
- `src/digitalmodel/offpipe/tolerances.yaml` -- default tolerance values

**Test files**:
- `tests/offpipe/test_pipelay_comparator.py`
- `tests/offpipe/test_tolerance_config.py`

**Steps (TDD)**:
1. Write tests: Identical results yield EXCELLENT classification
2. Write tests: 8% deviation yields GOOD; 18% yields FAIR; 25% yields POOR
3. Write tests: Per-parameter tolerance overrides work (stress at 5%, curvature at 15%)
4. Write tests: Tolerance YAML loads and validates (missing keys raise clear errors)
5. Implement comparator: per-node deviation calculation, max/mean/RMS statistics
6. Implement classification: EXCELLENT (<=5%), GOOD (<=10%), FAIR (<=20%), POOR (>20%)

### Phase 5: Benchmark Report + Integration

**Target files (new)**:
- `src/digitalmodel/offpipe/benchmark_report.py` -- Plotly HTML interactive report

**Test files**:
- `tests/offpipe/test_benchmark_report.py`
- `tests/offpipe/test_integration.py`

**Steps (TDD)**:
1. Write tests: Report generates valid HTML file with expected sections
2. Write tests: Overlay plots show both OFFPIPE and OrcaFlex traces per parameter
3. Write tests: End-to-end: parse -> convert -> compare -> report pipeline
4. Implement Plotly report with: overlay traces, classification badges, summary table
5. Integration test: full pipeline from fixture files to HTML report

### Phase 6: Input Generator + Skills (Deferred)

Deferred until Phases 1-5 are proven. Includes:
- `src/digitalmodel/offpipe/input_generator.py` -- generate OFFPIPE input decks from unified config
- `.claude/skills/eng/offpipe-analysis.md`
- `.claude/skills/eng/offpipe-orcaflex-benchmark.md`

### Dependencies & Prerequisites

| Dependency | Status | Notes |
|------------|--------|
-------|
| OFFPIPE documentation | **BLOCKED** | User must provide |
| OFFPIPE example output files | **BLOCKED** | User must provide |
| Matching OrcaFlex scenario | **BLOCKED** | User must provide `.dat` + `.sim` |
| OrcFxAPI Python package | Optional | `pytest.skip` fallback if not installed |
| Plotly | Available | Already used across digitalmodel |
| numpy | Available | For `PipeProfile` arrays |

### Existing Code to Build On

| Component | Path | Lines | Reuse Strategy |
|-----------|------|-------|
----------------|
| Engine routing | `src/digitalmodel/engine.py` | 196 | Add `offpipe` basename at line ~188 |
| Diffraction module (flat pattern) | `src/digitalmodel/hydrodynamics/diffraction/` | 32 files | Follow flat module structure, no sub-packages |
| OrcaFlex analysis | `src/digitalmodel/solvers/orcaflex/orcaflex_analysis.py` | -- | Pattern for OrcFxAPI interaction |
| RAO analysis (Plotly reports) | `src/digitalmodel/hydrodynamics/rao_analysis/rao_analysis.py` | ~200 | Plotly HTML report pattern |
| Benchmark runner (diffraction) | `src/digitalmodel/hydrodynamics/diffraction/benchmark_runner.py` | -- | Cross-validation report pattern |
| Comparison framework | `src/digitalmodel/hydrodynamics/diffraction/comparison_framework.py` | -- | Multi-solver comparison pattern |

### Test Strategy

| Test Scope | Target Path | Count (est.) |
|------------|-------------|
--------------|
| Router + engine.py | `tests/offpipe/test_offpipe_router.py` | ~6 |
| Output parser | `tests/offpipe/test_output_parser.py` | ~15 |
| Schema validation | `tests/offpipe/test_pipelay_schemas.py` | ~10 |
| OrcaFlex extractor | `tests/offpipe/test_orcaflex_pipelay.py` | ~8 |
| Converter | `tests/offpipe/test_offpipe_converter.py` | ~8 |
| Comparator | `tests/offpipe/test_pipelay_comparator.py` | ~12 |
| Tolerance config | `tests/offpipe/test_tolerance_config.py` | ~8 |
| Benchmark report | `tests/offpipe/test_benchmark_report.py` | ~6 |
| Integration | `tests/offpipe/test_integration.py` | ~4 |
| **Total** | | **~77** |

Run command: `PYTHONPATH="src:../assetutilities/src" python3 -m pytest tests/offpipe/ -v --tb=short --noconftest`

### Review Notes

**Cross-review date**: 2026-02-10

| Reviewer | Verdict |
|----------|
---------|
| Claude Opus 4.6 | APPROVE |
| Gemini CLI | APPROVE |
| Codex CLI | NO_OUTPUT |

**Feedback incorporated**:
- `rao_analysis.py` line count estimate wrong (~200 vs actual 604) but non-blocking
- engine.py off by 1 line
- All structural claims verified

*Approved by user: 2026-02-10 (deprioritized to low — no current work to progress)*

---
*Source: User request for OFFPIPE pipelay cross-validation module. Plan: specs/modules/dazzling-snuggling-thunder.md. Cross-reviewed by 3 independent agents (feasibility, architecture, testing).*

## Agentic AI Horizon

- OFFPIPE cross-validation extends digitalmodel's solver coverage and validates OrcaFlex results against a second pipelay-specific solver — important for client confidence.
- Cross-solver benchmarking requires domain-specific result interpretation; not superseded by AI improvements, though result comparison automation will get easier.
- **Disposition: do now** — validation against a reference solver (OFFPIPE) is engineering rigour that has time value; establishes credibility of OrcaFlex pipelay results.
