---
id: WRK-624
title: "chore(work-queue): review and harden workflow — linear stage schematic + agent completion gates"
status: pending
priority: high
complexity: complex
compound: false
created_at: 2026-02-26T00:00:00Z
target_repos:
  - workspace-hub
commit:
spec_ref:
related:
  - WRK-285
  - WRK-304
  - WRK-305
blocked_by: []
synced_to: []
plan_reviewed: false
plan_approved: false
percent_complete: 0
brochure_status: n/a
computer: ace-linux-1
provider: codex
provider_alt: gemini
cross_review: strong
---

# chore(work-queue): Review and Harden Workflow — Linear Stage Schematic + Agent Completion Gates

## Problem Statement

Agents consistently complete implementation work but miss the final bookkeeping steps,
leaving WRK items stranded in the wrong pipeline stage. Evidence from 2026-02-26:

- **174 items** with `status: done` were physically sitting in `pending/` — only frontmatter
  was updated, the `mv pending/ → done/` step was skipped
- WRK-617 completed by a parallel session (cross-review results timestamped, git commits
  present) with zero state update — status still `pending`, percent_complete still `0`
- `session-state.yaml` not updated since 2026-02-24 — session wrappers not being invoked
- `daily_today.sh` reported "53 done · 145 ready" when reality was "225 done · 174 ready"

Root cause: the workflow is documented in `process.md` and `SKILL.md` but there is no
**enforced linear checklist** agents must step through, and no automated gate that catches
"work done, state not updated".

## What

1. **Linear workflow schematic** — create a single canonical ASCII/Mermaid stage diagram
   that every agent can follow step-by-step, with no ambiguity about what "done" means
   at each stage:

   ```
   CAPTURE → TRIAGE → PLAN → CLAIM → IMPLEMENT → CROSS-REVIEW → CLOSE → ARCHIVE
      │         │        │       │         │             │           │        │
   pending/  pending/  pending/ working/ working/    working/    done/   archive/
   ```

   Each arrow = a specific `mv` + frontmatter update + INDEX regeneration.

2. **Agent completion checklist** — a mandatory `## Completion Checklist` block that
   agents must fill in the WRK item body before marking done:

   ```markdown
   ## Completion Checklist
   - [ ] Implementation committed: <hash>
   - [ ] Tests pass: <command + output>
   - [ ] Cross-review passed: <claude|codex|gemini results path>
   - [ ] WRK frontmatter updated: status=done, percent_complete=100, commit=<hash>
   - [ ] File moved: pending/ → done/
   - [ ] INDEX regenerated: python3 scripts/generate-index.py
   - [ ] Hub commit: <hash>
   ```

3. **`close-item.sh` script** — atomic shell script at
   `scripts/work-queue/close-item.sh <WRK-NNN> <commit-hash>` that:
   - Updates frontmatter (`status: done`, `percent_complete: 100`, `commit:`, `completed_at:`)
   - Moves file from `working/` (or `pending/`) to `done/`
   - Runs `generate-index.py`
   - Stages and commits the state update with `chore(work-queue): close WRK-NNN`

4. **`validate-queue-state.sh`** — linting script that:
   - Fails if any file in `pending/` or `working/` has `status: done`
   - Fails if any file in `done/` has `status: pending` or `status: working`
   - Warns if `working/` has items with `updated_at` > 7 days ago
   - Runs in `generate-index.py` as post-check (exit code 0/1)

5. **Update `process.md` and `SKILL.md`** — replace the current prose description with
   the canonical schematic; add `close-item.sh` to the Process stage; add the completion
   checklist template to the Conventions section.

6. **Pre-commit hook** — add `validate-queue-state.sh` to `.pre-commit-config.yaml` so
   mismatched state is caught before any hub commit.

## Why

- Agents are capable but lose context of the bookkeeping steps at session end
- A single executable script (`close-item.sh`) eliminates the multi-step manual process
- `validate-queue-state.sh` in pre-commit turns the oversight into an automated catch
- The schematic gives a visual anchor — agents can confirm "I am at stage X, next step is Y"

## Acceptance Criteria

- [ ] `docs/work-queue-workflow.md` created with canonical ASCII stage diagram
- [ ] `scripts/work-queue/close-item.sh <WRK-NNN> <commit-hash>` created and executable
  - Handles both `pending/` and `working/` source locations
  - Idempotent (safe to run twice)
  - Updates frontmatter, moves file, regenerates INDEX, commits hub state
- [ ] `scripts/work-queue/validate-queue-state.sh` created
  - Exit 1 if status/folder mismatch found
  - Integrated into `generate-index.py` post-check call
- [ ] `process.md` updated: schematic diagram added, `close-item.sh` usage documented
- [ ] `SKILL.md` (work-queue) updated: schematic + completion checklist template added
- [ ] `.pre-commit-config.yaml` updated: `validate-queue-state.sh` as a hook
- [ ] All existing 225 `done/` items pass `validate-queue-state.sh`
- [ ] Legal scan passes
- [ ] Cross-review: Claude + Codex + Gemini — all P1/P2 issues resolved

## Execution Brief (for Codex)

**Provider**: Codex (focused script + doc authoring); Gemini for cross-review of docs;
Claude for final orchestration review.

**Task for Codex**:
You are implementing `close-item.sh`, `validate-queue-state.sh`, and updating `process.md`
and `SKILL.md` for the workspace-hub work-queue system.

Repository: `workspace-hub` at `/mnt/local-analysis/workspace-hub/`
Work-queue root: `.claude/work-queue/`
Scripts root: `scripts/work-queue/`

Deliverables:
1. `scripts/work-queue/close-item.sh` — see spec above; use `#!/usr/bin/env bash`,
   `set -euo pipefail`; no hardcoded paths (use `git rev-parse --show-toplevel`)
2. `scripts/work-queue/validate-queue-state.sh` — same shell conventions
3. `docs/work-queue-workflow.md` — ASCII stage diagram + stage table + completion checklist
4. Edit `process.md` — add diagram reference + `close-item.sh` command in Process stage
5. Edit `.claude/skills/coordination/workspace/work-queue/SKILL.md` — add checklist template

Run tests: `bash scripts/work-queue/validate-queue-state.sh` must exit 0 on current queue.

**What user reviews**: the schematic diagram for clarity, the checklist for completeness,
and that `close-item.sh` handles the `pending/` fallback (not just `working/`).

## Agentic AI Horizon

**Assessment**: High fit for agentic execution. All deliverables are well-scoped scripts
and doc edits with clear acceptance criteria and machine-checkable outputs.

- `close-item.sh`: deterministic shell — Codex excels here
- `validate-queue-state.sh`: simple file-system checks — straightforward
- Doc updates: targeted edits to existing files, no architecture decisions needed
- Risk: SKILL.md is ≤20 lines limit — agent must check length before editing and migrate
  excess content to a linked doc file if needed

**Recommended execution**: Codex single-agent, no parallel subagents needed. Gemini
for doc review pass. Claude final gate.
