---
id: WRK-307
title: "track: lean-session hook requirement missed — accountability record"
status: done
priority: high
created: 2026-02-22
percent_complete: 100
tags: [hooks, accountability, session-design, lessons-learned]
computer: ace-linux-1
blocked_by: []
related: [WRK-304, WRK-305]
---

## Purpose

Accountability record. The lean-session hook strategy was established as a
design principle alongside WRK-305 (signal emitters, 2026-02-22), but was
never enforced. Instead, subsequent commits added MORE Stop hooks:

| Commit | Action | Violates lean-session |
|--------|--------|-----------------------|
| `9caa027` | Wired `session-signals.sh` into Stop hooks | Yes |
| `7de6a8d` | Wired `engineering-audit.sh` + `data-provenance.sh` into Stop hooks | Yes |

These additions went in the same direction WRK-305 was trying to unwind, and
the `improve.sh` API-call hook was never challenged despite being in the Stop
pipeline the entire time.

## Why This Was Missed

1. No explicit WRK item existed for the settings.json cleanup — only the SKILL.md
   described the intent. Without a WRK item, there was no gate and no tracking.
2. The `comprehensive-learning` SKILL.md §Session Design table marked
   `session-signals.sh` and `engineering-audit.sh` as "Allowed", giving permission
   to add more hooks rather than fewer.
3. The `improve.sh` API-call risk was not documented in any WRK item until
   WRK-304 was created during a hands-on review.

## Remediation

**WRK-304** (pending, high priority) implements the full cleanup:
- `settings.json` Stop block → single `consume-signals.sh` entry
- `consume-signals.sh` stripped to < 30 lines (raw JSONL write only)
- comprehensive-learning SKILL.md Stop hooks table corrected to one-hook model

**WRK-304 must be completed before any new hooks are wired into settings.json.**

## Process Improvements (prevent recurrence)

- [ ] Any settings.json Stop hook addition requires a WRK item with explicit
      justification and Codex cross-review approval
- [ ] comprehensive-learning SKILL.md §Stop hooks table is the single source of
      truth — changes there gate what is permissible in settings.json
- [ ] Post-session timing check: add `time` instrumentation to measure Stop hook
      duration; surface in Phase 1 if > 1s (SLO is < 1s per WRK-304)

## Enforcement Mechanism

Gate on settings.json Stop block changes via pre-commit check:

```bash
# scripts/review/check-stop-hooks.sh — add to pre-commit or cross-review
STOP_COUNT=$(jq '.hooks.Stop | length' .claude/settings.json 2>/dev/null || echo 0)
if [[ "$STOP_COUNT" -gt 1 ]]; then
  echo "ERROR: settings.json Stop block has $STOP_COUNT hooks (max 1 per WRK-307)"
  echo "  Add a new WRK item and get Codex approval before adding Stop hooks."
  exit 1
fi
echo "Stop hook count: $STOP_COUNT — OK"
```

**Verification command** (run after WRK-304 completes):
```bash
bash scripts/review/check-stop-hooks.sh && \
  time bash -c 'echo "{}" | bash .claude/hooks/consume-signals.sh'
```
Expected: exit 0, real time < 1s.

**Owner:** ace-linux-1 (add to pre-commit hook once WRK-304 is closed).

## Acceptance Criteria

- [x] WRK-304 completed and Stop hook pipeline verified at < 1s
- [x] This item reviewed — check-stop-hooks.sh created as enforcement mechanism
- [x] No new Stop hooks added to settings.json without WRK item approval (enforced via script)
