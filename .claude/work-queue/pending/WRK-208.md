---
id: WRK-208
title: 'Cross-platform encoding guard — pre-commit + post-pull encoding validation'
status: pending
priority: high
complexity: simple
created_at: 2026-02-19T00:00:00Z
target_repos:
  - workspace-hub
module: automation
tags:
  - cross-platform
  - encoding
  - hooks
  - windows
  - linux
related:
  - WRK-207
blocked_by: []
synced_to: []
provider: claude
spec_ref: ''
plan_reviewed: false
plan_approved: false
percent_complete: 0
brochure_status: n/a
---

# WRK-208: Cross-Platform Encoding Guard

## What

Work queue files, skill definitions, and specs authored on Windows can arrive
as UTF-16 (Notepad default) or CRLF files. These crash `generate-index.py` at
runtime — discovered when `WRK-162.md` was saved on Windows and broke the
entire index regeneration pipeline silently.

The fix must catch this **before** the file enters git (pre-commit) and
**immediately after** it arrives via pull (post-merge/post-checkout) — not
after the fact when a script crashes.

## Why

The workspace-hub is used daily across Windows and Linux machines. Any file
created or edited on Windows risks encoding incompatibility with parsers running
on Linux. The problem is silent until something crashes.

**Root cause of WRK-162.md failure**: Saved as UTF-16 LE with BOM (`\xff\xfe`)
from a Windows editor. `generate-index.py` line 47 called
`path.read_text(encoding="utf-8")` with no encoding detection, raising
`UnicodeDecodeError` and aborting the entire index build.

## Delivered in this session (2026-02-19)

- [x] `generate-index.py` — `_read_text()` helper: BOM-aware, UTF-16/UTF-8-BOM/UTF-8
      fallback, CRLF→LF normalization. Crash eliminated.
- [x] `.gitattributes` — `*.md`, `*.yaml`, `*.yml`, `*.json` forced to
      `eol=lf working-tree-encoding=UTF-8`. Git normalizes on checkout.
- [x] `.claude/hooks/check-encoding.sh` — pre-commit (blocks), post-merge +
      post-checkout (warns). Installed to `.git/hooks/`.
- [x] `/repo-sync` skill v1.1.0 — Phase 4 encoding check added to pull workflow.
- [x] `WRK-162.md` converted from UTF-16 to UTF-8.

## Remaining work

- [x] `scripts/operations/setup-hooks.sh` created — installs via `git config core.hooksPath`
      (works on Windows Git Bash without Developer Mode); smoke-tests encoding check
- [x] `interoperability` skill created at `.claude/skills/workspace-hub/interoperability/SKILL.md`
      — documents all cross-OS standards, health check items, fix commands (WRK-210)
- [ ] Install on Windows machines — run `bash scripts/operations/setup-hooks.sh` once per clone
- [ ] Add encoding check to CI pipeline (if/when CI is added)
- [x] Archive scan complete (2026-02-19, 1,725 files scanned):
  - `.claude/work-queue/archive/` (115 files): all clean
  - `specs/repos/digitalmodel/`: 48 utf8bom (OrcaFlex YAML — Windows tool output),
    5 bad-encoded (Latin-1/Win-1252 — engineering notation: °, Greek letters)
  - No UTF-16 files anywhere
  - **Decision needed**: `specs/repos/digitalmodel/` files are machine-generated by
    engineering tools. Do not auto-convert (risk: corrupt OrcaFlex content).
    Fix: exclude `specs/repos/` from hook scan scope OR mark as binary in .gitattributes
- [ ] Exclude `specs/repos/` from `check-encoding.sh` scan (it scans `specs/` broadly;
      engineering tool outputs should not trigger encoding warnings)
- [ ] Document in CLAUDE.md: "Always save work queue files as UTF-8 (no BOM)"

## Windows Setup Note

On Windows with Git Bash or MINGW:
```bash
# Option 1: core.hooksPath (works in Git Bash)
git config core.hooksPath .claude/hooks

# Option 2: Copy hook as .bat shim (PowerShell)
# .git/hooks/pre-commit.bat calls: bash .claude/hooks/check-encoding.sh
```

The `.gitattributes` `working-tree-encoding=UTF-8` forces git to re-encode
files to UTF-8 on checkout even if the editor saves UTF-16. This is the
strongest defence — the hook is a second layer.
