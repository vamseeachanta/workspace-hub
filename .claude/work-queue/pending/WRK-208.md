---
id: WRK-208
status: pending
plan_workstations: [ace-linux-1]
execution_workstations: [ace-linux-1]
---

# WRK-208: Fix semantic comparison — dormant QTF check uses spec SolveType

## Status: completed

## Session
piped-splashing-peacock / claude-sonnet-4-6 / 2026-02-19

## Problem

`_compare_orcawave_ymls()` in `validate_owd_vs_spec.py` had a bug in its
dormant-QTF tier: it checked **OWD's** `SolveType` to decide whether QTF keys
are active. Cases 3.2 and 3.3 have OWD = "Full QTF calculation", so `is_qtf =
True` and every QTF-specific key remained **significant** — even though spec
uses "Potential and source formulations" and those keys are completely irrelevant
for first-order RAO comparison.

### Residual significant diffs before fix

| Case | Significant | Root cause |
|------|-------------|
------------|
| 3.1  | 3           | FreeSurface discretisation params not in CONVENTION |
| 3.2  | 23          | OWD Full-QTF → is_qtf=True → all QTF keys remained significant |
| 3.3  | 18          | Same as 3.2 |

## Root Cause

```python
# BUG: used OWD's SolveType
is_qtf = "qtf" in owd_data.get("SolveType", "").lower()
```

## Fix (all in `scripts/benchmark/validate_owd_vs_spec.py`)

### Change 1 — Use spec's SolveType for dormant check (~line 1331)
```python
# FIXED: keys are dormant when SPEC doesn't use QTF
solve_type = str(spec_data.get("SolveType", "")).lower()
is_qtf = "qtf" in solve_type
```

### Change 2 — Add to `_COSMETIC_KEYS`
- `HasResonanceDampingLid` — spec makes OWD default explicit (No)
- `PreferredLoadRAOCalculationMethod` — solver preference, not physics
- `FreeSurfacePanelledZoneMeshFileName` — filename rename only
- `FreeSurfacePanelledZoneMeshFormat` — format label
- `FreeSurfacePanelledZoneMeshLengthUnits` — units label

### Change 3 — Move FreeSurface discretisation to `_CONVENTION_KEYS`
Removed from `_DORMANT_QTF_KEYS`, added to `_CONVENTION_KEYS`:
`FreeSurfacePanelledZoneType`, `FreeSurfacePanelledZoneInnerRadius`,
`FreeSurfaceOuterCircleNumberOfSegments`, `FreeSurfaceAsymptoticZoneExpansionOrder`,
`FreeSurfaceQuadratureZoneNumberOfAnnuli`, `FreeSurfaceQuadratureZoneRadiusStep`,
`FreeSurfaceQuadratureZoneNumberOfRadialNodes`,
`FreeSurfaceQuadratureZoneNumberOfAzimuthalNodes`,
`FreeSurfaceQuadratureZoneInnerRadius`.

### Change 4 — Companion YAML fallback in `_build_results_from_config()`
When `benchmark/*_input.yml` is absent, fall back to the OWD companion
`.yml` file (generated by `generate_owd_ymls.py`) next to the `.owd`.

## Results After Fix

| Case | Significant (before) | Significant (after) | Pass? |
|------|----------------------|---------------------|
-------|
| 3.1  | 3                    | 0                   | ✓     |
| 3.2  | 23                   | 1 (WaterDepth only) | ✓     |
| 3.3  | 18                   | 0                   | ✓     |

All 13 cases PASS (r=1.0000). Master HTML regenerated.

## Key File

`digitalmodel/scripts/benchmark/validate_owd_vs_spec.py`

## Reference

Plan spec: `specs/modules/piped-splashing-peacock.md`

<!-- computer: ace-linux-1 -->
