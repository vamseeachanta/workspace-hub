---
id: WRK-032
title: Modular OrcaFlex pipeline installation input with parametric campaign support
status: pending
priority: medium
complexity: complex
created_at: 2026-01-29 12:00:00+00:00
updated_at: 2026-02-03 00:00:00+00:00
target_repos:
- digitalmodel
commit: null
spec_ref: specs/modules/orcaflex/pipeline-installation-modular/plan.md
related:
- WRK-121
blocked_by: []
synced_to: []
supersedes:
- WRK-033
provider: codex
provider_alt: null
task_agents:
  phase_5a: codex
  phase_5b: codex
  phase_5c: codex
  phase_5d: gemini
plan_reviewed: false
plan_approved: false
computer: acma-ansys05
execution_workstations: [acma-ansys05]
plan_workstations: [acma-ansys05]
---

# Modular OrcaFlex Pipeline Installation Input with Parametric Campaign Support

> Merged scope from WRK-032 + WRK-033 (archived as superseded).

## What

Refactor OrcaFlex pipeline installation input into a modular include-file system with:
1. **Modular sections** — each OrcaFlex input file composed from independent, reusable include-file sections following the existing `_XX_DescriptiveName.yml` convention
2. **Parametric campaign matrix** — full installation sensitivity study across water depths, route lengths, environmental conditions, soil properties, and tension levels
3. **Roller arrangement as first-class parametric section** — count, spacing, type, V-angle, diameter, friction coefficient, height offset
4. **Both S-lay and floating tow** installation methods supported
5. **Include-file composition engine** — assemble runnable OrcaFlex models from selected section combinations with variable substitution

## Why

- Current `ProjectInputSpec` schema supports single pipeline + single equipment config only
- Legacy `OrcInstallation` uses `OrderedDict` manipulation outside the Pydantic schema system
- Roller model is minimal (single position + support count) — insufficient for parametric roller studies
- No batch campaign support for full installation sensitivity matrices
- WRK-033's include-file composition goal is inseparable from WRK-032's modular format goal

## Scope

### In Scope
- Extend Pydantic schema for multi-section pipeline installation input
- Roller arrangement model with full geometric parametrisation
- Campaign matrix definition (depth × length × environment × soil × tension)
- Section-based include-file composition (reuse existing `_XX_` convention)
- Variable substitution/templating within sections
- Both S-lay (vessel + stinger + tensioner + stinger rollers) and floating tow (tugs + buoyancy modules + rollers)
- Backward compatibility with current single-pipeline `ProjectInputSpec`
- Input validation for composed models
- Absorb/replace legacy `OrcInstallation` functionality into new schema

### Out of Scope
- J-lay installation method (future work)
- Multi-product pipelines in a single model (future — this is batch parametric only)
- OrcaFlex simulation execution (handled by existing batch runner WRK-029)
- Post-processing of results

## Existing Infrastructure to Build On

| Component | Path | Reuse Strategy |
|-----------|------|
----------------|
| Pydantic schema | `solvers/orcaflex/modular_generator/schema/` | Extend `ProjectInputSpec`, `Equipment`, `Rollers` |
| Builder pattern | `solvers/orcaflex/modular_generator/builders/` | Extend `buoys_builder`, `lines_builder` |
| Include-file spec | `specs/modules/orcaflex/modular-input-file/` | Follow `_XX_` naming convention |
| Legacy installation | `solvers/orcaflex/orcaflex_installation.py` | Replace with new schema-driven approach |
| Equipment models | `schema/equipment.py` | Extend `Rollers`, add `RollerArrangement` |

## Acceptance Criteria

### Schema & Data Model
- [ ] `RollerArrangement` Pydantic model with: count, spacing_pattern, type (V-roller/flat/cradle), V-angle, diameter, friction_coefficient, height_offset, support_count
- [ ] `InstallationSection` model representing a named section of the include-file system
- [ ] `CampaignMatrix` model defining parameter variations (water_depths, route_lengths, environments, soil_properties, tensions)
- [ ] Extended `ProjectInputSpec` supporting campaign mode alongside single-run mode
- [ ] S-lay equipment section (vessel + stinger + tensioner + stinger rollers)
- [ ] Floating tow equipment section (tugs + buoyancy modules + route rollers)

### Include-File Composition
- [ ] Section registry mapping section types to `_XX_DescriptiveName.yml` files
- [ ] Composition engine that assembles sections into valid OrcaFlex YAML
- [ ] Variable substitution within sections (e.g., `${water_depth}`, `${tension}`)
- [ ] Validation that composed models are structurally complete for OrcaFlex

### Campaign Generation
- [ ] Campaign matrix parsed from YAML config
- [ ] Cartesian product of parameter variations generates individual run configs
- [ ] Each run config is a composed set of include-file sections with substituted variables
- [ ] Output: directory of runnable OrcaFlex YAML files, one per matrix combination

### Quality
- [ ] Backward compatibility: existing single-pipeline YAML inputs still parse correctly
- [ ] Tests: schema validation, section composition, campaign matrix expansion, roller parametrisation
- [ ] Legacy `OrcInstallation` functionality preserved in new system (elevation-based model generation)

## SME Q&A Log

| # | Question | Answer | Date |
|---|----------|--------|
------|
| 1 | Installation method scope? | Both S-lay and floating tow | 2026-02-03 |
| 2 | Multi-pipeline meaning? | Batch parametric (same pipeline, parameter matrix) | 2026-02-03 |
| 3 | "Section" meaning? | Modular input file sections (include-file modules) | 2026-02-03 |
| 4 | WRK-032 vs WRK-033? | Merge into WRK-032 | 2026-02-03 |
| 5 | Parameter matrix scope? | Full campaign: depth × length × environment × soil × tension | 2026-02-03 |
| 6 | Roller parametrisation? | Count + spacing + type + V-angle, diameter, friction, height offset | 2026-02-03 |

## Plan

> **Status**: Phases 0-4 implemented (plan.md shows 100% complete). This plan covers **Phase 5: Hardening & Gaps** -- the remaining acceptance criteria items that are structurally complete but need field-validation and polish.

### Phase 5A: Stinger Roller Builder (NEW -- gap in current implementation)

The schema has `Stinger.rollers: list[StingerRoller]` and `Equipment.stinger` fully modelled, but no dedicated builder emits stinger roller supports into the include-file system. Currently `buoys_builder.py` (610 lines) handles route rollers via `RollerArrangement`, but stinger rollers on the vessel path require a separate builder.

**Target files (new)**:
- `src/digitalmodel/solvers/orcaflex/modular_generator/builders/stinger_roller_builder.py`

**Target files (modify)**:
- `src/digitalmodel/solvers/orcaflex/modular_generator/builders/__init__.py` -- add import
- `src/digitalmodel/solvers/orcaflex/modular_generator/builders/context.py` (100 lines) -- add `stinger_roller_names` context field

**Test file**:
- `tests/solvers/orcaflex/modular_generator/builders/test_stinger_roller_builder.py`

**Steps (TDD)**:
1. Write tests: S-lay spec with `equipment.stinger.rollers` produces Support objects at correct arc-length positions
2. Write tests: `should_generate()` returns `False` for floating-tow specs (no stinger)
3. Register builder at `order=75` (between supports at 70 and lines at 90): `@BuilderRegistry.register("06b_stinger_rollers.yml", order=75)`
4. Implement builder following `supports_builder.py` (83 lines) pattern
5. Verify existing S-lay end-to-end test still passes with new builder output

### Phase 5B: Campaign Soil Override Integration Test

The `SoilVariation` model and `_apply_overrides()` in `campaign.py` (487 lines) handle soil overrides, but there is no integration test exercising soil+environment combined campaign. The existing `test_campaign_integration.py` needs extension.

**Target files (modify)**:
- `tests/solvers/orcaflex/modular_generator/integration/test_campaign_integration.py`

**Steps (TDD)**:
1. Add test: Campaign with 2 water depths x 2 environments x 2 soils generates 8 run directories
2. Add test: Each generated `parameters.yml` has correct soil friction and stiffness values
3. Add test: `CampaignSpec.from_legacy_config()` round-trip preserves elevation-based generation for `create_model_for_water_depth()` use cases
4. Add test: `--resume` flag skips existing `master.yml` directories

### Phase 5C: CLI Campaign Subcommand Smoke Test

**Target files (modify)**:
- `src/digitalmodel/solvers/orcaflex/modular_generator/cli.py` (15,498 bytes) -- verify `campaign` subcommand exists
- `tests/solvers/orcaflex/modular_generator/test_cli_campaign.py` (new)

**Steps**:
1. Write test: `cli.py campaign --preview` with a sample campaign YAML returns expected combination count
2. Write test: `cli.py campaign --force` overwrites existing directories
3. Write test: CLI exits gracefully if campaign YAML has validation errors

### Phase 5D: Documentation & Skill Registration

**Target files (new)**:
- `.claude/skills/eng/orcaflex-campaign-generator.md` -- skill file for campaign generation workflows

**Steps**:
1. Create skill file documenting: (a) single-run generation, (b) campaign matrix generation, (c) legacy migration from `OrcInstallation`
2. Reference existing quickstart at `specs/modules/orcaflex/pipeline-installation-modular/quickstart.md`

### Dependencies & Prerequisites

- All Phases 0-4 complete (confirmed: 209 tests passing per plan.md)
- Pydantic v2, PyYAML (already installed)
- No external licenses required
- No data file dependencies

### Existing Code to Build On

| Component | Path | Lines | Reuse Strategy |
|-----------|------|-------|
----------------|
| Builder base class | `solvers/orcaflex/modular_generator/builders/base.py` | 73 | Extend `BaseBuilder` |
| Builder registry | `solvers/orcaflex/modular_generator/builders/registry.py` | 82 | Use `@BuilderRegistry.register` |
| Supports builder (pattern) | `solvers/orcaflex/modular_generator/builders/supports_builder.py` | 83 | Follow pattern for stinger rollers |
| Buoys builder (route rollers) | `solvers/orcaflex/modular_generator/builders/buoys_builder.py` | 610 | Already handles `RollerArrangement` |
| Campaign schema | `solvers/orcaflex/modular_generator/schema/campaign.py` | 487 | `CampaignGenerator`, `CampaignSpec` |
| Equipment schema | `solvers/orcaflex/modular_generator/schema/equipment.py` | 404 | `Stinger`, `StingerRoller` models |
| Variable resolver | `solvers/orcaflex/modular_generator/sections.py` | 76 | `VariableResolver` for templates |
| Legacy installation | `solvers/orcaflex/orcaflex_installation.py` | 241 | Already deprecated, `from_legacy_config()` exists |

### Test Strategy

| Test Scope | Target Path | Count (est.) |
|------------|-------------|
--------------|
| Stinger roller builder unit | `tests/solvers/orcaflex/modular_generator/builders/test_stinger_roller_builder.py` | ~12 |
| Campaign soil integration | `tests/solvers/orcaflex/modular_generator/integration/test_campaign_integration.py` | ~8 (additions) |
| CLI campaign smoke | `tests/solvers/orcaflex/modular_generator/test_cli_campaign.py` | ~6 |
| **Total new tests** | | **~26** |

Run command: `PYTHONPATH="src:../assetutilities/src" python3 -m pytest tests/solvers/orcaflex/modular_generator/ -v --tb=short --noconftest`

### Review Notes

**Cross-review date**: 2026-02-10

| Reviewer | Verdict |
|----------|
---------|
| Claude Opus 4.6 | APPROVE |
| Gemini CLI | APPROVE |
| Codex CLI | NO_OUTPUT |

**Feedback incorporated**:
- Outstanding plan accuracy, every file size claim matches disk
- Stinger roller gap is real and correctly identified as Phase 5A work

*Approved by user: 2026-02-10*

---
*Source: refactor pipeline input file to have roller section, floating section to have modular format. ability to have multiple pipelines, water depths, lengths etc. for installation. This is for pipeline OrcaFlex analysis. Merged with WRK-033: develop an OrcaFlex includefile modular skill to help prepare an analysis input file into sections so the variables can be easily parametrised.*

## Agentic AI Horizon

- OrcaFlex campaign generation infrastructure (Phase 5 hardening) is a direct capability multiplier — agents running parametric installation studies depend on this being reliable.
- Stinger roller builder and CLI smoke tests are implementation gaps that need closing; model improvements don't eliminate the need for correct OrcaFlex YAML generation.
- **Disposition: do now** — Phase 5 hardening is a small, well-scoped gap-fill; closing it completes the campaign infrastructure that upstream analysis work depends on.
