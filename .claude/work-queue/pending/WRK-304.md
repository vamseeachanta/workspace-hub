---
id: WRK-304
title: "cleanup: one lean Stop hook — consume-signals.sh only, all analysis to nightly cron"
status: pending
priority: high
created: 2026-02-22
updated: 2026-02-22
tags: [hooks, session-design, comprehensive-learning, cleanup]
computer: ace-linux-1
blocked_by: []
percent_complete: 90
---

## Goal

Replace the current 12-hook Stop pipeline with a single lightweight hook:
`consume-signals.sh` (fast raw write only, < 1s).

All analysis deferred to the nightly `comprehensive-learning` cron on ace-linux-1.

## Strategy

`comprehensive-learning` runs nightly via `scripts/cron/comprehensive-learning-nightly.sh`.
Sessions are pure execution engines — signal capture only at Stop, nothing else.
Analysis is the cron's job.

| Hook | Lines | Cost per session |
|------|-------|-----------------|
| `consume-signals.sh` | 444 | Reads + analyses all JSONL signals |
| `session-end-evaluate.sh` | 120 | Scores session quality |
| `ecosystem-health-check.sh` | 321 | Full ecosystem health scan |

## Current State (12 sequential Stop hooks — all blocking)

| Hook | Problem | Action |
|------|---------|--------|
| `session-memory/session-end-evaluate.sh` | Reads full transcript + calls `generate-session-report.sh` (262 lines) | **Remove** |
| date echo | Trivial | Remove (noise) |
| `post-task-review.sh` | Displays pending signal counts; prompts user | **Remove** |
| `session-signals.sh` | Fast raw write — added in `9caa027` to fix R-SKILLS warning | **Remove** — consolidate into consume-signals.sh |
| `engineering-audit.sh` | Fast raw write when eng keywords detected — wired in `7de6a8d` | **Remove** — nightly cron reads session-signals instead |
| `data-provenance.sh` | Fast raw write when data files detected — wired in `7de6a8d` | **Remove** — nightly cron reads session-signals instead |
| `consume-signals.sh` | 444 lines of analysis — KEEP but strip to raw write only | **Simplify** |
| `generate-resource-index.sh` | Full index rebuild | **Remove** |
| `query-quota.sh --refresh --log` | Cache bypass + file reads every Stop | **Remove** |
| `wrk-traceability-check.sh` | git status + git log | **Remove** |
| `ecosystem-health-check.sh` | Full ecosystem health scan | **Remove** — move to Phase 6 nightly |
| `readiness/ensure-readiness.sh` | 10 checks including `grep -rl` over `scripts/` | **Remove** |
| `improve.sh` | **Anthropic API calls** (30–120s, phases 2+5) | **Remove** — already runs in Phase 4 nightly |

Note: `session-signals.sh`, `engineering-audit.sh`, `data-provenance.sh` were added in recent
commits (`9caa027`, `7de6a8d`) but conflict with the lean-session strategy. Their signal
capture is absorbed by the simplified `consume-signals.sh` or handled nightly.

## Scope

### 1. `settings.json` — Stop hooks block

Replace the entire Stop hooks array with a single entry:

```json
"Stop": [
  {
    "matcher": ".*",
    "hooks": [
      {
        "type": "command",
        "statusMessage": "Capturing session signals",
        "command": "bash -c 'SCRIPT=\"${WORKSPACE_HUB:-$(git rev-parse --show-superproject-working-tree 2>/dev/null | grep . || git rev-parse --show-toplevel)}/.claude/hooks/consume-signals.sh\"; [ -f \"$SCRIPT\" ] && bash \"$SCRIPT\" 2>/dev/null || true'"
      }
    ]
  }
]
```

### 2. `consume-signals.sh` — strip to raw write only

Current: 444 lines with analysis loops, aggregation, WRK auto-creation, report generation.

Keep:
- Read session context from stdin (session_id, timestamp)
- Append one JSONL line to `.claude/state/session-signals/YYYY-MM-DD-HHMMSS.jsonl`
- Exit 0

Remove / move to nightly:
- All analysis loops and aggregation → comprehensive-learning Phase 1
- WRK auto-creation logic → comprehensive-learning Phase 7
- Session briefing + pending-insights writes → comprehensive-learning Phase 10
- Accumulator.json cross-session tracking → comprehensive-learning Phase 1
- Archive operations → nightly

Target: < 30 lines, < 1s execution.

### 3. comprehensive-learning SKILL.md — Stop hooks table

Update the "Stop hooks: signal capture only" table (currently marks `session-signals.sh`
and `engineering-audit.sh` as "Allowed"). New table:

| Hook | Allowed |
|------|---------|
| `consume-signals.sh` (simplified) | Yes — one fast raw write |
| Everything else | No — nightly cron |

### 4. `consume-signals.sh` — signal contract and JSONL schema

The simplified script must meet this contract:

- **Input:** JSON from stdin with at minimum `session_id` (string), `timestamp` (ISO8601)
- **Output:** JSONL entry appended to `.claude/state/session-signals/YYYY-MM-DD.jsonl`
  using `>>` (single-line append; atomic for lines < PIPE_BUF ~4KB on Linux/macOS)
- **Invalid/empty input:** write a stub entry with `session_id: "unknown-<epoch>"` and
  `event: "session_end_stub"`; never exit non-zero on input errors
- **Naming collision:** YYYY-MM-DD bucketing means multiple sessions per day append to the
  same file — intentional; Phase 1 reads all entries by date range

Minimum required JSONL output schema:
```json
{
  "ts": "ISO8601",
  "event": "session_end",
  "session_id": "<string>",
  "wrk": "<active-wrk or null>",
  "tool_calls": 0,
  "edits": 0,
  "machine": "<hostname -s>"
}
```
Tooling: use `jq` if available; fall back to bash string interpolation for the
minimal schema above. Never fail silently — log "consume-signals: jq not found,
using fallback" to stderr if fallback is used.

### 5. Signal parity table

| Removed hook | Signal emitted | Destination in new model | Validation |
|---|---|---|---|
| `session-signals.sh` | session summary JSONL | `consume-signals.sh` absorbs this directly | `jq .event session-signals/*.jsonl \| grep session_end` |
| `session-end-evaluate.sh` | delegation score, tool patterns | Phase 10 nightly derives from session-signals | Phase 10 report contains delegation_score field |
| `engineering-audit.sh` | wall_thickness/fatigue keyword hits | Phase 1 reads engineering_audit signals from session-signals | Phase 1 SKILL.md §Extract includes engineering audit signals |
| `data-provenance.sh` | SHA256 of data files | Phase 1 reads data_provenance signals from session-signals | Phase 1 SKILL.md §Extract includes data provenance signals |
| `ecosystem-health-check.sh` | health scan results | Phase 6 nightly | Phase 6 runs ecosystem health scan |
| `post-task-review.sh` | pending signal counts (display only) | Phase 10 report replaces display | Phase 10 report shows signal counts |
| `improve.sh` | skill/memory improvements | Phase 4 nightly | Phase 4 invokes `/improve` |

Engineering audit and data provenance signals should be added to the `consume-signals.sh`
output schema as optional fields when detected in session context (present = signal captured,
absent = not applicable for this session).

### 6. Cron failure fallback

The nightly cron is the single analysis path. If it fails or is delayed:
- Signal files in `session-signals/` persist indefinitely — no data loss
- Recovery: re-run `claude --skill comprehensive-learning` manually on ace-linux-1
- Monitoring: cron output logged to `.claude/state/learning-reports/cron.log`
  (relative to repo root; cron entry uses `cd <repo> &&` to set working directory)
- No automated alerting in scope for this WRK item; treated as best-effort for now

### 7. WRK-305 ordering

WRK-304 (this item) removes hooks; WRK-305 adds new emitters.
Safe ordering: WRK-304 first — removing hooks does not create a signal gap because
`consume-signals.sh` already captures the session summary. WRK-305 enriches that
signal with /clear and plan-mode events, which are additive.

### 8. Timing gate

After changes: `time bash -c 'echo "{}" | bash .claude/hooks/consume-signals.sh'`
must complete in < 1s.

## Acceptance Criteria

- [x] `settings.json` Stop block contains only `consume-signals.sh` ✅ done 2026-02-22
- [x] `consume-signals.sh` stripped to raw write only (< 1s, schema per §4 above) ✅ done 2026-02-22
- [x] `consume-signals.sh` writes JSONL entry to `session-signals/` (Phase 1 source) ✅ done 2026-02-22
- [x] Signal parity check completed: removed hooks' signals accounted for (§5) ✅ done 2026-02-22
- [x] Cron log path corrected to absolute path in `comprehensive-learning-nightly.sh` ✅ done 2026-02-22
- [x] `comprehensive-learning` SKILL.md Stop hooks table updated to one-hook model ✅ done 2026-02-22
- [x] Stop hook total time < 1s verified (`time bash -c 'echo "{}" | bash .claude/hooks/consume-signals.sh'`) ✅ 0.023s on ace-linux-1 2026-02-24
- [ ] Codex cross-review passes

## Workstation Verification — settings.json + consume-signals.sh

`settings.json` and `consume-signals.sh` are repo-tracked (synced via git pull).
`.git/hooks/pre-commit` is local — verify the Stop hook config reaches each machine.

| Machine | settings.json Stop block | consume-signals.sh | pre-commit lean |
|---------|--------------------------|-------------------|-----------------|
| ace-linux-1 | ✅ verified 2026-02-24 | ✅ 0.023s | ✅ |
| ace-linux-2 | ✅ in sync (git pull) | ✅ in sync | ✅ verified 2026-02-24 |
| ACMA-ANSYS05 | ❓ needs git pull | ❓ needs git pull | ❓ SSH unreachable |

**To verify ACMA-ANSYS05:** open Git Bash in workspace-hub and run:
```bash
git pull
grep -c "consume-signals" .claude/settings.json   # expect 1
wc -l .claude/hooks/consume-signals.sh             # expect ~30
cat .git/hooks/pre-commit                          # expect 3 lines only
```

## Route

Route A — `settings.json` Stop block + `consume-signals.sh` rewrite + SKILL.md table update.

## Related

- comprehensive-learning SKILL.md §Session Design: Lean by Default
- WRK-305: wire signal emitters (feeds the simplified consume-signals.sh)
- Commits `9caa027` (session-signals wired) and `7de6a8d` (audit+provenance wired) — these
  additions are superseded by this cleanup; hooks added in those commits are removed here.
