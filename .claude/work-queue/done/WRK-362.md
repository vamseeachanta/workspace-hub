---
id: WRK-362
title: "Fix repository_sync no-arg behavior — auto-track, commit, and parallel sync all repos"
status: done
priority: medium
complexity: medium
compound: false
created_at: 2026-02-23T00:00:00Z
completed_at: 2026-02-24T00:00:00Z
target_repos:
  - workspace-hub
commit: 0afa65e
spec_ref:
related: [WRK-357]
blocked_by: []
synced_to: []
plan_ensemble: false
ensemble_consensus_score: null
plan_reviewed: true
plan_approved: true
percent_complete: 100
brochure_status: n/a
computer: ace-linux-1
---

# Fix `repository_sync` no-arg behavior — auto-track, commit, and parallel sync all repos

## Summary
`scripts/repository_sync` currently launches an **interactive TUI menu** when run without
arguments. This blocks non-interactive use. The desired no-arg behavior is a fully-automated,
parallel "track everything → commit → sync" sweep across workspace-hub and all submodules.

## Current Behavior (no args)
Line 1444–1448 of `scripts/repository_sync`:
```bash
if [ $# -eq 0 ]; then
    show_main_menu   # interactive read loop — blocks in non-TTY contexts
    exit 0
fi
```
Operations run sequentially. The hub repo itself is excluded. 17 of 23 defined submodules
are not locally initialized (only 6 show up in `git submodule status`).

## Required Behavior (no args)
Run a fully non-interactive sweep in correct submodule order:

1. **Stage** — `git add -A` in every initialized submodule
2. **Commit** — commit with timestamped default message if staged changes exist
3. **Pull** — `git pull --ff-only` before push; warn and skip push if branch has diverged
4. **Push** — push committed changes to remote (skip if nothing to push / remote archived)
5. **Update hub pointers** — after all submodule commits land, `git add <submodule-paths>`
   at hub level to record updated pointers
6. **Commit + push workspace-hub** — commit the pointer update, then push the hub itself
7. Steps 1–4 run in **parallel** across all initialized submodules; steps 5–6 run after
   all parallel jobs complete

Uninitialized submodules (not present locally) are **skipped** and labeled "not initialized"
in the summary output. They are not auto-cloned.

## Acceptance Criteria
- [ ] `./scripts/repository_sync` (no args, non-TTY) completes without waiting for input
- [ ] Submodules are committed/pushed before hub pointer update (correct submodule order)
- [ ] workspace-hub itself is committed and pushed after submodule pointer update
- [ ] All initialized submodules are processed in parallel (`&` + `wait`)
- [ ] Uninitialized submodules appear in summary as "not initialized" (not an error)
- [ ] Repos with no changes produce a clean "nothing to do" in summary and exit 0
- [ ] Repos with archived/read-only remotes are skipped gracefully
- [ ] Diverged branches (remote ahead, fast-forward not possible) warn and skip push
- [ ] Parallel job failures are captured per-repo; one failure does not abort other repos
- [ ] A summary table (repo | staged | committed | pushed | result) is printed at the end
- [ ] Interactive menu mode is still accessible via `repository_sync menu` or `-i` flag
- [ ] `--dry-run` flag prints planned actions without executing any git operations

## Implementation Notes

### Correct execution order
```
parallel block (all initialized submodules):
  git add -A
  git commit -m "chore(sync): auto-sync YYYY-MM-DD"
  git pull --ff-only   # warn + skip push if this fails
  git push

wait  # block until all parallel jobs finish

hub (workspace-hub):
  git add <submodule-path> ...   # update submodule pointers
  git add -A                     # any other hub-level changes
  git commit -m "chore(sync): auto-sync YYYY-MM-DD"
  git pull --ff-only
  git push
```

### Parallelism
Use bash background jobs with per-pid exit code capture. Do NOT use `set -e` inside the
parallel block — collect failures manually:

```bash
declare -A pids
for repo in "${initialized_repos[@]}"; do
    sync_submodule "$repo" &
    pids["$repo"]=$!
done
for repo in "${!pids[@]}"; do
    wait "${pids[$repo]}" && results["$repo"]="ok" || results["$repo"]="failed"
done
```

The top-level `set -e` must be lifted or scoped around the parallel block.

### File length
`scripts/repository_sync` is already 1553 lines (hard limit: 400). Extract the new
`auto_sync_all()` logic into `scripts/repository_sync-auto` (a sourced helper), keeping
the main script as the dispatcher. The `-auto` helper should itself stay under 150 lines.

### Commit message format
```
chore(sync): auto-sync $(date +%Y-%m-%d)
```
No Claude co-author line in automated commits (this is a machine-generated batch operation,
not a human-assisted edit).

### No-arg vs named commands
- No args → `auto_sync_all`
- `repository_sync menu` or `repository_sync -i` → existing `show_main_menu` (unchanged)
- All other named commands (`sync`, `commit`, `push`, etc.) → unchanged

## Files to Modify
- `scripts/repository_sync` — replace no-arg `show_main_menu` call; add `menu`/`-i` dispatch
- `scripts/repository_sync-auto` — new helper, sourced by main script (create, ≤150 lines)
- `scripts/cron-repository-sync.sh` — fix shebang (`#!/opt/homebrew/bin/bash` → `#!/usr/bin/env bash`); optionally switch to no-arg form once stable

## Related
- WRK-357 (submodule pointer update pattern)
- `.claude/rules/git-workflow.md` — "Submodules: commit inside submodule first, then update pointer at hub level"
- `.claude/rules/coding-style.md` — 400-line hard limit
