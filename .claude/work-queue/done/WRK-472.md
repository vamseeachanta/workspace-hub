---
id: WRK-472
title: "fix(assethold/stocks): tz-naive/tz-aware datetime comparison in 52wk checks"
status: done
priority: medium
complexity: simple
compound: false
created_at: 2026-02-24T00:00:00Z
target_repos:
  - assethold
commit: 9023347
spec_ref:
related: []
blocked_by: []
synced_to: []
plan_reviewed: true
plan_approved: true
percent_complete: 100
brochure_status: n/a
computer: ace-linux-1
---

# fix(stocks): tz-naive/tz-aware datetime comparison in 52wk checks

## What Was Done
Fixed `TypeError: Invalid comparison between dtype=datetime64[ns] and datetime`
in two methods of `stock_analysis.py`:

1. `check_if_price_above_1p3_52wk_low` (line 350)
2. `check_if_price_near_52wk_high_range` (line 366)

## Root Cause
`datetime.datetime.now(pytz.timezone('America/New_York'))` returns a tz-aware
datetime. The DataFrame `Date` column is `datetime64[ns]` (tz-naive). Pandas
rejects comparisons between mixed tz-awareness.

## Fix Applied
```python
cutoff = (datetime.datetime.now(pytz.timezone('America/New_York')) +
          datetime.timedelta(days=-365)).replace(tzinfo=None)
```

Applied the same `.replace(tzinfo=None)` pattern to both occurrences.

## Result
- 128 stocks unit tests pass (0 failures)
- Full suite: 990 passed, 12 pre-existing failures (live data tests)
