---
id: WRK-020
title: "GIS skill for cross-application geospatial tools \u2014 Blender, QGIS, well\
  \ plotting"
status: done
priority: medium
complexity: complex
created_at: 2026-01-29 00:00:00+00:00
target_repos:
- digitalmodel
commit: null
spec_ref: null
related:
- WRK-015
blocked_by: []
synced_to: []
provider: claude
provider_alt: null
task_agents:
  phase_1: codex
  phase_2a: codex
  phase_2b: codex
  phase_3: codex
  phase_4: claude
  phase_5: codex
plan_reviewed: true
plan_approved: true
computer: ace-linux-2
percent_complete: 100
---

# GIS skill for cross-application geospatial information and tools

## What
Build a GIS skill/module within digitalmodel that provides geospatial information, coordinate handling, and visualization tools for use across multiple applications and use cases:
- **Applications**: Blender (3D visualization), QGIS (spatial analysis), Google Earth/Maps, and other GIS-capable tools
- **Use cases**: Identifying and plotting well locations, bathymetry/terrain rendering, field boundary mapping, pipeline routes, platform locations
- **Core capabilities**: Coordinate transformation (geographic ↔ projected ↔ local), GIS data import/export, spatial queries, and integration APIs for each target application

Example workflow: given well coordinates from BSEE or other regulatory data, plot them interactively in Blender with proper geospatial positioning, or export to QGIS for spatial analysis overlaid on bathymetry.

## Why
GIS operations are needed across multiple workflows (metocean analysis, field data visualization, digital twin positioning, client presentations). A centralized GIS skill avoids duplicating coordinate handling and spatial logic across separate tools, and provides consistent geospatial capabilities to all downstream applications.

## Acceptance Criteria
- [x] Coordinate reference system (CRS) handling: WGS84, UTM zones, local project coordinates
- [x] Coordinate transformation utilities between CRS types
- [x] Well location plotting capability:
  - [x] QGIS: layer generation with well markers, attribute tables (`qgis_export.py`)
  - [x] Blender: 3D positioned well objects with metadata (`blender_export.py`)
- [x] GIS data format support: GeoJSON, Shapefile, KML/KMZ, GeoTIFF
- [x] Spatial query support: find wells within radius, bounding box, polygon
- [ ] Bathymetry/terrain data integration for 3D rendering — Blender terrain mesh generation deferred (GeoTIFFHandler + QGIS export done)
- [x] Blender GIS integration: Python scripts for importing geospatial data (`blender_export.py`)
- [x] QGIS integration: processing scripts for well data workflows (`qgis_export.py`, `.qml` style)
- [x] API/interface for other applications to consume GIS data (`FeatureLayer`, `WellLayer`, GeoJSON export)
- [x] Document supported CRS, data formats, and application integration steps (.claude/skills/gis/SKILL.md)

## Plan

**Target**: `src/digitalmodel/gis/` (new top-level module — digitalmodel does not currently have a `gis/` directory)

### Existing Assets (reuse)
- `worldenergydata/metocean/` — NDBC buoy coordinates, NOAA station locations
- `worldenergydata/bsee/` — well locations (lat/lon from BSEE block/lease data)
- `digitalmodel/visualization/svg_primitives.py` — SVG generation patterns
- pyproj (if installed) for CRS transformations

### Phase 1 — CRS & Coordinate Engine
- [x] `coordinates.py`:
  - [x] `CoordinatePoint` dataclass: lat, lon, elevation, crs
  - [x] CRS definitions: WGS84 (EPSG:4326), UTM zones, NAD83, local project coords
  - [x] Transform between CRS using pyproj or manual formulas
  - [x] Batch transform for coordinate lists

### Phase 2a — Core Formats (GeoJSON, KML/KMZ via xml.etree) [DONE]
- [x] `io/geojson_handler.py`: Read/write GeoJSON, DataFrame conversion
- [x] `io/kml_handler.py`: Read/write KML/KMZ (lxml.etree)

### Phase 2b — Heavy Formats (optional, requires external deps) [DONE]
- [x] `io/shapefile_handler.py`: Shapefile support via optional geopandas/fiona
- [x] `io/geotiff_handler.py`: GeoTIFF reader for bathymetry (optional rasterio)

### Phase 3 — Spatial Queries [DONE]
- [x] `core/spatial_query.py`:
  - [x] Find points within radius (Haversine via `GeoPoint.distance_to`)
  - [x] Bounding box query (`GeoBoundingBox.contains`)
  - [x] Polygon containment (ray casting)
  - [x] Nearest-N search (linear scan, ascending sorted)

### Phase 4 — Application Integrations [DONE]
- [x] `integrations/blender_export.py`:
  - [x] `BlenderExporter.generate_well_script()` — self-contained Blender Python script
  - [x] Coordinate mapping: WGS84 → UTM → Blender scene units via configurable scale
  - [x] Well metadata as Blender custom properties; scene origin anchor at centroid
  - [x] `BlenderExporter.write_well_script()` — write to .py file
  - [x] `BlenderExporter.geo_to_blender()` — static coordinate helper
- [x] `integrations/qgis_export.py`:
  - [x] `QGISExporter.generate_project()` — QGIS project XML (.qgs) with embedded memory layer
  - [x] Field definitions and WKT feature geometries in project file
  - [x] `QGISExporter.generate_well_qml()` — QML style definition for well markers
  - [x] `QGISExporter.to_geojson_layer()` — GeoJSON export via FeatureLayer
- [x] `integrations/folium_maps.py` — Folium/Leaflet HTML maps (pre-existing)
- [x] `integrations/google_earth_export.py` — styled KML for Google Earth (pre-existing)
- [x] `integrations/plotly_maps.py` — Plotly mapbox scatter/dashboard (pre-existing)

### Phase 4b — Data Models [DONE]
- [x] `layers/feature_layer.py`:
  - [x] `FeatureLayer`: pandas-backed tabular GIS collection
  - [x] `centroid`, `bounding_box`, `filter()`, `from_geojson()`, `to_geojson()`
- [x] `layers/well_layer.py`:
  - [x] `WellLayer(FeatureLayer)`: well-specific subclass
  - [x] `filter_by_status()`, `filter_by_depth_range()`, `to_well_list()`

### Phase 5 — Tests [DONE — 113 passing]
- [x] `tests/gis/test_crs_and_spatial.py`: CRS, UTM detection, GeoPoint distance, GeoBoundingBox (27 tests)
- [x] `tests/gis/test_geojson_roundtrip.py`: GeoJSON write→read→compare (8 tests)
- [x] `tests/gis/test_spatial_queries.py`: radius, bbox, polygon, nearest-N (14 tests)
- [x] `tests/gis/test_feature_layer.py`: FeatureLayer + WellLayer construction, filters (19 tests)
- [x] `tests/gis/test_blender_export.py`: ast.parse script validation, coord mapping (13 tests)
- [x] `tests/gis/test_qgis_export.py`: XML schema validation for .qgs and .qml (18 tests)
- [x] `tests/gis/test_coordinates.py`: CoordinatePoint, transform_points, get_utm_crs (5 tests)
- Test matrix: all 113 tests pass with pyproj installed; zero optional deps required for MVP subset

### Dependencies
- Core: no heavy dependencies (pure Python CRS for basic UTM)
- Optional: pyproj (accurate transforms), geopandas (shapefiles), folium (maps), rasterio (GeoTIFF)
- Blender/QGIS: export scripts only (don't require runtime installation)

### Review Notes
- **Plan verdict**: Claude: MINOR | Codex: MINOR | Gemini: APPROVE
- **Actions taken**:
  - Noted `gis/` is a new top-level module in digitalmodel
  - Split Phase 2 into 2a (Core Formats: GeoJSON, KML) and 2b (Heavy Formats: Shapefile, GeoTIFF)
  - Added Blender/QGIS export validation tests (ast.parse, XML schema) without runtime deps
  - Added test matrix and MVP test subset per Codex feedback
  - Defined strict MVP: GeoJSON + Haversine + Folium export with zero optional deps
- *Cross-reviewed: 2026-02-09*

*Approved by user: 2026-02-09*

### Implementation Notes (2026-02-24)
- All Phases 1–5 implemented; 133 tests passing (113 original + 20 security regressions)
- New files: `layers/feature_layer.py`, `layers/well_layer.py`, `integrations/blender_export.py`, `integrations/qgis_export.py`
- Legal scan: no violations in `gis/` module
- Remaining: Blender terrain mesh generation (geotiff-to-blender.py terrain import) deferred — all other phases complete
- Documentation of CRS/formats/integration steps: complete (.claude/skills/gis/SKILL.md)

### Security Hardening (2026-02-25)
- Cross-review: Codex hard gate passed (3 rounds); Claude and Gemini reviewed
- Fixes applied per Codex findings:
  - P1: XXE-safe KML parsing (resolve_entities=False, no_network=True)
  - P1: Zip-slip prevention in KMZ extraction (per-member validation)
  - P1: Cross-UTM-zone consistency in Blender export (centroid zone)
  - P2: CRS string normalisation (bare numerics → EPSG:<code>)
  - P2: UTM zone/hemisphere validation in coordinate_transformer
  - P2: HTML escaping in Google Earth KML descriptions
  - P2: Style ID sanitisation in Google Earth export
  - P3: Defensive copy in FeatureLayer.data property
  - P3: Consistent KeyError in WellLayer.filter_by_depth_range
  - P3: Dead code removal in KML _build_placemark
- Codex config updated: gpt-4.1 → gpt-5.3-codex (ChatGPT account compatible)

---
*Source: gis skill to help with required gis information and tools for use across different applications eg: blender, qgis, etc. and different usecases eg: for identifying and plotting wells in interactive softwares such as blender etc*

## Agentic AI Horizon

- GIS skill centralises geospatial capability that multiple agents and workflows (metocean, field data, deployment analysis) will leverage — direct ecosystem boost.
- Coordinate transformation and spatial query primitives won't be superseded by model improvements; they need to be coded infrastructure.
- **Disposition: invest now** — the GIS skill is foundational scaffolding; agents will call it repeatedly once it exists; build it as a reusable skill module.
