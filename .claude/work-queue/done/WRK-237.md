---
id: WRK-237
title: Provider cost tracking — token spend per session and per WRK item
status: done
priority: medium
complexity: medium
compound: false
created_at: 2026-02-20T00:00:00Z
target_repos:
  - workspace-hub
commit:
spec_ref:
related: [WRK-231, WRK-226, WRK-234, WRK-235]
blocked_by: [WRK-231]
synced_to: []
plan_reviewed: false
plan_approved: false
standing: false
auto_execute: false
percent_complete: 100
brochure_status: n/a
computer: ace-linux-1
execution_workstations: [ace-linux-1]
plan_workstations: [ace-linux-1]
---

# Provider cost tracking — token spend per session and per WRK item

## What

Add cost attribution to the session analysis pipeline (WRK-231). Track token spend per session, per provider, and per WRK item. Surface unusually expensive sessions and patterns that drive disproportionate cost — enabling early budget awareness before quota limits are hit.

## Why

Three providers (Claude, Codex, Gemini) run across hundreds of sessions. Token spend is currently invisible until quota warnings appear. Expensive patterns — Opus on iterative work, verbose context on simple tasks, repeated subagent spawns — compound silently. Attributing cost to WRK items reveals which items are expensive and why. This directly supports the 3–6 month provider strategy (WRK-235): if Codex cross-review overhead is quantifiable, the consolidation decision is data-driven, not intuitive.

## Scope

- Capture token counts per session from provider API responses (input tokens, output tokens, model used)
- Attribute spend to WRK item if item ID is referenced in the session
- Track per-provider spend: Claude (Sonnet vs Opus), Codex, Gemini
- Flag sessions with spend >2x median as anomalies
- Aggregate: cost per WRK item, cost per repo, cost trend over 30 sessions
- Integrate with model-registry.yaml pricing data for $ calculation

## Integration

Add to WRK-231 morning cron output:
- `session_cost_usd`: estimated cost for the session
- `provider_breakdown`: per-provider token counts
- `wrk_attribution`: cost attributed to each WRK item touched
- `anomalies`: sessions >2x median, with likely cause (model choice, context size, subagent count)

Also feeds WRK-235 (provider strategy) with quantitative evidence on Codex overhead.

## Acceptance Criteria

- [ ] Token counts captured per session per provider from API response metadata
- [ ] Cost estimated using model-registry.yaml pricing (input/output $/M tokens)
- [ ] Cost attributed to WRK items referenced in the session
- [ ] Per-provider trend tracked over 30 sessions: Claude (Sonnet/Opus split), Codex, Gemini
- [ ] Anomaly detection: sessions >2x median flagged with cause analysis
- [ ] Morning cron report includes cost summary section
- [ ] WRK-235 provider strategy assessment has quantitative Codex overhead figure
- [ ] Alert emitted (warning, not block) if 7-day rolling cost exceeds configurable threshold

## Agentic AI Horizon

- Cost efficiency improves as models get cheaper and smarter — but the tracking infrastructure is needed now to measure that improvement
- Quantitative cost data is the prerequisite for the WRK-235 consolidation decision — do this before the strategic review, not after
- Low overhead to instrument (metadata already in API responses), high value for quota management

---
*Source: "yes and add separate work item in queue for 5 and 6 so we do not have to rethink same things again" — item 6 (provider cost per WRK item)*
