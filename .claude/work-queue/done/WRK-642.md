---
id: WRK-642
title: "investigate(review): diagnose Claude CLI no-response via subagent test matrix"
status: done
priority: high
complexity: medium
route: B
compound: false
created_at: 2026-02-28T00:00:00Z
target_repos:
  - workspace-hub
commit:
spec_ref:
related:
  - WRK-624
  - WRK-640
blocked_by: []
parent:
synced_to: []
plan_reviewed: true
plan_approved: true
percent_complete: 100
brochure_status: n/a
computer: ace-linux-1
execution_workstations: [ace-linux-1]
plan_workstations: [ace-linux-1]
provider: codex
provider_alt: claude
cross_review: strong
html_output_ref: assets/WRK-642/review.html
claim_routing_ref: .claude/work-queue/assets/WRK-642/claim-evidence.yaml
plan_html_review_draft_ref: .claude/work-queue/assets/WRK-642/plan-html-review-draft.md
plan_html_review_final_ref: .claude/work-queue/assets/WRK-642/plan-html-review-final.md
html_verification_ref: .claude/work-queue/assets/WRK-642/html-verification.md
---

# investigate(review): Diagnose Claude CLI No-Response via Subagent Test Matrix

## Problem

`WRK-624` now has hardened review transport and deterministic `NO_OUTPUT` /
`INVALID_OUTPUT` classification. `WRK-640` improved provider transport handling,
but `claude -p` still intermittently stalls or returns no usable non-interactive
review output for plan-review workloads.

The current system can classify the failure correctly, but it does not yet explain
why Claude fails in this mode or which invocation pattern is reliable enough for
workflow-grade review automation.

## What

Use an isolated subagent-style investigation to reproduce and diagnose the Claude
`NO_OUTPUT` problem under controlled conditions.

Scope:
1. build a compact test matrix for Claude non-interactive review runs
2. compare payload shapes:
   - full plan file
   - compact review bundle
   - minimal schema-only sample
3. compare prompt shapes:
   - current generic review prompt
   - stricter reviewer-only prompt
   - compact provider-specific prompt
4. compare runtime behavior:
   - direct `claude -p`
   - existing `submit-to-claude.sh`
   - wrapper with bounded timeout and capture
5. capture raw/stdout/stderr evidence and classify each run
6. recommend the most reliable Claude invocation pattern for future review automation

## Why

- the workflow now depends on reliable multi-agent review transport
- Claude is present on the command line but still not operationally dependable for
  this review path
- a focused subagent-style matrix is the fastest way to separate:
  - payload-size issues
  - prompt-shape issues
  - subprocess/wrapper issues
  - Claude CLI behavior itself

## Deliverables

1. test matrix artifact with pass/fail table
2. raw evidence files for each scenario
3. diagnosis of most likely failure mode
4. recommended wrapper/prompt strategy
5. follow-up implementation guidance if wrapper changes are required
6. HTML review artifact summarizing the findings

## Plan

### Phase 1 - Prepare compact test inputs

- create a compact `WRK-642` review input bundle for Claude plan-review testing
- create at least one minimal schema-only review target
- define prompt variants:
  - baseline current prompt
  - strict reviewer-only prompt
  - compact provider-specific prompt

Artifacts:
- `.claude/work-queue/assets/WRK-642/test-inputs/`
- `.claude/work-queue/assets/WRK-642/test-matrix.md`

### Phase 2 - Run the invocation matrix

- execute at least 5 materially different Claude invocation cases
- compare:
  - full vs compact payload
  - wrapper vs direct CLI
  - timeout profiles
  - prompt variants
- capture:
  - stdout
  - stderr where applicable
  - exit code
  - duration
  - validator result

Artifacts:
- `.claude/work-queue/assets/WRK-642/raw/`
- `.claude/work-queue/assets/WRK-642/test-results.md`

### Phase 3 - Diagnose and recommend

- rank the most likely root causes
- identify the best-performing invocation pattern
- document whether the failure is:
  - wrapper-level
  - prompt-level
  - payload-level
  - provider-level
- produce HTML review output for user inspection

Artifacts:
- `.claude/work-queue/assets/WRK-642/findings.md`
- `.claude/work-queue/assets/WRK-642/review.html`

### Test Strategy

- validate every run with `scripts/review/validate-review-output.sh`
- include at least one control case expected to pass if Claude transport is healthy
- include at least one intentionally oversized or high-friction case to confirm failure mode boundaries
- record exact commands used so the matrix is reproducible

### Review Strategy

- implementation/diagnostic review via Codex after artifacts exist
- if Claude returns a valid self-diagnostic artifact in one of the cases, treat it as evidence, not as sole review authority
- Gemini may be used later for secondary interpretation of findings if needed

## Acceptance Criteria

- [ ] Claude test matrix covers at least 5 materially different invocation cases
- [ ] Each case records:
  - input shape
  - prompt shape
  - timeout used
  - result classification
  - artifact path
- [ ] At least one case returns a schema-valid review artifact, or the report shows
      strong evidence that the failure is outside current wrapper control
- [ ] Root-cause hypothesis is documented and ranked
- [ ] Recommended next action is concrete:
  - wrapper fix
  - prompt change
  - compact-review mode
  - provider limitation escalation
- [ ] HTML review artifact exists for user inspection

## Notes

- This item is specifically for diagnosis, not broad workflow redesign.
- If the matrix shows a fixable wrapper/prompt issue, implementation can follow in
  a separate scoped change or a direct continuation item.
- If the matrix shows a provider limitation, the result should explicitly document
  that boundary so workflow policy can account for it.

## Evidence

- Test matrix: `/mnt/local-analysis/workspace-hub/.claude/work-queue/assets/WRK-642/test-matrix.md`
- Test results: `/mnt/local-analysis/workspace-hub/.claude/work-queue/assets/WRK-642/test-results.md`
- Findings: `/mnt/local-analysis/workspace-hub/.claude/work-queue/assets/WRK-642/findings.md`
- HTML review artifact: `/mnt/local-analysis/workspace-hub/.claude/work-queue/assets/WRK-642/review.html`

## Outcome

Claude non-interactive review transport is functional on a minimal schema control
case, but not reliable on WRK-624-sized review inputs. The dominant failure mode
is `NO_OUTPUT` on compact and full plan-review payloads. One wrapper scenario also
leaked a process chain beyond its configured timeout budget, which shows a wrapper
cleanup defect in addition to the provider boundary.
