---
id: WRK-657
title: "fix(review): harden submit-to-claude.sh timeout cleanup and liveness"
status: done
route: B
priority: high
complexity: medium
compound: false
created_at: 2026-03-01T02:10:00Z
completed_at: 2026-03-01T06:00:00Z
target_repos:
  - workspace-hub
commit:
spec_ref:
related:
  - WRK-642
  - WRK-647
blocked_by: []
synced_to: []
plan_reviewed: true
plan_approved: true
percent_complete: 100
brochure_status: n/a
computer: ace-linux-1
provider: claude
orchestrator: claude
cross_review: codex=REQUEST_CHANGES(resolved), gemini=APPROVE
plan_html_review_draft_ref: .claude/work-queue/assets/WRK-657/plan-html-review-draft.md
plan_html_review_final_ref: .claude/work-queue/assets/WRK-657/plan-html-review-final.md
---
# fix(review): Harden `submit-to-claude.sh` Timeout Cleanup and Liveness

## Problem

Claude CLI invocations through `scripts/review/submit-to-claude.sh` still rely on `timeout` without
tearing down the entire process group. `WRK-642`/`WRK-647` surfaced wrapper cleanup bugs,
and the missing hard watchdog lets hanging runs leak subprocesses, which degrades the cross-review gate.

## What

Harden the wrapper and add regression smoke tests so timeouts are predictable, cleanup is complete, and
`NO_OUTPUT` classifications are consistent.

Scope:

1. force-kill the wrapper process group (e.g., `kill -$$`) after the timeout fires so no child stays alive
2. log cleanup steps and surface non-zero exit codes when the watchdog triggers
3. add a smoke script that runs the wrapper with a dummy spec and asserts no Claude processes remain
4. teach `cross-review.sh` that wrapper timeouts now map to `NO_OUTPUT` rather than silent success

## Why

- prevents resource leaks that leave the system in a bad state for future reviews
- keeps Claude CLI fallback runs honest so cross-review remains a reliable gate
- sets the stage for the orchestrator validator to trust wrapper outcomes

## Plan

### Phase 1 — Teardown hardening

- track the spawned process group in the wrapper
- execute `kill -SIGTERM -$$` (or equivalent) before `timeout` exits and escalate to `SIGKILL` if needed
- add logging so the cleanup path is observable in review logs

### Phase 2 — Regression smoke check

- ship a smoke script (e.g., `scripts/review/submit-to-claude-smoke.sh`) that runs the wrapper with a dummy input, waits for the timeout, and confirms no Claude process remains
- hook the smoke check into the per-task CI step or `scripts/review/cross-review.sh` with a guard that reuses the existing `NO_OUTPUT` result handling

### Phase 3 — Policy notes

- update `.claude/CLAUDE.md` (or the workflow spec) to document the watchdog requirement
- record how to classify `NO_OUTPUT` results now that process-group cleanup is deterministic

## Acceptance Criteria
- [ ] `submit-to-claude.sh` kills the child process group when timeouts occur and logs the teardown
- [ ] Exit codes distinguish between a successful review and an aborted timeout
- [ ] Regression smoke script proves no orphaned Claude processes remain after a timeout
- [ ] Cross-review policy mentions the watchdog and instructs `NO_OUTPUT` reruns when the wrapper timeout path is taken

## Evidence
- `scripts/review/submit-to-claude.sh` diff
- `scripts/review/submit-to-claude-smoke.sh` (new)
- `.claude/CLAUDE.md` or workflow spec references

## Outcome

Wrapper runs are deterministic, cleanup is observable, and cross-review treats timed-out Claude runs as genuine failures.
