---
id: WRK-312
title: "feat: post-merge hook — auto-sync git hooks on pull for consistent cross-machine experience"
status: done
priority: high
created: 2026-02-23
tags: [hooks, git, cross-machine, setup, ecosystem, devex, session-workflow]
computer: any
blocked_by: []
---

## Problem

Git hooks live in `.git/hooks/` which is **not tracked by git**. Every session
and workflow improvement committed to the repo (lean pre-commit, Stop hook
cleanup, new guards) automatically reaches other machines via `git pull` for
scripts and config — but the actual installed `.git/hooks/*` files remain
stale until someone manually re-runs the installer.

This breaks the cross-machine consistency promise: ace-linux-2, acma-ansys05,
and acma-ws014 continue running old hook behaviour silently after every pull.

**What syncs on `git pull`** (already working):
- `.claude/settings.json` — Stop hooks config ✓
- `.claude/hooks/` — hook source files ✓
- `scripts/` — installer scripts ✓

**What does NOT sync** (the gap):
- `.git/hooks/pre-commit`, `.git/hooks/post-merge`, etc.

**Impact:** WRK-308 lean pre-commit only reaches other machines if someone
manually runs the installer. No `git pull` alone will fix it.

## Fix

### Self-bootstrapping post-merge hook

Store canonical hook content in a tracked directory (`scripts/hooks/`).
A `post-merge` hook re-runs the installer after every `git pull`.
One-time bootstrap per machine — then git pull keeps everything current forever.

**Flow after bootstrap:**
```
git pull → post-merge fires → install-all-hooks.sh runs →
  .git/hooks/pre-commit updated to latest canonical version ✓
```

### Files to create

| File | Purpose |
|------|---------|
| `scripts/hooks/pre-commit` | Canonical lean pre-commit (WRK-308 state) |
| `scripts/hooks/post-merge` | Re-runs install-all-hooks.sh after merge-based pull |
| `scripts/hooks/post-rewrite` | Symlink or copy of post-merge — fires after rebase-based pull |
| `scripts/setup/install-all-hooks.sh` | Idempotent: copies `scripts/hooks/*` to `.git/hooks/` |

### Pull strategy coverage

| `git pull` mode | Hook that fires | Covered? |
|-----------------|----------------|---------|
| `--no-rebase` (merge) | `post-merge` | ✓ |
| `--rebase` | `post-rewrite` | ✓ (new) |
| `--ff-only` (fast-forward) | `post-merge` | ✓ |

### Platform scope

All target machines use **Git Bash (MINGW64)** on Windows and bash on Linux.
The installer uses `bash`, `cp`, `chmod +x` — all available in MINGW64.
PowerShell is explicitly out of scope.

### `.gitattributes` addition

```
scripts/hooks/* text eol=lf
```

Prevents CRLF on Windows checkout which breaks shebangs in extensionless hook files.

### Bootstrap (one-time per machine)

```bash
bash scripts/setup/install-all-hooks.sh
```

After this, every `git pull` (merge or rebase) auto-applies committed hook
changes — no manual steps on other machines ever again.

## Acceptance Criteria

- [x] `scripts/hooks/pre-commit` exists with lean WRK-308 content
- [x] `scripts/hooks/post-merge` exists — calls `install-all-hooks.sh`
- [x] `scripts/hooks/post-rewrite` exists — same behaviour as post-merge
- [x] `.gitattributes` has `scripts/hooks/* text eol=lf`
- [x] `scripts/setup/install-all-hooks.sh` installs all hooks idempotently (symlink-safe — commit 338be1a)
- [x] After bootstrap + `git pull --no-rebase`, `.git/hooks/pre-commit` matches canonical
- [x] After bootstrap + `git pull --rebase`, `.git/hooks/pre-commit` matches canonical
- [x] `time git commit --allow-empty -m test` < 1s — measured 0.456s (2026-02-23)
- [ ] Bootstrap command documented in `.claude/docs/` or CLAUDE.md — deferred to WRK-313
- [ ] `scripts/skills/install-skill-validator-hook.sh` delegates to
      `install-all-hooks.sh` (no duplicate logic) — deferred to WRK-313

## Verification Log (2026-02-23)

### Hook state — ace-linux-1

| Hook | File type | Size | Matches canonical |
|------|-----------|------|-------------------|
| `pre-commit` | regular file | 111 bytes | ✓ |
| `post-merge` | regular file | 296 bytes | ✓ |
| `post-rewrite` | regular file | 311 bytes | ✓ |
| `commit-msg` | symlink → check-commit-msg.sh | — | ✓ (unchanged) |

### Cron jobs — ace-linux-1

| Job | Schedule | Log evidence |
|-----|----------|-------------|
| session-analysis | 3AM daily | ✓ ran 2026-02-22 (log present) |
| model-ids | Sunday 3:30AM | no log — possibly pre-dates install |
| skills-curation | Monday 4AM | ❌ "Unknown skill: skills-curation" — name mismatch, needs fix |
| comprehensive-learning | 2AM daily | ⏳ added 2026-02-23 — first run tonight |

### ace-linux-2 session archive

- Session-logger hook active; daily `session_YYYYMMDD.jsonl` files confirmed
- rsync path corrected (`/mnt/workspace-hub/...` not `~/.claude/...`) — commit 912580c
- 281 session files pulled successfully in live test (2026-02-23 19:00)
- No crontab needed on ace-linux-2 — sessions flow to ace-linux-1 via nightly rsync

### Open items (deferred, not blocking WRK-312 close)

- WRK-363: cron audit remaining machines (ace-linux-2, office); fix skills-curation skill name
- WRK-313: new-machine bootstrap doc + install-skill-validator-hook.sh delegation

## Plan Review Log

| Date | Reviewer | Verdict | Key Findings |
|------|----------|---------|--------------|
| 2026-02-23 | Claude | MINOR | post-rewrite gap; deprecation path |
| 2026-02-23 | Codex | REQUEST_CHANGES → resolved | P1: post-rewrite; P1: Windows scope |
| 2026-02-23 | Gemini | APPROVE | P2: post-rewrite; P3: .gitattributes LF |

All P1/P2 findings addressed in plan revision above. Plan approved for implementation.

## Route

Route A — clear scope, no cross-repo impact, self-contained.

## Agentic AI Horizon

Every future hook/session improvement committed once propagates to all machines
automatically. High leverage infrastructure — implement now.

## Related

- WRK-308: lean pre-commit (trigger that revealed this gap)
- WRK-304: Stop hook cleanup (`.claude/settings.json` syncs fine;
  `.git/hooks/` is the only remaining gap)
