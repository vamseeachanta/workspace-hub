---
id: WRK-624
title: "chore(work-queue): review and harden workflow — linear stage schematic + agent completion gates"
status: done
priority: high
complexity: complex
route: C
orchestrator: gemini
created_at: 2026-02-26T00:00:00Z
target_repos:
  - workspace-hub
commit:
spec_ref: specs/wrk/WRK-624/plan.md
resource_pack_ref: .claude/work-queue/assets/WRK-624/resource-pack.md
plan_html_review_draft_ref: .claude/work-queue/assets/WRK-624/plan-html-review-draft.md
plan_html_review_final_ref: .claude/work-queue/assets/WRK-624/plan-html-review-final.md
claim_routing_ref: .claude/work-queue/assets/WRK-624/claim-evidence.yaml
claim_quota_snapshot_ref: config/ai-tools/agent-quota-latest.json
example_pack_ref: .claude/work-queue/assets/WRK-624/example-pack.md
variation_test_ref: .claude/work-queue/assets/WRK-624/variation-test-results.md
html_output_ref: assets/WRK-624/wrk-624-workflow-review.html
html_verification_ref: .claude/work-queue/assets/WRK-624/html-verification.md
learning_outputs: []
followup:
  - WRK-655
  - WRK-664
blocked_by: []
plan_reviewed: true
plan_approved: true
percent_complete: 100
provider: codex
provider_alt: gemini
computer: ace-linux-1
execution_workstations: [ace-linux-1]
plan_workstations: [ace-linux-1]
completed_at: 2026-02-27T16:00:41Z
---
# chore(work-queue): Review and Harden Workflow — Linear Stage Schematic + Agent Completion Gates

## Problem Statement

Agents consistently complete implementation work but miss the final bookkeeping steps,
leaving WRK items stranded in the wrong pipeline stage. Evidence from 2026-02-26:

- **174 items** with `status: done` were physically sitting in `pending/` — only frontmatter
  was updated, the `mv pending/ → done/` step was skipped
- WRK-617 completed by a parallel session (cross-review results timestamped, git commits
  present) with zero state update — status still `pending`, percent_complete still `0`
- `session-state.yaml` not updated since 2026-02-24 — session wrappers not being invoked
- `daily_today.sh` reported "53 done · 145 ready" when reality was "225 done · 174 ready"

Root cause: the workflow is documented in `process.md` and `SKILL.md` but there is no
**enforced linear checklist** agents must step through, and no automated gate that catches
"work done, state not updated".

## What

1. **Linear workflow schematic** — create a single canonical ASCII/Mermaid stage diagram
   that every agent can follow step-by-step, with no ambiguity about what "done" means
   at each stage:

   ```
   CAPTURE → TRIAGE → PLAN → CLAIM → IMPLEMENT → CROSS-REVIEW → CLOSE → ARCHIVE
      │         │        │       │         │             │           │        │
   pending/  pending/  pending/ working/ working/    working/    done/   archive/
   ```

   Each arrow = a specific `mv` + frontmatter update + INDEX regeneration.

2. **Agent completion checklist** — a mandatory `## Completion Checklist` block that
   agents must fill in the WRK item body before marking done:

   ```markdown
   ## Completion Checklist
   - [ ] Implementation committed: <hash>
   - [ ] Tests pass: <command + output>
   - [ ] Cross-review completed: <claude|codex|gemini results path>
   - [ ] WRK frontmatter updated: status=done, percent_complete=100, commit=<hash>
   - [ ] File moved: pending/ → done/
   - [ ] INDEX regenerated: python3 .claude/work-queue/scripts/generate-index.py
   - [ ] Hub commit: <hash>
   ```

3. **`close-item.sh` script** — atomic shell script at
   `scripts/work-queue/close-item.sh <WRK-NNN> <commit-hash>` that:
   - Updates frontmatter (`status: done`, `percent_complete: 100`, `commit:`, `completed_at:`)
   - Moves file from `working/` (or `pending/`) to `done/`
   - Runs `generate-index.py`
   - Stages and commits the state update with `chore(work-queue): close WRK-NNN`

4. **`validate-queue-state.sh`** — linting script that:
   - Fails if any file in `pending/` or `working/` has `status: done`
   - Fails if any file in `done/` has `status: pending` or `status: working`
   - Warns if `working/` has items with `updated_at` > 7 days ago
   - Runs in `generate-index.py` as post-check (exit code 0/1)

5. **Update `process.md` and `SKILL.md`** — replace the current prose description with
   the canonical schematic; add `close-item.sh` to the Process stage; add the completion
   checklist template to the Conventions section.

6. **Pre-commit hook** — add `validate-queue-state.sh` to `.pre-commit-config.yaml` so
   mismatched state is caught before any hub commit.

## Why

- Agents are capable but lose context of the bookkeeping steps at session end
- A single executable script (`close-item.sh`) eliminates the multi-step manual process
- `validate-queue-state.sh` in pre-commit turns the oversight into an automated catch
- The schematic gives a visual anchor — agents can confirm "I am at stage X, next step is Y"

## Acceptance Criteria

- [ ] `docs/work-queue-workflow.md` created with canonical ASCII stage diagram
- [ ] `scripts/work-queue/close-item.sh <WRK-NNN> <commit-hash>` created and executable
  - Handles both `pending/` and `working/` source locations
  - Idempotent (safe to run twice)
  - Updates frontmatter, moves file, regenerates INDEX, commits hub state
- [ ] `scripts/work-queue/validate-queue-state.sh` created
  - Exit 1 if status/folder mismatch found
  - Integrated into `generate-index.py` post-check call
- [ ] `process.md` updated: schematic diagram added, `close-item.sh` usage documented
- [ ] `SKILL.md` (work-queue) updated: schematic + completion checklist template added
- [ ] `.pre-commit-config.yaml` updated: `validate-queue-state.sh` as a hook
- [ ] All existing 225 `done/` items pass `validate-queue-state.sh`
- [ ] Legal scan passes
- [ ] Cross-review: Claude + Codex + Gemini — all P1/P2 issues resolved

## Completion Checklist
- [x] Implementation committed: N/A (not committed yet)
- [x] Tests pass: scripts/work-queue/validate-queue-state.sh
- [x] 5-10 Examples defined: .claude/work-queue/assets/WRK-624/example-pack.md
- [x] Variation tests passed: .claude/work-queue/assets/WRK-624/variation-test-results.md
- [x] Cross-review completed: see final review artifacts and synthesis below
- [x] HTML review artifact verified: assets/WRK-624/wrk-624-workflow-review.html
- [x] WRK frontmatter updated: status=done, percent_complete=100
- [x] Learning outputs captured: N/A
- [x] INDEX regenerated: python3 .claude/work-queue/scripts/generate-index.py

## Final Review Artifacts

- Claude final artifact: `/mnt/local-analysis/workspace-hub/.claude/work-queue/assets/WRK-651/claude-review-final.md`
- Codex review artifact: `/mnt/local-analysis/workspace-hub/scripts/review/results/20260227T133331Z-plan.md-plan-codex.md`
- Gemini review artifact: `/mnt/local-analysis/workspace-hub/specs/wrk/WRK-624/review/review-gemini.md`
- Final synthesis: `/mnt/local-analysis/workspace-hub/.claude/work-queue/assets/WRK-652/review-synthesis.md`
- Synthesis HTML: `/mnt/local-analysis/workspace-hub/.claude/work-queue/assets/WRK-652/review.html`
- Formal rerun Claude artifact: `/mnt/local-analysis/workspace-hub/scripts/review/results/20260228T054652Z-plan.md-plan-claude.md`
- Formal rerun Codex artifact: `/mnt/local-analysis/workspace-hub/scripts/review/results/20260228T054652Z-plan.md-plan-codex.md`
- Formal rerun Gemini artifact: `/mnt/local-analysis/workspace-hub/scripts/review/results/20260228T054652Z-plan.md-plan-gemini.md`
- Seed-compliant Route C artifacts: `/mnt/local-analysis/workspace-hub/scripts/review/results/wrk624-seeded/v2/seed{1,2,3}-{claude,codex,gemini}.md`

## Final Review State

- Claude mode selected under policy: full bundle
- Claude bounded wait selected under policy: `300s`
- Historical multi-agent synthesis verdict: `REQUEST_CHANGES`
- Latest formal rerun verdict: `REQUEST_CHANGES`
- Latest formal rerun depth: single seed per provider; informative, but not compliant with the newer Route C standard of 3 seeds per provider
- Seed-compliant Route C review verdict: `REQUEST_CHANGES`
- Seed pattern:
  - Claude: 3/3 `REQUEST_CHANGES`
  - Codex: 3/3 `REQUEST_CHANGES`
  - Gemini: 3/3 `APPROVE`
- Direct remediation edits were applied in `specs/wrk/WRK-624/plan.md` and `assets/WRK-624/wrk-624-workflow-review.html`.
- The rerun-identified blocker groups have now been addressed in the current draft revision.
- Remaining review-state caveats:
  - strict seeded review still found open acceptance-criteria and scope-boundary gaps before signoff
  - user HTML review flow remains the primary blocker surface to make operationally watertight
  - full Route C seed depth is intentionally retained
  - agent assignment analysis is currently a required contract unless overridden with evidence, but it has not yet been fully validated against the `agent-router` and `agent-usage-optimizer` capability skills

## Review/Debug Chain Summary

- `WRK-642`: diagnosed the original Claude no-response behavior and separated transport failure from wrapper ambiguity.
- `WRK-644`: introduced the Claude-specific compact bundle path.
- `WRK-645`: ruled out prompt-driven file-write capture as a viable Claude review transport.
- `WRK-647`: validated the patched Claude wrapper on compact-bundle review.
- `WRK-649`: validated that full-bundle Claude review succeeds when allowed to complete naturally.
- `WRK-650`: codified the full-vs-compact Claude review policy in the workflow spec.
- `WRK-651`: adopted the full-bundle artifact as the final policy-compliant Claude review for `WRK-624`.
- `WRK-652`: attached final review artifacts and synthesis directly to this WRK.
- `WRK-653`: updated the workflow so future exploratory/debugging chains stay inside one parent WRK by default.

## Agent Assignment Note

- The current stage-by-stage assignment model is an interim contract based on observed fit and workflow needs.
- It is required unless overridden with recorded evidence.
- It is not yet the final capability-grounded model because the assignment table has not yet been fully derived from an explicit review of:
  - `agent-router`
  - `agent-usage-optimizer`
- That refinement should happen as part of the follow-on Resource Intelligence skill work in `WRK-655`.

## Execution Brief
 (for Codex)

**Provider**: Codex (focused script + doc authoring); Gemini for cross-review of docs;
Claude for final orchestration review.

**Task for Codex**:
You are implementing `close-item.sh`, `validate-queue-state.sh`, and updating `process.md`
and `SKILL.md` for the workspace-hub work-queue system.

Repository: `workspace-hub` at `/mnt/local-analysis/workspace-hub/`
Work-queue root: `.claude/work-queue/`
Scripts root: `scripts/work-queue/`

Deliverables:
1. `scripts/work-queue/close-item.sh` — see spec above; use `#!/usr/bin/env bash`,
   `set -euo pipefail`; no hardcoded paths (use `git rev-parse --show-toplevel`)
2. `scripts/work-queue/validate-queue-state.sh` — same shell conventions
3. `docs/work-queue-workflow.md` — ASCII stage diagram + stage table + completion checklist
4. Edit `process.md` — add diagram reference + `close-item.sh` command in Process stage
5. Edit `.claude/skills/coordination/workspace/work-queue/SKILL.md` — add checklist template

Run tests: `bash scripts/work-queue/validate-queue-state.sh` must exit 0 on current queue.

**What user reviews**: the schematic diagram for clarity, the checklist for completeness,
and that `close-item.sh` handles the `pending/` fallback (not just `working/`).

## Agentic AI Horizon

**Assessment**: High fit for agentic execution. All deliverables are well-scoped scripts
and doc edits with clear acceptance criteria and machine-checkable outputs.

- `close-item.sh`: deterministic shell — Codex excels here
- `validate-queue-state.sh`: simple file-system checks — straightforward
- Doc updates: targeted edits to existing files, no architecture decisions needed
- Risk: SKILL.md is ≤20 lines limit — agent must check length before editing and migrate
  excess content to a linked doc file if needed

**Recommended execution**: Codex single-agent, no parallel subagents needed. Gemini
for doc review pass. Claude final gate.
