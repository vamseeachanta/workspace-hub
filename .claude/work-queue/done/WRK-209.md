---
id: WRK-209
title: "Add unit validator to EnvironmentSpec.water_density — catch physically implausible values"
status: done
priority: medium
complexity: small
created_at: 2026-02-19T00:00:00Z
target_repos:
  - digitalmodel
related: [WRK-208, WRK-131]
computer: ace-linux-1
execution_workstations: [ace-linux-1]
plan_workstations: [ace-linux-1]
---

# WRK-209: Unit Validator for EnvironmentSpec.water_density

## Problem

`input_schemas.py` documents `water_density` as **kg/m³** (default 1025.0), but
`3.1/spec.yml` had `water_density: 1.0` — the density of **air** — which silently
passed into the pipeline. The backend converts kg/m³ → t/m³ (`÷1000`), producing
`WaterDensity: 0.001` in the exported YAML. Case 3.1 still passes because all DOFs
are fixed (motion RAOs are zero regardless of density), masking the bug.

## Root Cause

No field-level validation rejects clearly unphysical values. The schema accepts any
`float > 0`, including `1.0 kg/m³` (air) or `1e6 kg/m³` (lead).

## Immediate Fix Applied (WRK-208 session)

`3.1/spec.yml`: `water_density: 1.0` → `1000.0` (fresh water, kg/m³)

## Required Engineering Work

Add a Pydantic `@field_validator` to `EnvironmentSpec` in
`src/digitalmodel/hydrodynamics/diffraction/input_schemas.py`:

```python
@field_validator("water_density")
@classmethod
def validate_water_density(cls, v: float) -> float:
    """Reject values outside the physical range for water (500–1100 kg/m³).

    Fresh water ≈ 1000 kg/m³, seawater ≈ 1025 kg/m³, brines up to ~1100 kg/m³.
    Values below 500 are likely unit errors (e.g. t/m³ stored as kg/m³).
    Values above 1100 are outside any engineering water context.
    """
    if not (500.0 <= v <= 1100.0):
        raise ValueError(
            f"water_density={v} kg/m³ is outside the physical range [500, 1100]. "
            f"Did you supply t/m³ instead of kg/m³? "
            f"Fresh water = 1000, seawater ≈ 1025."
        )
    return v
```

## Acceptance Criteria

1. `EnvironmentSpec(water_depth=100, water_density=1.0)` raises `ValidationError`
   with a clear message citing the kg/m³ unit and the plausible range.
2. `EnvironmentSpec(water_depth=100, water_density=1000.0)` passes.
3. `EnvironmentSpec(water_depth=100, water_density=1025.0)` passes.
4. Tests added: `tests/hydrodynamics/diffraction/test_input_schemas.py`
   - `test_water_density_rejects_air_density` (1.0 → ValidationError)
   - `test_water_density_rejects_tonnes_per_m3` (1.025 → ValidationError)
   - `test_water_density_accepts_fresh_water` (1000.0 → OK)
   - `test_water_density_accepts_seawater` (1025.0 → OK)

## Good Engineering Principles Context

This follows the pattern established in WRK-131 (Pydantic validators for
engineering constraints). The broader principle: **schema fields with physical
units should validate physical plausibility at parse time**, not fail silently
at solver time or not at all.

Future: Consider extending to `gravity` (acceptable: 9.7–9.9 m/s²),
`water_depth` (> 0 for finite, Inf for deep), and mass/inertia fields.
