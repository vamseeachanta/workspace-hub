---
id: WRK-324
title: Risk metrics — VaR CVaR Sharpe ratio max drawdown per position and portfolio
status: done
priority: high
complexity: medium
compound: false
created_at: 2026-02-22T00:00:00Z
target_repos:
  - assethold
commit:
spec_ref:
related: [WRK-309]
blocked_by: []
synced_to: []
plan_reviewed: false
plan_approved: false
percent_complete: 100
brochure_status: n/a
completed_at: 2026-02-24
computer: ace-linux-1
execution_workstations: [ace-linux-1]
plan_workstations: [ace-linux-1]
---

# Risk metrics — VaR CVaR Sharpe ratio max drawdown per position and portfolio

## What

Implement portfolio risk metrics using existing price history data. VaR (historical,
parametric), CVaR/Expected Shortfall, Sharpe ratio, Sortino ratio, max drawdown, Calmar ratio.
Per-position and portfolio-level output. Wire into daily strategy report.

## Why

Quantitative risk metrics are essential for portfolio management. VaR, CVaR, and drawdown
analysis provide objective measures of downside risk that complement return-based analysis.
Adding these metrics to the daily strategy report enables monitoring of portfolio risk
alongside performance.

## Acceptance Criteria

- [x] Historical VaR (95% and 99% confidence, configurable lookback)
- [x] Parametric VaR (normal distribution assumption)
- [x] CVaR / Expected Shortfall (tail risk beyond VaR)
- [x] Sharpe ratio (annualised, configurable risk-free rate)
- [x] Sortino ratio (downside deviation only)
- [x] Max drawdown (peak-to-trough, with dates)
- [x] Calmar ratio (annualised return / max drawdown)
- [x] Per-position and portfolio-level output
- [x] Wire into existing daily strategy report
- [x] Pytest coverage with known results from sample return series

## Implementation Notes

- `DrawdownResult` dataclass added: drawdown float + peak_date + trough_date
- `max_drawdown_with_dates()` returns DrawdownResult with index labels
- `position_risk()` convenience function: all metrics for a single series
- `PortfolioRisk` class: weighted multi-asset portfolio metrics + text report
- `DailyStrategyReport.render()` / `.write()` accept `risk_metrics` kwarg
- Report renders a "Risk Metrics" Markdown table when risk_metrics provided
- Sortino uses correct N-denominator (RMS over all periods, not N_down)
- 100% line and branch coverage; 70 tests pass (49 unit + 21 report integration)
- Legal scan: PASS. Cross-review: Claude failed (API), Codex NO_OUTPUT (API), Gemini REQUEST_CHANGES (Sortino formula fixed per feedback)

---
*Source: Phase G assethold expansion — WRK-309 Document Intelligence.*
