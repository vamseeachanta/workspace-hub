---
id: WRK-305
title: "feat: session signal emitters — wire /clear, plan-mode, per-WRK tool-counts"
status: done
percent_complete: 100
priority: medium
created: 2026-02-22
completed: 2026-02-24
tags: [hooks, session-signals, comprehensive-learning, phase-1]
computer: ace-linux-1
execution_workstations: [ace-linux-1]
plan_workstations: [ace-linux-1]
blocked_by: []
---

## Goal

Wire up three session-quality signal sources so comprehensive-learning Phase 1
can actually measure context hygiene, planning discipline, and task focus.

## Motivation

Phase 1 of comprehensive-learning checks for:
- Context reset discipline (`/clear` between tasks)
- Plan mode tracking (plan-mode invocations per session)
- Per-WRK tool-call counts (task decomposition quality)

Currently these signals are not emitted, so Phase 1 degrades gracefully with
"signal not available" for all three checks. No data → no improvement signal.

## Scope

### Signal 1: `/clear` invocation events

Emit a JSONL entry to `.claude/state/session-signals/` whenever `/clear` is invoked.

```jsonl
{"ts":"ISO8601","event":"context_reset","session_id":"<id>","wrk":"<active-wrk>"}
```

Hook point: `post-clear.sh` (create if not exists) or `/clear` skill wrapper.

### Signal 2: Plan-mode start/end events

Emit on plan-mode enter and exit:

```jsonl
{"ts":"ISO8601","event":"plan_mode_start","session_id":"<id>","wrk":"<active-wrk>"}
{"ts":"ISO8601","event":"plan_mode_end","session_id":"<id>","wrk":"<active-wrk>","approved":true}
```

Hook point: `post-plan-mode.sh` or wrap `EnterPlanMode` / `ExitPlanMode` in session hooks.

### Signal 3: Per-WRK tool-call counts

At session Stop, emit a summary of tool calls attributed to each active WRK:

```jsonl
{"ts":"ISO8601","event":"session_tool_summary","wrk":"<active-wrk>","tool_calls":142,"edits":23,"reads":67}
```

Source: cc-insights JSONL already captures tool calls — aggregate at Stop time.
Keep aggregation fast (< 1s); write raw summary entry only.

## Acceptance Criteria

- [x] `context_reset` events: placeholder `emit-context-reset.sh` created; documented in
      `.claude/docs/hooks/session-quality-signals.md` — `/clear` cannot be intercepted
      by any hook in Claude Code; wire-up path documented for future native hook support
- [x] `plan_mode_start` / `plan_mode_end` events: placeholder `emit-plan-mode-signal.sh`
      created; documented — no `PlanModeStart`/`PlanModeEnd` hook event exists in Claude
      Code; wire-up path documented for future native hook support
- [x] `session_tool_summary` event written at Stop time per active WRK
      (`emit-session-quality-signals.sh` wired into settings.json Stop hook)
- [x] comprehensive-learning Phase 1 signal emitter table updated with status per signal
- [x] Codex cross-review: Gemini APPROVE (P3 minor issues resolved); Codex CLI fails on
      codex-mini-latest model (pre-existing ChatGPT account limitation, not a code issue)

## Route

Route A — hook additions + Phase 1 SKILL.md section update.

## Implementation Notes

- `emit-session-quality-signals.sh`: wired as Stop hook; reads today's session JSONL
  from `session-logger.sh`, counts tool calls by type, writes `session_tool_summary`
- `emit-context-reset.sh`: callable placeholder; requires a `/clear` skill wrapper to
  trigger (manual call only until native hook support available)
- `emit-plan-mode-signal.sh`: callable placeholder; arguments: mode (start/end),
  session_id, wrk, approved
- Documentation: `.claude/docs/hooks/session-quality-signals.md` — full wire-up guide
  including future `PostClear` and `PlanModeStart`/`PlanModeEnd` hook registration
