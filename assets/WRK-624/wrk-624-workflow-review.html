<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WRK-624 Workflow Review</title>
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true, theme: 'neutral', securityLevel: 'loose' });
  </script>
  <style>
    :root {
      --bg: #f3efe6;
      --panel: #fffdf8;
      --ink: #172126;
      --muted: #55636b;
      --accent: #0f766e;
      --accent-2: #8a5a2b;
      --line: #d9d0c0;
      --warn: #b45309;
      --good: #166534;
      --bad: #b91c1c;
      --shadow: 0 16px 40px rgba(20, 33, 38, 0.08);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Georgia, "Times New Roman", serif;
      background: radial-gradient(circle at top, #fffaf0 0, var(--bg) 48%, #ebe5d7 100%);
      color: var(--ink);
      line-height: 1.5;
    }
    .hero {
      padding: 48px 24px 28px;
      border-bottom: 1px solid rgba(23, 33, 38, 0.08);
      background: linear-gradient(135deg, rgba(15,118,110,0.08), rgba(138,90,43,0.1));
    }
    .hero-inner, .content { max-width: 1180px; margin: 0 auto; }
    .eyebrow {
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-size: 0.72rem;
      color: var(--accent);
      font-weight: 700;
    }
    h1 {
      margin: 10px 0 12px;
      font-size: clamp(2rem, 4vw, 4rem);
      line-height: 0.95;
      max-width: 10ch;
    }
    .lede {
      max-width: 70ch;
      color: var(--muted);
      font-size: 1.05rem;
    }
    .meta {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 18px;
    }
    .pill {
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.8);
      padding: 7px 12px;
      border-radius: 999px;
      font-size: 0.9rem;
    }
    .content {
      padding: 28px 24px 56px;
      display: grid;
      gap: 22px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }
    .card, .panel {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
    }
    .card { padding: 18px; }
    .card h2, .panel h2 {
      margin: 0 0 12px;
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--accent-2);
    }
    .metric {
      font-size: 2rem;
      font-weight: 700;
    }
    .panel { padding: 22px; }
    .panel p, .panel li, .panel td, .panel th { color: var(--muted); }
    .panel strong, .panel code { color: var(--ink); }
    .mermaid-wrap {
      overflow-x: auto;
      padding: 8px;
      background: linear-gradient(180deg, #fff, #fcf8ef);
      border: 1px solid var(--line);
      border-radius: 14px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }
    th, td {
      text-align: left;
      padding: 10px 8px;
      border-top: 1px solid var(--line);
      vertical-align: top;
    }
    th {
      color: var(--ink);
      font-size: 0.86rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    ul { margin: 0; padding-left: 18px; }
    .status-good { color: var(--good); font-weight: 700; }
    .status-warn { color: var(--warn); font-weight: 700; }
    .status-bad { color: var(--bad); font-weight: 700; }
    .split {
      display: grid;
      grid-template-columns: 1.3fr 1fr;
      gap: 22px;
    }
    @media (max-width: 900px) {
      .split { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header class="hero">
    <div class="hero-inner">
      <div class="eyebrow">WRK-624 Review Artifact</div>
      <h1>Canonical Work-Queue Workflow</h1>
      <p class="lede">This HTML artifact is the user review surface for the new lifecycle contract. It shows the proposed Mermaid schematic, the hard gates, and the quality-and-learning requirements, including both fast auto-memory capture and deeper comprehensive-learning synthesis, before provider-diverse multi-seed cross-review.</p>
      <div class="meta">
        <div class="pill">Status: Draft for review</div>
        <div class="pill">Scope: workspace-hub, portable to future repo-local queues</div>
        <div class="pill">Review set: Claude + Codex + Gemini</div>
      </div>
    </div>
  </header>

  <main class="content">
    <section class="grid">
      <article class="card">
        <h2>Stages</h2>
        <div class="metric">8</div>
        <p>Capture through Archive with explicit gates.</p>
      </article>
      <article class="card">
        <h2>Mandatory Reviewers</h2>
        <div class="metric">1-9</div>
        <p>Route A defaults to 1 seed total; Route B requires 2 seeds per provider; Route C requires 3 seeds per provider.</p>
      </article>
      <article class="card">
        <h2>Examples Per WRK</h2>
        <div class="metric">5-10</div>
        <p>Real examples plus variation tests for all work items.</p>
      </article>
      <article class="card">
        <h2>HTML Review</h2>
        <div class="metric">Every WRK</div>
        <p>Each work item must ship an HTML review artifact for direct user inspection.</p>
      </article>
    </section>

    <section class="panel">
      <h2>Mermaid Schematic</h2>
      <div class="mermaid-wrap">
        <pre class="mermaid">
flowchart TD
    A[Capture] --> B[Resource Intelligence]
    B --> C[Triage]
    C --> D[Plan Draft]
    D --> E{User Reviewed Draft HTML?}
    E -- Yes --> F[Multi-Agent Review]
    E -- No --> D
    F --> G{Plan Reviewed + User Reviewed Final HTML + Approved?}
    G -- Yes --> H[Claim]
    G -- No --> F1[Revise Plan HTML]
    F1 --> D
    H --> I{Best-Fit Agent + Quota Ready?}
    I -- Yes --> J{Blocked?}
    I -- No --> H1[Recommend alternate agent or short defer]
    H1 --> H
    J -- No --> K[Execute]
    J -- Yes --> L[Status: blocked]
    K --> M{Route Review Passed?}
    M -- Yes --> N[Close]
    M -- No --> M1[Address findings / revise implementation]
    M1 --> K
    N --> O{Queue Valid + Merge/Sync Complete?}
    O -- Yes --> P[Archive]
    O -- No --> N
        </pre>
      </div>
    </section>

    <section class="panel">
      <h2>New Global Review Rule</h2>
      <table>
        <tr>
          <th>Requirement</th>
          <th>Rule</th>
          <th>Closure impact</th>
        </tr>
        <tr>
          <td>HTML artifact</td>
          <td>Every WRK must produce an HTML review artifact for direct user inspection, including a planning-stage WRK HTML for plan review.</td>
          <td class="status-bad">Close blocked if missing</td>
        </tr>
        <tr>
          <td>Plan HTML gate</td>
          <td>User review of the draft WRK HTML artifact is required before multi-agent review, and user review of the final WRK HTML artifact is required again after multi-agent review before execution may proceed. The plan HTML must begin with an executive summary for quick review.</td>
          <td class="status-bad">Execution blocked if not reviewed</td>
        </tr>
        <tr>
          <td>Agent verification</td>
          <td>The orchestrating agent verifies the HTML artifact before closure evidence is complete.</td>
          <td class="status-bad">Close blocked if unverified</td>
        </tr>
        <tr>
          <td>Review schema</td>
          <td>Claude, Codex, and Gemini must all emit the same interpretable review structure so other agents and validators can parse the result without provider-specific logic.</td>
          <td class="status-bad">Review gate blocked on invalid format</td>
        </tr>
        <tr>
          <td>User verification</td>
          <td>The user reviews the HTML artifact before the WRK may move to final closure.</td>
          <td class="status-bad">Close blocked if not reviewed</td>
        </tr>
        <tr>
          <td>Claim capability check</td>
          <td>Claim must assess whether the current AI agent is best suited, and recommend an alternate executor when another agent is a materially better fit.</td>
          <td class="status-bad">Execution should not proceed blindly</td>
        </tr>
        <tr>
          <td>Claim quota check</td>
          <td>Claim must verify weekly AI usage and remaining quota before execution using the regular quota snapshot and readiness pipeline. Waiting up to 24 hours is acceptable when it preserves the best-fit agent; beyond 24 hours the claim should recommend rerouting instead of stalling.</td>
          <td class="status-bad">Execution should pause or reroute if quota is weak</td>
        </tr>
        <tr>
          <td>Domain outputs</td>
          <td>Where calculations or analysis outputs exist, the same HTML artifact must surface them in directly reviewable form.</td>
          <td class="status-bad">Close blocked if omitted</td>
        </tr>
      </table>
    </section>

    <section class="panel">
      <h2>Claude Review Mode Policy</h2>
      <table>
        <tr>
          <th>Mode</th>
          <th>Transport</th>
          <th>Strength</th>
          <th>When to use</th>
        </tr>
        <tr>
          <td>Full bundle</td>
          <td>Patched temp-file <code>Read</code> path via <code>submit-to-claude.sh</code></td>
          <td class="status-good">Best review quality</td>
          <td>Default for all relevant substantive reviews, including Route B/C plans, workflow/governance items, and final full-context review.</td>
        </tr>
        <tr>
          <td>Compact bundle</td>
          <td>Same patched temp-file <code>Read</code> path with <code>--compact-plan</code></td>
          <td class="status-warn">Faster, but lossy</td>
          <td>Fallback only for non-final screening passes or when the user explicitly wants faster feedback over full-context analysis.</td>
        </tr>
      </table>
      <p><strong>Policy:</strong> full bundle is the default Claude review mode for all relevant reviews. The default bounded wait for Claude review runs is 5 minutes (<code>300s</code>). If compact mode is used and Claude flags truncation, missing context, or bundle lossiness, rerun it on the full bundle before treating the review as final.</p>
    </section>

    <section class="panel">
      <h2>Exploration Chain Policy</h2>
      <table>
        <tr>
          <th>Keep inside one parent WRK</th>
          <th>Split into new WRK</th>
        </tr>
        <tr>
          <td>
            Experiments, retries, diagnostics, review-mode comparisons, and synthesis that all serve the same immediate objective and remain in the same active work stream.
          </td>
          <td>
            Work that becomes its own deliverable, changes ownership, is likely to be deferred independently, or is valuable as a standalone backlog item.
          </td>
        </tr>
      </table>
      <p><strong>Default:</strong> exploratory/debugging chains should stay inside one approved parent WRK, with sub-steps logged in the WRK body or assets, instead of creating a new WRK for every experiment.</p>
      <p><strong>User choice rule:</strong> when new work could reasonably fit either an existing active WRK or a new WRK, the user should be offered both paths. Reuse the existing WRK when objective and approval scope are still materially the same; create a new WRK when the branch has independent backlog value. In either case, traceability must be preserved and no findings, evidence, or learnings may be lost.</p>
    </section>

    <section class="split">
      <article class="panel">
        <h2>Key Rules</h2>
        <ul>
          <li><strong>Resource Intelligence</strong> is mandatory for every WRK and produces a modular resource pack.</li>
          <li><strong>One active orchestrator session</strong> owns transitions into <code>working</code>, <code>done</code>, and <code>archived</code>.</li>
          <li><strong>Claim</strong> includes an AI capability check and should recommend a better-fit executor when the current agent is not the strongest option.</li>
          <li><strong>Claim</strong> also checks weekly AI usage availability from the regular quota cron/readiness pipeline so execution does not start on an agent likely to hard-stop; waits up to 24 hours are acceptable, longer waits should reroute.</li>
          <li><strong>Review matrix</strong> is route-based, but no route skips review.</li>
          <li><strong>Review artifacts</strong> must share a common schema: <code>Verdict</code>, <code>Summary</code>, <code>Issues Found</code>, <code>Suggestions</code>, and <code>Questions for Author</code>.</li>
          <li><strong><code>INVALID_OUTPUT</code></strong> is a blocking review failure and requires rerun, alternate mode, or explicit user waiver before the gate can pass.</li>
          <li><strong>Script paths</strong> are intentionally split: lifecycle operations live in <code>scripts/work-queue/</code>, while queue-index helpers live in <code>.claude/work-queue/scripts/</code>.</li>
          <li><strong>Plan gate</strong> requires user review twice: once on the draft HTML before multi-agent review, and once on the final HTML after multi-agent review.</li>
          <li><strong>Plan HTML</strong> should front-load an executive summary near the top so the user can review the item quickly.</li>
          <li><strong>Every WRK</strong> carries 5-10 real examples, variation tests, and learning outputs.</li>
          <li><strong>Learning capture</strong> has two layers: auto-memory for real-time session capture and comprehensive-learning for slower, deeper multi-agent synthesis.</li>
          <li><strong>User-review SLA</strong>: HTML review gates remain in place for under 48 hours; beyond that the WRK must record a user defer, named delegate review, or rollback to the prior actionable stage.</li>
          <li><strong>Every WRK</strong> must produce an HTML review artifact, and the user reviews it before close.</li>
          <li><strong>Domain workflows</strong> must include calculation or analysis outputs inside that HTML artifact in a directly reviewable form.</li>
          <li><strong>Existing vs new WRK</strong>: if either path is viable, present both options to the user and preserve full traceability whichever path is chosen.</li>
          <li><strong>Archive</strong> is blocked until queue validation, merge to main, and sync flow complete.</li>
        </ul>
      </article>
      <article class="panel">
        <h2>Current Review Status</h2>
        <table>
          <tr><th>Gate</th><th>Status</th></tr>
          <tr><td>Spec draft</td><td class="status-good">Prepared</td></tr>
          <tr><td>HTML review artifact</td><td class="status-good">Prepared</td></tr>
          <tr><td>Claude review</td><td class="status-good">Full-bundle artifact adopted as final Claude review</td></tr>
          <tr><td>Codex review</td><td class="status-good">Formal review artifact recorded</td></tr>
          <tr><td>Gemini review</td><td class="status-good">Formal review artifact recorded</td></tr>
          <tr><td>Review synthesis</td><td class="status-warn">Fresh formal rerun completed; verdict still effectively <code>REQUEST_CHANGES</code> due to remaining enforceability gaps and Codex <code>NO_OUTPUT</code></td></tr>
        </table>
      </article>
    </section>

    <section class="panel">
      <h2>Review Matrix</h2>
      <table>
        <tr>
          <th>Route</th>
          <th>Review level</th>
          <th>Required reviewers</th>
          <th>Artifacts</th>
        </tr>
        <tr>
          <td>A</td>
          <td>Mandatory lightweight review</td>
          <td>1 seed by default, auto-escalates on defined risk signals</td>
          <td><code>review-primary.md</code></td>
        </tr>
        <tr>
          <td>B</td>
          <td>Standard</td>
          <td>Claude x2, Codex x2, Gemini x2</td>
          <td>Per-seed reviewer artifacts plus <code>review-synthesis.md</code></td>
        </tr>
        <tr>
          <td>C</td>
          <td>Full</td>
          <td>Claude x3, Codex x3, Gemini x3 per plan, phase, and close</td>
          <td>Per-seed reviewer artifacts plus per-phase synthesis</td>
        </tr>
      </table>
    </section>

    <section class="panel">
      <h2>Seed Depth Policy</h2>
      <table>
        <tr>
          <th>Concept</th>
          <th>Rule</th>
        </tr>
        <tr>
          <td>Provider diversity</td>
          <td>Which model families must review the item: Claude, Codex, and Gemini for Route B/C.</td>
        </tr>
        <tr>
          <td>Seed depth</td>
          <td>How many independent runs are required per provider.</td>
        </tr>
        <tr>
          <td>Default depth</td>
          <td>Route A: 1 seed total. Route B: 2 seeds per provider. Route C: 3 seeds per provider.</td>
        </tr>
        <tr>
          <td>High-governance items</td>
          <td>Workflow, governance, legal, compliance, and agent-behavior reviews use the Route C seed depth by default.</td>
        </tr>
      </table>
    </section>

    <section class="panel">
      <h2>Requirement Classes</h2>
      <table>
        <tr>
          <th>Requirement</th>
          <th>Route A</th>
          <th>Route B</th>
          <th>Route C</th>
        </tr>
        <tr>
          <td>Resource pack</td>
          <td>Concise but complete</td>
          <td>Standard</td>
          <td>Full</td>
        </tr>
        <tr>
          <td>Examples</td>
          <td>5-10 small real examples</td>
          <td>5-10 representative examples</td>
          <td>5-10 representative examples with phase traceability</td>
        </tr>
        <tr>
          <td>Variation tests</td>
          <td>Lightweight</td>
          <td>Standard</td>
          <td>Full / per phase</td>
        </tr>
        <tr>
          <td>Plan HTML reviews</td>
          <td>Draft + final</td>
          <td>Draft + final</td>
          <td>Draft + final</td>
        </tr>
        <tr>
          <td>Reviewers</td>
          <td>1 seed by default, escalate on risk</td>
          <td>2 seeds/provider</td>
          <td>3 seeds/provider per plan / phase / close</td>
        </tr>
      </table>
    </section>

    <section class="split">
      <article class="panel">
        <h2>Mandatory Metadata</h2>
        <ul>
          <li><code>orchestrator</code></li>
          <li><code>computer</code> (named execution host / workstation)</li>
          <li><code>resource_pack_ref</code></li>
          <li><code>plan_html_review_draft_ref</code></li>
          <li><code>plan_html_review_final_ref</code></li>
          <li><code>claim_routing_ref</code></li>
          <li><code>claim_quota_snapshot_ref</code></li>
          <li><code>claim_recommendation</code></li>
          <li><code>example_pack_ref</code></li>
          <li><code>variation_test_ref</code></li>
          <li><code>learning_outputs</code></li>
          <li><code>followup</code></li>
          <li><code>html_output_ref</code> and <code>html_verification_ref</code></li>
        </ul>
      </article>
      <article class="panel">
        <h2>Dependency Authority</h2>
        <ul>
          <li><strong>Quota source of truth</strong>: <code>config/ai-tools/agent-quota-latest.json</code></li>
          <li><strong>Producer</strong>: <code>scripts/ai/assessment/query-quota.sh</code> plus readiness pipeline</li>
          <li><strong>Queue validation</strong>: validator output is blocking for close/archive</li>
          <li><strong>Workstation registry</strong>: blocking source of truth for validating the <code>computer</code> field.</li>
          <li><strong>Document-intelligence indexing</strong>: advisory by default, blocking only when the WRK explicitly requires indexed artifacts before close/archive.</li>
          <li><strong>Comprehensive-learning handoff</strong>: blocking for archive when the WRK explicitly requires deep-learning handoff evidence.</li>
          <li><strong>Legal scan</strong>: blocking for generated WRK artifacts unless explicitly waived</li>
          <li><strong>Review evidence</strong>: blocking for plan/execute progression; fallback only for <code>NO_OUTPUT</code></li>
          <li><strong>Merge + sync</strong>: both are blocking for archive</li>
          <li><strong>Script location policy</strong>: use <code>scripts/work-queue/</code> for queue operations and <code>.claude/work-queue/scripts/</code> for queue index helpers.</li>
        </ul>
      </article>
    </section>

    <section class="split">
      <article class="panel">
        <h2>Learning Lanes</h2>
        <ul>
          <li><strong>Auto-memory</strong>: fast opportunistic capture during active Claude sessions.</li>
          <li><strong>Comprehensive-learning</strong>: slower deep synthesis across sessions, agents, and machines.</li>
          <li><strong>Relationship</strong>: complementary lanes writing back into a compatible memory and learning surface.</li>
          <li><strong>Deep-learning contract</strong>: when required by the WRK, archive expects a handoff artifact with summary, actions, and metadata proving propagation or deferred follow-up.</li>
        </ul>
      </article>
    </section>

    <section class="split">
      <article class="panel">
        <h2>Phased Rollout</h2>
        <ul>
          <li><strong>Phase 1 (Feb 27-Mar 7, 2026):</strong> normalize statuses, reconcile drift, reporting validator, manual-remediation list, git rollback path.</li>
          <li><strong>Phase 2 (Mar 8-Mar 21, 2026):</strong> require resource packs, draft-plan and final-plan WRK HTML reviews, close evidence, and HTML review artifacts for new/touched WRKs. Rollback: temporarily return the new artifact gates to warning-only while preserving status migration and validator reporting. Success metrics: new/touched WRKs carry required refs, zero closes without HTML/claim evidence, zero unresolved generated-artifact legal-scan failures.</li>
          <li><strong>Phase 3 (from Mar 22, 2026):</strong> enforce active session binding, hard-block invalid transitions, hard-fail legacy statuses. Rollback: disable hard-blocking and drop back to Phase 2 warning mode while keeping migration tooling and evidence artifacts intact. Success metrics: zero transition bypasses without remediation evidence, zero archive mismatches, zero archive moves without merge/sync evidence.</li>
        </ul>
      </article>
      <article class="panel">
        <h2>Archive Gate</h2>
        <ul>
          <li>Queue validation must pass.</li>
          <li>Merge to main must be complete.</li>
          <li>Repo sync flow must be complete.</li>
          <li>HTML review artifact must already be verified by agent and user.</li>
        </ul>
      </article>
    </section>

    <section class="panel">
      <h2>Testing Strategy</h2>
      <ul>
        <li>Transition tests across the full lifecycle.</li>
        <li>Validator tests for status, folder, and missing artifact mismatches.</li>
        <li>Idempotency tests for close, archive, and validation operations.</li>
        <li>Concurrency tests for conflicting claim attempts and stale session recovery.</li>
        <li>Outage tests for reviewer failure, quota-source outage, and HTML/legal tool failure.</li>
        <li>User-availability tests for 48-hour pending review, user-deferred states, and delegated review evidence.</li>
        <li>Migration tests for malformed filenames and legacy statuses.</li>
        <li>HTML gate tests for draft-plan review, final-plan review, and close-time HTML verification.</li>
        <li>Rollback tests for Phase 1, Phase 2, and Phase 3 rollback paths.</li>
      </ul>
    </section>

    <section class="panel">
      <h2>Review Focus</h2>
      <ul>
        <li>Does the Mermaid diagram show the happy path and the blocking paths clearly enough?</li>
        <li>Are the new hard gates concrete enough to drive automation?</li>
        <li>Does making HTML mandatory for every WRK improve reviewability without adding the wrong kind of overhead?</li>
        <li>Do the example, HTML, learning, and archive requirements feel proportionate and enforceable?</li>
        <li>Should any stage names or edge labels be tightened before 3-seed review?</li>
      </ul>
    </section>
  </main>
</body>
</html>
